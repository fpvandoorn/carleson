% This is the main point of entry to the blueprint.
% Add chapters of the blueprint here.
% This file is not meant to be built. Build src/web.tex or src/print.text instead.

% Note: still have to upstream section ~> chapter and subsection ~> section to Overleaf
\title{Carleson operators on doubling metric measure spaces}

\author{Lars Becker \and Floris van Doorn \and Asgar Jamneshan \and Rajula Srivastava \and Christoph Thiele}

\date{\today}

\maketitle

\begin{abstract}
    We prove bounds for a generalized version of the Carleson operator on doubling metric measure spaces.
    We also explicitly reduce Carleson's classical result on pointwise control of Fourier series.
    Both proofs are very detailed, suitable as a blueprint for computer verification of our results with
    the current capabilities of the software package Lean.
    Even Carleson's classical result has not yet been computer verified.
\end{abstract}

\tableofcontents

\chapter{Introduction}

In \cite{carleson}, L. Carleson addressed a classical question regarding the convergence of Fourier series of continuous functions by proving their pointwise convergence almost everywhere. Theorem \ref{classical Carleson} represents a version of this result.

Let $f$ be a complex-valued, $2\pi$-periodic bounded Borel measurable function on the real line, and for an integer $n$, define the Fourier coefficient as
\begin{equation}
    \widehat{f}_n:=\frac {1}{2\pi} \int_0^{2\pi} f(x) e^{- i nx} dx .
\end{equation}
Define the partial Fourier sum for $N\ge 0$ as
\begin{equation}
    S_Nf(x):=\sum_{n=-N}^N \widehat{f}_n e^{i nx}\ .
\end{equation}

\begin{theorem}[classical Carleson]
\label{classical Carleson}
\uses{piecewise constant approximation, convergence for piecewise constant,
control approximation effect,metric space Carleson}
Let $f$ be a $2\pi$-periodic complex-valued uniformly continuous function on $\mathbb{R}$ satisfying the bound $|f(x)|\le 1$ for all $x\in \mathbb{R}$. For all $0<\epsilon\le 2\pi$, there exists a Borel set $E\subset [0,2\pi]$ with Lebesgue measure $|E|\le \epsilon$ and a positive integer $N_0$ such that for all $x\in [0,2\pi]\setminus E$ and all integers $N>N_0$, we have
\begin{equation}\label{aeconv}
|f(x)-S_N f(x)|\le \epsilon.
\end{equation}
\end{theorem}

Note that mere continuity implies uniform continuity in the setting of this theorem. By applying this theorem with a sequence of $\epsilon_n:= 2^{-n}\delta$ for $n\ge 1$ and taking the union of corresponding exceptional sets $E_n$, we see that outside a set of measure $\delta$, the partial Fourier sums converge pointwise for $N\to \infty$. Applying this with a sequence of $\delta$ shrinking to zero and taking the intersection of the corresponding exceptional sets, which has measure zero, we see that the Fourier series converges outside a set of measure zero.

The purpose of this paper is twofold. On the one hand, it prepares computer verification of Theorem \ref{classical Carleson} by presenting a very detailed proof as a blueprint for coding in Lean. We pass through a bound for a generalization of the so-called Carleson operator to doubling metric measure spaces. This generalization is new, and proving these bounds constitutes the second purpose of this paper. This generalization incorporates several results from the recent literature, most prominently bounds for the polynomial Carleson operator of V. Lie \cite{lie-polynomial} as well as its generalization \cite{zk-polynomial}. A computer verification of our theorem will also entail a computer verification for the bulk of the work in these results.


We proceed to introduce the setup for our general theorem.
We carry a multi purpose parameter, a natural number
\begin{equation}
    a\ge 4
\end{equation} in our notation that as it gets larger will allow more general applications but will worsen the constants in the estimates.



A doubling metric measure space  $(X,\rho,\mu, a)$ is a complete
and locally compact metric space $(X,\rho)$
equipped with a $\sigma$-finite non-zero Radon--Borel measure $\mu$ that satisfies the doubling condition that for all $x\in X$ and all $R>0$ we have
\begin{equation}\label{doublingx}
    \mu(B(x,2R))\le 2^a\mu(B(x,R))\,,
\end{equation}
where we have denoted by $B(x,R)$ the open ball of radius $R$ centred at $x$:
\begin{equation}\label{eq define ball}
 B(x,R):=\{y\in X: \rho(x,y)<R\}. \end{equation}


A  collection $\Mf$ of real valued continuous functions on the doubling metric measure space $(X,\rho,\mu,a)$ is called compatible, if there is a point $o\in X$ where all the functions are equal to $0$, and the  local oscillation, defined for a Borel set $\borel\subset X$ by
\begin{equation}\label{definedE}
    d_{\borel}(\mfa,\mfb):=\sup_{x,y\in \borel}|\mfa(x)-{\mfa(y)}- \mfb(x)+{\mfb(y)}|
\end{equation}
satisfies the following three properties
\eqref{firstdb}, \eqref{seconddb}, and \eqref{thirddb}.
For any two balls $B_1=B(x_1,R)$, $B_2= B(x_2,2R)$ in $X$ with $x_1\in B_2$  and any $\mfa,\mfb\in \Mf$,
\begin{equation}\label{firstdb}
    d_{B_2}(\mfa,\mfb)\le 2^a d_{B_1}(\mfa,\mfb) .
\end{equation}
For any two balls
$B_1=B(x_1,R)$, $B_2= B(x_2,2^aR)$
with $B_1\subset B_2$, and $\mfa,\mfb\in \Mf$,
\begin{equation}\label{seconddb}
    2d_{B_1}(\mfa,\mfb)
\le d_{B_2}(\mfa,\mfb) .
\end{equation}
For every ball $B$ in $X$ and every $d_B$-ball $\tilde B$ of radius $2R$ in $\Mf$, there is a collection $\mathcal{B}$ of
at most $2^a$ many  $d_B$-balls of radius $R$ covering $\tilde B$, that is,
\begin{equation}\label{thirddb}
    \tilde B\subset \bigcup \mathcal{B}.
\end{equation}


Further, a compatible collection $\Mf$ is called cancellative, if
for any ball $B$ in $X$ of radius $R$, any Lipschitz function $\varphi: X\to \C$
supported on $B$, and any $\mfa,\mfb\in \Mf$ we have
\begin{equation}
    \label{eq vdc cond}
    |\int_B e(\mfa(x)-{\mfb(x)}) \varphi(x) d\mu(x)|\le 2^a  \mu(B)\|\varphi\|_{\Lip(B)}
(1+d_B(\mfa,\mfb))^{-\frac{1}{a}},
\end{equation}
%where $\C^\nu$ denotes the homogeneous H\"older space.
where $\|\cdot\|_{\Lip(B)}$ denotes the inhomogeneous Lipschitz norm on $B$:
$$
    \|\varphi\|_{\Lip(B)} = \sup_{x \in B} |\varphi(x)| + R \sup_{x,y \in B, x \neq y} \frac{|\varphi(x) - \varphi(y)|}{\rho(x,y)}\,.
$$




A one-sided Calder\'on--Zygmund kernel $K$ on  the doubling metric measure space $(X, \rho, \mu, a)$ is a measurable function
 \begin{equation}\label{eqkernel0}
K:X\times X\to \mathbb{C}
 \end{equation}
such that for all $x,y',y\in X$ with $x\neq y$, we have
\begin{equation}\label{eqkernel size}
    |K(x,y)| \leq \frac{2^{a^3}}{V(x,y)}
  \end{equation}
 and if $2\rho(y,y') \leq \rho(x,y)$, then
  \begin{equation}
  \label{eqkernel y smooth}
       |K(x,y) - K(x,y')| \leq \left(\frac{\rho(y,y')}{\rho(x,y)}\right)^{\frac{1}{a}}\frac{2^{a^3}}{V(x,y)},
\end{equation}
where  \[V(x,y):=\mu(B(x,\rho(x,y))).\]
%Observe that $V$ is essentially symmetric in the sense that $V(x,y)$ and $V(y,x)$ are comparable, with the implied constant depending only on $A$.
Define the maximally truncated non-tangential singular integral $T_{*}$ associated with $K$ by
\begin{equation}
    \label{def tang unm op}
    T_{*}f(x):=\sup_{R_1 < R_2} \sup_{\rho(x,x')<R_1} \left|\int_{R_1< \rho(x,y) < R_2}  K(x,y) f(y)  \, \mathrm{d}\mu(y) \right|\,.
\end{equation}
We define the generalized Carleson operator $T$ by
 \begin{equation}
        \label{def main op}
        Tf(x):=\sup_{\mfa\in\Mf} \sup_{0 < R_1 < R_2}\left| \int_{R_1 <  \rho(x,y) < R_2}  K(x,y) f(y) e(\mfa(y)) \, \mathrm{d}\mu(y) \right|\, ,
\end{equation}
where $e(r)=e^{ir}$.

Our main result  is the following restricted weak type estimate for $T$ in the range $1<q\le 2$, which by interpolation techniques recovers $L^q$ estimates for the open range
$1<q<2$.
\begin{theorem}[metric space Carleson]
\label{metric space Carleson}
\uses{ball metric,finitary Carleson, discrete Carleson, antichain operator, forest operator, Holder van der Corput, Hardy Littlewood, kernel summand, R truncation}
    For all  integers $a \ge  4$ and  real numbers $1<q\le 2$
    % there exists a positive  such that
    the following holds.
    Let $(X,\rho,\mu,a)$ be a doubling metric measure space. Let  $\Mf$ be a
    cancellative compatible  collection of functions and let $K$ be a one-sided Calder\'on--Zygmund kernel on $(X,\rho,\mu,a)$. Assume  that for every bounded measurable function $g$ on $X$ supported on a set of finite measure we have
    \begin{equation}\label{nontanbound}
        \|T_{*}g\|_{2} \leq 2^{a^3} \|g\|_2\,,
    \end{equation}
    where $T_{*}$ is defined in
\eqref{def tang unm op}.
    Then for all Borel sets $F$ and $G$ in $X$ and
    all Borel functions $f:X\to \C$ with
    $|f|\le \mathbf{1}_F$, we have, with $T$ defined in  \eqref{def main op},
    \begin{equation}
    \label{resweak}
        \left|\int_{G} T f \, \mathrm{d}\mu\right| \leq \frac{2^{270a^3}}{(q-1)^5} \mu(G)^{1-\frac{1}{q}} \mu(F)^{\frac{1}{q}}\, .
        \end{equation}
\end{theorem}

In the one-dimensional Euclidean setting, with $K$ representing the Hilbert kernel:
\begin{equation*}
K(x,y)=(x-y)^{-1}
\end{equation*}
and $\Mf$ denoting the class of linear functions, the operator \eqref{def main op} is the classical Carleson operator, which plays a crucial role in proving the almost everywhere convergence of Fourier series \cite{carleson}, \cite{fefferman}, \cite{lacey-thiele}. The supremum in $R_1$ and $R_2$ is often omitted in classical treatments, but considering the maximal truncations can easily be reduced to the case without these truncations.

By replacing $\Mf$ with the class of polynomials vanishing at $0$ up to some fixed but arbitrary degree, we obtain the polynomial Carleson operator of Lie \cite{lie-quadratic} (quadratic case) and \cite{lie-polynomial}. The case of the class of polynomials with vanishing linear coefficient is simpler and was estimated in \cite{stein-wainger}. The polynomial Carleson operator was generalized to the high-dimensional Euclidean setting in \cite{zk-polynomial} for $K$ being a Calderón-Zygmund kernel with some Hölder regularity.

Doubling metric measure spaces are instances of spaces of homogeneous type. Indeed, by changing from a quasi-metric to an equivalent metric, every space of homogeneous type can be viewed as a doubling metric measure space (cf. \cite{MaciasSegovia}). Spaces of homogeneous type were introduced by \cite{MR0499948} as a natural setting for Calderón-Zygmund theory. We refer to the textbook \cite{stein-book} for an account of these spaces.

Our concept of a compatible collection $\Mf$ as a natural class of phase functions on a doubling metric measure space does not appear in \cite{stein-book} but is implicitly anticipated in \cite{zk-polynomial} and subsequent work of \cite{mnatsakanyan}, who proves a Carleson-type theorem for the Malmquist-Takenaka series, which leads to classes of phases related to Blaschke products. A generalization of \eqref{def main op} from the previously mentioned Euclidean setting into the anisotropic setting that was suggested in \cite{zk-polynomial} is included in our theory. The polynomial Carleson operator also plays a role in the study of maximally modulated singular Radon transforms along the parabola, see \cite{ramos} and \cite{becker2024maximal}.

For the proof of Theorem \ref{metric space Carleson}, we largely follow \cite{zk-polynomial}, which in turn was inspired by \cite{lie-polynomial}. We make suitable modifications to adapt to our more general setting and have made a few technical improvements in the proof. In particular, in Section \ref{overviewsection}, we explicitly divide the main work of the proof into mutually independent sections \ref{thmfromproplinear}, \ref{christsection}, \ref{proptopropprop}, \ref{antichainboundary}, \ref{treesection}, \ref{liphoel}, and \ref{sec hlm}. Some of these sections follow a similar pattern, starting with a subsection dividing the proof into further mutually independent subsections. This modularization of our proof was strongly endorsed in personal communication by the author of \cite{zk-polynomial}.











\noindent \textit{Acknowledgement.}
L.B., F.v.D., R.S., and C.T. were funded by the Deutsche Forschungsgemeinschaft (DFG, German Research Foundation) under Germany's Excellence Strategy -- EXC-2047/1 -- 390685813.
L.B. , R.S., and C.T. were also supported by SFB 1060.
A.J. is funded by the T\"UBITAK (Scientific and Technological Research Council of T\"urkiye) under Grant Number 123F122.

\chapter{Proof of metric space Carleson (Thm \ref{metric space Carleson}), overview}
\label{overviewsection}


This section organizes the proof of Theorem \ref{metric space Carleson} into sections \ref{thmfromproplinear}, \ref{christsection}, \ref{proptopropprop}, \ref{antichainboundary}, \ref{treesection}, \ref{liphoel}, and \ref{sec hlm}. These sections are mutually independent except for referring to the statements formulated in the present section. Section \ref{thmfromproplinear} proves the main Theorem \ref{metric space Carleson}, while sections \ref{christsection}, \ref{proptopropprop}, \ref{antichainboundary}, \ref{treesection}, \ref{liphoel}, and \ref{sec hlm} each prove one proposition that is stated in the present section. The present section also introduces all definitions used across these sections.

Subsection \ref{global auxiliary lemmas} proves some auxiliary lemmas that are used in more than one of the sections 3-9.

Let $a, q$ be given as in Theorem \ref{metric space Carleson}.




Define
\begin{equation}\label{defineD}
D:= 2^{100 a^2}\,  ,
\end{equation}
\begin{equation}\label{definekappa}
\kappa:= 2^{-10a}\,,
\end{equation}
and
\begin{equation}
    \label{defineZ}
    Z := 2^{12a}\,.
\end{equation}
Let
 $\psi:\R \to \R$ be the unique compactly supported, piece-wise linear, continuous function with corners precisely at $\frac 1{4D}$, $\frac 1{2D}$, $\frac 14$ and $\frac 12$ which satisfies
 \begin{equation}
    \label{eq psisum}
    \sum_{s\in \mathbb{Z}} \psi(D^{-s}x)=1
\end{equation}
for all  $x>0$. This function vanishes outside $[\frac1{4D},\frac 12]$, is constant one on
$[\frac1{2D},\frac 14]$, and is Lipschitz
with constant $4D$.







Let a doubling metric measure space $(X,\rho,\mu, a)$ be given.
Let a cancellative compatible collection $\Mf$ of functions on $X$ be given.
Let $o\in X$ be a point such that $\mfa(o)=0$
for all $\mfa\in \Mf$.


The following lemma is used throughout the text, mostly
the triangle inequality part, without specific reference.
It allows us to call $d_B$ a metric.

\begin{lemma}[ball metric]
\label{ball metric}
    For any ball $B$ in $X$, the local oscillation
$d_{B}$ is a metric on $\Mf$.
\end{lemma}

\begin{proof}
    Symmetry and triangle inequality are immediate, and we argue that
for any ball $B(x,r)$, the identity
\begin{equation}\label{dvanish}
d_{B(x,r)}(\mfa,\mfb)=0
\end{equation}
implies $\mfa(y)=\mfb(y)$ for all $y\in X$. Assume $\eqref{dvanish}$.
Let $y\in X$ and let
\begin{equation}
    R=1+\rho(x,o)+\rho(x,y)\, .
\end{equation}
By an iterated application of \eqref{firstdb} or \eqref{seconddb},
\begin{equation}
    d_{B(x,R)}(\mfa,\mfb)=0.
\end{equation}
By the definition of
the local oscillation, evaluated using $o$ as one of the points and $y$ as the other, we obtain
$\mfa(y)=\mfb(y)$.
\end{proof}
%Let $\mathcal{B}(\Mf)$ denote the Borel $\sigma$-algebra in $\Mf$ with respect to the
%unique topology generated by any of the metrics $d_{B}$ with respect to some non-empty ball $B$ in $X$.   \ct{Not sure we need that (?) move to section 3}

Let a one-sided Calder\'on--Zygmund kernel $K$ on $X$ be given so that the operator $T_*$ defined in \eqref{def tang unm op}
satisfies
\eqref{nontanbound}. Let $T$ be the corresponding operator as defined in \eqref{def main op}.


For $s\in\mathbb{Z}$, we define
\begin{equation}\label{defks}
    K_s(x,y):=K(x,y)\psi(D^{-s}\rho(x,y))\,,
\end{equation}
so that for each $x, y \in X$ with $x\neq y$  we have
$$K(x,y)=\sum_{s\in\mathbb{Z}}K_s(x,y).$$
 In Section \ref{thmfromproplinear}, we prove Theorem \ref{metric space Carleson}
 from its finitary version, Proposition \ref{finitary Carleson} below. Recall
 that a function from a measure space to a finite set is measurable if the pre-image of each of the elements in the range is measurable.


\begin{prop}[finitary Carleson]
\label{finitary Carleson}
\uses{linearized truncation, grid existence, tile structure, tile sum operator}
Let ${\sigma_1},\sigma_2\colon X\to \mathbb{Z}$ be measurable functions with finite range and ${\sigma_1}\leq  \sigma_2$. Let $\tQ\colon X\to \Mf$ be a measurable function with finite range. Let $F,G$ be bounded Borel sets in $X$. Then there is a Borel set $G'$ in $X$ with $2\mu(G')\leq  \mu(G)$ such that
for all Borel functions $f:X\to \C$ with $|f|\le \mathbf{1}_F$.
\begin{equation*}
    \int_{G \setminus G'} \left|\sum_{s={\sigma_1}(x)}^{{\sigma_2}(x)} \int K_s(x,y) f(y) e(\tQ(x)(y))  \, \mathrm{d}\mu(y) \right| \mathrm{d}\mu(x)
\end{equation*}
\begin{equation}
    \label{eq-linearized}
    \le \frac{2^{260a^3}}{(q-1)^4} \mu(G)^{1-\frac{1}{q}}
     \mu(F)^{\frac 1 q}\,.
\end{equation}
\end{prop}
Let measurable functions ${\sigma_1}\leq \sigma_2\colon X\to \mathbb{Z}$ with finite range be given. Let a measurable function
$\tQ\colon X\to \Mf$ with finite range
be given.
Let bounded Borel sets $F,G$ in $X$ be given.
Let $S$ be the smallest integer such that the ranges of
$\sigma_1$ and $\sigma_2$ are contained in $[-S,S]$ and $F$ and $G$ are contained
in the ball $B(o, D^S)$.


In Section \ref{christsection},
we prove Proposition \ref{finitary Carleson}
 using  a
bound for a dyadic model formulated in Proposition
\ref{discrete Carleson} below.

A grid structure $(\mathcal{D}, c, s)$ on $X$ consists of a finite collection $\mathcal{D}$  of Borel sets in $X$ called dyadic cubes, a surjective function  $s\colon \mathcal{D}\to [-S, S]$
called scale function,
and a function $c:\mathcal{D}\to X$
called center function such that the five properties
\eqref{coverdyadic},
\eqref{dyadicproperty}, \eqref{coverball},
\eqref{eq vol sp cube}, and \eqref{eq small boundary}
hold.

For each dyadic cube $I$  and each $-S\le k<s(I)$ we have
\begin{equation}\label{coverdyadic}
I\subset \bigcup_{J\in \mathcal {D}: s(J)=k}J\, .
\end{equation}
Any two non-disjoint dyadic cubes  $I,J$ with $s(I)\le s(J)$ satisfy
\begin{equation}\label{dyadicproperty}
I\subset J.
\end{equation}
For any $x\in B(o,D^S)$, and every $k\in[-S,S]$, there
is a dyadic cube $I$ with $s(I)=k$ and
\begin{equation}\label{coverball}
x\in I.
\end{equation}
For any dyadic cube $I$,
 \begin{equation}
        \label{eq vol sp cube}
        c(I)\in B(c(I), \frac{1}{4} D^{s(I)}) \subset I \subset B(c(I), 4 D^{s(I)})\,.
    \end{equation}
For any dyadic cube  $I$ and any $t$ with $tD^{s(I)} \ge D^{-S}$,
\begin{equation}
        \label{eq small boundary}
        \mu(\{x \in I \ : \ \rho(x, X \setminus I) \leq t D^{s(I)}\}) \le 2^{100a^2} t^\kappa \mu(I)\,.
    \end{equation}







A tile structure  $(\fP,\sc,\fc,\fcc,\pc,\ps)$
for a given grid structure $(\mathcal{D}, c, s)$
is a finite set $\fP$  of elements called tiles with five maps
\begin{align*}
\sc&\colon \fP\to {\mathcal{D}}\\
\fc&\colon \fP\to \mathcal{P}(\Mf) \\
\fcc &\colon \fP\to \Mf\\
\pc &\colon \fP\to X\\
\ps &\colon \fP\to \mathbb{Z}
\end{align*}
with $\sc$ surjective and $\mathcal{P}(\Mf)$ denoting the power set of $\Mf$ such that the five properties \eqref{eq dis freq cover}, \eqref{eq freq dyadic},
\eqref{eq freq comp ball}, \eqref{tilecenter}, and
\eqref{tilescale} hold.
For each dyadic cube $I$, the restriction of the  map $\Omega$ to the set
\begin{equation}\label{injective}
    \fP(I)=\{\fp: \sc(\fp) =I\}
\end{equation}
is injective
and we have the disjoint covering property (we use the union symbol with dot on top to denote a disjoint union)
\begin{equation}\label{eq dis freq cover}
\tQ(X)\subset \dot{\bigcup}_{\fp\in \fP(I)}\fc(\fp).
\end{equation}
For any tiles $\fp,\fq$ with $\sc(\fp)\subset \sc(\fq)$ and $\fc(\fp) \cap \fc(\fq) \neq  \emptyset$ we have
\begin{equation} \label{eq freq dyadic}
\fc(\fq)\subset \fc(\fp) .
\end{equation}
For each tile $\fp$,
        \begin{equation}\label{eq freq comp ball}
        \fcc(\fp)\in B_{\fp}(\fcc(\fp), 0.2) \subset \fc(\fp) \subset B_{\fp}(\fcc(\fp),1)\,,
        \end{equation}
        where
\begin{equation}
    B_{\fp} (\mfa, R) := \{\mfb \in \Mf \, : \, d_{\fp}(\mfa, \mfb) < R\,\} ,
\end{equation}
 and
\begin{equation}\label{defdp}
d_{\fp} := d_{B(\pc(\fp),\frac 14 D^{\ps(\fp)})}\, .
\end{equation}
We have for each tile $\fp$
\begin{equation}\label{tilecenter}
    \pc(\fp)=c(\sc(\fp)),
\end{equation}
\begin{equation}\label{tilescale}
    \ps(\fp)=s(\sc(\fp)).
\end{equation}


\begin{prop}[discrete Carleson]
\label{discrete Carleson}
\uses{tile sum operator, exceptional set, forest union, forest complement}
Let $(\mathcal{D}, c, s)$ be a grid structure and \begin{equation*}
    (\fP,\sc,\fc,\fcc,\pc,\ps)
\end{equation*}
a tile structure  for this grid structure.
Define for $\fp\in \fP$
\begin{equation}\label{defineep}
    E(\fp)=\{x\in \sc(\fp): \tQ(x)\in \fc(\fp) , {\sigma_1}(x)\le \ps(\fp)\le {\sigma_2}(x)\}
\end{equation}
and
\begin{equation}\label{definetp}
    T_{\fp} f(x)= \mathbf{1}_{E(\fp)}(x) \int   K_{\ps(\fp)}(x,y) f(y) e(\tQ(x)(y)-\tQ(x)(x))\, d\mu(y).
\end{equation}
Then there exists a Borel set $G'$ with $2\mu(G') \leq \mu(G)$ such that for all $f:X\to \C$ with $|f|\le \mathbf{1}_F$
we have
\begin{equation}
    \label{disclesssim}
   \int_{G \setminus G'} \left| \sum_{\fp \in \fP} T_{\fp} f (x) \right| \, \mathrm{d}\mu(x)  \le \frac{2^{260a^3}}{(q-1)^4} \mu(G)^{1-\frac{1}{q}} \mu(F)^{\frac{1}{q}}\,.
\end{equation}
\end{prop}









The proof of Proposition \ref{discrete Carleson} is done in Section \ref{proptopropprop}
by a reduction to two further propositions that we state below.


Fix a grid structure  $(\mathcal{D}, c, s)$  and a tile structure $(\fP,\sc,\fc,\fcc,\pc,\ps)$
for this grid structure.

We define the relation
\begin{equation}\label{straightorder}
    \fp\le \fp'
\end{equation}
 on $\fP\times \fP$ meaning
$\sc(\fp)\subset \sc(\fp')$ and
$\Omega(\fp')\subset \Omega(\fp)$.
We further define for $\lambda,\lambda' >0$
the relation
\begin{equation}\label{wiggleorder}
    \lambda \fp \lesssim \lambda' \fp'
\end{equation}
on $\fP\times \fP$ meaning
$\sc(\fp)\subset \sc(\fp')$ and
\begin{equation}
    B_{\fp'}(\fcc(\fp'),\lambda' )
    \subset B_{\fp}(\fcc(\fp),\lambda )\, .
\end{equation}



Define for a tile $\fp$ and $\lambda>0$
\begin{equation}\label{definee1}
    E_1(\fp):=\{x\in \sc(\fp)\cap G: \tQ(x)\in \fc(\fp)\}\, ,
\end{equation}
\begin{equation}\label{definee2}
    E_2(\lambda, \fp):=\{x\in \sc(\fp)\cap G: \tQ(x)\in B_{\fp}(\fcc(\fp), \lambda)\}\, .
\end{equation}



Given a subset $\fP'$ of $\fP$, we define
$\fP(\fP')$ to be the set of
all $\fp \in \fP$ such that there exist $\fp' \in \fP'$ with $\sc(\fp)\subset \sc(\fp')$. Define  the densities
\begin{equation}\label{definedens1}
    {\dens}_1(\fP') := \sup_{\fp'\in \fP'}\sup_{\lambda \geq 2} \lambda^{-a} \sup_{\fp \in \fP(\fP'), \lambda \fp' \lesssim \lambda \fp}
    \frac{\mu({E}_2(\lambda, \fp))}{\mu(\sc(\fp))}\, ,
\end{equation}
\begin{equation}\label{definedens2}
    {\dens}_2(\fP') := \sup_{\fp'\in \fP'}
    \sup_{r\ge 4D^{\ps(\fp)}}
    \frac{\mu(F\cap B(\pc(\fp),r))}{\mu(B(\pc(\fp),r))}\, .
\end{equation}





An antichain is a subset $\mathfrak{A}$
of $\fP$ such that for any distinct $\fp,\fq\in \mathfrak{A}$ we do not have have $\fp\le \fq$.

The following proposition is proved in Section \ref{antichainboundary}.

\begin{prop}[antichain operator]
\label{antichain operator}

\uses{dens2 antichain,dens1 antichain}
For any antichain $\mathfrak{A} $ and  for all $f:X\to \C$ with $|f|\le \mathbf{1}_F$ and all $g:X\to\C$ with $|g| \le \mathbf{1}_G$
\begin{equation} \label{eq antiprop}
    |\int  \overline{g(x)} \sum_{\fp \in \mathfrak{A}} T_{\fp} f(x)\, d\mu(x)|
\end{equation}
\begin{equation}
    \le  \frac{2^{150a^3}}{q-1} \dens_1(\mathfrak{A})^{\frac {q-1}{8a^4}}\dens_2(\mathfrak{A})^{\frac 1{q}-\frac 12}  \|f\|_2 \|g\|_2\, .
\end{equation}
\end{prop}

Let $n\ge 0$.
An $n$-forest is a pair $(\fU, \mathfrak{T})$
where  $\fU$ is a subset of $\fP$
and $\mathfrak{T}$ is a map assigning to
each $\fu\in \fU$ a nonempty set $\fT (\fu)\subset \fP$ called tree
such that the following properties
\eqref{forest1}, \eqref{forest2},
\eqref{forest3},
\eqref{forest4},
\eqref{forest5}, and
\eqref{forest6}
hold.

For each $\fu\in \fU$ and each $\fp\in \fT(\fu)$
we have
\begin{equation}\label{forest1}
4\fp\lesssim 1\fu.
\end{equation}
For each $\fu \in \fU$ and each $\fp,\fp''\in \fT(\fu)$ and $\fp'\in \fP$
we have
\begin{equation}\label{forest2}
    \fp, \fp'' \in \mathfrak{T}(\fu), \fp \leq \fp' \leq \fp'' \implies \fp' \in \mathfrak{T}(\fu).
\end{equation}
We have
\begin{equation}\label{forest3}
   \|\sum_{\fu\in \fU} \mathbf{1}_{\sc(\fu)}\|_\infty \leq 2^n\,.
\end{equation}
We have for every $\fu\in \fU$
\begin{equation}\label{forest4}
\dens_1(\fT(\fu))\le 2^{4a + 1-n}\, .
\end{equation}
We have for $\fu, \fu'\in \fU$ and $\fp\in \fT(\fu')$ with $\sc(\fp)\subset \sc(\fu)$ that
\begin{equation}\label{forest5}
d_{\fp}(\fcc(\fp), \fcc(\fu))>2^{Z(n+1)}\, .
\end{equation}
We have for every $\fu\in \fU$ and $\fp\in \fT(\fu)$ that
\begin{equation}\label{forest6}
B(\pc(\fp), 8D^{\ps(\fp)})\subset \sc(\fu).
\end{equation}


The following proposition is proved in Section \ref{treesection}.
\begin{prop}[forest operator]
\label{forest operator}
For any $n\ge 0$ and any $n$-forest $(\fU,\fT)$ we have for all $f: X \to \mathbb{C}$ with $|f| \le \mathbf{1}_F$ and all bounded $g$ with bounded support
$$
    | \int \overline{g(x)} \sum_{\fu\in \fU} \sum_{\fp\in \fT(\fu)} T_{\fp} f(x) \, \mathrm{d}\mu(x)|
$$
$$
    \le %2^{257a^3}
    2^{605a^3}2^{-\frac{q-1}{q} n} \dens_2\left(\bigcup_{\fu\in \fU}\fT(\fu)\right)^{\frac{1}{q}-\frac{1}{2}} \|f\|_2 \|g\|_2 \,.
$$
\rs{Constant changed, check} \rs{Track dependence on Prop 2.3, Prop 2.2, Thm 1.2. Don't delete comment till I read Section 7 completely}
\end{prop}

Theorem \ref{metric space Carleson} is formulated at the level of generality
for general kernels satisfying the mere H\"older regularity condition \eqref{eqkernel y smooth}. On the other hand, the cancellative condition \eqref{eq vdc cond} is a testing condition against more regular,
namely Lipschitz functions. To bridge the gap, we follow \cite{zk-polynomial} to observe a variant of \eqref{eq vdc cond} that we formulate
in the following proposition proved in Section \ref{liphoel}.


Define
\begin{equation}
    \tau:=\frac 1a\, .
\end{equation}
Define for any open ball $B$ of radius $R$ in $X$ the $L^\infty$-normalized $\tau$-H\"older norm by
\begin{equation}
    \label{eq Hölder norm}
    \|\varphi\|_{C^\tau(B)} = \sup_{x \in B} |\varphi(x)| + R^\tau \sup_{x,y \in B, x \neq y} \frac{|\varphi(x) - \varphi(y)|}{\rho(x,y)^\tau}\,.
\end{equation}


\begin{prop}[Holder van der Corput]
    \label{Holder van der Corput}
    \uses{Lipschitz Holder approximation}
     Let $z\in X$ and $R>0$ and set $B=B(z,R)$.
     Let $\varphi: X \to \mathbb{C}$ by
     supported on $B$ and satisfy $\|{\varphi}\|_{C^\tau(B)}<\infty$.
     Let $\mfa, \mfb \in \Mf$. Then
    \begin{equation}
        \label{eq vdc cond tau 2}
        |\int e(\mfa(x)-{\mfb(x)})\varphi(x) dx|\le
         2^{8a} \mu(B) \|{\varphi}\|_{C^\tau(B)}
       (1 + d_{B}(\mfa,\mfb))^{-\frac{1}{2a^2+a^3}}
    \,.
    \end{equation}
    \end{prop}

We further formulate a classical Vitali covering result
and maximal function estimate that we need throughout several sections.
This following proposition will typically be applied to the absolute value of a complex valued function and be proved in Section \ref{sec hlm}. By a ball $B$ we mean a set $B(x,r)$ with $x\in X$
and $r>0$ as defined in \eqref{eq define ball}.
For a finite collection $\mathcal{B}$ of balls in $X$
and $1\le p< \infty$ define the measurable function $M_{\mathcal{B},p}u$ on $X$ by
\begin{equation}\label{def hlm}
M_{\mathcal{B},p}u(x):=\left(\sup_{B\in \mathcal{B}} \frac{\mathbf{1}_{B}(x)}{\mu(B)}\int _{B} |u(y)|^p\, d\mu(y)\right)^\frac 1p\,  .
\end{equation}
Define further $M_{\mathcal{B}}:=M_{\mathcal{B},1}$.

\begin{prop}[Hardy Littlewood]
\label{Hardy Littlewood}
\uses{layer cake representation,covering separable space}
   Let $\mathcal{B}$ be a finite collection of balls in $X$.
If for some $\lambda>0$ and some measurable function $u:X\to [0,\infty)$ we have
\begin{equation}\label{eq ball assumption}
\int_{B} u(x)\, d\mu(x)\ge \lambda \mu(B)
\end{equation}
   for each $B\in \mathcal{B}$,
   then
   \begin{equation}\label{eq besico}
\lambda \mu(\bigcup \mathcal{B}) \le 2^{2a}\int_X u(x)\, d\mu(x)\, .
\end{equation}
For every measurable function $v$
and $1\le p_1<p_2$ we have
\begin{equation}\label{eq hlm}
    \|M_{\mathcal{B},p_1} v\|_{p_2}\le 2^{2a}\frac{p_2}{p_2-p_1} \|v\|_{p_2}\, .
\end{equation}
Moreover, given any measurable bounded function $w: X \to \C$ there exists a measurable function $Mw: X \to [0, \infty)$ such that the following \eqref{eq ball av} and \eqref{eq hlm 2} hold. For each ball $B \subset X$ and each $x \in B$
\begin{equation}
    \label{eq ball av}
    \frac{1}{\mu(B)} \int_{B}  |w(y)| \, \mathrm{d}\mu(y) \le Mw(x)
\end{equation}
and for all $1 < p_1 \le p_2 \le \infty$
\begin{equation}
    \label{eq hlm 2}
    \|M(w^{p_1})^{\frac{1}{p_1}}\|_{p_2} \le 2^{4a} \frac{p_2}{p_2-p_1}\|w\|_{p_2}\,.
\end{equation}

\end{prop}

This completes the overview of the proof of Theorem \ref{metric space Carleson}.

\section{Auxiliary lemmas}
\label{global auxiliary lemmas}
We close this section by recording some auxiliary lemmas about the objects defined in Section \ref{overviewsection}, which will be used in multiple sections to follow.

First, we record an estimate for the metrical entropy numbers of balls in the space $\Mf$ equipped with any of the metrics $d_B$, following from the doubling property \eqref{thirddb}.

\begin{lemma}[ball metric entropy]
    \label{ball metric entropy}
    Let $B' \subset X$ be a ball. Let $r > 0$, $\mfa \in \Mf$ and $k \in \mathbb{N}$. Suppose that $\mathcal{Z} \subset B_{B'}(\mfa, r2^k)$  satisfies that for all $z, z' \in \mathcal{Z}$ with $z \ne z'$, we have $d_{B'}(z,z') \ge r$. Then
    $$
        |\mathcal{Z}| \le 2^{ka}\,.
    $$
\end{lemma}

\begin{proof}
    By applying property \eqref{thirddb}  $k$ times, we obtain a collection $\mathcal{Z}' \subset \Mf$ with $|\mathcal{Z}'| = 2^{ka}$ and
    $$
        B_{B'}(\mfa,r2^k) \subset \bigcup_{z' \in \mathcal{Z}'} B_{B'}(z', \frac{r}{2})\,.
    $$
    Then each $z \in \mathcal{Z}$ is contained in one of the balls $B(z', \frac{r}{2})$, but by the separation assumption no such ball contains more than one element of $\mathcal{Z}$. Thus $|\mathcal{Z}| \le |\mathcal{Z}'| = 2^{ka}$.
\end{proof}

The next lemma concerns monotonicity of the metrics $d_{B(c(I), \frac 14 D^{s(I)})}$ with respect to inclusion of cubes $I$ in a grid.

\begin{lemma}[monotone cube metrics]
    \label{monotone cube metrics}
    \uses{wiggle order 2, forest separation}
    Let $(\mathcal{D}, c, s)$ be a grid structure. Denote for cubes $I \in \mathcal{D}$
    $$
        I^\circ := B(c(I), \frac{1}{4} D^{s(I)})\,.
    $$
    Let $I, J \in \mathcal{D}$ with $I \subset J$.
    Then for all $\mfa, \mfb \in\Mf$ we have
    $$
        d_{I^\circ}(\mfa, \mfb) \le d_{J^\circ}(\mfa, \mfb)\,,
    $$
    and if $I \ne J$ then we have
    $$
        d_{I^\circ}(\mfa, \mfb) \le 2^{-95a} d_{J^\circ}(\mfa, \mfb)\,.
    $$
\end{lemma}

\begin{proof}
    If $s(I) \ge s(J)$ then \eqref{dyadicproperty} and the assumption $I\subset J$ imply $I = J$. Then the lemma holds by reflexivity.

    Note that by definition, the metrics $d_B$ have the following monotonicity property: If $B \subset B'$, then $d_B \le d_{B'}$.
    If $s(J) \ge s(I)+1$, then using the monotonicity property, \eqref{defineD} and \eqref{seconddb}, we get
    \begin{equation}
    \label{eq dIJ est}
        d_{I^\circ}(\mfa, \mfb) \le d_{B(c(I), 4 D^{s(I)})}(\mfa, \mfb) \le 2^{-100a} d_{B(c(I), 4D^{s(J)})}(\mfa, \mfb)\,.
    \end{equation}
    Using \eqref{eq vol sp cube}, together with the inclusion $I \subset J$, we obtain
    $$
        c(I) \in I \subset J \subset B(c(J), 4 D^{s(J)})
    $$
    and consequently by the triangle inequality
    $$
        B(c(I), 4 D^{s(J)}) \subset B(c(J), 8 D^{s(J)})\,.
    $$
    Using this together with the monotonicity property and \eqref{firstdb} in \eqref{eq dIJ est}, we obtain
    \begin{align*}
        d_{I^\circ}(\mfa, \mfb) &\le 2^{-100a} d_{B(c(J), 8D^{s(J)})}(\mfa, \mfb)\\
        &\le 2^{-100a + 5a} d_{B(c(J), \frac{1}{4}D^{s(J)})}(\mfa, \mfb)\\
        &= 2^{-95a}d_{J^\circ}(\mfa, \mfb)\,.
    \end{align*}
    This proves the second inequality claimed in the Lemma, from which the first follows since $a \ge 4$ and hence $2^{-95a} \le 1$.
\end{proof}

We also record the following basic estimates for the kernels $K_s$.

\begin{lemma}[kernel summand]
\label{kernel summand}
    Let $-S\le s\le S$ and $x,y,y'\in X$.
    If $K_s(x,y)\neq 0$, then we have
    \begin{equation}\label{supp Ks}
      \frac{1}{4} D^{s-1} \leq \rho(x,y) \leq \frac{1}{2} D^s\, .
    \end{equation}
    We have
    \begin{equation}
       \label{eq Ks size}
        |K_s(x,y)|\le \frac{2^{102 a^3}}{\mu(B(x, D^{s}))}\,
    \end{equation}
    and %if $2\rho(y,y')\leq \rho(x,y)$
    \begin{equation}
        \label{eq Ks smooth}
        |K_s(x,y)-K_s(x, y')|\le \frac{2^{150a^3}}{\mu(B(x, D^{s}))}
        \left(\frac{ \rho(y,y')}{D^s}\right)^{\frac 1a}\,.
    \end{equation}
\end{lemma}

\begin{proof}
    By Definition \eqref{defks}, the function $K_s$ is the product of
    $K$ with a function which is supported in the set of all
    $x,y$ satisfying \eqref{supp Ks}. This proves
    \eqref{supp Ks}.

    Using \eqref{eqkernel size} and the lower bound in \eqref{supp Ks}
    we obtain
    \begin{equation}
        |K_s(x,y)|\le \frac{2^{a^3}}{\mu(B(x,\frac 14 D^{s-1}))}
    \end{equation}
    Using $D=2^{100a^2}$
    and the doubling property \eqref{doublingx} $2 +100a^2$ times estimates
    the last display by
    \begin{equation}
        \label{eq Ks aux}
        \le \frac{2^{2a+101a^3}}{\mu(B(x,  D^{s}))}\, .
    \end{equation}
    Using $a\ge 4$ proves \eqref{eq Ks size}.

    \lars{The case where $\rho(y,y') > \rho(x,y)/2$ is missing}
    Similarly, we obtain with  \eqref{eqkernel y smooth} and the lower bound in
    \eqref{supp Ks}
    \begin{equation}
        |K_s(x,y)-K_s(x, y')|\le \frac{2^{a^3}}{\mu(B(x, \frac 14 D^{s-1}))}
        \left(\frac{ \rho(y,y')}{\frac 14 D^{s-1}}\right)^{\frac 1a}\,.
    \end{equation}
    As above, this is estimated by
    \begin{equation}
       \le \frac{4D 2^{2a+101a^3}}{\mu(B(x,  D^{s}))}
        \left(\frac{ \rho(y,y')}{D^{s}}\right)^{\frac 1a}
         = \frac{2^{2+2a+100a^2+101a^3}}{\mu(B(x,  D^{s}))}
        \left(\frac{ \rho(y,y')}{D^{s}}\right)^{\frac 1a}\,.
    \end{equation}
    Using $a\ge 4$, this proves  \eqref{eq Ks smooth}.
\end{proof}


\chapter{Proof of metric space Carleson (Thm \ref{metric space Carleson})}
\label{thmfromproplinear}


Let Borel sets $F$, $G$ in $X$ be given.
We have that
\begin{equation}
    X=\bigcup_{R>0}B(o,R),
\end{equation} because every point of $X$
has finite distance from $o$.
\begin{lemma}[R truncation]
\label{R truncation}
 \uses{S truncation}
For all integers $R>0$
$$
    \int \mathbf{1}_{G\cap B(o,R)}
    \sup_{1/R<R_1<R_2<R}\sup_{\mfa\in\Mf}
    \left| T_{R_1,R_2,\mfa} \mathbf{1}_{F}(x) \right|\, d\mu(x)
$$
\begin{equation} \label{Rcut}
    \leq \frac{2^{270a^3}}{(q-1)^5} \mu(G)^{1-\frac{1}{q}} \mu(F)^{\frac{1}{q}},
\end{equation}
where
\begin{equation}\label{TRR}
    T_{R_1,R_2,\mfa} f(x)=
    \int_{R_1 <  \rho(x,y) < R_2}  K(x,y) f(y) e(\mfa(y)) \, \mathrm{d}\mu(y) .
\end{equation}
\end{lemma}

We first show how Lemma \ref{R truncation} implies Theorem \ref{metric space Carleson}. As $R$ tends to $\infty$, the integrand of the left-hand side of \eqref{Rcut} grows monotonically toward the integrand of the left-hand side of \eqref{resweak} for all $x$. By Lebesgue's monotone convergence theorem, the left-hand side of \eqref{Rcut} converges to the left-hand side of \eqref{resweak}. This verifies Theorem \ref{metric space Carleson}.

It remains to prove Lemma \ref{R truncation}. Fix an integer $R>0$. By replacing $G$ with $G\cap B(o,R)$ if necessary, it suffices to show \eqref{Rcut} under the assumption that $G$ is contained in $B(o,R)$. We make this assumption. For every $x\in G$, the domain of integration in \eqref{TRR} is contained in $B(o,2R)$. By replacing $F$ with $F\cap B(o,2R)$ if necessary, it suffices to show \eqref{Rcut} under the assumption that $F$ is contained in $B(o,2R)$. We make this assumption.

Using the definition \eqref{defks} of $K_s$ and the partition of unity \eqref{eq psisum}, we express \eqref{TRR} as the sum of
\begin{equation}\label{middles}
{T}_{1,s_1,s_2,\mfa}f(x):=\sum_{s_1 \le s\le s_2}
\int K_s(x,y)  f(y) e(\mfa(y)) \, \mathrm{d}\mu(y)
\end{equation}
and
\begin{equation}\label{boundarys}
\sum_{s=s_1-2,s_1-1, s_2+1, s_2+2}
\int_{R_1 <  \rho(x,y) < R_2}  K_s(x,y) f(y) e(\mfa(y)) \,
 \mathrm{d}\mu(y),
\end{equation}
where $s_1$ is the smallest integer such that $D^{s_1-2}R_2>\frac 1{4D}$ and $s_2$ is the largest integer such that $D^{s_2+2}R_1<\frac 12$. We restrict the summation index $s$ by excluding summands with $s<s_1-2$ or $s>s_2+2$ because for these summands, the function $K_s$ vanishes on the domain of integration. We also omit the restriction in the integral for the summands in \eqref{middles} because in these summands, the support of $K_s$ is contained in the set described by this restriction.



We apply the triangle inequality and estimate the versions of \eqref{Rcut} separately with $T_{R_1,R_2,\mfa}$ replaced by \eqref{middles} and by each summand of \eqref{boundarys}. To handle the case \eqref{middles}, we employ the following lemma. Here, we utilize the fact that if $\frac 1R\le R_1\le R_2\le R$, then $s_1$ and $s_2$ as in \eqref{middles} are in an interval $[-S,S]$ for some sufficiently large $S$ depending on $R$.


\begin{lemma}[S truncation]
\label{S truncation}
\uses{finitary S truncation}
For all integers $S>0$
$$
    \int \mathbf{1}_{G}(x)
    \max_{-S<s_1\le s_2<S}\sup_{\mfa\in\Mf}
    \left| T_{1, s_1,s_2,\mfa} \mathbf{1}_{F}(x) \right|\, d\mu(x)
$$
\begin{equation} \label{Scut}
    \leq \frac{2^{265a^3+1}}{(q-1)^5} \mu(G)^{1 - \frac{1}{q}} \mu(F)^{\frac{1}{q}},
\end{equation}
where $T_{1, s_1,s_2,\mfa}$ is defined in \eqref{middles}.
\end{lemma}

To reduce Lemma \ref{R truncation} to Lemma \ref{S truncation}, we need estimates for the summands in \eqref{boundarys}. Using Lemma \ref{kernel summand}, we obtain for arbitrary $s$ the inequality
\begin{multline}
\left|\int_{R_1 <  \rho(x,y) < R_2}  K_s(x,y) f(y) e(\mfa(y)) \,  \mathrm{d}\mu(y)\right|\\
\leq \frac{2^{102 a^3}}{\mu(B(x, D^{s}))}
 \int_{B(x, D^s)} \mathbf{1}_F(y)  \, \mathrm{d}\mu(y)
\leq 2^{102 a^3} M\mathbf{1}_F(x),
\end{multline}
where $M\mathbf{1}_F$ is as defined in Proposition \ref{Hardy Littlewood}.
Now, the left-hand side of \eqref{Rcut}, with $T_{R_1,R_2,\mfa}$ replaced by a summand of \eqref{boundarys}, can be estimated using Hölder's inequality and Proposition \ref{Hardy Littlewood} by
$$
    2^{102 a^3}\int \mathbf{1}_{G}(x) M\mathbf{1}_F(x)\, d\mu(x)
    \leq \frac{2^{102 a^3+4a}q}{q-1}\mu(G)^{1-\frac{1}{q}} \mu(F)^{\frac{1}{q}}\,.
$$
Applying the triangle inequality to estimate the left-hand side of \eqref{Rcut} by contributions from the summands in \eqref{middles} and \eqref{boundarys}, using Lemma \ref{S truncation} to control the first term, and the above to estimate the contribution from the four summands in \eqref{boundarys}, combined with $a\geq 4$ and $q < 2$, completes the reduction of Lemma \ref{R truncation} to Lemma \ref{S truncation}.

It remains to prove Lemma \ref{S truncation}. Fix $S>0$.
\begin{lemma}[finitary S truncation]
\label{finitary S truncation}
\uses{linearized truncation}
For all finite sets $\tilde{\Mf}\subset \Mf$
$$
    \int \mathbf{1}_{G}(x)
    \max_{-S<s_1\le s_2<S}\sup_{\mfa\in\tilde{\Mf}}
    \left| T_{1, s_1,s_2,\mfa} \mathbf{1}_{F}(x) \right|\, d\mu(x)
$$
\begin{equation} \label{Sqcut}
\leq \frac{2^{265a^3}}{(q-1)^5} \mu(G)^{1-\frac{1}{q}} \mu(F)^{\frac{1}{q}}\,.
\end{equation}
\end{lemma}

We reduce Lemma \ref{S truncation} to Lemma \ref{finitary S truncation}.
By the Lebesgue monotone convergence theorem,
applied to an increasing sequence of finite sets $\tilde{\Mf}$, inequality \eqref{Sqcut}
continues to hold for countable $\tilde{\Mf}$.

Let $\epsilon=\frac{1}{2S+1}$. Pick some $\mfa_0 \in \Mf$.
For $k \ge 0$, let the set $\tilde{\Mf}_k$ be a subset of $B_{B(o,2R)}(\mfa_0, k)$ of maximal size, such that for all $\mfa, \mfb \in \tilde{\Mf}_k$, it holds that $d_{B(o, 2R)}(\mfa, \mfb) \ge \epsilon$. Such a set exists, since by Lemma \ref{ball metric entropy} there exists an upper bound for the size of such subsets in $B_{B(o, 2R)}(\mfa_0, k)$. Define
$$
    \tilde{\Mf} := \bigcup_{k \in \mathbb{N}} \tilde{\Mf}_k\,.
$$
Then the set $\tilde{\Mf}$ is at most countable, and it has the property that for any $\mfb \in \Mf$, there exists $\mfa \in \tilde{\Mf}$ with
$$
    d_{B(o, 2R)}(\mfb, \mfa) < \epsilon\,.
$$

For every $\mfa\in \Mf$, we have
\begin{equation}
\left| T_{1, s_1,s_2,\mfa} \mathbf{1}_{F}(x)\right|=
\left|\sum_{s_1 \le s\le s_2}
\int K_s(x,y)  f(y) e(\mfa(y)-{\mfa(x)}) \, \mathrm{d}\mu(y)\right|
\end{equation}
Moreover, there is a $\tilde{\mfa}
\in \tilde{\Mf}$ with $d_{B(o,2R)}(\mfa,\tilde{\mfa})\le \epsilon$. Hence,
\begin{align*}
    &\left| T_{1, s_1,s_2,\mfa} \mathbf{1}_{F}(x)\right|-\left|T_{1, s_1,s_2,\tilde{\mfa}} \mathbf{1}_{F}(x) \right|\\
  &\leq\sum_{s_1 \le s\le s_2} \int |K_s(x,y)|  \mathbf{1}_F(y) |e(\mfa(y)-{\mfa(x)})-e({\tilde{\mfa}(y)}-{\tilde{\mfa}(x)})| \, \mathrm{d}\mu(y)\\
    &\leq \sum_{s_1 \le s\le s_2} \epsilon \int |K_s(x,y)|  \mathbf{1}_F(y) \, \mathrm{d}\mu(y)
\end{align*}
Using Lemma \ref{kernel summand}, we can estimate the above expression by
\begin{align*}
    &\sum_{s_1 \le s\le s_2} \frac{2^{102 a^3}}{\mu(B(x, D^{s}))}
\epsilon \int_{B(x, D^s)} \mathbf{1}_F(y)  \, \mathrm{d}\mu(y)\\
    &\leq (2S+1)\epsilon 2^{102 a^3} M\mathbf{1}_F(x)\le 2^{102 a^3}M\mathbf{1}_F(x)
\end{align*}
We estimate the left-hand-side of \eqref{Scut} by
the sum of left-hand-side of \eqref{Sqcut} and
\begin{align*}
    &\int \mathbf{1}_{G}(x)
\max_{-S<s_1\le s_2<S}\sup_{\mfa\in {\Mf}}
\inf_{\tilde{\mfa}\in\tilde{\Mf}}
(| T_{1, s_1,s_2,\mfa}|-|T_{1, s_1,s_2,\tilde{\mfa}}  |)\mathbf{1}_{F}(x)\, d\mu(x)\,,\\
\end{align*}
which, as we have just shown, is estimated by
\begin{align*}
     &2^{102 a^3}\int \mathbf{1}_{G}(x)
M\mathbf{1}_{F}(x)\, d\mu(x).
\end{align*}
By Hölder's inequality and Proposition \ref{Hardy Littlewood}
 (more precisely, \eqref{eq hlm 2} with $p=q$), the above is no greater than
\begin{align*}
&\frac{2^{102 a^3+4a}q}{q-1} \mu(G)^{1-\frac{1}{q}} \mu(F)^{\frac{1}{q}}.
\end{align*}
Combining this with Lemma \ref{finitary S truncation} and the fact that
\begin{align*}
    \frac{2^{102 a^3+4a}q}{q-1}\leq \frac{2^{265a^3}}{(q-1)^5}
\end{align*}
proves Lemma \ref{S truncation}.

It remains to prove Lemma \ref{finitary S truncation}.
Fix a finite set
$\tilde{\Mf}$.
\begin{lemma}[linearized truncation]
\label{linearized truncation}
Let $\sigma_1,\sigma_2\colon X\to \mathbb{Z}$ be measurable functions with finite range
$[-S,S]$ and $\sigma_1\leq \sigma_2$.
Let $\tQ\colon X\to {\tilde{\Mf}}$ be a measurable function. Then we have
\begin{equation}  \label{Sqlin}
    \int \mathbf{1}_{G}(x)
    \left| {T}_{2,\sigma_1,\sigma_2,\tQ}\mathbf{1}_F(x)\right|\, d\mu(x)
    \le \frac{2^{265a^3}}{(q-1)^5} \mu(G)^{1-\frac{1}{q}} \mu(F)^{\frac{1}{q}},
\end{equation}
with
\begin{equation}\label{middles1}
    {T}_{2,\sigma_1,\sigma_2,\tQ}f(x)=\sum_{\sigma_1(x) \le s\le \sigma_2(x)}
    \int K_s(x,y)  f(y) e(\tQ(x)(y) - \tQ(x)(x)) \, \mathrm{d}\mu(y)\,.
\end{equation}
\end{lemma}

We reduce Lemma \ref{finitary S truncation} to
Lemma \ref{linearized truncation}.
For each $x$, let $\sigma_1(x)$ be the
minimal element $s'\in [-S,S]$ such that
\[\max_{s'\leq s_2<S}\max_{\mfa\in\tilde{\Mf}}
| T_{1, s',s_2,\mfa} \mathbf{1}_{F}(x)|
=
\max_{-S<s_1\le s_2<S}\max_{\mfa\in\tilde{\Mf}}
| {T}_{1, s_1,s_2,\mfa} \mathbf{1}_{F}(x)|:={T}_{1, x}.
\]
Similarly, let ${\sigma}_2(x)$ be the
minimal element $s''\in [-S,S]$ such that
% \[\max_{\mfa\in\tilde{\Mf}}
% | {T}_{\underline{\sigma}(x),\overline{\sigma}(x),\mfa} \mathbf{1}_{F}(x)|
% =
% \Tilde{T}_x|
% \]
\[\max_{\mfa\in\tilde{\Mf}}
| {T}_{1, {\sigma}_1(x), s'',\mfa} \mathbf{1}_{F}(x)|
=
{T}_{1,x}\,.
\]
Finally, choose a total order of the finite set $\tilde{\Mf}$
and let $\tQ(x)$ be the minimal element $\mfa$ with respect to this order such that
\[
| {T}_{1, {\sigma}_1(x),{\sigma}_2(x),\mfa} \mathbf{1}_{F}(x)| =  {T}_{1,x}\,.
\]
With these choices, and noting that
\begin{equation*}
{T}_{1, {\sigma}_1(x),{\sigma}_2(x),\tQ(x)} \mathbf{1}_{F}(x)={T}_{2, {\sigma}_1,{\sigma}_2,\tQ} \mathbf{1}_{F}(x),
\end{equation*}
we conclude that the left-hand side of \eqref{Sqcut}
and \eqref{Sqlin} are equal. Thus, Lemma \ref{finitary S truncation}
follows from Lemma \ref{linearized truncation}.

It remains to prove Lemma \ref{linearized truncation}.
Fix $\sigma_1$, $\sigma_2$,
and $\tQ$ as in the lemma.
Applying Proposition \ref{finitary Carleson} recursively, we obtain
a sequence of sets $G_n$ with $G_0=G$ and,
for each $n\ge 0$, $\mu(G_{n})\le 2^{-n} \mu(G)$ and
\begin{equation*}
    \int \mathbf{1}_{G_{n}\setminus G_{n+1}}(x)
    \left| {T}_{2,\sigma_1,\sigma_2, \tQ} \mathbf{1}_{F}(x) \right|\, d\mu(x)
\end{equation*}
\begin{equation}
    \le \frac{2^{260a^3}}{(q-1)^4} \mu(G_n)^{1 - \frac{1}{q}} \mu(F)^{\frac{1}{q}},
\end{equation}
Adding the first $n$ of these inequalities, we obtain by bounding a geometric series
    \begin{equation} \label{Sqcut2}
    \int \mathbf{1}_{G\setminus G_{n}}(x)
\left| {T}_{2,\sigma_1,\sigma_2, \tQ}\mathbf{1}_F(x) \right|\, d\mu(x)
\le \frac{2^{265a^3}}{(q-1)^5} \mu(G)^{1-\frac{1}{q}} \mu(F)^{\frac{1}{q}}.
\end{equation}
As the integrand is bounded by
\begin{equation}\mathbf{1}_{G\setminus G_{n}}(x)
\sum_{-S<s_1\le s_2<S}\sum_{\mfa\in\tilde{\Mf}}
\left| {T}_{1,s_1, s_2, \mfa} \mathbf{1}_{F}(x) \right|,
\end{equation}
which by interchange of summation and integration is seen to be integrable, we obtain by Lebesgue's dominated convergence theorem
 \begin{equation} \label{Sqcut3}
    \int \mathbf{1}_{G}(x)
\left| {T}_{2,\sigma_1,\sigma_2, \tQ}\mathbf{1}_F(x) \right|\, d\mu(x)
\le \frac{2^{265a^3}}{(q-1)^5} \mu(G)^{1-\frac{1}{q}} \mu(F)^{\frac{1}{q}}.
\end{equation}



This completes the proof of Lemma \ref{linearized truncation}
and thus Theorem \ref{metric space Carleson}.

\chapter{Proof of finitary Carleson (Prop \ref{finitary Carleson})}
\label{christsection}

To prove Proposition
\ref{finitary Carleson}, we already fixed in Section \ref{overviewsection}
measurable functions ${\sigma_1},\sigma_2,  \tQ$ and Borel sets $F,G$. We have also
defined $S$ to be the smallest
integer such that the ranges of
$\sigma_1$ and $\sigma_2$ are contained in $[-S,S]$ and $F$ and $G$ are contained
in the ball $B(o, D^S)$.


The proof of the next lemma is done in Subsection \ref{subsecdyadic},
following the construction of dyadic cubes in \cite[\S 3]{christ1990b}.

\begin{lemma}[grid existence]
\label{grid existence}
\uses{counting balls,cover big ball,cover by cubes}     There exists a grid structure $(\mathcal{D}, c,s)$.
\end{lemma}




The next lemma, which we prove in Subsection \ref{subsectiles}, should be compared
with the construction in \cite[Lemma 2.12]{zk-polynomial}.

\begin{lemma}[tile structure]
\label{tile structure}
 \uses{frequency ball cover, disjoint frequency cubes,frequency cube cover}
    For a given grid structure $(\mathcal{D}, c,s)$, there exists a tile structure
    $(\fP,\sc,\fc,\fcc,\pc,\ps)$.
\end{lemma}

Choose a grid structure $(\mathcal{D}, c,s)$ with Lemma \ref{grid existence} and a tile structure for this
grid structure $(\fP,\sc,\fc,\fcc,\pc,\ps)$ with Lemma \ref{tile structure}.
Applying Proposition \ref{discrete Carleson}, we obtain a Borel set $G'$ in $X$ with $2\mu(G')\leq \mu(G)$ such that for all Borel functions $f:X\to \C$ with $|f|\le \mathbf{1}_F$
we have \eqref{disclesssim}.

\begin{lemma}[tile sum operator]
\label{tile sum operator}
We have for all $x\in G\setminus G'$
\begin{equation}\label{eq sump}
    \sum_{\fp\in \fP}T_{\fp} f(x)= \sum_{s=\sigma_1(x)}^{\sigma_2(x)}
    \int   K_{s}(x,y) f(y) e(\tQ(x)(y)-\tQ(x)(x))\, d\mu(y).
\end{equation}
\end{lemma}
\begin{proof}
Fix $x\in G\setminus G'$.
Sorting the tiles $\fp$ on the left-hand-side of \eqref{eq sump} by the value $\ps(\fp)\in [-S,S]$,
it suffices to prove  for every $-S\le s\le S$ that
\begin{equation}\label{outsump}
    \sum_{\fp\in \fP: \ps(\fp)=s}T_{\fp} f(x)=0
\end{equation}
 if $s\not\in [\sigma_1(x), \sigma_2(x)]$ and
\begin{equation}\label{insump}
    \sum_{\fp\in \fP: \ps(\fp)=s}T_{\fp} f(x)=
    \int   K_{s}(x,y) f(y) e(\tQ(x)(y) - \tQ(x)(x))\, d\mu(y).
\end{equation}
if $s\in [\sigma_1(x),\sigma_2(x)]$.
If $s\not\in [\sigma_1(x), \sigma_2(x)]$, then by definition of $E(\fp)$ we have
$x\not\in E(\fp)$ for any $\fp$ with $\ps(\fp)=s$ and thus $T_{\fp} f(x)=0$. This proves
\eqref{outsump}.

Now assume $s\in [\sigma_1(x),\sigma_2(x)]$.
By \eqref{coverball} and $G\subset B(o,D^S)$, there is at least
one $I\in \mathcal{D}$ with $s(I)=s$ and $x\in I$.
By \eqref{dyadicproperty}, this $I$ is unique. By \eqref{eq dis freq cover}, there is precisely one $\fp\in \fP(I)$ such that
$\tQ(x)\in \fc(\fp)$. Hence there is precisely one  $\fp\in \fP$ with  $\ps(\fp)=s$ such that
$x\in E(\fp)$. For this $\fp$, the value $T_{\fp}(x)$ by its definition in \eqref{definetp}
equals the right-hand side of \eqref{insump}. This proves the lemma.
\end{proof}

We now estimate with Lemma \ref{tile sum operator} and Proposition \ref{discrete Carleson}
\begin{equation}
 \int_{G \setminus G'} \left|\sum_{s={\sigma_1}(x)}^{{\sigma_2}(x)} \int K_s(x,y) f(y) e(\tQ(x)(y))  \, \mathrm{d}\mu(y)\right| \mathrm{d}\mu(x)
\end{equation}
\begin{equation}
 =\int_{G \setminus G'} \left|\sum_{s={\sigma_1}(x)}^{{\sigma_2}(x)} \int K_s(x,y) f(y) e(\tQ(x)(y) - \tQ(x)(x))\mathrm{d}\mu(y)\right| \mathrm{d}\mu(x)
\end{equation}
\begin{equation}
 =\int_{G \setminus G'} \left|\sum_{\fp\in \fP}T_{\fp} f(x)\right| \mathrm{d}\mu(x)
 \le \frac{2^{260a^3}}{(q-1)^4} \mu(G)^{1 -  \frac{1}{q}} \mu(F)^{\frac{1}{q}} \,.
\end{equation}
This proves \eqref{eq-linearized} for the chosen set $G'$ and arbitrary $f$ and thus completes the proof of Proposition
\ref{finitary Carleson}.



\section{Proof of Lemma \ref{grid existence}, dyadic structure}
\label{subsecdyadic}

We begin with the construction of the centers of the dyadic cubes.
\begin{lemma}[counting balls]
\label{counting balls}
Let $-S\le k\le S$. Consider $Y\subset X$ such that for any $y\in Y$, we have
\begin{equation}\label{ybinb}
  y\in B(o,4D^S-D^k),
\end{equation}
furthermore, for any $y'\in Y$ with $y\neq y'$, we have
\begin{equation} \label{eq disj yballs}
    B(y,D^k)\cap B(y',D^k)=\emptyset.
\end{equation}
Then the cardinality of $Y$ is bounded by
\begin{equation}\label{boundY}
    |Y|\le 2^{3a + 200Sa^3}\, .
\end{equation}
\end{lemma}


\begin{proof}
Let $k$ and $Y$ be given. By applying the doubling property \eqref{doublingx} inductively, we have for each integer $j\ge 0$
\begin{equation}\label{jballs}
    \mu(B(y,2^{j}D^k))\le 2^{aj} \mu(B(y,D^k))\, .
\end{equation}
Since $X$ is the union of the balls $B(y,2^{j}D^k)$ and $\mu$ is not zero, at least one of the balls $B(y,2^{j}D^k)$ has positive measure, thus $B(y,D^k)$ has positive measure.

Applying \eqref{jballs} for $j' = \ln_2(8D^{2S}) = 3 + 2S \cdot 100a^2$ by \eqref{defineD}, using $-S\le k\le S$, $y\in B(o,4D^S)$, and the triangle inequality, we have
\begin{equation}
    B(o, 4D^S) \subset B(y, 8D^S) \subset B(y,2^{j'}D^k) \, .
\end{equation}
Using the disjointedness of the balls in \eqref{eq disj yballs}, \eqref{ybinb}, and the triangle inequality for $\rho$, we obtain
\begin{equation}
|Y|\mu(B(o,4D^S))\le 2^{j'a}\sum_{y\in Y}\mu(B(y,D^k))
\end{equation}
\begin{equation}
\le
2^{j'a}\mu(\bigcup_{y\in Y}B(y,D^k))
\le 2^{j'a}\mu(o,4D^S)\, .
\end{equation}
As $\mu(o,4D^S)$ is not zero, the lemma follows.
\end{proof}

For each $-S\le k\le S$, let $Y_k$ be a set of
maximal cardinality in $X$ such that $Y=Y_k$ satisfies
the properties \eqref{ybinb} and \eqref{eq disj yballs}.
By the upper bound of Lemma \ref{counting balls}, such a set exists.

For each $-S\le k\le S$, choose an enumeration of the points in the finite set $Y_k$ and thus a total
order  $<$ on $Y_{k}$.

\begin{lemma}[cover big ball]
\label{cover big ball}
\uses{basic grid structure}
  For each $-S\le k\le S$, the ball
  $B(o, 4D^S-D^k)$ is contained
  in the union of the balls $B(y,2D^k)$ with $y\in Y_k$.
\end{lemma}

\begin{proof}
Let $x$ be any point of $B(o, 4D^S-D^k)$.   By maximality of $|Y_k|$, the ball
$B(x,  D^k)$ intersects one of the balls
$B(y,  D^k)$ with $y\in Y_k$. By the triangle
inequality, $x\in B(y,2D^k)$.
\end{proof}

Define the set
\begin{equation}
    \mathcal{C}:= \{(y,k): -S\le k\le S, y\in Y_k\}\,
\end{equation}
We totally order the set $\mathcal{C}$ lexicographically by setting
$(y,k)<(y',k')$ if $k< k'$ or both $k=k'$ and $y<y'$.
In what follows, we define recursively in the sense of this order a function
\begin{equation}
    (I_1,I_2,I_3): \mathcal{C}\to \mathcal{P}(X)\times \mathcal{P}(X)\times \mathcal{P}(X)\, .
\end{equation}


Assume the sets ${I}_j(y',k')$ have already been defined  for $j=1,2,3$ if $k'<k$ and if  $k=k'$ and $y'<y$.




If $k=-S$, define for  $j\in \{1,2\}$ the set
${I}_j(y,k)$ to be $B(y,jD^{-S})$.
If $-S<k$, define for $j\in \{1,2\}$
and $y\in Y_k$ the set ${I}_j(y,k)$ to be
\begin{equation}\label{defineij}
\bigcup\{I_3(y',k-1):
y'\in Y_{k-1}\cap  B(y,jD^k)\}.
\end{equation}
Define for {$-S\leq k\leq S$} and $y\in Y_k$
\begin{equation}\label{definei3}
I_3(y,k):={I_1}(y,k)\cup \left[{I_2}(y,k)\setminus \left[X_k\cup \bigcup\{I_3(y',k):y'\in Y_{k}, y'<y\})\right]\right]
\end{equation}
with
\begin{equation}
      X_{k}:=\bigcup\{I_1(y', k):y'\in Y_{k}\}.
\end{equation}


\begin{lemma}[basic grid structure]
\label{basic grid structure}
\uses{dyadic property}
   For each $-S\le k\le S$ and $1\le j\le 3$
   the following holds.

   If $j\neq 2$ and for some $x\in X$ and $y_1,y_2\in Y_k$ we have
   \begin{equation}\label{disji}
       x\in I_j(y_1,k)\cap I_j(y_2,k),
   \end{equation}
then $y_1=y_2$.

   If $j\neq 1$, then
\begin{equation}\label{unioni}
B(o, 4D^S-2D^k)\subset \bigcup_{y\in Y_k} I_j(y,k)\, .
\end{equation}
We have for each $y\in Y_k$,
   \begin{equation}\label{squeezedyadic}
    B(y,\frac 12 D^k) \subset I_3(y,k)\subset
     B(y,4D^k).
\end{equation}



\end{lemma}
%\rs{Write}
\begin{proof}
We prove these statements simultaneously by induction on the ordered set of pairs $(y,k)$. Let $-S\le k\le S$.

We first consider \eqref{disji} for $j=1$. If $k=-S$, disjointedness of the sets $I_1(y,-S)$ follows by definition of $I_1$ and $Y_k$. If $k>-S$, assume $x$ is in $I_1(y_m,k)$ for $m=1,2$. Then, for $m=1,2$, there is $z_m\in Y_{k-1}\cap B(y_m,D^k)$ with $x\in I_3(z_m,k-1)$. Using \eqref{disji} inductively for $j=3$, we conclude $z_1=z_2$. This implies that the balls $B(y_1, D^k)$ and $B(y_2, D^k)$ intersect. By construction of $Y_k$, this implies $y_1=y_2$. This proves \eqref{disji} for $j=1$.

We next consider \eqref{disji} for $j=3$. Assume $x$ is in $I_3(y_m,k)$ for $m=1,2$ and $y_m\in Y_k$. If $x$ is in $X_k$, then by definition \eqref{definei3}, $x\in I_1(y_m,k)$ for $m=1,2$. As we have already shown \eqref{disji} for $j=1$, we conclude $y_1=y_2$. This completes the proof in case $x\in X_k$, and we may assume $x$ is not in $X_k$. By definition \eqref{definei3}, $x$ is not in $I_3(z,k)$ for any $z$ with $z<y_1$ or $z<y_2$. Hence, neither $y_1<y_2$ nor $y_2<y_1$, and by totality of the order of $Y_k$, we have $y_1=y_2$. This completes the proof of \eqref{disji} for $j=3$.

We show \eqref{unioni} for $j=2$. In case $k=-S$, this follows from Lemma \ref{cover big ball}. Assume $k>-S$. Let $x$ be a point of $B(o, 4D^S-2D^k)$. By induction, there is $y'\in Y_{k-1}$ such that $x\in I_3(y',k-1)$. Using the inductive statement \eqref{squeezedyadic}, we obtain $x\in B(y',4D^{k-1})$. As $D>4$, by applying the triangle inequality with the points, $o$, $x$, and $y'$, we obtain that $y'\in B(o, 4D^S-D^k)$. By Lemma \ref{cover big ball}, $y'$ is in $B(y,2D^k)$ for some $y\in Y_k$. It follows that $x\in I_2(y,k)$. This proves \eqref{unioni} for $j=2$.

We show \eqref{unioni} for $j=3$. Let $x\in B(o, 4D^S-2D^k)$. In case $x\in X_k$, then by definition of $X_k$ we have $x\in I_1(y,k)$ for some $y\in Y_k$ and thus $x\in I_3(y,k)$. We may thus assume $x\not\in X_k$. As we have already seen \eqref{unioni} for $j=2$, there is $y\in Y_k$ such that $x\in I_2(y,k)$. We may assume this $y$ is minimal with respect to the order in $Y_k$. Then $x\in I_3(y,k)$. This proves \eqref{unioni} for $j=3$.

Next, we show the first inclusion in \eqref{squeezedyadic}. Let $x\in B(y,\frac 12 D^k)$. As $I_1(y,k)\subset I_3(y,k)$, it suffices to show $x\in I_1(y,k)$. If $k=-S$, this follows immediately from the assumption on $x$ and the definition of $I_1$. Assume $k>-S$. By the inductive statement \eqref{unioni} and $D>4$, there is a $y'\in Y_{k-1}$ such that $x\in I_3(y',k-1)$. By the inductive statement \eqref{squeezedyadic}, we conclude $x\in B(y',4D^{k-1})$. By the triangle inequality with points $x$, $y$, $y'$, and $D>4$, we have $y'\in B(y,D^k)$. It follows by definition \eqref{defineij} that $I_3(y',k-1)\subset I_1(y,k)$, and thus $x\in I_3(y,k)$. This proves the first inclusion in \eqref{squeezedyadic}.

We show the second inclusion in \eqref{squeezedyadic}. Let $x\in I_3(y,k)$. As $I_1(y,k)\subset I_2(y,k)$ directly from the definition \eqref{defineij}, it follows by definition \eqref{definei3} that $x\in I_2(y,k)$. By definition \eqref{defineij}, there is $y'\in Y_{k-1}\cap B(y,2D^k)$ with $x\in I_3(y',k-1)$. By induction, $x\in B(y', 4D^{k-1})$. By the triangle inequality applied to the points $x,y',y$ and $D>4$, we conclude $x\in B(y,4D^k)$. This shows the second inclusion in \eqref{squeezedyadic} and completes the proof of the lemma.
\end{proof}

\begin{lemma}[cover by cubes]
\label{cover by cubes}
\uses{dyadic property}
Let  $-S\le l\le k\le S$ and
$y\in Y_k$.
We have
\begin{equation}\label{3coverdyadic}
   I_3(y,k)\subset \bigcup_{y'\in Y_l} I_3(y',l)\, .
\end{equation}
\end{lemma}
\begin{proof}

Let $-S\le l\le k\le S$ and $y\in Y_k$.
If $l=k$, the inclusion \eqref{3coverdyadic}
is true from the definition of set union.
We may then assume inductively that $k>l$ and the statement of the lemma is true if $k$ is replaced by $k-1$.
Let $x\in I_3(y,k)$.
By definition \eqref{definei3},  $x\in I_j(y,k)$
for some $j\in \{1,2\}$. By \eqref{defineij},
$x\in I_3(w,k-1)$ for some $w\in Y_{k-1}$.
We conclude \eqref{3coverdyadic} by induction.
\end{proof}

\begin{lemma}[dyadic property]
\label{dyadic property}
\uses{transitive boundary}
Let  $-S\le l\le k\le S$ and $y\in Y_k$ and  $y'\in Y_l$ with
$I_3(y',l)\cap I_3(y,k)\neq \emptyset$.  Then
\begin{equation}
    \label{3dyadicproperty}
I_3(y',l)\subset I_3(y,k).
\end{equation}


\end{lemma}

\begin{proof}
Let $l,k,y,y'$ be as in the lemma. Pick $x\in I_3(y',l)\cap I_3(y,k)$. Assume first $l=k$. By \eqref{disji} of Lemma \ref{basic grid structure}, we conclude $y'=y$, and thus \eqref{3dyadicproperty}. Now assume $l<k$. By induction, we may assume that the statement of the lemma is proven for $k-1$ in place of $k$.

By Lemma \ref{cover by cubes}, there is a $y''\in Y_{k-1}$ such that $x\in I_3(y'',k-1)$. By induction, we have $I_3(y',l)\subset I_3(y'',k-1)$. If $l=k-1$, then by the disjointedness property of Lemma \ref{basic grid structure}, we see that $y'=y''$, and hence \eqref{3dyadicproperty} follows. For $l<k-1$, it remains to prove
\begin{equation}\label{wyclaim}
I_3(y'',k-1)\subset I_3(y,k).
\end{equation}
We make a case distinction and assume first $x\in X_k$. By Definition \eqref{definei3}, we have $x\in I_1(y,k)$. By Definition \eqref{defineij}, there is a $v\in Y_{k-1}\cap B(y,D^k)$ with $x\in I_3(v,k-1)$. By \eqref{disji} of Lemma \ref{basic grid structure}, we have $v=y''$. By Definition \eqref{defineij}, we then have $I_3(y'',k-1)\subset I_1(y,k)$. Then \eqref{wyclaim} follows by Definition \eqref{definei3} in the given case.

Assume now the case $x\notin X_k$. By \eqref{definei3}, we have $x\in I_2(y,k)$. Moreover, for any $u<y$ in $Y_k$, we have $x\not\in I_3(u,k)$. Let $u<y$. By transitivity of the order in $Y_k$, we conclude $x\not \in I_2(u,k)$. By \eqref{defineij} and the disjointedness property of Lemma \ref{basic grid structure}, we have $I_3(y'',k-1)\cap  I_2(u,k)= \emptyset$. Similarly, $I_3(y'',k-1)\cap  I_1(u,k)= \emptyset$. Hence $I_3(y'',k-1)\cap  I_3(u,k)=\emptyset$. As $u<y$ was arbitrary, we conclude with \eqref{definei3} the claim in the given case. This completes the proof of \eqref{wyclaim}, and thus also \eqref{3dyadicproperty}.
\end{proof}




For $-S\le k'\le k\le S$ and $y'\in Y_{k'}$, $y\in Y_k$
write  $(y',k'|y,k)$ if $I_3(y',k')\subset I_3(y,k)$ and
\begin{equation}\label{bdcond}
    \inf_{x\in X\setminus I_3(y,k)}\rho(y',x)<6D^{k'}\, .
\end{equation}


\begin{lemma}[transitive boundary]
\label{transitive boundary}
\uses{small boundary}
Assume $-S\le k''< k'< k\le S$ and
$y''\in Y_{k''}$, $y'\in Y_{k'}$, $y\in Y_k$.
Assume there is $x\in X$ such that
\begin{equation}
x\in I_3(y'',k'')\cap I_3(y',k')\cap I_3(y,k)\, .
\end{equation}
If $(y'',k''|y,k)$, the also
$(y'',k''|y',k')$ and $(y',k'|y,k)$
\end{lemma}

\begin{proof}
As $x\in I_3(y'',k'')\cap I_3(y',k')$ and $k''< k'$, we have by Lemma \ref{dyadic property} that
$I_3(y'',k'')\subset I_3(y',k')$. Similarly,
$I_3(y',k')\subset I_3(y,k)$.
Pick $x'\in X\setminus I_3(y,k)$ such that
\begin{equation}\label{yppxp}
    \rho(y'',x')< 6D^{k''}\, ,
\end{equation}
which exists as $(y'',k''|y,k)$. As
$x'\in X\setminus I_3(y',k')$ as well, we conclude
$(y'',k''| y',k')$.
By the triangle inequality, we have
\begin{equation}
\rho(y',x')\le  \rho(y',x)+\rho(x,y'')+\rho(y'',x')
\end{equation}
Using the choice of $x$ and \eqref{squeezedyadic}
as well as \eqref{yppxp}, we estimate this by
\begin{equation}
<  4D^{k'}+4D^{k''}+6D^{k''}\le 6D^{k'}\, ,
\end{equation}
where we have used $D>5$ and $k''<k'$.
We conclude $(y',k'|y,k)$.
\end{proof}


\begin{lemma}[small boundary]
\label{small boundary}
\uses{smaller boundary}
 Let $K = 2^{4a+1}$. For each $-S+K\le k\le S$ and $y\in Y_k$ we have
    \begin{equation}
        \label{new small boundary}
        \sum_{z\in Y_{k-K}: (z,k-K|y,k)}\mu(I_3(z,k-K)) \le \frac 12 \mu(I_3(y,k))\,.
    \end{equation}
\end{lemma}

\begin{proof}
Let $K$ be as in the lemma. Let $-S+K\le k\le S$ and $y\in Y_k$.

Pick $k'$ so that $k-K\le k'\le k$.
For each $y''\in Y_{k-K}$ with $(y'',k-K| y,k)$,
by Lemma \ref{cover by cubes} and Lemma \ref{dyadic property}, there is a unique $y'\in Y_{k'}$ such that
\begin{equation}\label{4.31}
    I_3(y'',k-K)\subset I_3(y',k')\subset I_3(y,k)\, .
\end{equation}
Using Lemma \ref{transitive boundary}, $(y',k'|y,k)$.

We conclude using the disjointedness property of
Lemma \ref{basic grid structure} that
\begin{equation}\label{scalecompare}
    \sum_{y'': (y'',k-K|y,k)}\mu(I_3(y'',k-K))
%\end{equation}
%\begin{equation}
%    \le
%\sum_{y': (y',k'|y,k)}\left(
% \sum_{y'': (y'',k-K|y',k')}\mu(I_3(z,k-K))\right)
%\end{equation}
%   \begin{equation}
   \le
\sum_{y': (y',k'|y,k)}
\mu(I_3(y',k'))    \, .
   \end{equation}
Adding over $k-K<k'\le k$, and using
\[\mu(I_3(y',k'))\le 2^{4a} \mu(B(y', \frac 14 D^{k'}))\]
from the doubling property \eqref{doublingx} and
\eqref{squeezedyadic} gives
\begin{equation}\label{sumcompare}
    K\sum_{y'': (y'',k-K|y,k)}
    \mu(I_3(y'',k-K))
\end{equation}
\begin{equation}\label{sumcompare1}
    \le 2^{4a} \sum_{k-K<k'\le k}
   \left[ \sum_{y': (y',k'|y,k)}
\mu(B(y', \frac 14 D^{k'}))\right]
\end{equation}
Each ball $B(y', \frac 14 D^{k'})$ occurring in
\eqref{sumcompare1} is contained in $I_3(y',k')$
by \eqref{squeezedyadic} and in turn contained in
$I_3(y,k)$ by \eqref{4.31}. Assume for the moment all these balls are pairwise disjoint. Then
by additivity of the measure,
\begin{equation}
    K\sum_{y'': (y'',k-K|y,k)}
    \mu(I_3(y'',k-K))
    \le 2^{4a}
\mu(I_3(y,k))\,
\end{equation}
which by $K=2^{4a+1}$ implies \eqref{new small boundary}.

It thus remains to prove that the balls
occurring in
\eqref{sumcompare1} are pairwise disjoint.
Let $(u,l)$ and $(u',l')$ be two parameter pairs occurring
in the sum of \eqref{sumcompare1} and let
$ B(u, \frac 14 D^l)$ and $B({u'}, \frac 14 D^{l'})$
be the corresponding balls. If
$l=l'$, then the balls are equal or disjoint by
\eqref{squeezedyadic} and \eqref{disji} of Lemma \ref{basic grid structure}. Assume then without loss of generality that $l'<l$. Towards a contradiction, assume that
\begin{equation}\label{bulbul}
    B(u, \frac 14 D^l)\cap B({u'}, \frac 14 D^{l'})\neq \emptyset
\end{equation}
As $(u',l'|y,k)$, there is a point  $x$ in
$X\setminus I_3(y,k)$ with $\rho(x,u')<6D^{l'}$.
Using $D>25$, we conclude from the triangle inequality and \eqref{bulbul} that
$x\in B(u,\frac 12D^l)$. However, $B(u,\frac 12 D^l)\subset I_3(u,l)$,
and $I_3(u,l)\subset I_3(y,k)$, a contradiction to
$x\not\in I_3(y,k)$.
This proves the lemma.
\end{proof}

\begin{lemma}[smaller boundary]
\label{smaller boundary}
\uses{boundary measure}
Let $K = 2^{4a+1}$
and let $n\ge 0$ be an integer. Then
for each $-S+nK\le k\le S$ we have
   \begin{equation}
        \label{very new small}
        \sum_{y'\in Y_{k-nK}: (y',k-nK|y,k)}\mu(I_3(y',k-nK)) \le 2^{-n} \mu(I_3(y,k))\,.
    \end{equation}
\end{lemma}
\begin{proof}
    We prove this by induction on $n$. If $n=0$,
    both sides of \eqref{very new small} are equal to
    $\mu(I_3(y,k))$ by \eqref{disji}. If $n=1$, this follows from Lemma \ref{small boundary}.

    Assume $n>1$ and \eqref{very new small} has been proven for  $n-1$.
We write  \eqref{very new small}
     \begin{equation}
             \sum_{y''\in Y_{k-nK}: (y'',k-nK|y,k)}\mu(I_3(y'',k-nK))
    \end{equation}
     \begin{equation}
=  \sum_{y'\in Y_{k-K}:(y',k-K|y,k)}   \left[   \sum_{y''\in Y_{k-nK}: (y'',k-nK|y',k-K)}\mu(I_3(y'',k-nK)) \right]
    \end{equation}
Applying the induction hypothesis, this is bounded by
         \begin{equation}
=  \sum_{y'\in Y_{k-K}:(y',k-K|y,k)}   2^{1-n}\mu(I_3(y',k-K))
    \end{equation}
Applying \eqref{new small boundary} gives
\eqref{very new small}, and proves the lemma.
\end{proof}

\begin{lemma}[boundary measure]
\label{boundary measure}
 For each $-S\le k\le S$ and $y\in Y_k$ and $0<t<1$
 with $tD^k\ge D^{-S}$ we have
    \begin{equation}
        \label{old small boundary}
        \mu(\{x \in I_3(y,k) \ : \ \rho(x, X \setminus I_3(y,k)) \leq t D^{k}\}) \le 2^{100a^2} t^\kappa \mu(I_3(y,k))\,.
    \end{equation}
\end{lemma}
\begin{proof}
Let $x\in I_3(y,k)$ with  $\rho(x, X \setminus I_3(y,k)) \leq t D^{k}$. Let $K = 2^{4a+1}$ as in Lemma \ref{smaller boundary}.
Let $n$ be the largest integer such that
$D^{nK} \le \frac{1}{t}$, so that $tD^k \le D^{k-nK}$ and
\begin{equation}
\label{eq n size}
    D^{nK} > \frac{1}{tD^K}\,.
\end{equation}
Let $k' = k - nK$, by the assumption $tD^k \ge D^{-S}$, we have $k' \ge -S$. By \eqref{3coverdyadic}, there exists $y' \in Y_{k'}$ with $x \in I_3(y',k')$. By the squeezing property \eqref{squeezedyadic} and the assumption on $x$, we have
$$
    \rho(y', X \setminus I_3(y,k)) \le \rho(x,y') + \rho(x, X \setminus I_3(y,k)) \le 4 D^{k'} + t D^{k}\,.
$$
By the assumption on $n$ and the definition of $k'$, this is
$$
    \le 4D^{k'} + D^{k - nK} < 6D^{k'}\,.
$$
Together with \eqref{3dyadicproperty} thus $(y',k'|y,k)$. We have shown that
$$
    \{x \in I_3(y,k) \ : \ \rho(x, X \setminus I_3(y,k)) \leq t D^{k}\}
$$
$$
    \subset \bigcup_{y'\in Y_{k-nK}: (y',k-nK|y,k)}I_3(y',k-nK)\,.
$$
Using monotonicity and additivity of the measure and Lemma \ref{smaller boundary}, we obtain
$$
    \mu(\{x \in I_3(y,k) \ : \ \rho(x, X \setminus I_3(y,k)) \leq t D^{k}\}) \le 2^{-n} \mu(I_3(y,k))\,.
$$
By \eqref{eq n size} and the definition \eqref{defineD} of $D$, this is bounded by
$$
    t^{1/(100a^2 K)} 2^{100a^2} \mu(I_3(y,k))\,,
$$
which completes the proof by the definition \eqref{definekappa} of $\kappa$.
\end{proof}

Let $\mathcal{D}$ be the set of all $I_3(y,k)$ with $k\in [-S,S]$ and
$y\in Y_k$. Define
\begin{equation}
s(I_3(y,k)):=k
\end{equation}
\begin{equation}
c(I_3(y,k)):=y\,.
\end{equation}
We show that $(\mathcal{D},c,s)$ constitutes a grid structure. Property \eqref{eq vol sp cube}
follows from \eqref{squeezedyadic}, while \eqref{eq small boundary} follows from Lemma \ref{boundary measure}.
% \rs{\sout{To see \eqref{coverdyadic}, let $I\in \mathcal{D}$
% and $-S\le k< s(I)$. Let $x\in I$.}}

Let $x\in B(o, D^S)$. We show properties
\eqref{coverdyadic},
\eqref{dyadicproperty} and
\eqref{coverball}
for $(\mathcal{D},c,s)$ and $x$.

We first show \eqref{coverdyadic} by contradiction. Then there is an $I$ violating the conclusion of
\eqref{coverdyadic}. Pick such $I=I_3(y,l)$ such that $l$ is minimal.
{By assumption, we have $-S\le k<l$; in particular $-S<l$}.
% By definition, $I$ is contained in $\tilde{B}(x,k)$, which
% is contained in the union of $I(y,l-1)$ with $y\in X_{l-1}$.
By definition, $I_3(y, l)$ is contained in $I_1(y, l)\cup I_2(y, l)$, which is contained in the union of $I_3(y',l-1)$ with $y'\in Y_{l-1}$.
By minimality of $l$, each such $I_3(y',l-1)$ is contained in the union of
all $I_3(z,k)$ with $z\in Y_k$. This proves \eqref{coverdyadic}.

We now show \eqref{dyadicproperty}. Assume to get a contradiction that
there are non-disjoint $I, J\in \mathcal{D}$ with $s(I)\le s(J)$
and $I \not \subset J$. We may assume the existence of such $I$ and $J$ with minimal
$s(J)-s(I)$. Let $k=s(I)$. Assume first $s(J)=k$. Let $I=I_3(y_1,k)$ and $J=I_3(y_2,k)$ with $y_1,y_2\in Y_k$.
{If $y_1=y_2$, then $I=J$, a contradiction to $I\not \subset J$.
If $y_1\neq y_2$, then $I\cap J=\emptyset$ by \eqref{disji}, a contradiction to the non-disjointedness of $I,J$.% of $J=I_3(y_2, k)$ and the disjointedness of $I_1(y_1, k)$ and $I_1(y_2, k)$ by Lemma \ref{basic grid structure}, a contradiction.
%Similarly, if $y_2<y_1$, then $I\cap J=\emptyset$, a contradiction again.
Assume now $s(J)>k$. Choose $y\in I\cap J$. By property \eqref{coverdyadic},
there is $K\in \mathcal{D}$ with $s(K)=s(J)-1$ and $y\in K$. By construction
of $J$, and pairwise disjointedness of all $I_3(w,s(J)-1)$ that we have already seen,
we have $K\subset J$. By minimality of $s(J)$, we have $I\subset K$.
This proves $I\subset J$ and thus \eqref{dyadicproperty}.

We next establish \eqref{coverball}. Let $-S\leq k\leq S$. Using \eqref{unioni} for $j=3$, we get \begin{equation}
x\in B(o, D^S)\subset B(o, 4D^S-2D^k)\subset \bigcup_{y\in Y_k} I_3(y,k)\, .
\end{equation} Thus, there exists a dyadic cube $I=I_3(y, k)$ with $s(I)=k$ and $x\in I$. This proves \eqref{coverball}.


\section{Proof of Lemma \ref{tile structure}, tile structure}
\label{subsectiles}
Choose a grid structure $(\mathcal{D}, c, s)$.
Let $I \in \mathcal{D}$. Suppose that
\begin{equation}
    \label{eq tile Z}
    \mathcal{Z} \subset \bigcup_{\mfa \in \tQ(X)} B_{I^\circ}(\mfa, 1)
\end{equation}
is such that for any $\mfa, \mfb \in \mathcal{Z}$ we have
\begin{equation}
    \label{eq tile disjoint Z}
    B_{I^\circ}(\mfa, 0.3) \cap B_{I^\circ}(\mfb, 0.3) = \emptyset\,.
\end{equation}
By Lemma \ref{ball metric entropy} applied to each of the balls $B_{I^\circ}(\mfa, 1)$, $\mfa \in \tQ(X)$, we have
$$
    |\mathcal{Z}| \le 2^{2a} |\tQ(X)|\,.
$$
In particular, there exists a set $\mathcal{Z}$ satisfying both \eqref{eq tile Z} and \eqref{eq tile disjoint Z} of maximal cardinality among all such sets. We pick for each $I \in \mathcal{D}$ such a set $\mathcal{Z}(I)$.

\begin{lemma}[frequency ball cover]
\label{frequency ball cover}
    For each $I \in \mathcal{D}$, we have
    \begin{equation}
        \label{eq tile cover}
        \tQ(X) \subset  \bigcup_{\mfa \in \tQ(X)} B_{I^\circ}(\mfa, 1) \subset \bigcup_{z \in \mathcal{Z}(I)} B_{I^\circ}(z, 0.7)\,.
    \end{equation}
\end{lemma}

\begin{proof}
    To show \eqref{eq tile cover} note that the first inclusion is obvious. For the second inclusion let $\mfb \in  \bigcup_{\mfa \in \tQ(X)} B_{I^\circ}(\mfa, 1)$. By maximality of $\mathcal{Z}(I)$, there must be a point $z \in \mathcal{Z}(I)$ such that $B_{I^\circ}(z, 0.3) \cap B_{I^\circ}(\mfb, 0.3) \ne \emptyset$. Else, $\mathcal{Z}(I) \cup \{\mfb\}$ would be a set of larger cardinality than $\mathcal{Z}(I)$ satisfying \eqref{eq tile Z} and \eqref{eq tile disjoint Z}. Fix such $z$, and fix a point $z_1 \in B_{I^\circ}(z, 0.3) \cap B_{I^\circ}(\mfb, 0.3)$. By the triangle inequality, we deduce that
    $$
        d_{I^\circ}(z,\mfb) \le d_{I^\circ}(z,z_1) + d_{I^\circ}(\mfb, z_1) < 0.3 + 0.3 = 0.6\,,
    $$
    and hence $\mfb \in B_{I^\circ}(z, 0.7)$.
\end{proof}

We define
$$
    \fP = \{(I, z) \ : \ I \in \mathcal{D}, z \in \mathcal{Z}(I)\}\,,
$$
$$\sc((I, z)) = I\qquad \text{and} \qquad \fcc((I, z)) = z.$$ We further set $$\ps(\fp) = s(\sc(\fp)),\qquad \qquad \pc(\fp) = c(\sc(\fp)).$$ Then \eqref{tilecenter}, \eqref{tilescale} hold by definition.

It remains to construct the map $\Omega$, and verify properties \eqref{eq dis freq cover}, \eqref{eq freq dyadic} and
\eqref{eq freq comp ball}. We first construct an auxiliary map $\Omega_1$. For each $I \in \mathcal{D}$, we pick an enumeration of the finite set $\mathcal{Z}(I)$
$$
    \mathcal{Z}(I) = \{z_1, \dotsc, z_M\}\,.
$$
We define {$\Omega_1:\fP \mapsto \mathcal{P}(\Mf) $ as below}. Set
$$
    \Omega_1((I, z_1)) = B_{I^\circ}(z_1, 0.7) \setminus \bigcup_{z \in \mathcal{Z}(I)\setminus \{z_1\}} B_{I^\circ}(z, 0.3)
$$
and then define iteratively
\begin{equation}
    \label{eq def omega1}
    \Omega_1((I, z_k)) = B_{I^\circ}(z_k, 0.7) \setminus \bigcup_{z \in \mathcal{Z}(I) \setminus \{z_k\}} B_{I^\circ}(z, 0.3) \setminus \bigcup_{i=1}^{k-1} \Omega_1((I, z_i))\,.
\end{equation}
\begin{lemma}[disjoint frequency cubes]
    \label{disjoint frequency cubes}
    \uses{dyadic frequency cubes}
    For each $I \in \mathcal{D}$, and $\fp_1, \fp_2\in \fP(I)$, if $$\Omega_1(\fp_1)\cap \Omega_1(\fp_2)\neq \emptyset,$$ then $\fp_1=\fp_2$.
\end{lemma}

\begin{proof}
    By the definition of the map $\sc$, we have
    $$
        \fP(I) = \{(I, z) \, : \, z \in \mathcal{Z}(I)\}\,.
    $$
    By \eqref{eq def omega1}, the set $\Omega_1((I, z_k))$ is disjoint from each $\Omega_1((I, z_i))$ with $i < k$. Thus the sets $\Omega_1(\fp)$, $\fp \in \fP(I)$ are pairwise disjoint.
\end{proof}

\begin{lemma}[frequency cube cover]
\label{frequency cube cover}
\uses{dyadic frequency cubes}
    For each $I \in \mathcal{D}$, it holds that
    \begin{equation}
    \label{eq omega1 cover}
         \bigcup_{z \in \mathcal{Z}(I)} B_{I^\circ}(z, 0.7)\subset \bigcup_{\fp \in \fP(I)} \Omega_1(\fp)\,.
    \end{equation}
    For every $\fp \in \fP$, it holds that
    \begin{equation}
        \label{eq omega1 incl}
        B_{\fp}(\fcc(\fp), 0.3) \subset \Omega_1(\fp) \subset B_{\fp}(\fcc(\fp), 0.7)\,.
    \end{equation}
\end{lemma}

\begin{proof}
    For \eqref{eq omega1 incl} let $\fp = (I, z)$.
    The second inclusion in \eqref{eq omega1 incl} then follows from \eqref{eq def omega1} and the equality $B_{\fp}(\fcc(\fp), 0.7) = B_{I^\circ}(z, 0.7)$, which is true by definition.
    For the first inclusion in \eqref{eq omega1 incl} let $\mfa \in B_{\fp}(\fcc(\fp),0.3)$. Let $k$ be such that $z = z_k$ in the enumeration we chose above. It follows immediately from \eqref{eq def omega1} and \eqref{eq tile disjoint Z} that
    $\mfa \notin \Omega_1((I, z_i))$ for all $i < k$. Thus, again from \eqref{eq def omega1}, we have
    $\mfa \in \Omega_1((I,z_k))$.

    To show \eqref{eq omega1 cover} let $\mfa \in \bigcup_{z \in \mathcal{Z}(I)} B_{I^\circ}(z,0.7)$.
    If there exists $z \in \mathcal{Z}(I)$ with $\mfa \in B_{I^\circ}(z,0.3)$, then
    $$
        z \in \Omega_1((I, z)) \subset \bigcup_{\fp \in \fP(I)} \Omega_1(\fp)
    $$
    by the first inclusion in \eqref{eq omega1 incl}.

    Now suppose that there exists no $z \in \mathcal{Z}(I)$ with $\mfa \in B_{I^\circ}(z, 0.3)$. Let $k$ be minimal such that $\mfa \in B_{I^\circ}(z_k, 0.7)$. Since $\Omega_1((I, z_i)) \subset B_{I^\circ}(z_i, 0.7)$ for each $i$ by \eqref{eq def omega1}, we have that $\mfa \notin \Omega_1((I, z_i))$ for all $i < k$. Hence $\mfa \in \Omega_1((I, z_k))$, again by \eqref{eq def omega1}.
\end{proof}

Now we are ready to define the function $\Omega$. For all cubes $I \in \mathcal{D}$ such that there exists no $J \in \mathcal{D}$ with $I \subset J$ and $I \ne J$, we define for all $\fp \in \fP(I)$
\begin{equation}
    \label{eq max omega}
    \fc(\fp) = \Omega_1(\fp)\,.
\end{equation}
For cubes $I \in \mathcal{D}$ for which there exists $J \in \mathcal{D}$ with $I \subset J$ and $I \ne J$, we define $\Omega$ by recursion. We can pick an inclusion minimal $J \in \mathcal{D}$ among the finitely many cubes such that $I \subset J$ and $I \ne J$. This $J$ is unique: Suppose that $J'$ is another inclusion minimal cube with $I \subset J'$ and $I \ne J'$. Without loss of generality, we have that $s(J) \le s(J')$. By \eqref{dyadicproperty}, it follows that $J \subset J'$. Since $J'$ is minimal with respect to inclusion, it follows that $J = J'$.  Then we define
\begin{equation}
    \label{eq it omega}
    \fc(\fp) = \bigcup_{z \in \mathcal{Z}(J) \cap \Omega_1(\fp)} \Omega((J, z)) \cup B_{\fp}(\fcc(\fp),0.2)\,.
\end{equation}

\begin{lemma}[dyadic frequency cubes]
\label{dyadic frequency cubes}

    With this definition, \eqref{eq dis freq cover}, \eqref{eq freq dyadic} and \eqref{eq freq comp ball} hold.
\end{lemma}

\begin{proof}
    First, we prove \eqref{eq freq comp ball}. If $I \in \mathcal{D}$ is maximal in $\mathcal{D}$ with respect to set inclusion, then \eqref{eq freq comp ball} holds for all $\fp \in \fP(I)$ by \eqref{eq max omega} and \eqref{eq omega1 incl}. Now suppose that $I$ is not maximal in $\mathcal{D}$ with respect to set inclusion. Then we may assume by induction that for all $J \in \mathcal{D}$ with $I \subset J$ and all $\fp' \in \fP(J)$, \eqref{eq freq comp ball} holds. Let $J$ be the unique minimal cube in $\mathcal{D}$ with $I \subsetneq J$.

    Suppose that $\mfa \in \Omega(\fp)$. If $\mfa\in B_{\fp}(\mathcal{Q}(\fp), 0.2)$, then since
    \begin{equation*}
        B_{\fp}(\mathcal{Q}(\fp), 0.2)\subset B_{\fp}(\mathcal{Q}(\fp), 1)\, ,
    \end{equation*}
    we conclude that $\mfa\in B_{\fp}(\mathcal{Q}(\fp), 0.7)$. If not, by \eqref{eq it omega}, there exists $z \in \mathcal{Z}(J) \cap \Omega_1(\fp)$ with $\mfa \in \Omega(J,z)$. Using the triangle inequality and \eqref{eq omega1 incl}, we obtain
    $$
        d_{I^\circ}(\fcc(\fp),\mfa) \le d_{I^\circ}(\fcc(\fp), z) + d_{I^\circ}(z, \mfa) \le 0.7 + d_{I^\circ}(z, \mfa)\,.
    $$
    By Lemma \ref{monotone cube metrics} and the induction hypothesis, this is estimated by
    $$
        \le 0.7 + 2^{-95a} d_{J^\circ}(z,\mfa) \le 0.7 + 2^{-95a}\cdot 1 < 1\,.
    $$
    This shows the second inclusion in \eqref{eq freq comp ball}. The first inclusion is immediate from \eqref{eq it omega}.

    Next, we show \eqref{eq dis freq cover}. Let $I \in \mathcal{D}$.

    If $I$ is maximal with respect to inclusion, then disjointedness of the sets $\fc(\fp)$ for $\fp \in \fP(I)$ follows from the definition \eqref{eq max omega} and Lemma \ref{disjoint frequency cubes}. To obtain the inclusion in \eqref{eq dis freq cover} one combines the inclusions \eqref{eq tile cover} and \eqref{eq omega1 cover}
    of Lemma \ref{frequency cube cover} with  \eqref{eq max omega}.

    Now we turn to the case where there exists $J \in \mathcal{D}$ with $I \subset J$ and $I\ne J$. In this case we use induction: It suffices to show \eqref{eq dis freq cover} under the assumption that it holds for all cubes $J \in \mathcal{D}$ with $I \subset J$. As shown before definition \eqref{eq it omega}, we may choose the unique inclusion minimal such $J$. To show disjointedness of the sets $\fc(\fp), \fp \in \fP(I)$ we pick two tiles $\fp, \fp' \in \fP(I)$ and $\mfa \in \fc(\fp) \cap \fc(\fp')$.
    Then we are by \eqref{eq it omega} in one of the following four cases.

    1. There exist $z \in \mathcal{Z}(J) \cap \Omega_1(\fp)$ such that $\mfa \in \Omega(J, z)$, and there exists $z' \in \mathcal{Z}(J) \cap \Omega_1(\fp')$ such that $\mfa \in \Omega(J, z')$. By the induction hypothesis, that \eqref{eq dis freq cover} holds for $J$, we must have $z = z'$. By Lemma \ref{disjoint frequency cubes}, we must then have $\fp = \fp'$.

    2. There exists $z \in \mathcal{Z}(J) \cap \Omega_1(\fp)$ such that $\mfa \in \Omega(J,z)$, and $\mfa \in B_{\fp'}(\fcc(\fp'), 0.2)$.  Using the triangle inequality, Lemma \ref{monotone
    cube metrics} and \eqref{eq freq comp ball}, we obtain
    $$
        d_{\fp'}(\fcc(\fp'),z) \le d_{\fp'}(\fcc(\fp'), \mfa) + d_{\fp'}(z, \mfa) \le 0.2 + 2^{-95a} \cdot 1 < 0.3\,.
    $$
    Thus $z \in \Omega_1(\fp')$ by \eqref{eq omega1 incl}. By Lemma \ref{disjoint frequency cubes}, it follows that $\fp = \fp'$.

    3. There exists $z' \in \mathcal{Z}(J) \cap \Omega_1(\fp')$ such that $\mfa \in \Omega(J,z')$, and $\mfa \in B_{\fp}(\fcc(\fp), 0.2)$. This case is the same as case 2., after swapping $\fp$ and $\fp'$.

    4. We have $\mfa \in B_{\fp}(\fcc(\fp), 0.2) \cap B_{\fp'}(\fcc(\fp'), 0.2)$. In this case it follows that $\fp = \fp'$ since the sets $B_{\fp}(\fcc(\fp), 0.2)$ are pairwise disjoint by the inclusion \eqref{eq omega1 incl} and Lemma \ref{disjoint frequency cubes}.

    To show the inclusion in \eqref{eq dis freq cover}, let $\mfa \in \tQ(X)$. By the induction hypothesis, there exists $\fp \in \fP(J)$ such that $\mfa \in \Omega(\fp)$. By definition of the set $\fP$, we have $\fp = (J, z)$ for some $z \in \mathcal{Z}(J)$. By \eqref{eq tile Z}, there exists $x \in X$ with $d_{J^\circ}(\tQ(x), z) \le 1$. By Lemma \ref{monotone cube metrics}, it follows that $d_{I^\circ}(\tQ(x), z) \le 1$.
    Thus, by \eqref{eq tile cover}, there exists $z' \in \mathcal{Z}(I)$ with $z \in B_{I^\circ}(z', 0.7)$. Then by Lemma \eqref{frequency cube cover} there exists $\fp' \in \fP(I)$ with $z \in \mathcal{Z}(J) \cap \Omega_1(\fp')$. Consequently, by \eqref{eq it omega}, $\mfa \in \fc(\fp')$. This completes the proof of \eqref{eq dis freq cover}.

    Finally, we show \eqref{eq freq dyadic}. Let $\fp, \fq \in \fP$ with $\sc(\fp) \subset \sc(\fp)$ and $\fc(\fp) \cap \fc(\fq) \ne \emptyset$. If we have $\ps(\fp) \ge \ps(\fq)$, then it follows from \eqref{dyadicproperty} that $I = J$, thus $\fp, \fq \in \fP(I)$. By \eqref{eq dis freq cover} we have then either $\fc(\fp) \cap \fc(\fq) = \emptyset$ or $\fc(\fp) = \fc(\fq)$. By the assumption in \eqref{eq freq dyadic} we have $\fc(\fp) \cap \fc(\fq) \ne \emptyset$, so we must have $\fc(\fp) = \fc(\fq)$ and in particular $\fc(\fq) \subset \fc(\fp)$.

    So it remains to show \eqref{eq freq dyadic} under the additional assumption that $\ps(\fq) > \ps(\fp)$. In this case, we argue by induction on $\ps(\fq)-\ps(\fp)$. By \eqref{coverdyadic}, there exists a cube $J \in \mathcal{D}$ with $s(J) = \ps(\fq) - 1$ and $J \cap\sc(\fp) \ne \emptyset$. We pick one such $J$. By \eqref{dyadicproperty}, we have $\sc(\fp) \subset J \subset \sc(\fq)$.

    By \eqref{eq tile Z}, there exists $x \in X$ with $d_{\fq}(\tQ(x), \fcc(\fq)) \le 1$. By Lemma \ref{monotone cube metrics}, it follows that $d_{J^\circ}(\tQ(x), \fcc(\fq)) \le 1$.
    Thus, by \eqref{eq tile cover}, there exists $z' \in \mathcal{Z}(J)$ with $\fcc(\fq) \in B_{J^\circ}(z', 0.7)$. Then by Lemma \eqref{frequency cube cover} there exists $\fq' \in \fP(J)$ with $\fcc(\fq) \in\Omega_1(\fq')$.
    By \eqref{eq it omega}, it follows that $\Omega(\fq) \subset \Omega(\fq')$. Note that then $\sc(\fp) \subset \sc(\fq')$ and $\fc(\fp) \cap \fc(\fq') \ne \emptyset$ and $\ps(\fq') - \ps(\fp) = \ps(\fq) - \ps(\fp) - 1$. Thus, we have by the induction hypothesis that $\Omega(\fq') \subset \Omega(\fp)$. This completes the proof.
\end{proof}

\chapter{Proof of discrete Carleson (Prop.  \ref{discrete Carleson}) }
\label{proptopropprop}

%\section{Decomposition of grid cubes and first exceptional set}


Let a grid structure $(\mathcal{D}, c, s)$ and a tile structure $(\fP, \sc, \fc, \fcc)$ for this grid structure be given. In Subsection \ref{subsectilesorg}, we decompose the set $\fP$ of tiles into subsets. Each subset will be controlled by one of three methods. The guiding principle of the decomposition is to be able to apply the forest estimate of Proposition \ref{forest operator} to the final subsets defined in \eqref{defc5}. This application is done in Subsection \ref{subsecforest}. The miscellaneous subsets along the construction of the forests will either be thrown into exceptional sets, which are defined and controlled in Subsection \ref{subsetexcset}, or will be controlled by the antichain estimate of Proposition \ref{antichain operator}, which is done in Subsection \ref{subsecantichain}. Subsection \ref{subsec lessim aux} contains some auxiliary lemmas needed for the proofs in Subsections \ref{subsecforest}-\ref{subsecantichain}.

%The oganisation and summation of these various
%estimates is done in Subsection \ref{subsecaddingup}.




\section{Organisation of the tiles}\label{subsectilesorg}

In the following definitions, $k, n$, and
$j$ will be nonnegative integers.
Define
$\mathcal{C}(G,k)$ to be the set of $I\in \mathcal{D}$
such that there exists a $J\in \mathcal{D}$ with $I\subset J$
and
\begin{equation}\label{muhj1}
   {\mu(G \cap J)} > 2^{-k-1}{\mu(J)}\, ,
\end{equation}
but there does not exist a $J\in \mathcal{D}$ with $I\subset J$ and
\begin{equation}\label{muhj2}
   {\mu(G \cap J)} > 2^{-k}{\mu(J)}\,.
\end{equation}
Let
\begin{equation}
    \label{eq defPk}
    \fP(k)=\{\fp\in \fP \ : \ \sc(\fp)\in \mathcal{C}(G,k)\}
\end{equation}
Define $ {\mathfrak{M}}(k,n)$ to be the set of  $\fp \in \fP(k)$ such that
 \begin{equation}\label{ebardense}
    \mu({E_1}(\fp))  > 2^{-n}  \mu(\sc(\fp))
 \end{equation}
and there does not exist $\fp'\in \fP(k)$ with
$\fp'\neq \fp$ and  $\fp\le \fp'$  such that
 \begin{equation}\label{mnkmax}
    \mu({E_1}(\fp'))  > 2^{-n}  \mu(\sc(\fp')).
 \end{equation}
Define for a collection $\fP'\subset \fP(k)$
\begin{equation}
    \label{eq densdef}
   \dens_k' (\fP'):= \sup_{\fp'\in \fP'}\sup_{\lambda \geq 2} \lambda^{-a} \sup_{\fp \in \fP(k): \lambda \fp' \lesssim \lambda \fp}
    \frac{\mu({E}_2(\lambda, \fp))}{\mu(\sc(\fp))}\,.
\end{equation}
Sorting by density, we define
\begin{equation}
    \label{def cnk}
    \fC(k,n):=\{\fp\in \fP(k) \ : \
    2^{4a}2^{-n}< \dens_k'(\{\fp\}) \le
    2^{4a}2^{-n+1}\}\,.
\end{equation}
Following Fefferman \cite{fefferman}, we
define for $\fp \in \fC(k,n)$
    \begin{equation}\label{defbfp}
         \mathfrak{B}(\fp) := \{ \mathfrak{m} \in \mathfrak{M}(k,n) \ : \ 2 \fp \lesssim 100 \mathfrak{m}\}
    \end{equation}
and
\begin{equation}\label{defcnkj}
       \fC_1(k,n,j) := \{\fp \in \fC(k,n) \ : \ 2^{j} \leq |\mathfrak{B}(\fp)| < 2^{j+1}\}\,.
\end{equation}
and
\begin{equation}\label{defl0nk}
       \fL_0(k,n) := \{\fp \in \fC(k,n) \ : \ |\mathfrak{B}(\fp)| <1\}\,.
\end{equation}
Together with the following removal of minimal layers, the splitting into $\fC_1(k,n,j)$ will lead to a separation of  trees.
Define recursively for $0\le l\le Z(n+1)$
\begin{equation}
    \label{eq L1 def}
    \fL_1(k,n,j,l)
\end{equation}
to be the set of minimal elements with respect to $\le$ in
\begin{equation}
    \fC_1(k,n,j)\setminus \bigcup_{0\le l'<l}
\fL_1(k,n,j,l')\, .
\end{equation}
Define
\begin{equation}
    \label{eq C2 def}
    \fC_2(k,n,j):= \fC_1(k,n,j)\setminus \bigcup_{0\le l'\le Z(n+1)}
\fL_1(k,n,j,l')\, .
\end{equation}

The remaining tile organization will be relative to
prospective tree tops, which we define now.
Define
\begin{equation}\label{defunkj}
     \fU_1(k,n,j)
\end{equation}
to be the set of all
$\fu \in \fC_1(k,n,j)$ such that
for all $\fp \in \fC_1(k,n,j)$
with  $\sc(\fu)$ strictly contained in
$\sc(\fp)$ we have $B_{\fu}(\fcc(\fu), 100) \cap B_{\fp}(\fcc(\fp),100) = \emptyset$.

We first remove the pairs that are outside the immediate reach of any of the prospective tree tops.
Define
\begin{equation}
\label{eq L2 def}
\fL_2(k,n,j)
\end{equation}
to be the set of all $\fp\in \fC_2(k,n,j)$ such that there
does not exist
$\fu\in \fU_1(k,n,j)$
with $\sc(\fp)\neq \sc(\fu)$ and $2\fp\lesssim \fu$.
Define
\begin{equation}
\label{eq C3 def}
\fC_3(k,n,j):=\fC_2(k,n,j)
  \setminus \fL_2(k,n,j)\, .
\end{equation}


We next remove the maximal layers.
Define recursively for $0 \le l \le Z(n+1)$
\begin{equation}
    \label{eq L3 def}
    \fL_3(k,n,j,l)
\end{equation}
to be the set of all maximal elements with respect to $\le$ in
\begin{equation}
    \fC_3(k,n,j) \setminus \bigcup_{0 \le l' < l} \fL_3(k,n,j,l')\,.
\end{equation}
Define
\begin{equation}
\label{eq C4 def}
\fC_4(k,n,j):=\fC_3(k,n,j)
  \setminus \bigcup_{0 \le l \le Z(n+1)} \fL_3(k,n,j,l)\,.
\end{equation}

Finally, we remove the boundary pairs relative to the prospective tree tops. Define
\begin{equation}
    \label{eq L def}
    \mathcal{L}(\fu)
\end{equation}
to be the set of all $I \in \mathcal{D}$ with $I \subset \sc(\fu)$ and $s(I) = \ps(\fu) - Z(n+1) - 1$ and
\begin{equation}
    B(c(I), 8 D^{s(I)})\not \subset \sc(\fu)\, .
\end{equation}
Define
\begin{equation}
    \label{eq L4 def}
    \fL_4(k,n,j)
\end{equation}
to be the set of all $\fp\in \fC_4(k,n,j)$ such that there exists
$\fu\in \fU_1(k,n,j)$
with $\sc(\fp) \subset \bigcup \mathcal{L}(\fu)$, and define
\begin{equation}\label{defc5}
\fC_5(k,n,j):=\fC_4(k,n,j)
  \setminus \fL_4(k,n,j)\, .
\end{equation}


We define three exceptional sets.
The first exceptional set $G_1$ takes into account the ratio of the measures of $F$ and $G$.
Define $\fP_{F,G}$ to be the set of all $\fp\in \fP$
with
\begin{equation}
    \dens_2(\{\fp\})\ge 2^{2a+5}\frac{\mu(F)}{\mu(G)}\,.
\end{equation}
Define
\begin{equation}\label{definegone}
    G_1:=\bigcup_{\fp\in \fP_{F,G} }\sc(\fp)\, .
\end{equation}
For an integer $\lambda\ge 0$, define  $A(\lambda,k,n)$ to be the set  of all $x\in X$ such that
\begin{equation}
    \label{eq Aoverlap def}
    \sum_{\fp \in \mathfrak{M}(k,n)}\mathbf{1}_{\sc(\fp)}(x)>1+\lambda 2^{n+1}
\end{equation}
and define
\begin{equation}\label{definegone2}
    G_2:=
\bigcup_{k\ge  0}\bigcup_{k< n}
A(2n+6,k,n)\, .
\end{equation}
Define
    \begin{equation}\label{defineg3}
        G_3 :=
        \bigcup_{k\ge 0}\, \bigcup_{n \geq k}\,
        \bigcup_{0\le j\le 2n+3}
        \bigcup_{\fp \in \fL_4 (k,n,j)}
        \sc(\fp)\, .
     \end{equation}
Define $G'=G_1\cup G_2 \cup G_3$
The following bound of the measure of $G'$ will be proven in
Subsection \ref{subsetexcset}.
\begin{lemma}[exceptional set]
\label{exceptional set}
\uses{first exception,dense cover,pairwise disjoint,dyadic union,tree count,boundary measure}
We have
\begin{equation}
    \mu(G')\le 2^{-2}\mu(G)\, .
\end{equation}
\end{lemma}

In Subsection \ref{subsecforest}, we identify each set $\fC_5(k,n,j)$ outside $G'$ as forest and use Proposition
\ref{forest operator} to prove the following lemma.

\begin{lemma}[forest union]
\label{forest union}
\uses{relation geometry,C6 forest, C6 convex, forest separation, forest stacking}
  Let
  \begin{equation}
      \fP_1 =\bigcup_{k\ge 0}\bigcup_{n\ge k}
      \bigcup_{0\le j\le 2n+3}\fC_5(k,n,j)
  \end{equation}
  For all $f:X\to \C$ with $|f|\le \mathbf{1}_F$ we have
\begin{equation}
    \label{disclesssim1}
    \int_{G \setminus  G'} \left|\sum_{\fp \in \fP_1} T_{\fp} f \right|\, \mathrm{d}\mu  \le \frac{2^{260a^3}}{(q-1)^3} \mu(G)^{1 - \frac{1}{q}} \mu(F)^{\frac{1}{q}}\,.
\end{equation}
\end{lemma}

In Subsection \ref{subsecantichain}, we decompose
the complement of the set of tiles in Lemma
\ref{forest union} and apply the antichain estimate of
Proposition \ref{antichain operator} to prove the following lemma.

\begin{lemma}[forest complement]
\label{forest complement}
\uses{antichain decomposition,L0 antichain,L2 antichain,L1 L3 antichain}
  Let
  \begin{equation}
      \fP_2 =\fP\setminus \fP_1 %\left(\bigcup_{k\ge 0}\bigcup_{n\ge k}
     % \bigcup_{0\le j\le 2n+3}\fC_5(k,n,j)\right)\,.
  \end{equation}
 For all $f:X\to \C$ with $|f|\le \mathbf{1}_F$ we have
\begin{equation}
    \label{disclesssim2}
    \int_{G \setminus  G'} \left|\sum_{\fp \in \fP_2} T_{\fp} f\right| \, \mathrm{d}\mu  \le \frac{2^{210a^3}}{(q-1)^4} \mu(G)^{1 - \frac{1}{q}} \mu(F)^{\frac{1}{q}}\,.
\end{equation}
\end{lemma}
Proposition \ref{discrete Carleson} follows by applying
triangle inequality to \eqref{disclesssim}
according to the splitting in Lemma \ref{forest union}
and Lemma \ref{forest complement} and using both Lemmas as well
as the bound on the set $G'$ given by Lemma \ref{exceptional set}.
\asgar{Perhaps $\frac{2^{260 a^3+1}}{(q-1)^4}$ by triangle inequality.}



\section{Proof of Lemma \ref{exceptional set}, the exceptional sets}
\label{subsetexcset}


We prove separate bounds for $G_1$, $G_2$, and $G_3$
in Lemmas  \ref{first exception},
\ref{second exception}, and \ref{third exception}. Adding up these bounds proves Lemma \ref{exceptional set}.

The bound for $G_1$ is follows from the Vitali covering lemma, Proposition \ref{Hardy Littlewood}.

\begin{lemma}
[first exception]\label{first exception}
\uses{Hardy Littlewood}
We have
\begin{equation}
    \mu(G_1)\le 2^{-4}\mu(G)\, .
\end{equation}
\end{lemma}
\begin{proof}
Let
$$
    K = 2^{2a+5}\frac{\mu(F)}{\mu(G)}\,.
$$
For each $\fp\in \fP_{F,G}$ pick a
$r(\fp)>4D^{\ps(\fp)}$  with
$$
  {\mu(F\cap B(\pc(\fp),r(\fp)))}\ge K{\mu(B(\pc(\fp),r(\fp)))}\, .
$$
This ball exists by definition of $\fP_{F,G}$
and $\dens_2$. By applying Proposition \ref{Hardy Littlewood} to the collection of balls
$$
    \mathcal{B} = \{B(\pc(\fp),r(\fp)) \ : \ \fp \in \fP_{F,G}\}
$$
and the function $u = \mathbf{1}_F$, we obtain
$$
    \mu(\bigcup \mathcal{B}) \le 2^{2a+1} K^{-1}  \mu(F)\,.
$$
We conclude  with \eqref{eq vol sp cube} and $r(\fp)>4D^{\ps(\fp)}$
$$
    \mu(G_1)= \mu(\bigcup_{\fp\in \fP_{F,G}} \sc(\fp))
    \le \mu(\bigcup \mathcal{B})\le 2^{2a+1} K^{-1} \mu (F) = 2^{-4}\mu(G)\,.
$$
\end{proof}


We turn to the bound of $G_2$, which relies on the Dyadic Covering Lemma \ref{dense cover} and the
John-Nirenberg Lemma \ref{John Nirenberg} below.

\begin{lemma}[dense cover]
\label{dense cover}
\uses{John Nirenberg}
For  each $k\ge 0$, the union of all dyadic cubes
in $\mathcal{C}(G,k)$ has measure at most $2^{k+1} \mu(G)$ .
\end{lemma}
\begin{proof}
The union of dyadic cubes  in $\mathcal{C}(G,k)$
is contained the union of elements of the set $\mathcal{M}(k)$
of all dyadic cubes $J$ with
${\mu(G \cap J)} > 2^{-k-1}{\mu(J)}$.
The union of elements in the set $\mathcal{M}(k)$ is contained in the union of elements in
the set $\mathcal{M}^*(k)$ of maximal elements in
$\mathcal{M}(k)$ with respect to set inclusion. Hence
\begin{equation}\label{cbymstar}
\mu (\bigcup \mathcal{C}(G,k))\le \mu (\bigcup \mathcal{M}^*(k))\le
\sum_{J\in \mathcal{M}^*(k)}\mu(J)
\end{equation}
Using the definition of $\mathcal{M}(k)$ and then
the  pairwise disjointedness of elements in
$\mathcal{M}^*(k)$,
we estimate \eqref{cbymstar} by
\begin{equation}
\le
2^{k+1}\sum_{J\in \mathcal{M}^*(k)}\mu(J\cap G)
\le 2^{k+1}\mu(G).
\end{equation}
This proves the lemma.
\end{proof}




\begin{lemma}[pairwise disjoint]
\label{pairwise disjoint}
\uses{John Nirenberg}
     If $\fp, \fp' \in {\mathfrak{M}}(k,n)$ and
     \begin{equation}\label{eintersect}
     {E_1}(\fp)\cap {E_1}(\fp')\neq \emptyset,
     \end{equation}
     then $\fp=\fp'$.
\end{lemma}
\begin{proof}
Let $\fp,\fp'$ be as in the lemma. By definition of $E_1$,
we have
$E_1(\fp)\subset \sc(\fp)$ and analogously for $\fp'$, we conclude from \eqref{eintersect} that  $\sc(\fp)\cap \sc(\fp')\neq \emptyset$. Let without loss of generality $\sc(\fp)$ be maximal in
$\{\sc(\fp),\sc(\fp')\}$, then $\sc(\fp')\subset \sc(\fp)$.
By \eqref{eintersect}, we conclude by definition of $E_1$ that $\fc(\fp)\cap \fc(\fp')\neq \emptyset$. By
\eqref{eq freq dyadic} we conclude $\fc(\fp)\subset \fc(\fp')$. It follows that $\fp'\le \fp$. By maximality
\eqref{mnkmax}
of $\fp'$, we have $\fp'=\fp$. This proves the lemma.
\end{proof}


\begin{lemma}[dyadic union]
\label{dyadic union}
\uses{John Nirenberg}
For each  $x\in A(\lambda,k,n)$,
there is a dyadic cube $I$
that contains $x$ and is
a subset of
$A(\lambda,k,n)$.
\end{lemma}

\begin{proof}
Fix $k,n,\lambda,x$ as in the lemma such that $x\in A(\lambda,k,n)$.
Let $\mathcal{M}$ be the set of dyadic cubes $\sc(\fp)$ with $\fp$ in $\mathfrak{M}(k,n)$ and $x\in \sc(\fp)$.
By definition of $A(\lambda,k,n)$, the cardinality of $\mathcal{M}$ is at least $1+\lambda 2^{n+1}$.
Let $I$ be a cube of smallest scale in $\mathcal{M}$.
Then $I$ is contained in all cubes of $\mathcal{M}$.
It follows that $I\subset A(\lambda,k,n)$.
\end{proof}

\begin{lemma}[John Nirenberg]
\label{John Nirenberg}
\uses{second exception, top tiles}
    For all integers $k,n,\lambda\ge 0$, we have
    \begin{equation}\label{alambdameasure}
        \mu(A(\lambda,k,n))        \le 2^{k+1-\lambda}\mu(G)\, .
    \end{equation}


\end{lemma}
\begin{proof}
Fix $k,n$ as in the lemma
and suppress notation to write
$A(\lambda)$ for $A(\lambda,k,n)$.
We prove the lemma by induction on $\lambda$.
For $\lambda=0$, we use that $A(\lambda)$ by definition of $\mathfrak{M}(k,n)$ is contained in the union of elements in $ \mathcal{C}(G,k)$. Lemma \ref{dense cover} then completes  the base of the induction.

Now assume that the statement of Lemma \ref{John Nirenberg}
is proven for some integer $\lambda\ge 0$.
The set $A(\lambda+1)$ is contained in the set $A(\lambda)$.
Let  $\mathcal{M}$ be the set of dyadic cubes which are a subset of $A(\lambda)$. By Lemma \ref{dyadic union}, the union of $\mathcal{M}$ is $A(\lambda)$.
Let $\mathcal{M}^*$ be the set of maximal dyadic cubes in $\mathcal{M}$.

Let $L\in \mathcal{M}^*$. For each $x\in L$, we have
\begin{equation}\label{suminout}
 \sum_{\fp \in {\mathfrak{M}}(k,n)} \mathbf{1}_{\sc(\fp)}(x)=
   \sum_{\fp \in {\mathfrak{M}}(k,n):\sc(\fp) \subset L} \mathbf{1}_{\sc(\fp)}(x)+
  \sum_{\fp \in {\mathfrak{M}}(k,n):\sc(\fp) \not \subset L} \mathbf{1}_{\sc(\fp)}(x)\, .
\end{equation}
If the second sum on the right-hand-side is not zero, there is
an element of $\mathcal{D}$  strictly containing $L$.
Let $\hat{L}$ be such a dyadic cube with minimal $s(L)$. Then $\hat{L}$ is contained in $\sc(\fp)$ for all $\fp$
contributing to the second sum in
\eqref{suminout}.
Hence the second sum in \eqref{suminout} is constant on
$\hat{L}$.
By maximality of $L$, the second sum is less than  $1+\lambda 2^{n+1}$ somewhere on $\hat{L}$, thus on all of $\hat{L}$ and consequently also
at $x$.
If $x$ is in addition in $A(\lambda+1)$, then
the left-hand-side of \eqref{suminout} is at least
$1+(\lambda+1) 2^{n+1}$, so we have by the triangle inequality for the first sum on the right-hand side
\begin{equation}\label{mnkonl}
\sum_{\fp \in {\mathfrak{M}}(k,n):\sc(\fp) \subset L} \mathbf{1}_{\sc(\fp)}(x)\ge 2^{n+1}\, .\end{equation}
By Lemma \ref{pairwise disjoint}, we have
\begin{equation}
\sum_{\fp \in {\mathfrak{M}}(k,n):\sc(\fp) \subset L} \mu({E_1}(\fp)) \leq \mu(L)\, .
\end{equation}
Multiplying by $2^n$ and applying  \eqref{ebardense}, we obtain
\begin{equation}\label{mnkintl}
    \sum_{\fp \in {\mathfrak{M}}(k,n):\sc(\fp) \subset L} \mu(\sc(\fp))  \leq 2^n \mu(L)\, .
\end{equation}
We then have with \eqref{mnkonl} and \eqref{mnkintl}
\begin{equation}
2^{n+1}\mu(A(\lambda+1)\cap L) =
 \int_{A(\lambda+1)\cap L} 2^{n+1} d\mu
\end{equation}
\begin{equation}
\le
    \int \sum_{\fp \in {\mathfrak{M}}(k,n):\sc(\fp) \subset L} \mathbf{1}_{\sc(\fp)} d\mu
\le 2^n \mu(L)\, .
\end{equation}
Hence
\begin{equation}
    2\mu(A(\lambda+1))=2\sum_{L\in \mathcal{M}^*}
\mu(A(\lambda+1)\cap L)\le
\sum_{L\in \mathcal{M}^*}\mu( L)= \mu(A(\lambda))\, .
\end{equation}
Using the induction hypothesis, this proves
\eqref{alambdameasure} for $\lambda+1$ and completes the proof of the lemma.
\end{proof}

\begin{lemma}[second exception]
\label{second exception}
We have
\begin{equation}
    \mu(G_2)\le 2^{-4} \mu(G)\, .
\end{equation}
\end{lemma}
\begin{proof}

We use Lemma \ref{John Nirenberg} and sum twice a geometric series
to obtain
\begin{equation}
    \sum_{0\le  k}\sum_{k< n}
\mu(A(2n+6,k,n))\le \sum_{0\le  k}\sum_{k< n} 2^{k-5-2n}\mu(G)
\end{equation}
\begin{equation}
   \le \sum_{0\le  k} 2^{-k-5}\mu(G)\le 2^{-4}\mu(G)\, .
\end{equation}
This proves the lemma.
\end{proof}


We turn to the set $G_3$.

\begin{lemma}[top tiles]
\label{top tiles}
    We have
    \begin{equation}\label{eq musum}
        \sum_{\mathfrak{m} \in \mathfrak{M}(k,n)} \mu(\sc(\mathfrak{m}))\le 2^{n+1}2^{k+1}\mu(G).
    \end{equation}
\end{lemma}
\begin{proof}
    We write the left-hand side of \eqref{eq musum}
\begin{equation}
    \int \sum_{\mathfrak{m} \in \mathfrak{M}(k,n)} \mathbf{1}_{\sc(\mathfrak{m})}(x) \, d\mu(x) \le
2^{n+1} \sum_{\lambda=1}^{|\mathfrak{M}|}\mu(A(\lambda, k,n))\,.
\end{equation}
Using Lemma \ref{John Nirenberg}
%\ref{alambdameasure}
and then summing a geometric series, we estimate this by
\begin{equation}
    \le
2^{n+1}\sum_{\lambda=1}^{|\mathfrak{M}|}
2^{k+1-\lambda}\mu(G)
\le
2^{n+1}2^{k+1}\mu(G)\, .
\end{equation}
This proves the lemma.
\end{proof}


\begin{lemma}[tree count]
\label{tree count}
\uses{third exception}
Let $k,n,j\ge 0$. We have for every $x\in X$
\begin{equation}
    \sum_{\fu\in \fU_1(k,n,j)} \mathbf{1}_{\sc(\fu)}(x)
    \le 2^{1-j}
    2^{4a} \sum_{\mathfrak{m}\in \mathfrak{M}(k,n)}
     \mathbf{1}_{\sc(\mathfrak{m})}(x)
\end{equation}
\end{lemma}

\begin{proof}
Let $x\in X$. For each
$\fu\in \fU_1(k,n,j)$ with $x\in \sc(\fu)$, as $\fu \in \fC_1(k,n,j)$,
there are at least $2^{j-1}$  elements $\mathfrak{m}\in \mathfrak{M}(k,n)$
with $2\fu \lesssim 100\mathfrak{m}$ and in particular
$x\in \sc(\mathfrak{m})$. Hence
\begin{equation}\label{ubymsum}
     \mathbf{1}_{\sc(\fu)}(x)
    \le 2^{1-j}\sum_{\mathfrak{m} \in \mathfrak{M}(k,n): 2\fu\lesssim 100 \mathfrak{m}} \mathbf{1}_{\sc(\mathfrak{m})}(x)\, .
\end{equation}
Conversely, for each $\mathfrak{m}\in \mathfrak{M}(k,n)$
with $x\in \sc(\mathfrak{m})$,
let $\fU(\mathfrak{m})$ be the set of
$\fu\in \fU_1(k,n,j)$ with $x\in \sc(\fu)$
and $2\fu \lesssim 100\mathfrak{m}$.
Summing \eqref{ubymsum} over $\fu$ and counting the pairs
$(\fu,\mathfrak{m})$ with $2\fu \lesssim 100\mathfrak{m}$
differently gives
\begin{equation}\label{usumbymsum}
     \sum_{\fu\in \fU_1(k,n,j)} \mathbf{1}_{\sc(\fu)}(x)
    \le 2^{1-j}\sum_{\mathfrak{m} \in \mathfrak{M}(k,n)}
    \sum_{\fu \in \fU(\mathfrak{m})} \mathbf{1}_{\sc(\mathfrak{m})}(x)\, .
\end{equation}



We estimate the number of elements in $\fU(\mathfrak{m})$.
Let $\fu  \in \fU(\mathfrak{m})$.
Then by definition of
$\fU(\mathfrak{m})$
\begin{equation}\label{dby2}
     d_{\fu}(\fcc(\fu),\fcc(\mathfrak{m}))\le 2\, .
\end{equation}
If $\fu'$ is a further element in $\fU(\mathfrak{m})$ with $\fu\neq \fu'$, then
\begin{equation}
    \fcc(\mathfrak{m})
    \in B_{\fu}(\fcc(\fu),100)\cap B_{\fu'}(\fcc(\fu'),100)\ .
\end{equation}
By the last display and definition of $\fU_1(k,n,j)$, none of $\sc(\fu)$, $\sc(\fu')$ is strictly contained in the other. As both contain $x$, we have $\sc(\fu)=\sc(\fu')$.
We then have $d_{\fu}=d_{\fu'}$.

By \eqref{eq freq comp ball}, the balls
$B_{\fu}(\fcc(\fu),0.2)$ and
$B_{\fu}(\fcc(\fu'),0.2)$ are
contained respectively in $\fc(\fu)$
and $\fc(\fu')$ and thus are disjoint by \eqref{eq dis freq cover}.
By \eqref{dby2} and the triangle inequality, both balls are contained in $B_{\fu}(\fcc(\mathfrak{m}), 2.2)$.

By \eqref{thirddb} applied four times, there is a collection of at most
$2^{4a}$ balls of radius $0.2$ with respect to the metric $d_{\fu}$ which cover the ball $B_{\fu}(\fcc(\mathfrak{m}),2.2)$.
Let $B'$ be a ball in this cover.
As the center of $B'$  can be in at most one of the disjoint balls
$B_{\fu}(\fcc(\fu),0.2)$ and
$B_{\fu}(\fcc(\fu'),0.2)$,
the ball $B'$ can contain at most
one of the points $\fu$, $\fu'$.

Hence the set $\fU(\mathfrak{m})$ has at most
$2^{4a}$ many elements.
Inserting this into \eqref{usumbymsum} proves the lemma.
\end{proof}

\begin{lemma}[boundary exception]
\label{boundary exception}
\uses{third exception}
Let $\mathcal{L}(\fu)$ be as defined in \eqref{eq L def}. We have for each $\fu\in \fU_1(k,n,l)$,
\begin{equation}
\mu(\bigcup_{I\in \mathcal{L}(\fu)} I)
\le 2^{100a^2} D^{-\kappa Z(n+1)}
        \mu(\sc(\mathfrak{u})).
\end{equation}

\end{lemma}


\begin{proof}
  Let $\fu\in \fU_1(k,n,l)$.
Let $I \in \mathcal{L}(\fu)$. Then we have $s(I) = \ps(\fu) - Z(n+1) - 1$ and $I \subset \sc(\fu)$ and $B(c(I), 8D^{s(I)}) \not \subset \sc(\fu)$.
By \eqref{eq vol sp cube}, the set $I$
is contained in $B(c(I), 4D^{s(I)})$.
By the triangle inequality, the set $I$
is contained in
\begin{equation}
    X(\fu):=\{x \in \sc(\fu) \, : \, \rho(x, X \setminus \sc(\fu)) \leq 12 D^{\ps(\fu) - Z(n+1)-1}\}\,.
\end{equation}
 By the small boundary property \eqref{eq small boundary}, noting that
 \begin{equation*}
     12D^{\ps(\fu) - Z(n+1) - 1} = 12D^{s(I)} > D^{-S}\ ,
 \end{equation*} we have
   $$
        \mu(X(\fu)) \le
        2^{100a^2}(12 D^{-Z(n+1)-1})^\kappa
        \mu(\sc(\mathfrak{u})).
    $$
Using $\kappa<1$ and $D \ge 12$, this proves the lemma.
\end{proof}














    \begin{lemma}[third exception]
    \label{third exception}

       We have
\begin{equation}
    \mu(G_3)\le 2^{-4} \mu(G)\, .
\end{equation}
    \end{lemma}



    \begin{proof}
As each $\fp\in \fL_4(k,n,j)$
is contained in $\cup\mathcal{L}(\fu)$ for some
$\fu\in \fU_1(k,n,l)$, we have
\begin{equation}
\mu(\bigcup_{\fp \in \fL_4 (k,n,j)}\sc(\fp))
\le \sum_{\fu\in \fU_1(k,n,j)}
\mu(\bigcup_{I \in \mathcal{L} (\fu)}I).
\end{equation}
Using Lemma \ref{boundary exception} and then Lemma \ref{tree count}, we estimate this further
 by
\begin{equation}
    \le \sum_{\fu\in \fU_1(k,n,j)}
    2^{100a^2} D^{-\kappa Z(n+1)}
        \mu(\sc(\mathfrak{u}))
\end{equation}
\begin{equation}
    \le 2^{100a^2+4a+1-j} \sum_{\mathfrak{m}\in \mathfrak{M}(k,n)}
     D^{-\kappa Z(n+1)}
    \mu(\sc(\mathfrak{m}))\,.
\end{equation}
Using Lemma \ref{top tiles}, we estimate this by
  \begin{equation}
     \le
2^{100a^2 + 4a + 1-j}  D^{-\kappa Z(n+1)}
     2^{n+1}2^{k+1}\mu(G)\, .
\end{equation}
Now we estimate $G_3$ defined in \eqref{defineg3} by
\begin{equation}
    \mu(G_3)\le \sum_{k\ge 0}\, \sum_{n \geq k}\,
    \sum_{0\le j\le 2n+3}
    \mu(\bigcup_{\fp \in \fL_4 (k,n,j)}
    \sc(\fp))
\end{equation}
\begin{equation}
    \le \sum_{k\ge 0}\, \sum_{n \geq k}\,
    \sum_{0\le j\le 2n+3}
    2^{100a^2 + 4a + 3 + n + k -j}  D^{-\kappa Z(n+1)}\mu(G)
\end{equation}
Summing geometric series, using that $D^{\kappa Z}\ge 8$ by \eqref{defineD}, \eqref{definekappa} and \eqref{defineZ}, we estimate this by
\begin{equation}
    \le \sum_{k\ge 0}\, \sum_{n \geq k}\,
    2^{100a^2 + 4a + 4 + n + k}  D^{-\kappa Z(n+1)}\mu(G)
\end{equation}
\begin{equation}
    = \sum_{k\ge 0} 2^{100a^2 + 4a + 4 + 2k} D^{-\kappa Z(k+1)} \sum_{n \geq k}\,
    2^{n - k}  D^{-\kappa Z(n-k)}\mu(G)
\end{equation}
\begin{equation}
    \le \sum_{k\ge 0} 2^{100a^2 + 4a + 5 + 2k}  D^{-\kappa Z(k+1)}\mu(G)
\end{equation}
\begin{equation}
   \le 2^{100a^2 + 4a + 6}  D^{-\kappa Z}\mu(G)
\end{equation}
Using $D = 2^{100a^2}$ and $a \ge 4$ and $\kappa Z \ge 2$ by \eqref{defineD} and \eqref{definekappa} proves the lemma.
\end{proof}

\section{Auxiliary lemmas}
\label{subsec lessim aux}
Before proving Lemma \ref{forest union} and Lemma \ref{forest complement}, we collect some useful properties of $\lesssim$.

\begin{lemma}[wiggle order 1]
    \label{wiggle order 1}
    \uses{wiggle order 3}
    If $n\fp \lesssim m\fp'$ and
    $n' \ge  n$ and $m \ge m'$ then $n'\fp \lesssim m'\fp'$.
\end{lemma}

\begin{proof}
    This follows immediately from the definition \eqref{wiggleorder} of $\lesssim$ and the two inclusions $B_{\fp}(\fcc(\fp), n) \subset B_{\fp}(\fcc(\fp), n')$ and $B_{\fp'}(\fcc(\fp'), m') \subset B_{\fp'}(\fcc(\fp'), m)$.
\end{proof}

\begin{lemma}[wiggle order 2]
    \label{wiggle order 2}
    \uses{wiggle order 3}
    Let $n, m \ge 1$.
    If $\fp, \fp' \in \fP$ with $\sc(\fp) \ne \sc(\fp')$ and
    \begin{equation}
        \label{eq wiggle1}
        n \fp \lesssim \fp'
    \end{equation}
    then
    \begin{equation}
        \label{eq wiggle2}
        (n + 2^{-95 a} m) \fp \lesssim m\fp'\,.
    \end{equation}
\end{lemma}

\begin{proof}
    The assumption \eqref{eq wiggle1} together with the definition \eqref{wiggleorder} of $\lesssim$ implies that $\sc(\fp) \subsetneq \sc(\fp')$. Let $\mfa \in B_{\fp'}(\fcc(\fp'), 100)$.  Then we have by the triangle inequality
    $$
        d_{\fp}(\fcc(\fp), \mfa) \le  d_{\fp}(\fcc(\fp), \fcc(\fp')) +  d_{\fp}(\fcc(\fp'), \mfa)
    $$
    Using \eqref{eq wiggle1} and \eqref{wiggleorder} for the first summand, and Lemma \ref{monotone cube metrics} for the second summand, this is estimated by
    $$
        n + 2^{-95a} d_{\fp'}(\fcc(\fp'), \mfa) < n + 2^{-95a} m\,.
    $$
    Thus $B_{\fp'}(\fcc(\fp'),n) \subset B_{\fp}(\fcc(\fp),n + 2^{-95a}m)$. Combined with $\sc(\fp) \subset \sc(\fp')$, this yields \eqref{eq wiggle2}.
\end{proof}

\begin{lemma}[wiggle order 3]
\label{wiggle order 3}
\uses{C convex, relation geometry}
    The following implications hold for all $\fq, \fq' \in \fP$:
    \begin{equation}
        \label{eq sc1}
        \fq \lesssim \fq' \ \text{and} \ \lambda \ge 1 \implies \lambda \fq \lesssim \lambda \fq'\,,
    \end{equation}
    \begin{equation}
        \label{eq sc2}
        10\fq \lesssim \fq' \ \text{and} \ \fq \ne \fq' \implies 100 \fq \lesssim 100 \fq'\,,
    \end{equation}
    \begin{equation}
        \label{eq sc3}
        2\fq \lesssim \fq' \ \text{and} \ \fq \ne \fq' \implies 4 \fq \lesssim 500 \fq'\,.
    \end{equation}
\end{lemma}

\begin{proof}
    All three implications are easy consequences of Lemma \ref{wiggle order 1}, Lemma \ref{wiggle order 2} and the fact that $a \ge 4$.
\end{proof}



We call a collection $\mathfrak{A}$ of tiles convex if
\begin{equation}
    \label{eq convexity}
    \fp \le \fp' \le \fp'' \ \text{and} \ \fp, \fp'' \in \mathfrak{A} \implies \fp' \in \mathfrak{A}\,.
\end{equation}

\begin{lemma}[P convex]
    \label{P convex}
    \uses{C convex}
    For each $k$, the collection $\fP(k)$ is convex.
\end{lemma}

\begin{proof}
    Suppose that $\fp \le \fp' \le \fp''$ and $\fp, \fp'' \in \fP_k$. By \eqref{eq defPk} we have $\sc(\fp), \sc(\fp'') \in \mathcal{C}(G,k)$, so there exists by \eqref{muhj1} some $J \in \mathcal{D}$ with
    $$
        \sc(\fp') \subset \sc(\fp'') \subset J
    $$
    and $\mu(G \cap J) > 2^{-k-1} \mu(G)$. Thus \eqref{muhj1} holds for $\sc(\fp')$. On the other hand, by \eqref{muhj2}, there exists no $J \in \mathcal{D}$ with $\sc(\fp) \subset J$ and $\mu(G \cap J) > 2^{-k} \mu(G)$. Since $\sc(\fp) \subset \sc(\fp')$, this implies that \eqref{muhj2} holds for $\sc(\fp')$. Hence $\sc(\fp') \in \mathcal{C}(G,k)$, and therefore by \eqref{eq defPk} $\fp' \in \fP(k)$.
\end{proof}

\begin{lemma}[C convex]
    \label{C convex}
    \uses{C1 convex}
    For each $k,n$, the collection $\fC(k,n)$ is convex.
\end{lemma}

\begin{proof}
    Let $\fp \le \fp' \le \fp''$ with $\fp, \fp'' \in \fC(k,n)$. Then, in particular, $\fp, \fp'' \in \fP(k)$, so, by Lemma \ref{P convex}, $\fp' \in \fP(k)$. Next, we show that if $\fq \le \fq' \in \fP(k)$ then $\dens'_k(\{\fq\}) \ge \dens_k'(\{\fq'\})$. If $\fp \in \fP(k)$ and $\lambda \ge 2$ with $\lambda \fq' \lesssim \lambda \fp$, then it follows from $\fq \le \fq'$, \eqref{eq sc1} of Lemma \ref{wiggle order 3} and transitivity of $\lesssim$ that $\lambda \fq \lesssim \lambda \fp$. Thus the supremum in the definition \eqref{eq densdef} of $\dens_k'(\{\fq\})$ is over a superset of the set the  supremum in the definition of $\dens_k'(\{\fq'\})$ is taken over, which shows $\dens'_k(\{\fq\}) \ge \dens_k'(\{\fq'\})$. From $\fp' \le \fp''$, $\fp'' \in \fC(k,n)$ and \eqref{def cnk} it then follows that
    $$
        2^{4a}2^{-n} < \dens_k'(\{\fp''\}) \le \dens_k'(\{\fp'\})\,.
    $$
    Similarly, it follows from $\fp \le \fp'$, $\fp'' \in \fC(k,n)$ and \eqref{def cnk} that
    $$
        \dens_k'(\{\fp'\}) \le \dens_k'(\{\fp\}) \le 2^{4a}2^{-n+1}\,.
    $$
    Thus $\fp' \in \fC(k,n)$.
\end{proof}

\begin{lemma}[C1 convex]
    \label{C1 convex}
    \uses{C2 convex}
    For each $k,n,j$, the collection $\fC_1(k,n,j)$ is convex.
\end{lemma}

\begin{proof}
    Let $\fp\le\fp'\le\fp''$ with $\fp, \fp'' \in \fC_1(k,n,j)$. By Lemma \ref{C convex} and the inclusion $\fC_1(k,n,j) \subset \fC(k,n)$, which holds by definition \eqref{defcnkj}, we have $\fp' \in \fC(k,n)$. By \eqref{eq sc1} and transitivity of $\lesssim$ we have that $\fq \le \fq'$ and $2 \fq' \lesssim 100\mathfrak{m}$ imply $2\fq \lesssim 100\mathfrak{m}$. So, by \eqref{defbfp}, $\mathfrak{B}(\fp'') \subset \mathfrak{B}(\fp') \subset \mathfrak{B}(\fp)$. Consequently, by \eqref{defcnkj}
    $$
        2^j \le |\mathfrak{B}(\fp'')|\le |\mathfrak{B}(\fp')| \le |\mathfrak{B}(\fp)| < 2^{j+1}\,,
    $$
    thus $\fp' \in \fC_1(k,n,j)$.
\end{proof}

\begin{lemma}[C2 convex]
    \label{C2 convex}
    \uses{C3 convex}
    For each $k,n,j$, the collection $\fC_2(k,n,j)$ is convex.
\end{lemma}

\begin{proof}
     Let $\fp \le \fp' \le \fp''$ with $\fp, \fp'' \in \fC_2(k,n,j)$. By \eqref{eq C2 def}, we have
     \begin{equation*}
         \fC_2(k,n,j) \subset \fC_1(k,n,j)\ .
     \end{equation*} Combined with Lemma \ref{C1 convex}, it follows that $\fp' \in \fC_1(k,n,j)$. Suppose that $\fp' \notin \fC_2(k,n,j)$. By \eqref{eq C2 def}, this implies that there exists $0 \le l' \le Zn$ with $\fp' \in \fL_1(k,n,j,l')$. By the definition \eqref{eq L1 def} of $\fL_1(k,n,j,l')$, this implies that $\fp$ is minimal with respect to $\le$  in $\fC_1(k,n,j) \setminus \bigcup_{l < l'} \fL_1(k,n,j,l)$. Since $\fp \in \fC_2(k,n,j)$ we must have $\fp \ne \fp'$. Thus $\fp \le \fp'$ and $\fp \ne \fp'$. By minimality of $\fp'$ it follows that $\fp \notin \fC_1(k,n,j) \setminus \bigcup_{l < l'} \fL_1(k,n,j,l)$. But by \eqref{eq C2 def} this implies $\fp \notin \fC_2(k,n,j)$, a contradiction.
\end{proof}

\begin{lemma}[C3 convex]
    \label{C3 convex}
    \uses{C4 convex}
    For each $k,n,j$, the collection $\fC_3(k,n,j)$ is convex.
\end{lemma}

\begin{proof}
    Let $\fp \le \fp' \le \fp''$ with $\fp, \fp'' \in \fC_3(k,n,j)$. By \eqref{eq C3 def} and Lemma \ref{C2 convex} it follows that $\fp' \in \fC_2(k,n,j)$. Suppose that $\fp' \notin \fC_3(k,n,j)$. Then, by \eqref{eq C3 def} and \eqref{eq L2 def}, there exists $\fu \in \fU_1(k,n,j)$ with $2\fp' \lesssim \fu$ and $\sc(\fp') \ne \sc(\fu)$. Together this gives $\sc(\fp') \subsetneq \sc(\fu)$. From $\fp' \le \fp$, \eqref{eq sc1} and transitivity of $\lesssim$ we then have $2\fp \lesssim \fu$. Also, $\sc(\fp) \subset \sc(\fp') \subsetneq \sc(\fu)$, so $\sc(\fp) \ne \sc(\fu)$. But then $\fp \in \fL_2(k,n,j)$, contradicting by \eqref{eq C3 def} the assumption $\fp \in \fC_3(k,n,j)$.
\end{proof}

\begin{lemma}[C4 convex]
    \label{C4 convex}
    \uses{C5 convex}
    For each $k,n,j$, the collection $\fC_4(k,n,j)$ is convex.
\end{lemma}

\begin{proof}
    Let $\fp \le \fp' \le\fp''$ with $\fp, \fp'' \in \fC_4(k,n,j)$. As before we obtain from the inclusion $\fC_4(k,n,j) \subset \fC_3(k,n,j)$ and Lemma \ref{C3 convex} that $\fp' \in \fC_3(k,n,j)$. Thus, if $\fp' \notin \fC_4(k,n,j)$ then by \eqref{eq L3 def} there exists $l$ such that $\fp' \in \fL_3(k,n,j,l)$. Thus $\fp'$ is maximal with respect to $\le$ in $\fC_3(k,n,j) \setminus \bigcup_{0 \le l' < l} \fL_3(k,n,j,l')$.  Since $\fp'' \in \fC_4(k,n,j)$ we must have $\fp' \ne \fp''$. Thus $\fp' \le \fp''$ and $\fp'\ne \fp''$. By minimality of $\fp'$ it follows that $\fp'' \notin \fC_3(k,n,j) \setminus \bigcup_{l < l'} \fL_3(k,n,j,l)$. But by \eqref{eq C4 def} this implies $\fp'' \notin \fC_4(k,n,j)$, a contradiction.
\end{proof}

\begin{lemma}[C5 convex]
    \label{C5 convex}
    \uses{C6 convex}
    For each $k,n,j$, the collection $\fC_5(k,n,j)$ is convex.
\end{lemma}

\begin{proof}
    Let $\fp \le \fp' \le\fp''$ with $\fp, \fp'' \in \fC_5(k,n,j)$. Then $\fp, \fp'' \in \fC_4(k,n,j)$ by \eqref{defc5}, and thus by Lemma \ref{C4 convex} also $\fp' \in \fC_4(k,n,j)$. Suppose that $\fp' \notin \fC_5(k,n,j)$. By \eqref{defc5}, it follows that $\fp' \in \fL_4(k,n,j)$.
    By \eqref{eq L4 def}, there exists $\fu \in \fU_1(k,n,j)$ with $\sc(\fp') \subset \bigcup \mathcal{L}(\fu)$. Then also $\sc(\fp) \subset \bigcup \mathcal{L}(\fu)$, a contradiction.
\end{proof}

\begin{lemma}[dens compare]
    \label{dens compare}
    \uses{C dens1}
    We have for every $k\ge 0$ and $\fP'\subset \fP(k)$
\begin{equation}
    \dens_1(\fP')\le \dens_k'(\fP')\, .
\end{equation}
\end{lemma}
\begin{proof}
It suffices to show that for all $\fp'\in \fP'$
and  $\lambda>2$ and  $\fp\in \fP(\fP')$ with $\lambda \fp' \lesssim \lambda \fp$ we have
\begin{equation}
    \frac{\mu({E}_2(\lambda, \fp))}{\mu(\sc(\fp))}
    \le \sup_{\fp'' \in \fP(k): \lambda \fp' \lesssim \lambda \fp''}
    \frac{\mu({E}_2(\lambda, \fp''))}{\mu(\sc(\fp''))}.
\end{equation}
    Let such $\fp'$, $\lambda$, $\fp$ be given.
    It suffices to show that $\fp\in \fP(k)$,
    that is, it satisfies \eqref{muhj1}
    and \eqref{muhj2}.

We show \eqref{muhj1}.
 As $\fp\in \fP(\fP')$, there exists
$\fp''\in \fP'$ with $\sc(\fp')\subset \sc(\fp'')$. By assumption on $\fP'$, we have  $\fp''\in \fP(k)$ and there exists
$J\in \mathcal{D}$ with
   $\sc(\fp'')\subset J$ and
   \begin{equation}
       \mu(G\cap J)>2^{-k-1} \mu(J).
   \end{equation}
Then also $\sc(\fp')\subset J$, which proves
\eqref{muhj1} for $\fp$.

We show \eqref{muhj2}. Assume to get a contradiction that
there exists $J\in \mathcal{D}$ with
   $\sc(\fp)\subset J$ and
   \begin{equation}\label{mugj}
       \mu(G\cap J)>2^{-k} \mu(J).
   \end{equation}
   As $\lambda\fp'\lesssim \lambda\fp$, we have $\sc(\fp')\subset \sc(\fp)$, and therefore
    $\sc(\fp')\subset J$. This contradicts
   $\fp'\in \fP'\subset \fP(k)$. This proves
\eqref{muhj2} for $\fp$.
\end{proof}

\begin{lemma}[C dens1]
    \label{C dens1}
    For each set $\mathfrak{A} \subset \mathfrak{C}(k,n)$, we have
    $$
        \dens_1(\mathfrak{A}) \le 2^{4a}2^{-n+1}\,.
    $$
\end{lemma}

\begin{proof}
    We have by Lemma \ref{dens compare} that
    $\dens_1(\mathfrak{A}) \le \dens_k'(\mathfrak{A})$. Since $\mathfrak{A} \subset \fC(k,n)$, it follows from monotonicity of suprema and the definition \eqref{eq densdef} that
    $
        \dens_k'(\mathfrak{A}) \le \dens_k'(\fC(k,n))\,.
    $
    By \eqref{eq densdef} and \eqref{def cnk}, we have
    $$
        \dens_k'(\fC(k,n)) = \sup_{\fp \in \fC(k,n)} \dens_k'(\{\fp\}) \le 2^{4a}2^{-n+1}\,.
    $$
\end{proof}

\section{Proof of Lemma \ref{forest union}, the forests}
\label{subsecforest}

Fix $k,n,j\ge 0$.
Define
$$
    \fC_6(k,n,j)
$$
to be the set of all tiles $\fp \in \fC_5(k,n,j)$ such that $\sc(\fp) \not\subset G'$. The following chain of lemmas
establishes that the set $\fC_6(k,n,j)$ can be written as a union of a small number of $n$-forests.

For $\fu\in \fU_1(k,n,j)$, define
\begin{equation}
    \label{eq T1 def}
    \mathfrak{T}_1(\fu):= \{\fp \in \fC_1(k,n,j) \ : \sc(\fp)\neq \sc(\fu), \ 2\fp \lesssim  \fu\}\,.
\end{equation}
Define
\begin{equation}
    \label{eq U2 def}
    \fU_2(k,n,j) := \{ \fu \in \fU_1(k,n,j) \, : \, \mathfrak{T}_1(\fu)  \cap \fC_6(k,n,j) \ne \emptyset\}\,.
\end{equation}

Define a relation $\sim$ on $\fU_2(k,n,j)$
by setting $\fu\sim \fu'$
for $\fu,\fu'\in \fU_2(k,n,j)$
if $\fu=\fu'$ or there exists $\fp$ in $\mathfrak{T}_1(\fu)$
with $10 \fp\lesssim \fu'$.

\begin{lemma}[relation geometry]
    \label{relation geometry}
    \uses{forest geometry,equivalence relation,forest inner}
    If $\fu \sim \fu'$, then $\sc(u) = \sc(u')$ and
    \begin{equation*}
        B_{\fu}(\fcc(\fu), 100) \cap B_{\fu'}(\fcc(\fu'), 100) \neq \emptyset\ .
    \end{equation*}
\end{lemma}

\begin{proof}
    Let $\fu, \fu' \in \fU_1(k,n,j)$ with $\fu \sim \fu'$. If $u = u'$ then the conclusion of the Lemma clearly holds. Else, there exists $\fp \in \fC_1(k,n,j)$ such that $\sc(\fp) \ne \sc(\fu)$ and  $2 \fp \lesssim \fu$ and $10 \fp \lesssim \fu'$.
    Using Lemma \ref{wiggle order 1} and \eqref{eq sc2} of Lemma \ref{wiggle order 3}, we deduce that
    \begin{equation}
        \label{eq Fefferman trick0}
        100 \fp\lesssim  100 \fu\,, \qquad 100 \fp \lesssim 100\fu'\,.
    \end{equation}
    Now suppose that $B_{\fu}(\fcc(\fu), 100) \cap B_{\fu'}(\fcc(\fu'), 100) = \emptyset$. Then we have $\mathfrak{B}(\fu) \cap \mathfrak{B}(\fu') = \emptyset$, by the definition \eqref{defbfp} of $\mathfrak{B}$ and the definition \eqref{wiggleorder} of $\lesssim$, but also $\mathfrak{B}(\fu) \subset \mathfrak{B}(\fp)$ and $\mathfrak{B}(\fu') \subset \mathfrak{B}(\fp)$, by \eqref{defbfp}, \eqref{wiggleorder} and \eqref{eq Fefferman trick0}.
    Hence,
    $$
        |\mathfrak{B}(\fp)| \geq |\mathfrak{B}(\fu)| + |\mathfrak{B}(\fu')| \geq 2^{j} + 2^j = 2^{j+1}\,,
    $$
    which contradicts $\fp \in \fC_1(k,n,j)$. Therefore we must have
    \begin{equation*}
        B_{\fu}(\fcc(\fu), 100) \cap B_{\fu'}(\fcc(\fu'), 100) \ne \emptyset\, .
    \end{equation*}

    It follows from $2\fp \lesssim \fu$ and $10\fp \lesssim \fu'$ that $\sc(\fp) \subset \sc(\fu)$ and $\sc(\fp) \subset \sc(\fu')$. By \eqref{dyadicproperty}, it follows that $\sc(\fu)$ and $\sc(\fu')$ are nested.
    Combining this with the conclusion of the last paragraph and definition \eqref{defunkj} of $\fU_1(k,n,j)$, we obtain that $\sc(\fu) = \sc(\fu')$.
\end{proof}


\begin{lemma}[equivalence relation]
\label{equivalence relation}
For each $k,n,j$, the relation $\sim$ on
$\fU_2(k,n,j)$ is an equivalence relation.
\end{lemma}

\begin{proof}
    Reflexivity holds by definition.
    For transitivity, suppose that
    \begin{equation*}
        \fu, \fu', \fu'' \in \fU_1(k,n,j)
    \end{equation*}
    and $\fu \sim \fu'$, $\fu' \sim \fu''$.
    By Lemma \ref{relation geometry}, it follows that $\sc(\fu) =\sc(\fu') = \sc(\fu'')$, that there exists
    \begin{equation*}
        \mfa \in B_{\fu}(\fcc(\fu), 100) \cap B_{\fu'}(\fcc(\fu'), 100)
    \end{equation*}
    and that there exists
    \begin{equation*}
        \mfb \in B_{\fu'}(\fcc(\fu'), 100) \cap B_{\fu''}(\fcc(\fu''), 100)\, .
    \end{equation*}
    If $\fu = \fu'$, then $\fu \sim \fu''$ holds by assumption. Else, there exists by the definition of $\sim$ some $\fp \in \mathfrak{T}_1(\fu)$ with $10\fp\lesssim \fu'$.
    Then we have $2\fp \lesssim \fu$  and $\fp \ne \fu$ by definition of $\mathfrak{T}_1(\fu)$,  so $4 \fp \lesssim 500 \fu$ by \eqref{eq sc3}. For $q \in B_{\fu''}(\fcc(\fu''), 1)$ it follows by the triangle inequality that
    \begin{align*}
        d_{\fu}(\fcc(\fu), q) &\le d_{\fu}(\fcc(\fu), \mfa) + d_{\fu}(\mfa, \fcc(\fu'))\\
        &\quad+ d_{\fu}(\fcc(\fu'), \mfb) + d_{\fu}(\mfb, \fcc(\fu'')) +
        d_{\fu}(\fcc(\fu''), q)\,.
    \end{align*}
    Using \eqref{defdp} and the fact that $\sc(\fu) = \sc(\fu') = \sc(\fu'')$ this equals
    \begin{align*}
        &\quad d_{\fu}(\fcc(\fu), \mfa) + d_{\fu'}(\mfa, \fcc(\fu'))\\
        &\quad+ d_{\fu'}(\fcc(\fu'), \mfb) + d_{\fu''}(\mfb, \fcc(\fu'')) +
        d_{\fu''}(\fcc(\fu''), q)\\
        &< 100 + 100 + 100 + 100 + 1 < 500\,.
    \end{align*}
    Since $4\fp \lesssim 500 \fu$, it follows that $d_{\fp}(\fcc(\fp), q) < 4 < 10$. We have shown that $B_{\fu''}(\fcc(\fu''), 1) \subset B_{\fp}(\fcc(\fp), 10)$, combining this with $\sc(\fu'') = \sc(\fu)$ gives $\fu \sim \fu''$.

    For symmetry suppose that $\fu \sim \fu'$. By Lemma \eqref{relation geometry}, it follows that $\sc(\fu) = \sc(\fu')$ and that there exists $\mfa \in B_{\fu}(\fcc(\fu), 100) \cap B_{\fu'}(\fcc(\fu'), 100)$. Again, for $\fu = \fu'$ symmetry is obvious. If $\fu \ne \fu'$, then there exists $\fp \in \mathfrak{T}_1(\fu')$ with $10\fp\lesssim \fu$. By definition of $\mathfrak{T}_1(\fu')$, Lemma \ref{wiggle order 1} and \eqref{eq sc3}, it follows that
    \begin{equation}
        \label{eq rel1}
        10\fp \lesssim 4\fp \lesssim 500 \fu'\,.
    \end{equation}
    If $q \in B_{\fu}(\fcc(\fu),1)$ then we have from the triangle inequality and the fact that $\sc(\fu) = \sc(\fu')$:
    \begin{align*}
        d_{\fu'}(\fcc(\fu'), q) &\le d_{\fu'}(\fcc(\fu'), \mfa) + d_{\fu'}(\mfa, \fcc(\fu)) + d_{\fu'}(\fcc(\fu), q)\\
        &= d_{\fu'}(\fcc(\fu'), \mfa) + d_{\fu}(\mfa, \fcc(\fu)) + d_{\fu}(\fcc(\fu), q)\\
        &< 100 + 100 + 1 < 500\,.
    \end{align*}
    Combining this with \eqref{eq rel1} and \eqref{wiggleorder}, we get
    \begin{equation*}
     B_{\fu}(\fcc(\fu), 1) \subset B_{\fp}(\fcc(\fp), 10)\, .
    \end{equation*}
    Since $2\fp \lesssim \fu'$, we have $\sc(\fp) \subset \sc(\fu') = \sc(\fu)$. Thus, $10\fp \lesssim \fu$ which completes the proof of $\fu' \sim \fu$.
\end{proof}

Choose a set  $\fU_3(k,n,j)$ of representatives for the equivalence
classes of $\sim$ in $\fU_2(k,n,j)$.
Define for each $\fu\in \fU_3(k,n,j)$
\begin{equation}\label{definesv}
\fT_2(\fu):=
   \bigcup_{\fu\sim \fu'}\mathfrak{T}_1(\fu')\cap \fC_6(k,n,j)\, .
\end{equation}

\begin{lemma}[C6 forest]
\label{C6 forest}
We have
\begin{equation}
    \fC_6(k,n,j)=\bigcup_{\fu\in \fU_3(k,n,j)}\mathfrak{T}_2(\fu)\, .
\end{equation}
\end{lemma}
\begin{proof}
    Let $\fp \in \fC_6(k,n,j)$.
    By \eqref{eq C4 def} and \eqref{defc5}, we have $\fp \in \fC_3(k,n,j)$. By \eqref{eq L2 def} and \eqref{eq C3 def}, there exists $\fu \in \fU_1(k,n,j)$ with $2\fp \lesssim \fu$ and $\sc(\fp) \ne \sc(\fu)$, that is, with $\fp \in \mathfrak{T}_1(\fu)$. Then $\mathfrak{T}_1(\fu)$ is clearly nonempty, so $\fu \in \fU_2(k,n,j)$. By the definition of $\fU_3(k,n,j)$, there exists $\fu' \in \fU_3(k,n,j)$ with $\fu \sim \fu'$. By \eqref{definesv}, we have $\fp \in \mathfrak{T}_2(\fu')$.
\end{proof}

\begin{lemma}[C6 convex]
    \label{C6 convex}
    \uses{forest convex}
    Let $\fu \in \fU_3(k,n,j)$. If $\fp \le \fp' \le \fp''$ and $\fp, \fp'' \in \mathfrak{T}_2(\fu)$, then $\fp' \in \mathfrak{T}_2(\fu)$.
\end{lemma}

\begin{proof}
    Suppose that $\fp, \fp'' \in \mathfrak{T}_2(\fu)$. Then by Lemma \ref{C5 convex}, we have
$\fp' \in \fC_5(k,n,j)$. Since $\fp \in \fC_6(k,n,j)$ we have $\sc(\fp) \not\subset G$, hence $\sc(\fp') \not \subset G$. This implies $\fp' \in \fC_6(k,n,j)$. Since $\fp'' \in \mathfrak{T}_2(\fu)$, we have $2\fp'' \lesssim \fu'$ and $\sc(\fp'')\ne\sc(\fu')$ for some $\fu' \sim \fp''$. By \eqref{eq sc1}, we have $2\fp' \lesssim 2\fp''$, so by transitivity of $\lesssim$ we have $2\fp' \lesssim \fu'$. Finally, $\sc(\fp') \subset \sc(\fp'')$ implies $\sc(\fp') \ne \sc(\fu')$, thus $\fp' \in \mathfrak{T}_1(\fu') \subset \mathfrak{T}_2(\fu)$.
\end{proof}


\begin{lemma}[forest geometry]
    \label{forest geometry}
    For each $\fu\in \fU_3(k,n,j)$,
    the set $\mathfrak{T}_2(\fu)$
    satisfies \eqref{forest1}.
\end{lemma}
\begin{proof}
    Let $\fp \in \mathfrak{T}_2(\fu')$. By \eqref{definesv}, there exists $\fu \sim \fu'$ with $\fp \in \mathfrak{T}_1(\fu)$. Then we have $2\fp \lesssim \fu$ and $\sc(\fp) \ne \sc(\fu)$, so by \eqref{eq sc3} $4\fp \lesssim 500\fu$.
    Further, by Lemma \ref{relation geometry}, we have that $\sc(\fu) = \sc(\fu')$ and there exists $\mfa \in B_{\fu}(\fcc(\fu),100) \cap B_{\fu'}(\fcc(\fu'),100)$.
    Let $\mfb \in B_{\fu'}(\fcc(\fu'), 1)$.
    Using the triangle inequality and the fact that $\sc(\fu)  =\sc(\fu')$, we obtain
    \begin{align*}
        d_{\fu}(\fcc(\fu), \mfb) &\le d_{\fu'}(\fcc(\fu), \mfa) + d_{\fu'}(\fcc(\fu'), \mfa) + d_{\fu'}(\fcc(\fu'), \mfb)\\
        &= d_{\fu}(\fcc(\fu), \mfa) + d_{\fu'}(\fcc(\fu'), \mfa) + d_{\fu'}(\fcc(\fu'), \mfb)\\
        &< 100 + 100 + 1 < 500\,.
    \end{align*}
    Combining this with $4\fp \lesssim 500\fu$, we obtain
    $$
        B_{\fu'}(\fcc(\fu'), 1) \subset B_{\fu}(\fcc(\fu), 500) \subset B_{\fp}(\fcc(\fp), 4)\,.
    $$
    Together with $\sc(\fp) \subset \sc(\fu) = \sc(\fu')$, this gives $4\fp \lesssim 1\fu'$, which is \eqref{forest1}.
\end{proof}

\begin{lemma}[forest convex]
    \label{forest convex}
    For each $\fu\in \fU_3(k,n,j)$,
    the set $\mathfrak{T}_2(\fu)$
    satisfies the convexity condition \eqref{forest2}.
\end{lemma}

\begin{proof}
    Let $\fp, \fp'' \in \mathfrak{T}_2(\fu')$ and $\fp' \in \fP$ with $\fp \le \fp' \le \fp''$. By \eqref{definesv} we have $\fp, \fp'' \in \fC_6(k,n,j) \subset \fC_5(k,n,j)$. By Lemma \ref{C5 convex}, we have $\fp' \in \fC_5(k,n,j)$. Since $\fp \in \fC_6(k,n,j)$ we have $\sc(\fp) \not \subset G'$, so $\sc(\fp') \not \subset G'$ and therefore also $\fp' \in \fC_6(k,n,j)$.

    By \eqref{definesv} there exists $\fu \in \fU_1(k,n,j)$ with $\fp'' \in \mathfrak{T}_1(\fu)$ and hence $2\fp'' \lesssim \fu$ and $\sc(\fp'') \ne \sc(\fu)$. Together this implies $\sc(\fp'') \subsetneq \sc(\fu)$. With the inclusion $\sc(\fp') \subset \sc(\fp'')$ from $\fp' \le \fp''$, it follows that $\sc(\fp') \subsetneq \sc(\fu)$ and hence $\sc(\fp') \ne \sc(\fu)$.
    By \eqref{eq sc1} and transitivity of $\lesssim$ we further have $2\fp' \lesssim \fu$, so $\fp' \in \mathfrak{T}_1(\fu)$.
    It follows that $\fp' \in \mathfrak{T}_2(\fu')$, which shows \eqref{forest2}.
\end{proof}

\begin{lemma}[forest separation]
    \label{forest separation}
    For each $\fu,\fu'\in \fU_3(k,n,j)$ with $\fu\neq \fu'$ and
    and each $\fp \in \fT_2(\fu)$
    with $\sc(\fp)\subset \sc(\fu')$ we have
    \begin{equation}
    d_{\fp}(\fcc(\fp), \fcc(\fu')) > 2^{Z(n+1)}\,.
    \end{equation}
\end{lemma}

\begin{proof}
    By the definition \eqref{eq C2 def} of $\fC_2(k,n,j)$, there exists a tile $\fp' \in \fC_1(k,n,j)$ with $\fp' \le \fp$ and $\ps(\fp') = \ps(\fp)- Z(n+1)$.
    By Lemma \ref{monotone cube metrics} we have
    $$
        d_{\fp}(\fcc(\fp), \fcc(\fu')) \ge 2^{95a Z(n+1)} d_{\fp'}(\fcc(\fp), \fcc(\fu'))\,.
    $$
    By \eqref{eq sc1} we have $2\fp' \lesssim 2\fp$, so by transitivity of $\lesssim$ there exists $\mathfrak{v} \sim \fu$ with $2\fp' \lesssim \mathfrak{v}$ and $\sc(\fp') \ne \sc(\mathfrak{v})$. Since $\fu, \fu'$ are not equivalent under $\sim$, we have $\mathfrak{v} \not \sim \fu'$, thus $10\fp' \not\lesssim \fu'$. This implies that there exists $q \in B_{\fu'}(\fcc(\fu'), 1) \setminus B_{\fp'}(\fcc(\fp'), 10)$.

    From $\fp' \le \fp$, $\sc(\fp') \subset \sc(\fp) \subset \sc(\fu')$ and Lemma \ref{monotone cube metrics} it then follows that
    \begin{align*}
        &\quad d_{\fp'}(\fcc(\fp), \fcc(\fu'))\\
        &\ge -d_{\fp'}(\fcc(\fp), \fcc(\fp')) + d_{\fp'}(\fcc(\fp'), q) - d_{\fp'}(q, \fcc(\fu'))\\
        &\ge -d_{\fp'}(\fcc(\fp), \fcc(\fp')) + d_{\fp'}(\fcc(\fp'), q) - d_{\fu'}(q, \fcc(\fu'))\\
        &> -1 + 10 - 1 = 8\,.
    \end{align*}
    The Lemma follows by combining the two displays with the fact that $95 a \ge 1$.
\end{proof}

\begin{lemma}[forest inner]
    \label{forest inner}
    For each $\fu\in \fU_3(k,n,j)$
    and each $\fp \in \mathfrak{T}_2(\fu)$
    we have
    \begin{equation}
        B(\pc(\fp)), 8 D^{\ps(\fp)}) \subset \sc(\fu).
    \end{equation}
\end{lemma}

\begin{proof}
    Let $\fp \in \mathfrak{T}_2(\fu)$. Let $\fq$ be a maximal element with respect to $\le$ in
    $$
        \bigcup_{\fu \sim \fu'} \mathfrak{T}_1(\fu') \cap \fC_3(k,n,j)\,.
    $$
    We now show that there is no $\fq' \in \fC_3(k,n,j)$ with $\fq \le \fq'$ and $\fq \ne \fq'$. Indeed, suppose $\fq'$ was such a tile. Then $2\fq' \not \lesssim \fu'$ for any $\fu' \sim \fu$, by maximality of $\fq$. But by \eqref{eq C3 def} there exists $\fu'' \in \fU_1(k,n,j)$ with $2\fq' \lesssim \fu''$. By Lemma \ref{wiggle order 1}, this implies $\fu \sim \fu''$, so $\fq' \in \mathfrak{T}_2(\fu)$, a contradiction.

    By Lemma \ref{relation geometry}, we have $\ps(\fq) < \ps(\fu)$. By definition of $\fC_4(k,n,j)$, $\fp$ is not in any of the maximal $Z(n+1)$ layers of tiles in $\fC_3(k,n,j)$, and hence $\ps(\fp) \le \ps(\fq) - Z(n+1) \le \ps(\fu) - Z(n+1) - 1$.

    Thus, there exists some cube $I \in \mathcal{D}$ with $s(I) = \ps(\fu) - Z(n+1) - 1$ and $I \subset \sc(\fu)$ and $\sc(\fp) \subset I$. Since $\fp \in \fC_5(k,n,j)$, we have that $I \notin \mathcal{L}(\fu)$, so $B(c(I), 8D^{s(I)}) \subset \sc(\fu)$. By the triangle inequality, \eqref{defineD} and $a \ge 4$, the same then holds for the subcube $\sc(\fp) \subset I$.
\end{proof}


\begin{lemma}[forest stacking]
    \label{forest stacking}
    It holds that
    \begin{equation}
        \sum_{\fu \in \fU_3(k,n,j)} \mathbf{1}_{\sc(\fu)} \le 1 + (4n+12)2^{n}\,.
    \end{equation}
\end{lemma}

\begin{proof}
    Suppose that a point $x$ is contained in more than $1 + (4n + 12)2^n$ cubes $\sc(\fu)$ with $\fu \in \fU_3(k,n,j)$. Since $\fU_3(k,n,j) \subset \fC_1(k,n,j)$ for each such $\fu$, there exist $\mathfrak{m}(\fu) \in \mathfrak{M}(k,n)$ with $\fu \le \mathfrak{m}(\fu)$. The map $\fu \mapsto\mathfrak{m}(\fu)$ is injective: If $\fu \le \mathfrak{m}$ and $\fu' \le \mathfrak{m}$, then $\sc(\fu) \subset \sc(\fu')$ or $\sc(\fu') \subset \sc(\fu)$ by \eqref{dyadicproperty}. Hence, by \eqref{defunkj}, $B_{\fu}(\fcc(\fu),100) \cap B_{\fu'}(\fcc(\fu'), 100) = \emptyset$. This contradicts $\Omega(\mathfrak{m})$ being contained in both sets. Thus $x$ is contained in at least $1 + (4n + 12)2^n$ cubes $\sc(\mathfrak{m})$, $\mathfrak{m} \in \mathfrak{M}(k,n)$. Consequently, we have by \eqref{eq Aoverlap def} that $x \in A(2n + 6, k,n) \subset G_2$. Let $\sc(\fu)$ be an inclusion minimal cube among the $\sc(\fu'), \fu' \in \fU_3(k,n,j)$ with $x \in \sc(\fu)$. By the dyadic property \eqref{dyadicproperty}, we have $\sc(\fu) \subset \sc(\fu')$ for all cubes $\sc(\fu')$ containing $x$. Thus
    $$
        \sc(\fu) \subset \{y \ : \ \sum_{\fu \in \fU_3(k,n,j)} \mathbf{1}_{\sc(\fu)}(y) > 1 + (4n+12)2^{n}\} \subset G_2\,.
    $$
    Thus $\mathfrak{T}_1(k,n,j) \cap \fC_6(k,n,j) = \emptyset$.
    This contradicts $\fu \in \fU_2(k,n,j)$.
\end{proof}

\begin{proof}[Proof of Lemma \ref{forest union}]
    We first fix $k,n, j$.
    By \eqref{definetp} and \eqref{definedE}, we have that
    $\mathbf{1}_{\sc(\fp)} T_{\fp}f(x) = T_{\fp}f(x)$ and hence $\overline{g(x)} T_{\fp}f(x)= 0$ for all $\fp \in \fC_5(k,n,j) \setminus \fC_6(k,n,j)$.
    Thus it suffices to estimate the contribution of the sets $\fC_6(k,n,j)$. By Lemma \ref{forest stacking}, we can decompose $\fU_3(k,n,j)$ as a disjoint union of at most $4n + 13$ collections $\fU_4(k,n,j,l)$, $1 \le l \le 4n+13$, each satisfying
    $$
        \sum_{\fu \in \fU_4(k,n,j,l} \mathbf{1}_{\sc(\fu)} \le 2^n\,.
    $$
    By Lemmas \ref{forest geometry}, \ref{forest convex}, \ref{forest separation}, \ref{forest inner} and \ref{C dens1}, the pairs
    $$
        (\fU_4(k,n,j,l), \mathfrak{T}_2|_{\fU_4(k,n,j,l)})
    $$
    are $n$-forests for each $k,n,j,l$, and by Lemma \ref{C6 forest}, we have
    $$
        \fC_6(k,n,j) = \bigcup_{l = 1}^{4n + 13} \bigcup_{\fu \in \fU_4(k,n,j,l)} \mathfrak{T}_2(\fu)\,.
    $$
    Since $\sc(\fp) \not\subset G_1$ for all $\fp \in \fC_6(k,n,j)$, we have $\fC_6(k,n,j) \cap \fP_{F,G} = \emptyset$ and hence
    $$
        \dens_2(\bigcup_{\fu \in \fU_4(k,n,j,l)} \mathfrak{T}_2(\fu)) \le 2^{2a + 5} \frac{\mu(F)}{\mu(G)}\,.
    $$
    Using the triangle inequality according to the splitting by $k,n,j$ and $l$ in \eqref{disclesssim1} and applying Proposition \ref{forest operator} to each term, we obtain the estimate
    $$
        \sum_{k \ge 0}\sum_{n \ge k} (2n+3)(4n+13) 2^{257a^3}2^{-(1-\frac{1}{q})n}(2^{2a+5} \frac{\mu(F)}{\mu(G)})^{\frac{1}{q} - \frac{1}{2}} \|f\|_2 \|\mathbf{1}_{G\setminus G'}\|_2
    $$
    for the left hand side of \eqref{disclesssim1}. Since $|f| \le \mathbf{1}_F$, we have $\|f\|_2 \le \mu(F)^{1/2}$, and we have $\|\mathbf{1}_{G\setminus G'}\|_2 \le \mu(G)^{1/2}$. Combining this with $a \ge 4$, we estimate by
    $$
        2^{258a^3} \mu(F)^{\frac{1}{q}} \mu(G)^{\frac{1}{q'}} \sum_{k \ge 0}\sum_{n \ge k}n^2 2^{-(1-\frac{1}{q})n}\,.
    $$
    Interchanging the order of summation, the sum equals
    $$
        \sum_{n \ge 0} n^2(n+1) 2^{-\frac{q-1}{q}n} \le \frac{2^{2a^3}}{(q-1)^3}\,,
    $$
    which completes the proof of the lemma.
\end{proof}

\section{Proof of Lemma \ref{forest complement}, the antichains}
\label{subsecantichain}

Define $\fP_{X \setminus G'}$ to be the set of all $\fp \in \fP$ such that $\sc(\fp) \not \subset G'$.
\begin{lemma}[antichain decomposition]
\label{antichain decomposition}
    We have that
    \begin{align}
        \label{eq fp' decomposition}
        &\quad \fP_2 \cap \fP_{X \setminus G'}\\
        &=  \bigcup_{k \ge 0} \bigcup_{n \ge k} \fL_0(k,n) \cap \fP_{X \setminus G'} \\
        &\quad\cup \bigcup_{k \ge 0} \bigcup_{n \ge k}\bigcup_{0 \le j \le 2n+3} \fL_2(k,n,j) \cap \fP_{X \setminus G'}\\
        &\quad\cup  \bigcup_{k \ge 0} \bigcup_{n \ge k}\bigcup_{0 \le j \le 2n+3} \bigcup_{0 \le l \le Z(n+1)} \fL_1(k,n,j,l) \cap \fP_{X \setminus G'}\\
        &\quad\cup  \bigcup_{k \ge 0} \bigcup_{n \ge k}\bigcup_{0 \le j \le 2n+3} \bigcup_{0 \le l \le Z(n+1)}  \fL_3(k,n,j,l)\cap \fP_{X \setminus G'}\,.
    \end{align}
\end{lemma}

\begin{proof}
    Let $\fp \in \fP_2 \cap \fP_{X \setminus G'}$. Clearly, for every cube $J \in \mathcal{D}$ there exists some $k \ge 0$ such that \eqref{muhj1} holds, and for no cube $J \in \mathcal{D}$ and no $k < 0$ does \eqref{muhj2} hold. Thus $\fp \in \fP(k)$ for some $k \ge 0$.

    Next, since $E_2(\lambda, \fp') \subset \sc(\fp')\cap G$ for every $\lambda \ge 2$ and every tile $\fp' \in \fP(k)$ with $\lambda\fp \lesssim \lambda \fp'$, it follows from \eqref{muhj2} that $\mu(E_2(\lambda, \fp')) \le 2^{-k} \mu(\sc(\fp'))$ for every such $\fp'$, so $\dens_k'(\{\fp\}) \le 2^{-k}$. Combining this with $a \ge 0$, it follows from \eqref{def cnk} that there exists $n\ge k$ with $\fp \in \fC(k,n)$.

    Since $\fp \in \fP_{X \setminus G'}$, we have in particular $\fp \not \subset A(2n + 6, k, n)$, so there exist at most $1 + (4n + 12)2^n < 2^{2n+4}$ tiles $\mathfrak{m} \in \mathfrak{M}(k,n)$ with $\fp \le \mathfrak{m}$. It follows that $\fp \in \fL_0(k,n)$ or $\fp \in \fC_1(k,n,j)$ for some $1 \le j \le 2n + 3$. In the former case we are done, in the latter case the inclusion to be shown follows immediately from the definitions of the collections $\fC_i$ and $\fL_i$.
\end{proof}

\begin{lemma}[L0 antichain]
\label{L0 antichain}
    We have that
    $$
        \fL_0(k,n) = \dot{\bigcup_{1 \le l \le n}} \fL_0(k,n,l)\,,
    $$
    where each $\fL_0(k,n,l)$ is an antichain.
\end{lemma}

\begin{proof}
    It suffices to show that $\fL_0(k,n)$ contains no chain of length $n + 1$. Suppose that we had such a chain $\fp_0 \le \fp_1 \le \dotsb \le \fp_{n}$ with $\fp_i \ne \fp_{i+1}$ for $i  =0, \dotsc, n-1$. By \eqref{def cnk}, we have that $\dens_k'(\{\fp_n\}) > 2^{-n}$. Thus, by \eqref{eq densdef}, there exists $\fp' \in \fP(k)$ and $\lambda \ge 2$ with $\lambda \fp_n \le \lambda \fp'$ and
    \begin{equation}
        \label{eq p'}
        \frac{\mu(E_2(\lambda, \fp'))}{\mu(\sc(\fp'))} > \lambda^{a} 2^{4a} 2^{-n}\,.
    \end{equation}
    Let $\mathfrak{O}$ be the set of all $\fp'' \in \fP_k$ such that we have $ \sc(\fp'') = \sc(\fp')$ and $B_{\fp'}(\fcc(\fp'), \lambda) \cap \Omega(\fp'') \neq \emptyset$.
    We now show that
    \begin{equation}
        \label{eq O bound}
        |\mathfrak{O}| \le 2^{4a}\lambda^a\,.
    \end{equation}
    The balls $B_{\fp'}(\fcc(\fp''), 0.2)$, $\fp'' \in \mathfrak{O}$ are disjoint by \eqref{eq freq comp ball}, and by the triangle inequality contained in $B_{\fp'}(\fcc(\fp'), \lambda+1)$. By assumption the \eqref{thirddb} on $\Theta$, this ball can be covered with
    $$
        2^{a(\lceil \log_2(\lambda+1)\rceil + 2)} \le 2^{a(\log_2(\lambda) + 4)} = 2^{4a}\lambda^a
    $$ many $d_{\fp'}$-balls of radius $1/4$. By the triangle inequality, each such ball contains at most one $\fcc(\fp'')$, and each $\fcc(\fp'')$ is contained in one of the balls. Thus we get \eqref{eq O bound}.

    By \eqref{definee1} and \eqref{definee2} we have $E_2(\lambda, \fp') \subset \bigcup_{\fp'' \in \mathfrak{O}} E_1(\fp'')$, thus
    $$
        2^{4a}\lambda^a 2^{-n} < \sum_{\fp'' \in \mathfrak{O}} \frac{\mu(E_1(\fp''))}{\mu(\sc(\fp''))}\,.
    $$
    Hence there exists a tile $\fp'' \in \mathfrak{O}$ with
    \begin{equation*}
        \mu(E_1(\fp'')) \ge 2^{-n} \mu(\sc(\fp'))\,.
    \end{equation*}
    By the definition \eqref{mnkmax} of $\mathfrak{M}(k,n)$, there exists a tile $\mathfrak{m} \in \mathfrak{M}(k,n)$ with $\fp' \leq \mathfrak{m}$. From \eqref{eq p'}, the inclusion $E_2(\lambda, \fp') \subset \sc(\fp')$ and $a\ge 1$ we obtain
    $$
        2^n \geq 2^{4a} \lambda^{a} \geq \lambda\,.
    $$
    From the triangle inequality, Lemma \ref{monotone cube metrics} and $a \ge 1$, we now obtain for all $\mfa \in B_{\mathfrak{m}}(\fcc(\mathfrak{m}), 100)$ that
    \begin{align*}
        &\quad d_{\fp_0}(\fcc(\fp_0), \mfa)\\
        &\leq d_{\fp_0}(\fcc(\fp_0), \fcc(\fp_{n}))  + d_{\fp_0}(\fcc(\fp_{n}), \fcc(\fp'))  + d_{\fp_0}(\fcc(\fp'), \fcc(\fp''))\\
        &\quad+ d_{\fp_0}(\fcc(\fp''), \fcc(\mathfrak{m})) +
        d_{\fp_0}(\fcc(\mathfrak{m}), \mfa)\\
        &\leq 1 + 2^{-95an} (d_{\fp_{n}}(\fcc(\fp_n), \fcc(\fp'))  + d_{\fp'}(\fcc(\fp'), \fcc(\fp''))\\
        &\quad+ d_{\fp''}(\fcc(\fp''), \fcc(\mathfrak{m})) +
        d_{\mathfrak{m}}(\fcc(\mathfrak{m}), \mfa))\\
        &\leq 1 + 2^{-95an}(\lambda + (\lambda + 1) + 1 + 100) \leq 2\,.
    \end{align*}
    Thus, by \eqref{straightorder}, $2\fp_0 \leq 100\mathfrak{m}$, a contradiction to $\fp_0 \notin \fC(k,n)$.
\end{proof}

\begin{lemma}[L2 antichain]
\label{L2 antichain}
    Each of the sets $\fL_2(k,n,j)$ is an antichain.
\end{lemma}

\begin{proof}
    Suppose that there are $\fp_0, \fp_1 \in \fL_2(k,n,j)$ with $\fp_0 \ne \fp_1$ and $\fp_0 \le \fp_1$. By Lemma \ref{wiggle order 1} and Lemma \ref{wiggle order 2}, it follows that $2\fp_0 \lesssim 200\fp_1$. Since $\fL_2(k,n,j)$ is finite, there exists a maximal $l \ge 1$ such that there exists a chain $2\fp_0 \lesssim 200 \fp_1 \lesssim \dotsb \lesssim 200 \fp_l$ with $\fp_i \ne \fp_{i+1}$ for $i = 0, \dotsc, l-1$.
    If we have $\fp_l \in \fU_1(k,n,j)$, then it follows from $2\fp \lesssim 200 \fp_l \lesssim \fp_l$ and \eqref{eq L2 def} that $\fp \not\in \fL_2(k,n,j)$, a contradiction. Thus, by the definition \eqref{defunkj}  of $\fU_1(k,n,j)$, there exists $\fp_{l+1} \in \fC_1(k,n,j)$ with $\sc(\fp_l) \subsetneq \sc(\fp_{l+1}) $ and $\mfa \in B_{\fp_l}(\fcc(\fp_l), 100) \cap B_{\fp_{l+1}}(\fcc(\fp_{l+1}), 100)$. Using the triangle inequality and Lemma \ref{monotone cube metrics}, one deduces that $200 \fp_l \lesssim 200\fp_{l+1}$. This contradicts maximality of $l$.
\end{proof}

\begin{lemma}[L1 L3 antichainf]
\label{L1 L3 antichain}
    Each of the sets $\fL_1(k,n,j,l)$ and $\fL_3(k,n,j,l)$ is an antichain.
\end{lemma}

\begin{proof}
    By its definition \eqref{eq L1 def}, each set $\fL_1(k,n,j,l)$ is a set of minimal elements in some set of tiles with respect to $\le$. If there were distinct $\fp, \fq \in \fL_1(k,n,j,l)$ with $\fp \le \fq$, then $\fq$ would not be minimal. Hence such $\fp, \fq$ do not exist. Similarly, be \eqref{eq L3 def}, each set $\fL_3(k,n,j,l)$ is a set of maximal elements in some set of tiles with respect to $\le$. If there were distinct $\fp, \fq \in \fL_3(k,n,j,l)$ with $\fp \le \fq$, then $\fp$ would not be maximal.
\end{proof}

\begin{proof}[Proof of Lemma \ref{forest complement}]
    If $\fp \not\in \fP_{X \setminus G'}$, then $\sc(\fp) \subset G'$. By \eqref{definetp} and \eqref{definee1}, it follows that
    $\mathbf{1}_{G \setminus G'} T_{\fp}f(x) = 0$. We thus have
    $$
        \mathbf{1}_{G\setminus G'} \sum_{\fp \in \fP_2} T_{\fp}f(x) = \mathbf{1}_{G\setminus G'} \sum_{\fp \in \fP_2 \cap \fP_{X \setminus G'}} T_{\fp}f(x)\,.
    $$
    Let $\fL(k,n)$ denote any of the terms $\fL_i(k,n,j,l) \cap \fP_{X \setminus \fP_2}$ on the right hand side of \eqref{eq fp' decomposition}, where the indices $j, l$ may be void. Then $\fL(k,n)$ is an antichain, by the three preceding lemmas. Further, we have
    \begin{equation*}
    \dens_1(\fL(k,n)) \le 2^{4a+1 - n}
    \end{equation*}
    by Lemma \ref{C dens1}, and we have
    \begin{equation*}
     \dens_2(\fL(k,n)) \le 2^{2a+5} \frac{\mu(F)}{\mu(G)},
     \end{equation*}
     since
     \begin{equation*}
     \fL(k,n) \cap \fP_{F,G} \subset \fP_{X \setminus \fP_2} \cap \fP_{F, G} = \emptyset.
     \end{equation*}

    Applying now the triangle inequality according to the decomposition in Lemma \ref{antichain decomposition}, and then applying Proposition \ref{antichain operator} to each term, we obtain the estimate
    \begin{multline*}
        \le \sum_{k \ge 0} \sum_{n \ge k} (n + (2n+4) + 2(2n+4) Z(n+1)) \\
        \times 2^{201a^3}(q-1)^{-1} (2^{4a+1-n})^{\frac{q-1}{8a^4}} (2^{2a+5} \frac{\mu(F)}{\mu(G)})^{\frac{1}{q} - \frac{1}{2}} \|f\|_2\|\mathbf{1}_{G\setminus G'}\|_2\,.
    \end{multline*}
    Because $|f| \le \mathbf{1}_F$, we have $\|f\|_2 \le \mu(F)^{1/2}$, and we have $\|\mathbf{1}_{G\setminus G'}\|_2 \le \mu(G)^{1/2}$. Using this and \eqref{defineZ}, we bound
    $$
        \le 2^{202a^3} (q - 1)^{-1} \mu(F)^{\frac{1}{q}} \mu(G)^{\frac{1}{q'}}  \sum_{k \ge 0} \sum_{n \ge k} n^2 2^{-n\frac{q-1}{8a^4}}\,.
    $$
    The last sum equals, by changing the order of summation,
    $$
        \sum_{n \ge 0} n^2(n+1) 2^{-n\frac{q-1}{8a^4}} \le \frac{2^{8a^3}}{(q-1)^3}\,.
    $$
    This completes the proof.
\end{proof}

\chapter{Proof of  Proposition \ref{antichain operator}}

\label{antichainboundary}

Let an antichain $\mathfrak{A}$
and functions $f$, $g$ as in Proposition \ref{antichain operator} be given.
We prove \eqref{eq antiprop}
in Subsection \ref{sec TT* T*T}
as the geometric mean of two inequalities,
each involving one of the two densities.
One of these two inequalities will need a careful estimate formulated in
Lemma \ref{tile correlation} of
the $TT^*$ correlation between two tile operators of two tiles.
Lemma \ref{tile correlation} will be proven in
Subsection \ref{sec tile operator}.
The summation of the contributions of these individual correlations will require a
geometric Lemma \ref{antichain tile count} counting the relevant tile pairs.
Lemma \ref{antichain tile count} will be proven in Subsection
\ref{subsec geolem}.






\section{The density  arguments}\label{sec TT* T*T}

We begin with the following crucial disjointedness property of the sets $E(\fp)$ with $\fp \in \mathfrak{A}$.
\begin{lemma}[tile disjointness]
\label{tile disjointness}
Let $\fp,\fp'\in \mathfrak{A}$.
If there exists an $x\in X$ with $x\in  E(\fp)\cap E(\fp')$,
then $\fp= \fp'$.
\end{lemma}
\begin{proof}
Let $\fp,\fp'$ and $x$ be given.
Assume without loss of generality that $\ps(\fp)\le \ps(\fp')$.
As we have $x\in E(\fp)\subset \sc(\fp)$  and $x\in E(\fp')\subset \sc(\fp')$ by Definition \eqref{defineep}, we conclude
for $i=1,2$ that
$\tQ(x)\in\fc(\fp)$ and $\tQ(x)\in\fc(\fp')$. By \eqref{eq freq dyadic} we have $\fc(\fp')\subset \fc(\fp)$. By Definition
\eqref{straightorder}, we conclude $\fp\le \fp'$. As $\mathfrak{A}$ is an antichain, we conclude $\fp=\fp'$.
This proves the lemma.
\end{proof}



Let $\mathcal{B}$ be the collection of balls
\begin{equation}
    B(\pc(\fp), 8D^{\ps(\fp)})
\end{equation}
with $\fp\in \mathfrak{A}$ and recall the definition of
$M_{\mathcal{B}}$ from Proposition \ref{Hardy Littlewood}.
\begin{lemma}[maximal bound antichain]\label{maximal bound antichain}
\uses{tile disjointness}
Let $x\in X$.
Then
\begin{equation}\label{hlmbound}
  | \sum_{\fp \in \mathfrak{A}}T_{\fp} f(x)|\le 2^{107 a^3} M_{\mathcal{B}} f (x) \, .
\end{equation}
\end{lemma}



\begin{proof}
Fix $x\in X$.  By Lemma \ref{tile disjointness}, there is at most one $\fp \in \mathfrak{A}$
such that
 $T_{\fp} f(x)$ is not zero.
 If there is no such $\fp$, the estimate \eqref{hlmbound} follows.

 Assume there is such a $\fp$.
 By definition of $T_{\fp}$ we have $x\in E(\fp)\subset \sc(\fp)$ and  by the squeezing property \eqref{eq vol sp cube}
\begin{equation}\label{eqtttt0}
    \rho(x, \pc(\fp))\le 4D^{\ps(\fp)}\, .
\end{equation}

Let $y\in X$ with  $K_{\ps(\fp)}(x,y)\neq 0$. By Definition \eqref{defks} of $K_{\ps(\fp)}$
we have
\begin{equation}\label{supp Ks1}
   \frac{1}{4} D^{\ps(\fp)-1}
   \leq \rho(x,y) \leq \frac{1}{2} D^{\ps(\fp)}\, .
\end{equation}
The triangle inequality with \eqref{eqtttt0} and \eqref{supp Ks1} implies
\begin{equation}
    \rho(\pc(\fp),y)\le 8D^{\ps(\fp)}\, .
\end{equation}
Using the kernel bound \eqref{eqkernel size} and the lower bound in \eqref{supp Ks}
we obtain
\begin{equation}
|K_{\ps(\fp)}(x,y)|\le \frac{2^{a^3}}{\mu(B(x,\frac 14 D^{{\ps(\fp)}-1}))}\, .
\end{equation}
Using $D=2^{100a^2}$
and the doubling property \eqref{doublingx} $5 +100a^2$ times estimates
the last display by
\begin{equation}
\le \frac{2^{5a+101a^3}}{\mu(B(x,  8D^{\ps(\fp)}))}\, .
\end{equation}
 Using that {$|e(\mfa)|$} is bounded by $1$
for every $\mfa\in \Mf$, we estimate with the triangle inequality and the above information
 \begin{equation}
  | T_{\fp} f(x)|
    \le \frac{2^{5a+101 a^3}}{\mu(B(x, 8D^{\ps(\fp)}))} \int _{\mu(B(x, 8D^{\ps(\fp)}))} |f(y)|\, dy   \end{equation}
This together with $a\ge 1$ proves the Lemma.
\end{proof}

Set
\begin{equation}
    \tilde{q}=\frac {2q}{1+q}\,.
\end{equation}
Since $1< q\le 2$, we have $1<\tilde{q}<q\le 2$.
\begin{lemma}[dens2 antichain]
\label{dens2 antichain}
\uses{,Hardy Littlewood,maximal bound antichain}
We have that
\begin{equation}\label{eqttt9}
  \left|\int \overline{g(x)} \sum_{\fp \in \mathfrak{A}} T_{\fp} f(x)\, d\mu(x)\right|\le
  2^{111a^2}({q}-1)^{-1} \dens_2(\mathfrak{A})^{\frac 1{\tilde{q}}-\frac 12} \|f\|_2\|g\|_2\, .
\end{equation}
\end{lemma}
\begin{proof}
We have $f=\mathbf{1}_Ff$. Using H\"older's inequality, we obtain for
each $x\in B'$ and each $B'\in \mathcal{B}$ using $1<\tilde{q}\le 2$
\begin{equation}
    \frac 1{\mu(B')}\int_{B'} |f(y)|\, d\mu(y)d\mu(y)
\end{equation}
\begin{equation}
    \le
    \left(\frac 1{\mu(B')}\int_{B'} |f(y)|^{\frac {2{\tilde{q}}}{3\tilde{q}-2}}\, d\mu(y)\right)^{\frac 32-\frac 1{\tilde{q}}}
    \left(\frac 1{\mu(B')}\int_{B'} \mathbf{1}_F(y)\, d\mu(y)\right)^{\frac 1{\tilde{q}}-\frac 12}
\end{equation}
\begin{equation}
    \le \left(M_{\mathcal{B}} (|f|^{\frac {2{\tilde{q}}}{3{\tilde{q}}-2}})(x)\right)^{\frac 32-\frac 1{\tilde{q}}}
\dens_2(\mathfrak{A})^{\frac 1{\tilde{q}}-\frac 12}\, .
\end{equation}
Taking the maximum over all $B'$ containing $x$, we obtain
\begin{equation} \label{eqttt1}
    M_{\mathcal{B}}|f|\le
    M_{\mathcal{B},\frac {2{\tilde{q}}}{3{\tilde{q}}-2} } |f|
    \dens_2(\mathfrak{A})^{\frac 1{\tilde{q}}-\frac 12}\, .
\end{equation}
We have with Proposition \ref{Hardy Littlewood}
\begin{equation}
\left\|M_{\mathcal{B}, \frac {2q}{3q-2}} f\right\|_2\le 2^{2a}(3\tilde{q}-2)(2\tilde{q}-2)^{-1}\|f\|_2\, .
\end{equation}
Using $1<\tilde{q}\le 2$ estimates the last display by
\begin{equation}\label{eqttt2}
 2^{2a+2} (\tilde{q}-1)^{-1}  \|f\|_2\, .
\end{equation}
We obtain with Cauchy-Schwarz
and then Lemma \ref{maximal bound antichain}
 \begin{equation}
     |\int \overline{g(x)} \sum_{\fp \in \mathfrak{A}} T_{\fp} f(x)\, d\mu(x)|
\end{equation}
 \begin{equation}
     \le \|g\|_2 \Big\| \sum_{\fp \in \mathfrak{A}} T_{\fp} f \Big\|_2
\end{equation}
 \begin{equation}
     \le 2^{107a^2}\|g\|_2 \|  M_{\mathcal{B}}f \|_2
\end{equation}
With \eqref{eqttt1} and
\eqref{eqttt2} we can estimate the last display by
\begin{equation}
    \le 2^{107a^2+2a+2}(\tilde{q}-1)^{-1} \|g\|_2 \|f\|_2\dens_2(\mathfrak{A})^{\frac 1{\tilde{q}}-\frac 12}
\end{equation}
Using $a\ge 4$ and
$(\tilde q - 1)^{-1} = (q+1)/(q-1) \le 3(q-1)^{-1}$
proves the lemma.
\end{proof}


\begin{lemma}[dens1 antichain]\label{dens1 antichain}
\uses{Hardy Littlewood, tile disjointness, tile correlation,antichain tile count}
Set $p:=4a^4$. We have
    \begin{equation}\label{eqttt3}
  \left|\int \overline{g(x)} \sum_{\fp \in \mathfrak{A}} T_{\fp} f(x)\, d\mu(x)\right|\le
   2^{150a^3}\dens_1(\mathfrak{A})^{\frac 1{2p}} \|f\|_2\|g\|_2\,.
\end{equation}
\end{lemma}



\begin{proof}

 We write for the expression inside the absolute values on the left-hand side of \eqref{eqttt3}
\begin{equation}
  \sum_{\fp \in \mathfrak{A}}\iint \overline{g(x)} \mathbf{1}_{E(\fp)}(x)
  {K_{\ps(\fp)}(x,y)}e(\tQ(x)(y) -
   \tQ(x)(x))
   f(y)\, d\mu(y)\,d\mu(x)
\end{equation}
\begin{equation}
  =\int \sum_{\fp \in \mathfrak{A}} \overline{T_{\fp} ^*g(y)}   f(y)\, d\mu(y)
\end{equation}
with the adjoint operator
\begin{equation}\label{eq tstarwritten}
    T_{\fp}^*g(y)=\int_{E(\fp)} \overline{K_{\ps(\fp)}(x,y)}e(-\tQ(x)(y)+
    \tQ(x)(x))g(x)\, d\mu(x)\, .
\end{equation}





 We have by expanding the square
\begin{equation}
    \int \Big|\sum_{\fp\in \mathfrak{A}}T^*_{\fp}g(y)\Big|^2\, d\mu(y)=
    \int \left(\sum_{\fp\in \mathfrak{A}} T^*_{\fp}g(y)\right)
    \left(\sum_{\fp'\in \mathfrak{A}}\overline{T^*_{\fp'}g(y)}\right)\, d\mu(y)
\end{equation}\label{eqtts1}
\begin{equation}
    \le \sum_{\fp\in \mathfrak{A}} \sum_{\fp'\in \mathfrak{A}}
    \Big|\int T^*_{\fp}g(y)\overline{T^*_{\fp'}g(y)}\, d\mu(y)\Big|\,.
\end{equation}
We split the sum into the terms with $\ps(\fp')\le \ps(\fp)$
and $\ps(\fp)< \ps(\fp')$. Using the symmetry of each summand,
we may switch $\fp$ and $\fp'$ in the second sum. Using further positivity
of each summand to replace the condition $\ps(\fp')< \ps(\fp)$
by $\ps(\fp')\le  \ps(\fp)$ in the second sum, we estimate \eqref{eqtts1} by
\begin{equation}\label{eqtts2}
    \le2 \sum_{\fp\in \mathfrak{A}} \sum_{\fp'\in \mathfrak{A}: \ps(\fp')\le \ps(\fp)}
    \Big|\int T^*_{\fp}g(y)\overline{T^*_{\fp'}g(y)}\, d\mu(y)\Big|\,.
\end{equation}
The following basic $TT^*$ estimate will be proved in Subsection \ref{sec tile operator}.
\begin{lemma}[tile correlation]
    \label{tile correlation}
    \uses{Holder van der Corput,correlation kernel bound,tile uncertainty,tile range support}
    Let $\fp, \fp'\in \fP$ with
    $\ps({\fp'})\leq \ps({\fp})$.
    Then
    \begin{equation}
        \label{eq basic TT* est}
        \left|\int T^*_{\fp'}g\overline{T^*_{\fp}g}\right|
    \end{equation}
    \begin{equation}
        \le 2^{255a^3}\frac{(1+d_{\fp'}(\fcc(\fp'), \fcc(\fp))^{-1/(2a^2+a^3)}}{\mu(\sc(\fp))}\int_{E(\fp')}|g|\int_{E(\fp)}|g|\,.
    \end{equation}
    Moreover, the term   \eqref{eq basic TT* est} vanishes unless
    \begin{equation}
        \sc(\fp') \subset B(\pc(\fp), 15D^{\ps(\fp)})\, .
    \end{equation}
\end{lemma}
Define for $\fp\in \fP$
\begin{equation}
    B(\fp):=B(\pc(\fp), 15D^{\ps(\fp)})
\end{equation}
and define
\begin{equation}
    \label{eq Dp definition}
    \mathfrak{A}(\fp):=\{\fp'\in\mathfrak{A}: \ps(\fp')\leq \ps(\fp) \land  \sc(\fp') \subset B(\fp)\}.
\end{equation}
Note that by the squeezing property \eqref{eq vol sp cube}
and the doubling property \eqref{doublingx} applied
$6$ times we have
\begin{equation}\label{eqttt4}
    \mu(B(\fp))\le 2^{6a} \mu(\sc(\fp))\, .
\end{equation}
Using Lemma \ref{tile correlation} and \eqref{eqttt4}, we estimate \eqref{eqtts2} by
\begin{equation}\label{eqtts3}
     \le  2^{255a^3+6a+1} \sum_{\fp\in \mathfrak{A}}
    \int_{E(\fp)}|g|(y) h(\fp)\, d\mu(y)
\end{equation}
with $h(\fp)$ defined as
\begin{equation}\label{def hp}
    \frac 1{\mu(B(\fp))}\int \sum_{\fp'\in \mathfrak{A}(\fp)}
    {(1+d_{\fp'}(\fcc(\fp'), \fcc(\fp))^{-1/(2a^2+a^3)}}(\mathbf{1}_{E(\fp')}|g|)(y')\, d\mu(y')\,.
\end{equation}
The following lemma will be proved in Subsection \ref{subsec geolem}.
\begin{lemma}[antichain tile count]
    \label{antichain tile count}
    \uses{global antichain density}
    Set $p:=4a^4$ and let $p'$ be the dual exponent of $p$, that is $1/p+1/p'=1$.
    For  every $\mfa\in\Mf$ and every subset $\mathfrak{A}'$ of $\mathfrak{A}$ we have
    \begin{equation}
        \label{eq antichain Lp}
        \Big\|\sum_{\fp\in\mathfrak{A}'}(1+d_{\fp}(\fcc(\fp), \mfa))^{-1/(2a^2+a^3)}\mathbf{1}_{E(\fp)}\mathbf{1}_G\Big\|_{p}
    \end{equation}
    \begin{equation}
        \le
        2^{104a}\dens_1(\mathfrak{A})^{\frac 1p}\mu\left(\cup_{\fp\in\mathfrak{A}'}I_{\fp}\right)^{\frac 1p}\, .
    \end{equation}
\end{lemma}

Note that $p\geq 4$ since $a>4$.
We estimate $h(\fp)$ as defined in \eqref{def hp} with H\"older using  $|g|\le \mathbf{1}_G$ and $E(\fp')\subset B(\fp)$ by

\begin{equation}
    \frac{\|g\mathbf{1}_{B(\fp)}\|_{p'}}{\mu(B(\fp))}
    \Big\|\sum_{\fp\in\mathfrak{A}(\fp)}(1+d_{\fp}(\fcc(\fp), \fc(\fp'))^{-1/(2a^2+a^3)}\mathbf{1}_{E(\fp)}\mathbf{1}_G\Big\|_{p}\, .
\end{equation}
Then we apply Lemma \ref{antichain tile count} to estimate this by
\begin{equation}\label{eqttt5}
    \le  2^{104a}
    \frac{\|g\mathbf{1}_{B(\fp)}\|_{p'}}{\mu(B(\fp))}
    \dens_1(\mathfrak{A})^{\frac 1p}\mu(B(\fp))^{\frac 1p}\,.
\end{equation}
Let $\mathcal{B}$ be the collection of all balls
$B(\fp)$ with $\fp\in \mathfrak{A}$. Then
for each $\fp\in \mathfrak{A}$ and $x\in B(\fp)$ we have by
definition  \eqref{def hlm} of $M_{\mathcal{B},p'}$
\begin{equation}
    \|g\mathbf{1}_{B(\fp)}\|_{p'}\le
    \mu(B(\fp))^{\frac 1{p'}} M_{\mathcal{B},p'}g(x) \, .
\end{equation}
Hence we can estimate \eqref{eqttt5} by
\begin{equation}
\label{eqttt5b}
    \le
    2^{104a}
    (M_{\mathcal{B}, p'}g(x))
   \dens_1(\mathfrak{A})^{\frac 1p}\, .
\end{equation}
With this estimate of $h(\fp)$,
using $E(\fp)\subset B(\fp)$ by construction of $B(\fp)$, we estimate
\eqref{eqtts3} by
 \begin{equation}\label{eqtts4}
 \le  2^{255a^3+110a + 1} { \dens_1(\mathfrak{A})^{\frac 1p}}\sum_{\fp\in \mathfrak{A}}
 \int_{E(\fp)}|g|(y)M_{\mathcal{B}, p'}g(y) \, dy\,.
         \end{equation}
Using Lemma \ref{tile disjointness},
the last display is observed to be
\begin{equation}\label{eqtts4a}
=  2^{255a^3+110a + 1}
 {\dens_1(\mathfrak{A})^{\frac 1p}} \int |g|(y)(M_{\mathcal{B}, p'}g)(y) \, dy\,.
         \end{equation}
Applying Cauchy-Schwarz and using Proposition \ref{Hardy Littlewood} estimates the last display by
\begin{equation}
    2^{255a^3+110a + 1} \dens_1(\mathfrak{A})^{\frac 1p}
    \|g\|_2 \|M_{\mathcal{B}, p'} g\|_2
\end{equation}
\begin{equation}
    \le  2^{255a^3+110a + 3}\frac{2}{2-p'}
    \dens_1(\mathfrak{A})^{\frac 1p}\|g\|_2 ^2\,.
\end{equation}
Using $p>4$ and thus $1<p'<\frac 43$, we estimate the last display by
\begin{equation}
    \le  2^{255a^3+110a + 5} \dens_1(\mathfrak{A})^{\frac 1p}
    \|g\|_2^2\,.
\end{equation}
Now Lemma \ref{dens1 antichain} follows by applying Cauchy-Schwarz on the left-hand side and using
$a\ge 4$.
\end{proof}
We have
\begin{equation}
    \left (\frac 1{\tilde{q}} -\frac 12\right) (2-q)= \frac 1q -\frac 12\,.
\end{equation}
Multiplying  the $(2-q)$-th power of  \eqref{eqttt9} and the $(q-1)$-th power of \eqref{eqttt3}
and estimating gives after simplification of some factors
\begin{equation}\label{eqttt8}
    \Big|\int \overline{g(x)} \sum_{\fp \in \mathfrak{A}} T_{\fp} f(x)\, d\mu(x)\Big|
\end{equation}
 \begin{equation}
    \le  2^{150a^3}({q}-1)^{-1} \dens_1(\mathfrak{A})^{\frac {q-1}{2p}}\dens_2(\mathfrak{A})^{\frac 1{q}-\frac 12}  \|f\|_2\|g\|_2\, .
\end{equation}
With the definition of $p$, this  implies
Proposition \ref{antichain operator}.


\section{Proof of Lemma \ref{tile correlation}, the tile correlation bound }\label{sec tile operator}

The next lemma prepares an application of
Proposition \ref{Holder van der Corput}.
\begin{lemma}[correlation kernel bound]\label{correlation kernel bound}
Let $-S\le s_1\le s_2\le S$ and let $x_1,x_2\in X$.
Define \begin{equation}
 \varphi(y) :=  \overline{K_{s_1}(x_1, y)}
 K_{s_2}(x_2, y) \, .
\end{equation}
If $\varphi(y)\neq 0$, then
\begin{equation}\label{eqt10}
    y\in B(x_1, D^{s_1})\, .
\end{equation}
Moreover, we have with $\tau = 1/a$
\begin{equation}\label{eqt11}
  \|\varphi\|_{C^\tau(B(x_1, D^{s_1}))}\le
\frac{2^{254 a^3}}{\mu(B(x_1, D^{s_1}))\mu(B(x_2, D^{s_2}))}
      \, .
\end{equation}

\end{lemma}
\begin{proof}

If $\varphi(y)$ is not zero, then $K_{s_1}(x_1, y)$ is not zero and thus
\eqref{supp Ks} gives \eqref{eqt10}.

We next have for $y$ with \eqref{eq Ks size}
\begin{equation}\label{suppart}
    |\varphi(y)|\le
    \frac{2^{204 a^3}}{\mu(B(x_1, D^{s_1}))\mu(B(x_2, D^{s_2}))}
\end{equation}
and for $y'\neq y$
\begin{equation}
    |\varphi(y)-\varphi(y')|
 \end{equation}
 \begin{equation}
 \le
 |K_{s_1}(x_1,y)-K_{s_1}(x_1,y'))||
 K_{s_2}(x_2, y)|
\end{equation}
 \begin{equation}+|K_{s_1}(x_1, y')|
 |K_{s_2}(x_2, y) - K_{s_2}(x_2, y'))|
\end{equation}
\begin{equation}
      \le \frac{2^{252 a^3}}{\mu(B(x_1, D^{s_1}))\mu(B(x_2, D^{s_2}))}
       \left(\left(\frac{ \rho(y,y')}{D^{s_1}}\right)^{1/a}+
       \left(\frac{ \rho(y,y')}{D^{s_2}}\right)^{1/a}\right)
\end{equation}
\begin{equation}\label{holderpart}
      \le \frac{2^{253 a^3}}{\mu(B(x_1, D^{s_1}))\mu(B(x_2, D^{s_2}))}
       \left(\frac{ \rho(y,y')}{D^{s_1}}\right)^{1/a}\,.
\end{equation}
Adding the estimates \eqref{suppart} and \eqref{holderpart} gives \eqref{eqt11}.
This proves the lemma.
\end{proof}
The next lemma is a geometric estimate for two tiles.
\begin{lemma}\label{tile uncertainty}
\uses{monotone cube metrics}
    Let $\fp_1, \fp_2\in \fP$ with
$\ps({\fp_1})\leq \ps({\fp_2})$. For each $x_1\in E(\fp_1)$ and
$x_2\in E(\fp_2)$  we have
\begin{equation}\label{tgeo}
  1+d_{\fp_1}(\fcc(\fp_1), \fcc(\fp_2))\le
    2^{3a}(1 + d_{B(x_1, D^{\ps(\fp_1)})}(\tQ(x_1),\tQ(x_2)))\, .
\end{equation}
\end{lemma}
\begin{proof}
Let $i\in \{1,2\}$.
By Definition \eqref{defineep} of $E$,
we have $\tQ(x_i)\in \fc(\fp_i)$
With \eqref{eq freq comp ball} we then conclude
\begin{equation}\label{dponetwo}
    d_{\fp_i}(\tQ(x_i),\fcc(\fp_i))\le 1\, .
\end{equation}
We have $\sc(\fp_1)\subset \sc(\fp_2)$ by \eqref{dyadicproperty}. Using Lemma \ref{monotone cube metrics} it follows that
\begin{equation}\label{tgeo0.5}
    d_{\fp_1}(\tQ(x_2), \fcc(\fp_2)) \le 1\,.
\end{equation}
By the triangle inequality, we obtain from \eqref{dponetwo} and
\eqref{tgeo0.5}
\begin{equation}\label{tgeo1}
     1+d_{\fp_1}(\fcc(\fp_1), \fcc(\fp_2))\le  3 +d_{\fp_1}(\tQ(x_1), \tQ(x_2))\, .
\end{equation}
As $x_1\in \sc(\fp_1)$ by Definition \eqref{defineep} of $E$, we have by the squeezing property  \eqref{eq vol sp cube}
\begin{equation}
    d(x_1,\pc(\fp_1))\le 4D^{\ps(\fp_1)}
\end{equation}
and thus by \eqref{eq vol sp cube} again and the triangle inequality
\begin{equation}
    \sc(\fp_1)\subset B(x_1,8D^{\ps(\fp_1)})\, .
\end{equation}
We thus estimate the right-hand side of \eqref{tgeo1} with monotonicity of the  Definition \eqref{definedE} by
\begin{equation}\label{tgeo1.5}
    \le  3+d_{B(x_1,8D^{\ps(\fp_1)})}(\tQ(x_1), \tQ(x_2))\, .
\end{equation}
This is further estimated by applying the doubling property  \eqref{firstdb} three times by
\begin{equation}\label{tgeo2}
    \le  3+2^{3a}d_{B_1(x_1, D^{\ps(\fp_1)})}(\tQ(x_1), \tQ(x_2))\, .
\end{equation}
Now \eqref{tgeo} follows with $a\ge 1$.
\end{proof}




\begin{lemma}[tile range support]\label{tile range support}
    For each  $\fp\in \fP$, and each $y\in X$, we have that
\begin{equation}\label{tstargnot0}
     T_{\fp}^* g(y)\neq 0
\end{equation}
   implies
\begin{equation}\label{ynotfar}
    y\in  B(\pc(\fp),5D^{\ps(\fp)})\, .
\end{equation}
\end{lemma}
\begin{proof}
Fix $\fp$ and $y$ with \eqref{tstargnot0}.
Then there exists $x\in E(\fp)$ with
\begin{equation}
   \overline{K_{\ps(\fp)}(x,y)}e(-\tQ(x)(y)
    +\tQ(x)(x))g(x) \neq 0\, .
\end{equation}
As $E(\fp)\subset \sc(\fp)$ and by the squeezing property
\eqref{eq vol sp cube}, we have
\begin{equation}
    \rho(x,\pc(\fp))\le 4D^{\ps(\fp)}\, .
\end{equation}
As $K_{\ps(\fp)}(x,y)\neq 0$, we have by  \eqref{supp Ks}
that
\begin{equation}
\rho(x,y)\le \frac 12 D^{\ps(\fp)}\, .
\end{equation}
Now \eqref{ynotfar} follows by the triangle inequality.
\end{proof}


We now prove Lemma \ref{tile correlation}. We begin with  \eqref{eq basic TT* est}.

We expand the left-hand side of \eqref{eq basic TT* est} as
\begin{equation}\label{tstartstar}
\left|\int \int_{E(\fp_1)} \overline{K_{\ps(\fp_1)}(x_1,y)}e(-\tQ(x_1)(y)+
    \tQ(x_1)(x_1))g(x_1)\, d\mu(x_1) \right.
\end{equation}
\begin{equation}
 \times \left.\int_{E(\fp_2)} {K_{\ps(\fp_2)}(x_2,y)}e(\tQ(x_2)(y)
    -\tQ(x_2)(x_2))\overline{g(x_2)}\, d\mu(x_2)\, d\mu(y)\right|\, .
\end{equation}
By Fubini and the triangle inequality and
the fact $|e(\tQ(x_i)(x_i))|=1$ for $i=1,2$, we can estimate
\eqref{tstartstar} from above by
\begin{equation}\label{eqa1}
    \int_{E(\fp_1)} \int_{E(\fp_2)} {\bf I}\, d\mu(x_1)d\mu(x_2)\,.
\end{equation}
with
\begin{equation}
    {\bf I}:=
    \left|\int
    e(-\tQ(x_1)(y)+\tQ(x_2)(y))\varphi_{x_1,x_2}(y)
    d\mu(y) \, g(x_1)g(x_2)\right|
\end{equation}


We estimate for fixed $x_1\in E(\fp_1)$ and
$x_2\in E(\fp_2)$ the inner integral of \eqref{eqa1} with
Proposition \ref{Holder van der Corput}. The function
$\varphi:=\varphi_{x_1,x_2}$ satisfies the assumptions of
Proposition \ref{Holder van der Corput} with $z = x_1$ and $R = D^{s_1}$ by Lemma \ref{correlation kernel bound}.
We obtain with $B':= B(x_1, D^{\ps(\fp_1)})$,
\begin{equation*}
 {\bf I}\le     2^{8a} \mu(B') \|{\varphi}\|_{C^\tau(B')}
       (1 + d_{B'}(\tQ(x_1),\tQ(x_2)))^{-1/(2a^2+a^3)}
\end{equation*}
\begin{equation}
\label{eqa1.5}
 \le     \frac{2^{254a^3+8a}}
 {\mu(B(x_2, D^{\ps(\fp_2)}))}
       (1 + d_{B'}(\tQ(x_1),\tQ(x_2)))^{-1/(2a^2+a^3)}\,.
\end{equation}
Using Lemma \ref{tile uncertainty} and $a\ge 1$ estimates \eqref{eqa1.5} by
\begin{equation}\label{eqa2}
 \le     \frac{2^{254a^3 + 8a + 1}}
 {\mu(B(x_2, D^{\ps(\fp_2)}))}
       (1+d_{\fp_1}(\fcc(\fp_1), \fcc(\fp_2)))^{-1/(2a^2+a^3)}\,.
\end{equation}
As $x_2\in \sc(\fp_2)$ by Definition \eqref{defineep} of $E$, we have by \eqref{eq vol sp cube}
\begin{equation}
    d(x_2,\pc(\fp_2))\le 4D^{\ps(\fp_2)}
\end{equation}
and thus by \eqref{eq vol sp cube} again and the triangle inequality
\begin{equation}
    \sc(\fp_2)\subset B(x_2,8D^{\ps(\fp_2)})\, .
\end{equation}
Using three iterations of the doubling property \eqref{doublingx} give
\begin{equation}
    \mu(\sc(\fp_2))\le 2^{3a}\mu(B(x_2,D^{\ps(\fp_2)}))\, .
\end{equation}
With $a\ge 1$ and \eqref{eqa2} we conclude \eqref{eq basic TT* est}.


Now assume the left-hand side of \eqref{eq basic TT* est} is not zero.
There is a $y\in X$ with
\begin{equation}
    T^*_{\fp}g(y)\overline{T^*_{\fp'}g(y)}\neq 0
\end{equation}
By the triangle inequality and Lemma \ref{tile range support}, we conclude
\begin{equation}
   \rho(\pc(\fp),\pc(\fp'))\le  \rho(\pc(\fp),y) +\rho(\pc(\fp'),y)
   \le 5D^{\ps(\fp)}+5D^{\ps(\fp')}\le 10 D^{\ps(\fp)}\, .
\end{equation}
By the squeezing property \eqref{eq vol sp cube} and the triangle inequality,
we conclude
\begin{equation}
    \sc(\fp') \subset B(\pc(\fp), 15D^{\ps(\fp)})\, .
\end{equation}
   This completes the proof of Lemma  \ref{tile correlation}.





\section{Proof of Lemma \ref{antichain tile count}, the geometric estimate}
\label{subsec geolem}


\begin{lemma}[tile reach]\label{tile reach}
\uses{monotone cube metrics}
Let $\mfa\in \Mf$ and $N\ge0$ be an integer.
Let $\fp, \fp'\in \fP$ with
\begin{equation}\label{eqassumedismfa}
    d_{\fp}(\fcc(\fp), \mfa))\le 2^N\,
\end{equation}
\begin{equation}\label{eqassumedismfap}
    d_{\fp'}(\fcc(\fp'), \mfa))\le 2^N\, .
\end{equation}
Assume $\sc(\fp)\subset \sc(\fp')$ and $\ps(\fp)<\ps(\fp')$.
Then
\begin{equation}\label{lp'lp''}2^{N+2}\fp\lesssim 2^{N+2} \fp'\, .
\end{equation}
\end{lemma}

\begin{proof}
By Lemma \ref{monotone cube metrics}, we have
\begin{equation}
     d_{\fp}(\fcc(\fp'),\mfa)
     \le d_{\fp'}(\fcc(\fp'),\mfa)
     \le  2^{N} \, .
\end{equation}
Together with \eqref{eqassumedismfa} and the triangle inequality, we obtain
\begin{equation}\label{eqdistqpqp}
    d_{\fp'}(\fcc(\fp'),\fcc(\fp))\le 2^{N+1}  \, .
\end{equation}
Now assume
\begin{equation}
    \mfa'\in B_{\fp'}(\fcc(\fp'),2^{N+2}).
\end{equation}
By the doubling property \eqref{firstdb}, applied five times, we have
\begin{equation}\label{ageo1}    d_{B(\pc(\fp'),8D^{\ps(\fp')})}(\fcc(\fp'),\mfa') < 2^{5a+N+2}\, .
\end{equation}
We have by the squeezing property \eqref{eq vol sp cube}
\begin{equation}
 \pc(\fp)\in
B(\pc(\fp'),4D^{\ps(\fp')})\, .
\end{equation}
Hence by the triangle inequality
\begin{equation}
 B(\pc(\fp), 4D^{\ps(\fp')})
 \subset
B(\pc(\fp'),8D^{\ps(\fp')})\, .
\end{equation}
Together with \eqref{ageo1} and   monotonicity of $d$, see the Definition \eqref{definedE}
\begin{equation}
    d_{B(\pc(\fp),4D^{\ps(\fp')})}(\fcc(\fp'),\mfa') < 2^{5a+N+2}\, .
\end{equation}
Using the doubling property \eqref{seconddb} $5a+2$ times  gives
\begin{equation}
    d_{B(\pc(\fp),2^{2-5a^2-2a}D^{\ps(\fp')})}(\fcc(\fp'),\mfa') < 2^{N}\, .
\end{equation}
Using $\ps(\fp)<\ps(\fp')$ and $D=2^{100a^2}$ and $a\ge 4$ gives
\begin{equation}
    d_{\fp}(\fcc(\fp'),\mfa') < 2^{N}\, .
\end{equation}
With the triangle inequality and \eqref{eqdistqpqp},
\begin{equation}
    d_{\fp}(\fcc(\fp),\mfa') < 2^{N+2}\, .
\end{equation}
This shows
\begin{equation}
B_{\fp'}(\fcc(\fp'),2^{N+2})\subset    B_{\fp}(\fcc(\fp),2^{N+2})\, .
\end{equation}
This implies  \eqref{lp'lp''} and completes the proof of the lemma.
\end{proof}

For $\mfa \in \Mf$ and $N\ge 0$ define
\begin{equation}\label{eqantidefap}
    \mathfrak{A}_{\mfa,N}:=\{\fp\in\mathfrak{A}: 2^{N}\le 1+d_{\fp}(\fcc(\fp), \mfa)\le 2^{N+1}\} \, .
\end{equation}


\begin{lemma}[stack density]
\label{stack density}
Let $\mfa \in \Mf$ and $N\ge 0$ and
$L\in \mathcal{D}$. Then
\begin{equation}\label{eqanti-1}
    \sum_{\fp\in\mathfrak{A}_{\mfa,N}:\sc(\fp)=L}\mu(E(\fp)\cap G)\le  2^{a(N+5)}\dens_1(\mathfrak{A})\mu(L)\, .
\end{equation}
\end{lemma}
\begin{proof}
Let $\mfa,N,L$ be given and set
\begin{equation}
\mathfrak{A}':=\{\fp\in\mathfrak{A}_{\mfa,N}:\sc(\fp)=L\}\, .
\end{equation}
Let
$\fp\in\mathfrak{A}'$.
We have
by Definition \eqref{definedens1}
using $\lambda=2$ and the squeezing property \eqref{eq freq comp ball}
\begin{equation}\label{eqanti-3}
\mu(E(\fp)\cap G)\le \mu(E_2(2, \fp))\le 2^{a}\dens_1(\mathfrak{A}')\mu(L)\, .
\end{equation}
By the covering property \eqref{thirddb}, applied $N+4$ times, there is a collection $\Mf'$ of at most $2^{a(N+4)}$
elements such that
\begin{equation}\label{eqanti-4}
    B_{\fp}(\mfa, 2^{N+1})\subset \bigcup_{\mfa'\in \Mf'}
    B_{\fp}(\mfa', 0.2)\, .
\end{equation}
As each $\fcc(\fp)$ with $\fp\in \mathfrak{A}_{\mfa,N}$
is contained in the left-hand-side
of \eqref{eqanti-4}
by definition, it is in  at least one $B_{\fp}(\mfa', 0.2)$
with $\mfa'\in \Mf'$.


For two different $\fp,\fp'\in \mathfrak{A}'$, we have by
\eqref{eq dis freq cover} that
$\fc(\fp)$ and $\fc(\fp')$ are disjoint and thus by the squeezing property \eqref{eq freq comp ball} we have for every $\mfa'\in \Mf'$
\begin{equation}
    \mfa'\not\in B_{\fp}(\fcc(\fp), 0.2)\cap
B_{\fp}(\fcc(\fp'), 0.2)\, .
\end{equation}
Hence at most one of $\fcc(\fp)$
and $\fcc(\fp)$ is in
$B_{\fp}(\mfa', 0.2)$.
It follows that there are at most $2^{a(N+4)}$ elements in
$\mathfrak{A}'$. Adding \eqref{eqanti-3} over $\mathfrak{A}'$ proves
\eqref{eqanti-1}.


\end{proof}


\begin{lemma}[local antichain density]\label{local antichain density}
\uses{tile disjointness,tile reach}
Let $\mfa\in\Mf$ and {$N$} be
an integer. Let $\fp_{\mfa}$ be a tile with $\mfa\in \fc(\fp_{\mfa})$.
Then we have
\begin{equation}\label{eqanti-0.5}
    \sum_{\fp\in\mathfrak{A}_{\mfa,N}: \ps(\fp_{\mfa})<\ps(\fp)}\mu(E(\fp)\cap G \cap \sc(\fp_{\mfa}))
    \le  \mu (E_2(2^{N+3},\fp_{\mfa}))
 \, .
\end{equation}



\end{lemma}

\begin{proof}


Let $\fp$ be any tile in $\mathfrak{A}_{\mfa,N}$ with $\ps(\fp_{\mfa})<\ps(\fp)$. By definition of
$E$, the tile contributes zero to the sum on the left-hand side of \eqref{eqanti-0.5} unless
 $\sc(\fp)\cap \sc(\fp_{\mfa}) \neq \emptyset$, which we may assume. With $\ps(\fp_{\mfa})<\ps(\fp)$
and the dyadic property
\eqref{dyadicproperty} we conclude $\sc(\fp_{\mfa})\subset  \sc(\fp)$.
By the squeezing property
\eqref{eq freq comp ball},
we conclude from
$\mfa\in \fc(\fp_{\mfa})$
that
\begin{equation}
    \mfa\in B(\fcc(\fp_{\mfa}), 1)\, .
\end{equation}
We conclude from $\fp \in \mathfrak{A}_{\mfa,N}$ that
\begin{equation}
    \mfa \in B(\fcc(\fp), 2^{N+1})\, .
\end{equation}
With Lemma \ref{tile reach}, we conclude
\begin{equation}
    2^{N+3}\fp_{\mfa}  \lesssim  2^{N+3}\fp \, .
\end{equation}
By Definition \eqref{definee2} of $E_2$, we conclude
\begin{equation}
    E(\fp)\cap G \subset E_2(2^{N+3},\fp_{\mfa})\, .
\end{equation}
Using disjointedness of the various $E(\fp)$ with $\fp\in \mathfrak{A}$  by Lemma \ref{tile disjointness}, we obtain \eqref{eqanti-0.5}.
This proves the lemma.
\end{proof}
\begin{lemma}[global antichain density]
\label{global antichain density}
\uses{stack density,local antichain density}
Let $\mfa\in\Mf$ and let $N\ge 0$  be
an integer. Then we have
\begin{equation}\label{eqanti00}
    \sum_{\fp\in\mathfrak{A}_{\mfa,N}}\mu(E(\fp)\cap G)
    \le
 2^{101a^3+Na}\dens_1(\mathfrak{A})\mu\left(\cup_{\fp\in\mathfrak{A}}I_{\fp}\right)\, .
\end{equation}
\end{lemma}



\begin{proof}
{Fix $\mfa$ and $N$. Let
$\mathfrak{A}'$ be the set of $\fp\in\mathfrak{A}_{\mfa,N}$ such that $\sc(\fp)\cap G$ is not empty.}


   Let $\mathcal{L}$ be the collection dyadic cubes $I\in\mathcal{D}$ such that $I\subset \sc(\fp)$ for some $\fp\in\mathfrak{A}'$ and if $\sc(\fp)\subset I$ for some $\fp\in\mathfrak{A}'$, then $\ps(\fp)=-S$. By \eqref{coverdyadic}, for each $\fp \in \mathfrak{A}'$
   and each $x\in \sc(\fp)\cap G$, there is a $I\in \mathcal{D}$ with $s(I)=-S$ and $x\in I$. By \eqref{dyadicproperty},
   we have $I\subset \sc(\fp)$. Hence
   \begin{equation}
       \sc(\fp)\subset \bigcup\{I\in \mathcal{D}: s(I)=-S, I\subset \sc(\fp)\}\subset \bigcup \mathcal{L}\, .
   \end{equation}
As each $I\in \mathcal{L}$ satisfies $I\subset \sc(\fp)$ for some $\fp$ in $\mathfrak{A'}$, we conclude
     \begin{equation}
\bigcup\mathcal{L}=\bigcup_{\fp \in \mathfrak{A}'}\sc(\fp)\, .
   \end{equation}
Let $\mathcal{L}^*$ be the set of maximal elements on $\mathcal{L}$ with respect to set inclusion.
By \eqref{dyadicproperty}, the elements in $\mathcal{L}^*$ are pairwise disjoint and we have
 \begin{equation}\label{eqdecAprime}
\bigcup\mathcal{L}^*=\bigcup_{\fp \in \mathfrak{A}'}\sc(\fp)\, .
   \end{equation}
Using the partition \eqref{eqdecAprime} into elements of $\mathcal{L}$ in \eqref{eqanti0}, it suffices to show for each $L\in \mathcal{L}^*$
\begin{equation}\label{eqanti0}
    \sum_{\fp\in\mathfrak{A}'}\mu(E(\fp)\cap G \cap L)
    \le
    2^{101a^3+aN}
    \dens_1(\mathfrak{A})\mu(L)\,.
\end{equation}
Fix $L\in \mathcal{L}^*$.
By definition of $L$, there exists an element $\fp'\in \mathfrak{A}'$ such that $L\subset \sc(\fp')$. Pick such an element $\fp
'$
in $\mathfrak{A}$ with minimal $\ps(\fp')$. As $\sc(\fp')\not \subset L$ or $s(L) = -S$ by definition of $L$, we have
with \eqref{dyadicproperty} that $s(L)< \ps(\fp')$ or $s(L) = -S$. In particular $s(L)<S$.

If there exists no cube $J \in \mathcal{D}$ with $L \subsetneq J$, then by the definition of $\mathcal{L}$ we must have $s(L) = -S$. By \eqref{dyadicproperty}, this implies that each tile $\fp$ with $E(\fp) \cap L \ne \emptyset$ must satisfy $\sc(\fp) = L$. Thus the left hand side of \eqref{eqanti0} equals
\begin{equation}
    \sum_{\fp\in\mathfrak{A}':\sc(\fp)=L}\mu(E(\fp)\cap G\cap L)\,.
\end{equation}
Thus in this case \eqref{eqanti0} is a direct consequence of Lemma \ref{stack density} and $a \ge 4$.

We now assume that there exists a cube $J \in \mathcal{D}$ with $L \subsetneq J$.
By \eqref{coverdyadic}, there is an
$L'\in \mathcal{D}$ with $s(L')=s(L)+1$ and $c(L)\in L'$. By \eqref{dyadicproperty}, we have
$L\subset L'$.

We split the left-hand side of \eqref{eqanti0} as
\begin{equation}\label{eqanti1}
    \sum_{\fp\in\mathfrak{A}':\sc(\fp)=L'}\mu(E(\fp)\cap G\cap L)
\end{equation}
\begin{equation}\label{eqanti2}
    +
     \sum_{\fp\in\mathfrak{A}':\sc(\fp)\neq L'}\mu(E(\fp)\cap G\cap L)\, ,
\end{equation}

We first estimate \eqref{eqanti1}
with Lemma \ref{stack density} by
\begin{equation}\label{equanti1.5}
    \le \sum_{\fp\in\mathfrak{A}':\sc(\fp)=L'}\mu(E(\fp)\cap G\cap L')\le 2^{a(N+5)}\dens_1(\mathfrak{A})\mu(L')\, .
\end{equation}



We turn to \eqref{eqanti2}.
Consider the element $\fp'\in \mathfrak{A}'$ as above
with $L\subset \sc(\fp')$ and $s(L)<\ps(\fp')$.
As $L\subset L'$ and $s(L')=s(L)+1$, we conclude with the dyadic property that $L'\subset \sc(\fp')$.
By maximality of $L$, we have
$L'\not\in \mathcal{L}$.
This together with the existence of the given $\fp'\in \mathfrak{A}$
with $L'\subset \sc(\fp')$
shows by definition of $\mathcal{L}$ that there exists $\fp''\in \mathfrak{A}'$ with
$\sc(\fp'')\subset L'$.




By the covering property \eqref{eq dis freq cover}, there exists a unique $\fp_{\mfa}$ with
\begin{equation*}
    \sc(\fp_{\mfa})=L'
\end{equation*}
such that $\mfa\in \fc(\fp_{\mfa})$.
Note that
\begin{equation}
    \mfa\in B(\fcc(\fp_{\mfa}), 1)
\end{equation}
and as  $\fp'' \in \mathfrak{A}_{\mfa,N}$ that
\begin{equation}
    \mfa \in B(\fcc(\fp''), 2^{N+1})\, .
\end{equation}
By Lemma \ref{tile reach}, we conclude
\begin{equation}
    2^{N+3}\fp''  \lesssim  2^{N+3}\fp_{\mfa} \, .
\end{equation}
As $\fp''\in \mathfrak{A}'$, we have by Definition
\eqref{definedens1} of $\dens_1$ that
\begin{equation}\label{pmfadens}
   {\mu(E_2(2^{N+3}, \fp_{\mfa})}\le 2^{Na+3a}\dens_1(\mathfrak{A}) {\mu(L')}\, .
\end{equation}
Now let $\fp$ be any tile in the summation set in \eqref{eqanti2}, that is, $\fp\in \mathfrak{A}'$ and $\sc(\fp)\neq L'$.
Then $\sc(\fp)\cap L\neq \emptyset$. It follows by the dyadic property \eqref{dyadicproperty}
and the definition of $L$ that
$L\subset \sc(\fp)$ and $L\neq \sc(\fp)$. By the dyadic property \eqref{dyadicproperty}, we have
$s(L)<\ps(\fp)$ and thus $s(L')\le \ps(\fp)$. By the dyadic property
   \eqref{dyadicproperty} again, we have $L'\subset \sc(\fp)$.
As $L'\neq \sc(\fp)$, we conclude $s(L)<\ps(\fp)$.
By Lemma \ref{local antichain density}, we can thus estimate \eqref{eqanti2} by
\begin{equation}\label{eqanti0.5}
    \sum_{\fp\in\mathfrak{A}':\sc(\fp)\neq L'}\mu(E(\fp)\cap G\cap L')
    \le  \mu (E_2(2^{N+3},\fp_{\mfa}))\, .
\end{equation}
Using the decomposition
into \eqref{eqanti1} and
\eqref{eqanti2} and the estimates
\eqref{equanti1.5},
\eqref{eqanti-0.5},
\eqref{pmfadens} we obtain the estimate
\begin{equation}\label{eqanti3.14}
\sum_{\fp\in\mathfrak{A}'}\mu(E(\fp)\cap G \cap L)
    \le (2^{a(N+5)}+2^{Na+3a})\dens_1(\mathfrak{A})\mu(L')\,.
\end{equation}

Using $s(L')=s(L)+1$ and $D=2^{100a^2}$ and the
squeezing property \eqref{eq vol sp cube}
and the doubling property \eqref{doublingx} $100a^2+4$ times , we obtain
\begin{equation}
    \mu(L')\le 2^{100a^3+4a}\mu(L)\, .
\end{equation}
Inserting in \eqref{eqanti3.14} and using $a>4$ gives \eqref{eqanti0}.
This completes the proof of the lemma.
\end{proof}



We turn to the proof of Lemma \ref{antichain tile count}.




\begin{proof}


Using that $\mathfrak{A}$ is the union of the
$\mathfrak{A_{\mfa,N}}$ with $N\ge 0$,
we estimate the left-hand side of
with the triangle inequality by
\begin{equation}\label{eqanti23}
\le \sum_{N\ge 0} \left\|\sum_{\fp\in \mathfrak{A}_{\mfa,N}} 2^{-N/(2a^2+a^3)}\mathbf{1}_{E(\fp)} \mathbf{1}_G\right\|_{p}
\end{equation}
We consider each individual term in this sum and estimate it's $p$-th power.
   Using that for each $x\in X$  by Lemma \ref{global antichain density} there is at most one $\fp\in \mathfrak{A}$ with $x\in E(\fp)$,
 we have
 \begin{equation}
     \left\|\sum_{\fp\in \mathfrak{A}_{\mfa,N}} 2^{-N/(2a^2+a^3)}\mathbf{1}_{E(\fp)} \mathbf{1}_G\right\|_{p}^p
 \end{equation}
\begin{equation}
    =\int_G\Big(\sum_{\fp\in \mathfrak{A}_{\mfa,N}}2^{-N/(2a^2+a^3)}\mathbf{1}_{E(\fp)}(x)\Big)^p\, d\mu(x)
\end{equation}
\begin{equation}
  =   \int _G\sum_{\fp\in\mathfrak{A}_{\mfa,N}}2^{-pN/(2a^2+a^3)}\mathbf{1}_{E(\fp)}(x)\, d\mu(x)
\end{equation}
\begin{equation}
  =   2^{-pN/(2a^2+a^3)} \sum_{\fp\in\mathfrak{A}_{\mfa,N}}\mu(E(\fp)\cap G)
\end{equation}

Using Lemma \ref{global antichain density}, we estimate the last display by
\begin{equation}\label{eqanti21}
    \le  2^{-pN/(2a^2+a^3)+101a^3+Na}\dens_1(\mathfrak{A})\mu\left(\cup_{\fp\in\mathfrak{A}}\sc(\fp)\right)
\end{equation}
Using that with $a\ge 4$ and since $p = 4a^4$, we have
\begin{equation}
    pN/(2a^2+a^3)\ge
    4a^4N/(3a^3)= \ge Na+N\, .
\end{equation}
Hence we have for \eqref{eqanti21} the upper bound
\begin{equation}\label{eqanti22}
\le  2^{101a^3-N}\dens_1(\mathfrak{A})\mu\left(\cup_{\fp\in\mathfrak{A}}\sc(\fp)\right)\, .
\end{equation}
Taking th $p$-th root and summing over $N\ge 0$ gives for \eqref{eqanti23} the upper bound

\begin{equation}
\le \left(\sum_{N\ge 0} 2^{-N/p}\right)2^{101a^3/p}\dens_1(\mathfrak{A})^{{\frac{1}{p}}}\mu\left(\cup_{\fp\in\mathfrak{A}}\sc(\fp)\right)^{{\frac{1}{p}}}
\end{equation}
\begin{equation}
\le \left(1-2^{-1/p}\right)^{-1}
2^{101a^3/p}
\dens_1(\mathfrak{A})^{\frac 1p}\mu\left(\cup_{\fp\in\mathfrak{A}}\sc(\fp)\right)^{\frac 1p}\, .
\end{equation}
Using that $p = 4a^4$ and $a \ge 4$, this proves the lemma.
\end{proof}







\chapter{Proof of Proposition \ref{forest operator}}

\label{treesection}

\section{The pointwise tree estimate}
Fix a forest $(\fU, \fT)$. The main result of this subsection is Lemma \ref{pointwise tree estimate}, we begin this section with some definitions necessary to state the lemma.

For $\fu \in \fU$ and $x\in X$, we define
$$
    \sigma (\fu, x):=\{\ps(\fp):\fp\in \fT(\fu), x\in E(\fp)\}\,.
$$
This is a subset of $\mathbb{Z} \cap [-S, S]$, so has a minimum and a maximum. We set
$$
    \overline{\sigma} (\fu, x) := \max \sigma(\fT(\fu), x)
$$
$$
    \underline{\sigma} (\fu, x) := \min\sigma(\fT(\fu), x)\,.
$$
\begin{lemma}[convex scales]
\label{convex scales}
    For each $\fu \in \fU$, we have
    $$
        \sigma(\fu, x) = \mathbb{Z} \cap [\underline{\sigma} (\fu, x), \overline{\sigma} (\fu, x)]\,.
    $$
\end{lemma}

\begin{proof}
    Let $s \in \mathbb{Z}$ with $\underline{\sigma} (\fT(\fu), x) \le s \le \overline{\sigma} (\fT(\fu), x)$. By definition of $\sigma$, there exists $\fp \in \fT(\fu)$ with $\ps(\fp) = \underline{\sigma} (\fT(\fu), x)$ and $x \in E(\fp)$, and there exists $\fp'' \in \fT(\fu)$ with $\ps(\fp'') = \overline{\sigma} (\fT(\fu), x)$ and $x \in E(\fp'') \subset \sc(\fp'')$. By property \eqref{coverdyadic} of the dyadic grid, there exists a cube $I \in \mathcal{D}$ of scale $s$ with $x \in I$. By property \eqref{eq dis freq cover}, there exists a tile $\fp' \in \fP(I)$ with $\tQ(x) \in \fc(\fp')$. By the dyadic property \eqref{dyadicproperty}  we have $\sc(\fp) \subset \sc(\fp') \subset \sc(\fp'')$, and by \eqref{eq freq dyadic}, we have $\fc(\fp'') \subset \fc(\fp') \subset \fc(\fp)$. Thus $\fp \le \fp' \le\fp''$, which gives with the convexity property \eqref{forest2} of $\fT(\fu)$ that $\fp' \in \fT(\fu)$, so $s \in \sigma(\fT(\fu), x)$.
\end{proof}

For a nonempty collection of tiles $\mathfrak{S} \subset \fP$ we define
$$
    \mathcal{J}_0(\mathfrak{S})
$$
to be the collection of all dyadic cubes $J \in \mathcal{D}$ such that $s(J) = -S$ or
$$
    \sc(\fp) \not\subset B(c(J), 100D^{s(J) + 1})
$$
for all $\fp \in \mathfrak{S}$. We define $\mathcal{J}(\mathfrak{S})$ to be the collection of inclusion maximal cubes in $\mathcal{J}_0(\mathfrak{S})$.

We further define
$$
    \mathcal{L}_0(\mathfrak{S})
$$
to be the collection of dyadic cubes $L \in \mathcal{D}$ such that $s(L) = -S$, or there exists $\fp \in \mathfrak{S}$ with $L \subset \sc(\fp)$ and there exists no $\fp \in \mathfrak{S}$ with $\sc(\fp) \subset L$. We define $\mathcal{L}(\mathfrak{S})$ to be the collection of inclusion maximal cubes in $\mathcal{L}_0(\mathfrak{S})$.

\begin{lemma}[dyadic partitions]
    \label{dyadic partitions}
    For each $\mathfrak{S} \subset \fP$, we have
    \begin{equation}
        \label{eq J partition}
        \bigcup_{I \in \mathcal{D}} I = \dot{\bigcup_{J \in \mathcal{J}(\mathfrak{S})}} J
    \end{equation}
    and
    \begin{equation}
        \label{eq L partition}
        \bigcup_{\fp\in \mathfrak{S}} \sc(\fp) = \dot{\bigcup_{L \in \mathcal{L}(\mathfrak{S})}} L\,.
    \end{equation}
\end{lemma}

\begin{proof}
    Since $\mathcal{J}(\mathfrak{S})$ is the set of inclusion maximal cubes in $\mathcal{J}_0(\mathfrak{S})$, cubes in $\mathcal{J}(\mathfrak{S})$ are pairwise disjoint by \eqref{dyadicproperty}. The same applies to $\mathcal{L}(\mathfrak{S})$.

    If $x \in \bigcup_{I \in \mathcal{D}} I$, then there exists by \eqref{coverdyadic} a cube $I \in \mathcal{D}$ with $x \in I$ and $s(I) = -S$. Then $I \in \mathcal{J}_0(\mathfrak{S})$. There exists an inclusion maximal cube in $\mathcal{J}_0(\mathfrak{S})$ containing $I$. This cube contains $x$ and is contained in $\mathcal{J}(\mathfrak{S})$. This shows one inclusion in \eqref{eq J partition}, the other one follows from $\mathcal{J}(\mathfrak{S}) \subset \mathcal{D}$.

    The proof of the two inclusions in \eqref{eq L partition} is similar.
\end{proof}

For a finite collection of pairwise disjoint cubes $\mathcal{C}$, define the projection operator
$$
    P_{\mathcal{C}}f(x) :=\sum_{J\in\mathcal{C}}\mathbf{1}_J(x) \frac{1}{\mu(J)}\int_J f(y) \, \mathrm{d}\mu(y)\,.
$$
Given a scale $-S \le s\le S$ and a point $x \in \bigcup_{I\in \mathcal{D}, s(I) = s} I$, there exists a unique cube in $\mathcal{D}$ of scale $s$ containing $x$ by \eqref{coverdyadic}. We denote it by $I_s(x)$. Define the nontangential maximal operator
\begin{equation}
    \label{eq TN def}
    T_{\mathcal{N}} f(x) := \sup_{-S \le s_1 < s_2 \le S} \sup_{x' \in I_{s_1}(x)} \left| \sum_{s = s_1}^{s_2}  \int K_s(x',y) f(y)  \, \mathrm{d}\mu(y) \right|\,.
\end{equation}
Define for each $\fu \in \fU$ the auxiliary operator
$$
    S_{1,\fu}f(x)
$$
\begin{equation}
    \label{eq def S op}
    :=\sum_{I\in\mathcal{D}} \mathbf{1}_{I}(x) \sum_{\substack{J\in \mathcal{J}(\fT(\fu))\\
    J\subset B(c(I), 16 D^{s(I)})}} \frac{D^{(s(J) - s(I))/a}}{\mu(B(c(I), 16D^{s(I)}))}\int_J |f(y)| \, \mathrm{d}\mu(y)\,.
\end{equation}
Define also the collection of balls
$$
    \mathcal{B} = \{B(c(I), D^{s + s(I)}) \ : \ I \in \mathcal{D}\,, 0 \le s \le S + 5\}\,.
$$

The following pointwise estimate for operators associated to sets $\fT(\fu)$ is the main result of this subsection.

\begin{lemma}[pointwise tree estimate]
    \label{pointwise tree estimate}
    \uses{first tree pointwise,second tree pointwise,third tree pointwise}
    Let $\fu \in \fU$ and $L \in \mathcal{L}(\fT(\fu))$. Let $x, x' \in L$.
    Then for all bounded functions $f$ with bounded support
    $$
        \left|\sum_{\fp \in \fT(\fu)} T_{\fp}[ e(\fcc(\fu))f](x)\right|
    $$
    \begin{equation}
        \label{eq LJ ptwise}
        \leq 2^{151a^3}(M_{\mathcal{B},1}+S_{1,\fu})P_{\mathcal{J}(\fT(\fu))}|f|(x')+|T_{\mathcal{N}}P_{\mathcal{J}(\fT(\fu))}f(x')|,
    \end{equation}
\end{lemma}


\begin{proof}
    By \eqref{definetp}, if $T_{\fp}[ e(-\fcc(\fu))f](x) \ne 0$, then $x \in E(\fp)$. Combining this with $|e(\fcc(\fu)(x)-\tQ(x)(x))| = 1$, we obtain
    $$
        |\sum_{\fp \in \fT(\fu)} T_{\fp}[ e(\fcc(\fu))f](x)|
    $$
    \begin{multline*}
        = \Bigg| \sum_{s \in \sigma(\fu, x)} \int e(-\fcc(\fu)(y) + \tQ(x)(y) + \fcc(\fu)(x) -\tQ(x)(x))\times\\
        K_s(x,y)f(y) \, \mathrm{d}\mu(y) \Bigg|\,.
    \end{multline*}
    Using the triangle inequality, we bound this by the sum of three terms:
    \begin{multline}
        \label{eq term A}
        \le \Bigg| \sum_{s \in \sigma(\fu, x)} \int (e(-\fcc(\fu)(y) + \tQ(x)(y) + \fcc(\fu)(x) -\tQ(x)(x))-1)\times\\
        K_s(x,y)f(y) \, \mathrm{d}\mu(y) \Bigg|
    \end{multline}
    \begin{equation}
        \label{eq term B}
        + \Bigg| \sum_{s \in \sigma(\fu, x)} \int K_s(x,y) P_{\mathcal{J}(\fT(\fu))} f(y) \, \mathrm{d}\mu(y) \Bigg|
    \end{equation}
    \begin{equation}
        \label{eq term C}
        + \Bigg| \sum_{s \in \sigma(\fu, x)} \int K_s(x,y) (f(y) - P_{\mathcal{J}(\fT(\fu))} f(y)) \, \mathrm{d}\mu(y) \Bigg|\,.
    \end{equation}
    The proof is completed using the bounds for these three terms proven in Lemma \ref{first tree pointwise}, Lemma \ref{second tree pointwise} and Lemma \ref{third tree pointwise}.
\end{proof}

\begin{lemma}[first tree pointwise]
    \label{first tree pointwise}
    For all $\fu \in \fU$, all $L \in \mathcal{L}(\fT(\fu))$, all $x, x' \in L$ and all bounded $f$ with bounded support, we have
    $$
        \eqref{eq term A} \le 10 \cdot 2^{105a^3} M_{\mathcal{B}, 1}P_{\mathcal{J}(\fT(\fu))}|f|(x')\,.
    $$
\end{lemma}

\begin{proof}
    Let $s \in \sigma(\fu,x)$.
    If $x, y \in X$ are such that $K_s(x,y)\neq 0$, then, by \eqref{supp Ks}, we have $\rho(x,y)\leq 1/2 D^s$. By $1$-Lipschitz continuity of the function $t \mapsto \exp(it) = e(t)$, it follows that
    \begin{multline*}
        |e(-\fcc(\fu)(y)+\tQ(x)(y)+\fcc(\fu)(x)-\tQ(x)(x))-1|\\
        \leq d_{B(x, 1/2 D^{s})}(\fcc(\fu), \tQ(x))\,.
    \end{multline*}
    Let $\fp_s \in \fT(\fu)$ be a tile with $\ps(\fp_s) = s$ and $x \in E(\fp_s)$, and let $\fp'$ be a tile with $\ps(\fp') = \overline{\sigma}(\fu, x)$ and $x \in E(\fp')$.
    Using the doubling property \eqref{firstdb}, the definition of $d_{\fp}$ and Lemma \ref{monotone cube metrics}, we can bound the previous display by
    $$
        2^a d_{\fp_s}(\fcc(\fu), \tQ(x)) \le 2^{a} 2^{s - \overline{\sigma}(\fu, x)} d_{\fp'}(\fcc(\fu), \tQ(x))\,.
    $$
    Since $\fcc(\fu) \in B_{\fp'}(\fcc(\fp'), 4)$ by \eqref{forest1} and $\tQ(x) \in \Omega(\fp') \subset B_{\fp'}(\fcc(\fp'), 1)$ by \eqref{eq freq comp ball}, this is estimated by
    $$
        \le 5 \cdot 2^{a} 2^{s - \overline{\sigma}(\fu, x)} \,.
    $$
    Using \eqref{eq Ks size}, it follows that
    $$
        \eqref{eq term A} \le 5\cdot 2^{103a^3} \sum_{s\in\sigma(x)}2^{s - \overline{\sigma}(\fu, x)} \frac{1}{\mu(B(x,D^s))}\int_{B(x,0.5D^{s})}|f(y)|\,\mathrm{d}\mu(y)\,.
    $$
    By \eqref{eq J partition}, the collection $\mathcal{J}$ is a partition of $X$, so this is estimated by
    $$
         5\cdot 2^{103a^3} \sum_{s\in\sigma(x)}2^{s - \overline{\sigma}(\fu, x)} \frac{1}{\mu(B(x,D^s))}\sum_{\substack{J \in \mathcal{J}(\fT(\fu))\\J \cap B(x, 0.5D^s) \ne \emptyset} }\int_{J}|f(y)|\,\mathrm{d}\mu(y)\,.
    $$
    This expression does not change if we replace $|f|$ by $P_{\mathcal{J}(\fT(\fu))}|f|$.

    Let $J \in \mathcal{J}(\fT(\fu))$ with $B(x, 0.5 D^s) \cap J \ne \emptyset$. By the triangle inequality and since $x \in E(\fp_s) \subset B(\pc(\fp_s), 4D^{s})$, it follows that $B(\pc(\fp_s), 4.5D^s) \cap J \ne \emptyset$. If $s(J) \ge s$ and $s(J) > -S$, then it follows from the triangle inequality, \eqref{eq vol sp cube} and \eqref{defineD} that $\sc(\fp_s) \subset B(c(J), 100 D^{s(J)+1})$, contradicting $J \in \mathcal{J}(\mathfrak{T}(\fu))$. Thus $s(J) \le s - 1$ or $s(J) = -S$. If $s(J) = -S$ and $s(J) > s - 1$, then $s = -S$. Thus we always have $s(J) \le s$. It then follows from the triangle inequality and \eqref{eq vol sp cube} that $J \subset B(\pc(\fp_s), 16 D^s)$.

    Thus we can continue our chain of estimates with
    $$
        5\cdot 2^{103a^3} \sum_{s\in\sigma(x)}2^{s - \overline{\sigma}(\fu, x)} \frac{1}{\mu(B(x,D^s))}\int_{B(\pc(\fp_s),16 D^s)}P_{\mathcal{J}(\fT(\fu))}|f(y)|\,\mathrm{d}\mu(y)\,.
    $$
    We have $B(\pc(\fp_s), 16D^s)) \subset B(x, 32D^s)$, by \eqref{eq vol sp cube} and the triangle inequality, since $x \in \sc(\fp)$. Combining this with the doubling property \eqref{doublingx}, we obtain
    $$
        \mu(B(\pc(\fp_s), 16D^s)) \le 2^{5a} \mu(B(x, D^s))\,.
    $$
    Since $a \ge 4$, it follows that \eqref{eq term A} is bounded by
    $$
        2^{104a^3} \sum_{s\in\sigma(x)}2^{s - \overline{\sigma}(\fu, x)} \frac{1}{\mu(B(\pc(\fp_s),16D^s))}\int_{B(\pc(\fp_s),16D^s)}P_{\mathcal{J}(\fT(\fu))}|f(y)|\,\mathrm{d}\mu(y)\,.
    $$
    Since $L \in \mathcal{L}(\fT(\fu))$, we have $s(L) \le \ps(\fp)$ for all $\fp \in \fT(\fu)$. Since $x\in L \cap \sc(\fp_s)$, it follows by \eqref{dyadicproperty} that $L \subset \sc(\fp_s)$, in particular $x' \in \sc(\fp_s) \subset B(\pc(\fp_s), 16D^s)$. Thus
    $$
        \le 2^{104a^3} \sum_{s\in\sigma(x)}2^{s - \overline{\sigma}(\fu, x)} M_{\mathcal{B}, 1}P_{\mathcal{J}(\fT(\fu))}|f|(x')
    $$
    $$
        \le 2^{105a^3} M_{\mathcal{B}, 1}P_{\mathcal{J}(\fT(\fu))}|f|(x')\,.
    $$
    This completes the estimate for term \eqref{eq term A}.
\end{proof}

\begin{lemma}[second tree pointwise]
    \label{second tree pointwise}
    For all $\fu \in \fU$, all $L \in \mathcal{L}(\fT(\fu))$, all $x, x' \in L$ and all bounded $f$ with bounded support, we have
    $$
        %\eqref{eq term B}
         \Bigg| \sum_{s \in \sigma(\fu, x)} \int K_s(x,y) P_{\mathcal{J}(\fT(\fu))} f(y) \, \mathrm{d}\mu(y) \Bigg| \le T_{\mathcal{N}} P_{\mathcal{J}(\fT(\fu))} f(x')\,.
    $$
\end{lemma}

\begin{proof}
    Let $s = \underline{\sigma}(\fu, x)$. By definition, there exists a tile $\fp \in \fT(\fu)$ with $\ps(\fp) = s$ and $x \in E(\fp)$. Then $x \in \sc(\fp) \cap L$. By \eqref{dyadicproperty} and the definition of $\mathcal{L}(\fT(\fu))$, it follows that $L \subset \sc(\fp)$, in particular $x' \in \sc(\fp)$, so $x \in I_s(x')$.
    The lemma now follows from the definition of $T_{\mathcal{N}}$.
\end{proof}

\begin{lemma}[third tree pointwise]
    \label{third tree pointwise}
    For all $\fu \in \fU$, all $L \in \mathcal{L}(\fT(\fu))$, all $x, x' \in L$ and all bounded $f$ with bounded support, we have
    \begin{equation*}
        \Bigg| \sum_{s \in \sigma(\fu, x)} \int K_s(x,y) (f(y) - P_{\mathcal{J}(\fT(\fu))} f(y)) \, \mathrm{d}\mu(y) \Bigg|
    \end{equation*}
    \begin{equation*}
          \le 2^{151a^3} S_{1,\fu} P_{\mathcal{J}(\fT(\fu))}|f|(x')\,.
    \end{equation*}
\end{lemma}

\begin{proof}
    We have for $J \in \mathcal{J}(\fT(\fu))$:
    $$
        \int_J K_{s}(x,y)(1 - P_{\mathcal{J}(\fT(\fu))})f(y) \, \mathrm{d}\mu(y)
    $$
    \begin{equation}
    \label{eq canc comp}
        =  \int_J \frac{1}{\mu(J)} \int_J K_s(x,y) - K_s(x,z) \, \mathrm{d}\mu(z) \,f(y) \, \mathrm{d}\mu(y)\,.
    \end{equation}
    By \eqref{eq Ks smooth} and \eqref{eq vol sp cube}, we have for $y, z \in J$
    $$
        |K_s(x,y) - K_s(x,z)| \le \frac{2^{150a^3}}{\mu(B(x, D^s))} \left(\frac{8 D^{s(J)}}{D^s}\right)^{1/a}\,.
    $$
    Suppose that $s \in \sigma(\fu, x)$.
    If $K_s(x,y) \ne 0$ for some $y \in J \in \mathcal{J}(\fT(\fu))$ then, by \eqref{supp Ks}, $y \in B(x, 0.5 D^s) \cap J \ne \emptyset$. Let $\fp \in \fT(\fu)$ with $\ps(\fp) = s$ and $x \in E(\fp)$. Then $B(\pc(\fp_s), 4.5D^s) \cap J \ne \emptyset$ by the triangle inequality. If $s(J) \ge s$ and $s(J) > -S$, then it follows from the triangle inequality, \eqref{eq vol sp cube} and \eqref{defineD} that $\sc(\fp) \subset B(c(J), 100 D^{s(J)+1})$, contradicting $J \in \mathcal{J}(\mathfrak{T}(\fu))$. Thus $s(J) \le s - 1$ or $s(J) = -S$. If $s(J) = -S$ and $s(J) > s - 1$, then $s = -S$. So in both cases, $s(J) \le s$. It then follows from the triangle inequality and \eqref{eq vol sp cube} that $J \subset B(x, 16 D^s)$.

    Thus, we can estimate \eqref{eq term C} by
    $$
        2^{150a^3 + 3/a}\sum_{\fp\in \mathfrak{T}}\frac{\mathbf{1}_{E(\fp)}(x)}{\mu(B(x,D^{\ps(\fp)}))}\sum_{\substack{J\in \mathcal{J}(\fT(\fu))\\J\subset B(x,  16D^{\ps(\fp)})}}  D^{(s(J) - \ps(\fp))/a} \int_J |f|\,.
    $$
    $$
        = 2^{150a^3 + 3/a}\sum_{I \in \mathcal{D}} \sum_{\substack{\fp\in \mathfrak{T}\\ \sc(\fp) = I}}\frac{\mathbf{1}_{E(\fp)}(x)}{\mu(B(x, D^{s(I)}))}\sum_{\substack{J\in \mathcal{J}(\fT(\fu))\\J\subset B(x,  16 D^{\ps(\fp)})}}  D^{(s(J) - s(I))/a} \int_J |f|\,.
    $$
    By \eqref{eq dis freq cover} and \eqref{definedE}, the sets $E(\fp)$ for tiles $\fp$ with $\sc(\fp) = I$ are pairwise disjoint.
    If $x \in E(\fp)$ then in particular $x \in \sc(\fp)$, so by \eqref{eq vol sp cube} $B(c(I),16D^{s(I)}) \subset B(x, 32D^{s(I)})$. By the doubling property \eqref{doublingx}
    $$
        \mu(B(c(I), 16D^{s(I)})) \le 2^{5a} \mu(B(x, D^{s(I)}))\,.
    $$
    Since $a \ge 4$ we can continue our estimate with
    $$
        \le 2^{151a^3}\sum_{I \in \mathcal{D}} \frac{\mathbf{1}_{I}(x)}{\mu(B(c(I),  16D^{s(I)}))}\sum_{\substack{J\in \mathcal{J}(\fT(\fu))\\J\subset B(x,  16 D^{\ps(\fp)})}}  D^{(s(J) - \ps(\fp))/a} \int_J |f|\,.
    $$
    Finally, it follows from the definition of $\mathcal{L}(\fT(\fu))$ that $x \in \sc(\fp)$ if and only if $x' \in \sc(\fp)$, thus this equals
    $$
         2^{151a^3} S_{1,\fu} P_{\mathcal{J}(\fT(\fu))}|f|(x')\,.
    $$
    This completes the proof.
\end{proof}

\section{An auxiliary \texorpdfstring{$L^2$}{L2} tree estimate}

In this subsection we prove the following estimate on $L^2$ for operators associated to trees.

\begin{lemma}[tree projection estimate]
    \label{tree projection estimate}
    \uses{dyadic partitions,pointwise tree estimate,nontangential operator bound,boundary operator bound}
    Let $\fu \in \fU$.
    Then we have for all $f, g$ bounded with bounded support
    $$
        \Bigg|\int_X \sum_{\fp \in \fT(\fu)} \bar g(y) T_{\fp}f(y) \, \mathrm{d}\mu(y)  \Bigg|
    $$
    \begin{equation}
        \label{eq tree est}
         \le 2^{104a^3}\|P_{\mathcal{J}(\fT(\fu))}|f|\|_{2}\|P_{\mathcal{L}(\fT(\fu))}|g|\|_{2}.
    \end{equation}
\end{lemma}

Below, we deduce Lemma \ref{tree projection estimate} from Lemma \ref{pointwise tree estimate} and the following estimates for the operators in Lemma \ref{pointwise tree estimate}.

\begin{lemma}[nontangential operator bound]
    \label{nontangential operator bound}
  \uses{Hardy Littlewood}
    For all bounded $f$ with bounded support
    $$
        \|T_{\mathcal{N}} f\|_2 \le 2^{103a^3} \|f\|_2\,.
    $$
\end{lemma}

\begin{lemma}[boundary operator bound]
    \label{boundary operator bound}
    \uses{Hardy Littlewood,boundary overlap}
    For all $\fu \in \fU$ and all bounded functions $f$ with bounded support
    \begin{equation}
        \label{eq S bound}
        \|S_{1,\fu}f\|_2 \le 2^{12a} \|f\|_2\,.
    \end{equation}
\end{lemma}

\begin{proof}[Proof of Lemma \ref{tree projection estimate}]
    For each $L \in \mathcal{L}(\fT(\fu))$, choose a point $x'(L) \in L$ such that for all $y \in L$
    $$
        (M_{\mathcal{B},1}+S_{1,\fu})P_{\mathcal{J}(\fT(\fu))}|f|(x')+|T_{\mathcal{N}}P_{\mathcal{J}(\fT(\fu))}f(x')|
    $$
    \begin{equation}
        \label{eq x'L almost inf}
        \le 2 ((M_{\mathcal{B},1}+S_{1,\fu})P_{\mathcal{J}(\fT(\fu))}|f|(y)+|T_{\mathcal{N}}P_{\mathcal{J}(\fT(\fu))}f(y)|)\,.
    \end{equation}
    This point exists since \eqref{eq x'L almost inf} is non-negative for each $y$.
    Then we have by Lemma \ref{pointwise tree estimate} for each $L \in \mathcal{L}(\fT(\fu))$
    $$
        \int_L |g(y)| \Bigg| \sum_{\fp \in \fT(\fu)} T_{\fp} f(y) \Bigg| \, \mathrm{d}\mu(y)
    $$
    $$
        \le 2^{151a^3} \int_L |g(y)| ((M_{\mathcal{B},1}+S_{1,\fu})P_{\mathcal{J}(\fT(\fu))}|f|(x')+|T_{\mathcal{N}}P_{\mathcal{J}(\fT(\fu))}f(x')| ) \, \mathrm{d}\mu(y)
    $$
    \begin{multline*}
        \le 2^{151a^3} \int_L |g(y)| \, \mathrm{d}\mu(y)\times\\
         \int_L 2((M_{\mathcal{B},1}+S_{1,\fu})P_{\mathcal{J}(\fT(\fu))}|f|(y)+|T_{\mathcal{N}}P_{\mathcal{J}(\fT(\fu))}f(y)| ) \, \mathrm{d}\mu(y)
    \end{multline*}
    \begin{multline*}
        =  2^{151a^3 + 1} \int_L P_{\mathcal{L}(\fT(\fu))}|g|(y)\times \\((M_{\mathcal{B},1}+S_{1,\fu})P_{\mathcal{J}(\fT(\fu))}|f|(y)+|T_{\mathcal{N}}P_{\mathcal{J}(\fT(\fu))}f(y)| ) \, \mathrm{d}\mu(y)\,.
    \end{multline*}
    By \eqref{definetp}, we have $T_{\fp} f = \mathbf{1}_{\sc(\fp)} T_{\fp} f$ for all $\fp \in \fP$, so
    $$
        \Bigg| \int \bar g(y) \sum_{\fp \in \fT(\fu)} T_{\fp} f(y)  \, \mathrm{d}\mu(y) \Bigg| = \Bigg| \int_{\bigcup_{\fp \in \fT(\fu)} \sc(\fp)} \bar g(y) \sum_{\fp \in \fT(\fu)} T_{\fp} f(y)  \, \mathrm{d}\mu(y) \Bigg|\,.
    $$
    Since $\mathcal{L}(\fT(\fu))$ partitions $\bigcup_{\fp \in \fT(\fu)} \sc(\fp)$ by Lemma \ref{dyadic partitions},
    we get from the triangle inequality
    $$
        \le \sum_{L \in \mathcal{L}(\fT(\fu))} \int_L |g(y)| \Bigg| \sum_{\fp \in \fT(\fu)} T_{\fp} f(y) \Bigg| \, \mathrm{d}\mu(y)
    $$
    which by the above computation is bounded by
    \begin{multline*}
        2^{151a^3 + 1} \sum_{L \in \mathcal{L}(\fT(\fu))} \int_L P_{\mathcal{L}(\fT(\fu))}|g|(y) \times \\((M_{\mathcal{B},1}+S_{1,\fu})P_{\mathcal{J}(\fT(\fu))}|f|(y)+|T_{\mathcal{N}}P_{\mathcal{J}(\fT(\fu))}f(y)| ) \, \mathrm{d}\mu(y)
    \end{multline*}
    \begin{multline*}
        = 2^{151a^3 + 1} \int_X P_{\mathcal{L}(\fT(\fu))}|g|(y)\times \\((M_{\mathcal{B},1}+S_{1,\fu})P_{\mathcal{J}(\fT(\fu))}|f|(y)+|T_{\mathcal{N}}P_{\mathcal{J}(\fT(\fu))}f(y)| ) \, \mathrm{d}\mu(y)\,.
    \end{multline*}
    Applying Cauchy-Schwarz and Minkowski's inequality, this is bounded by
    \begin{multline*}
        2^{151a^3 + 1} \|P_{\mathcal{L}(\fT(\fu))}|g|\|_2 \times \\(\|M_{\mathcal{B},1}P_{\mathcal{J}(\fT(\fu))}|f|\|_2 + \|S_{1,\fu}P_{\mathcal{J}(\fT(\fu))}|f|\|_2 + \|T_{\mathcal{N}}P_{\mathcal{J}(\fT(\fu))}f(y)|\|_2)\,.
    \end{multline*}
    By Proposition \ref{Hardy Littlewood}, Lemma \ref{nontangential operator bound} and Lemma \ref{boundary operator bound}, the second factor is at most
    $$
        (2^{2a+1} + 2^{12a})\|P_{\mathcal{J}(\fT(\fu))}|f|\|_2 + 2^{103a^3} \|P_{\mathcal{J}(\fT(\fu))}f\|_2\,.
    $$
    By the triangle inequality we have for all $x \in X$ that $|P_{\mathcal{J}(\fT(\fu))}f|(x) \le P_{\mathcal{J}(\fT(\fu))}|f|(x)$, thus we can further estimate the above by
    $$
        (2^{2a+1} + 2^{12a} + 2^{103a^3}) \|P_{\mathcal{J}(\fT(\fu))}|f|\|_2\,.
    $$
    This completes the proof since $a \ge 4$.
\end{proof}

Now we prove the two auxiliary lemmas. We begin with the nontangential maximal operator $T_{\mathcal{N}}$.

\begin{proof}[Proof of Lemma \ref{nontangential operator bound}]
    Fix $s_1, s_2$. By \eqref{eq psisum} we have for all $x \in (0, \infty)$
    $$
        \sum_{s = s_1}^{s_2} \psi(D^{-s}x) = 1 - \sum_{s < s_1} \psi(D^{-s}x) - \sum_{s > s_1} \psi(D^{-s}x)\,.
    $$
    Since $\psi$ is supported in $[\frac{1}{4D}, \frac{1}{2}]$, the two sums on the right hand side are zero for all $x \in [\frac{1}{2}D^{s_1-1}, \frac{1}{4} D^{s_2 - 1}]$, hence
    $$
        x \in  [\frac{1}{2}D^{s_1-1}, \frac{1}{4} D^{s_2}] \implies \sum_{s = s_1}^{s_2} \psi(D^{-s}x) = 1\,.
    $$
    Since $\psi$ is supported in $[\frac{1}{4D}, \frac{1}{2}]$, we further have
    $$
        x \notin [\frac{1}{4}D^{s_1 - 1}, \frac{1}{2}D^{s_2}] \implies \sum_{s = s_1}^{s_2} \psi(D^{-s}x) = 0\,.
    $$
    Finally, since $\psi \ge 0$ and $\sum_{s \in \mathbb{Z}} \psi(D^{-s}x) = 1$, we have for all $x$
    $$
        0 \le \sum_{s = s_1}^{s_2} \psi(D^{-s}x) \le 1\,.
    $$
    Let $x' \in I_{s_1}(x)$. By the triangle inequality and \eqref{eq vol sp cube}, it holds that $\rho(x,x') \le 8D^{s_1}$. We have
    $$
        \Bigg|\sum_{s = s_1}^{s_2} \int K_s(x',y) f(y) \, \mathrm{d}\mu(y)\Bigg|
    $$
    $$
        = \Bigg|\int \sum_{s = s_1}^{s_2} \psi(D^{-s}\rho(x',y)) K(x',y) f(y) \, \mathrm{d}\mu(y)\Bigg|
    $$
    \begin{equation}
        \label{eq sharp trunc term}
        \le \Bigg| \int_{8D^{s_1} \le \rho(x',y) \le \frac{1}{4}D^{s_2}} K(x',y) f(y) \, \mathrm{d}\mu(y) \Bigg|
    \end{equation}
    \begin{equation}
        \label{eq lower bound term}
        + \int_{\frac{1}{4}D^{s_1-1} \le \rho(x',y) \le 8D^{s_1}} |K(x', y)| |f(y)| \, \mathrm{d}\mu(y)
    \end{equation}
    \begin{equation}
        \label{eq upper bound term}
        + \int_{\frac{1}{4}D^{s_2} \le \rho(x',y) \le \frac{1}{2}D^{s_2}} |K(x', y)| |f(y)| \, \mathrm{d}\mu(y)\,.
    \end{equation}
    The first term \eqref{eq sharp trunc term} is at most $T_* f(x)$.

    The other two terms will be estimated by the finitary maximal function from Proposition \ref{Hardy Littlewood}.
    For the second term \eqref{eq lower bound term} we use \eqref{eqkernel size} which implies that for all $y$ with $\rho(x', y) \ge \frac{1}{4}D^{s_1 - 1}$, we have
    $$
        |K(x', y)| \le \frac{2^{a^3}}{\mu(B(x', \frac{1}{4}D^{s_1 - 1}))}\,.
    $$
    Using $D=2^{100a^2}$
    and the doubling property \eqref{doublingx} $6 +100a^2$ times estimates
    the last display by
    \begin{equation}
    \label{pf nontangential operator bound imeq}
        \le \frac{2^{6a+101a^3}}{\mu(B(x',  16D^{s_1}))}\, .
    \end{equation}
    By the triangle inequality and \eqref{eq vol sp cube}, we have
    $$
        B(x', 8D^{s_1}) \subset B(c(I_{s_1}(x)), 16D^{s(I_{s_1}(x))})\,.
    $$
    Combining this with \eqref{pf nontangential operator bound imeq}, we conclude that \eqref{eq lower bound term} is at most
    $$
        2^{6a + 101a^3} M_{\mathcal{B},1} f(x)\,.
    $$

    For \eqref{eq upper bound term} we argue similarly. We have for all $y$ with $\rho(x', y) \ge \frac{1}{4}D^{s_2}$
    $$
        |K(x', y)| \le \frac{2^{a^3}}{\mu(B(x', \frac{1}{4}D^{s_2}))}\,.
    $$
    Using the doubling property \eqref{doublingx} $6$ times estimates
    the last display by
    \begin{equation}
        \le \frac{2^{6a + a^3}}{\mu(B(x',  16 D^{s_2}))}\, .
    \end{equation}
    Note that by \eqref{dyadicproperty} we have $I_{s_1}(x) \subset I_{s_2}(x)$, in particular $x' \in I_{s_2}(x)$.
    By the triangle inequality and \eqref{eq vol sp cube}, we have
    $$
        B(x', 8D^{s_2}) \subset B(c(I_{s_2}(x)), 16D^{s(I_{s_2}(x))})\,.
    $$
    Combining this, \eqref{eq upper bound term} is at most
    $$
        2^{6a+a^3} M_{\mathcal{B},1} f(x)\,.
    $$

    Using $a \ge 4$, taking a supremum over all $x' \in I_{s_1}(x)$ and then a supremum over all $-S \le s_1 < s_2 \le S$, we obtain
    $$
        T_{\mathcal{N}} f(x) \le T_*f(x) + 2^{102a^3}  M_{\mathcal{B},1} f(x)\,.
    $$
    The lemma now follows from assumption \eqref{nontanbound}, Proposition \ref{Hardy Littlewood} and $a \ge 4$.
\end{proof}

We need the following lemma to prepare the $L^2$-estimate for the auxiliary operators $S_{1, \fu}$.

\begin{lemma}[boundary overlap]
    \label{boundary overlap}
    For every cube $I \in \mathcal{D}$, there exist at most $2^{8a}$ cubes $J \in \mathcal{D}$ with $s(J) = s(I)$ and $B(c(I), 16D^{s(I)}) \cap B(c(J), 16 D^{s(J)}) \ne \emptyset$.
\end{lemma}

\begin{proof}
    Suppose that $B(c(I), 16 D^{s(I)}) \cap B(c(J), 16 D^{s(J)}) \ne \emptyset$ and $s(I) = s(J)$. Then $B(c(I), 32 D^{s(I)}) \subset B(c(J), 64 D^{s(J)})$. Hence by the doubling property \eqref{doublingx}
    $$
        2^{8a}\mu(B(c(J), \frac{1}{4}D^{s(J)})) \ge \mu(B(c(I), 32 D^{s(I)}))\,,
    $$
    and by the triangle inequality, the ball $B(c(J), \frac{1}{4}D^{s(J)})$ is contained in $B(c(I), 32 D^{s(I)})$.

    If $\mathcal{C}$ is any finite collection of cubes $J \in \mathcal{D}$ satisfying $s(J) = s(I)$ and
    \begin{equation*}
        B(c(I), 16 D^{s(I)}) \cap B(c(J), 16 D^{s(J)}) \ne\emptyset\ ,
    \end{equation*} then it follows from \eqref{eq vol sp cube} and pairwise disjointedness of cubes of the same scale \eqref{dyadicproperty} that the balls $B(c(J), \frac{1}{4} D^{s(J)})$ are pairwise disjoint. Hence
    \begin{align*}
        \mu(B(c(I), 32 D^{s(I)})) &\ge \sum_{J \in \mathcal{C}} \mu(B(c(J), \frac{1}{4}D^{s(J)}))\\
        &\ge |\mathcal{C}| 2^{-8a} \mu(B(c(I), 32 D^{s(I)}))\,.
    \end{align*}
    Since $\mu$ is doubling and $\mu \ne 0$, we have $\mu(B(c(I), 32D^{s(I)})) > 0$. The lemma follows after dividing by $2^{-8a}\mu(B(c(I), 32D^{s(I)}))$.
\end{proof}

Now we can bound the operators $S_{1, \fu}$.

\begin{proof}[Proof of Lemma \ref{boundary operator bound}]
    Note that by definition, $S_{1,\fu}f$ is a finite sum of indicator functions of cubes $I \in \mathcal{D}$ for each locally integrable $f$, and hence is bounded, has bounded support and is integrable. Let $g$ be another function with the same three properties. Then $\bar g S_{1,\fu}f$ is integrable, and we have
    $$
        \Bigg|\int \bar g(y) S_{1,\fu}f(y) \, \mathrm{d}\mu(y)\Bigg|
    $$
    \begin{multline*}
        = \Bigg|\sum_{I\in\mathcal{D}} \frac{1}{\mu(B(c(I), 16 D^{s(I)}))} \int_I \bar g(y) \, \mathrm{d}\mu(y)\\
        \times \sum_{J\in \mathcal{J}\,:\,J\subseteq B(c(I), 16 D^{s(I)})} D^{(s(J)-s(I))/a}\int_J |f(y)| \,\mathrm{d}\mu(y)\Bigg|
    \end{multline*}
    \begin{multline*}
        \le \sum_{I\in\mathcal{D}} \frac{1}{\mu(B(c(I), 16D^{s(I)}))} \int_{B(c(I), 16D^{s(I)})} | g(y)| \, \mathrm{d}\mu(y)\\ \times \sum_{J\in \mathcal{J}\,:\,J\subseteq B(c(I), 16 D^{s(I)})} D^{(s(J)-s(I))/a}\int_J |f(y)| \,\mathrm{d}\mu(y)\,.
    \end{multline*}
    Changing the order of summation and using $J \subset B(c(I), 16 D^{s(I)})$ to bound the first average integral by $M_{\mathcal{B},1}|g|(y)$ for any $y \in J$, we obtain
    \begin{align}
    \label{eq boundary operator bound 1}
        \le \sum_{J\in\mathcal{J}}\int_J|f(y)|  M_{\mathcal{B},1}|g|(y) \, \mathrm{d}\mu(y) \sum_{I \in \mathcal{D} \, : \, J\subset B(c(I),16 D^{s(I)})} D^{(s(J)-s(I))/a}.
    \end{align}
    By \eqref{eq vol sp cube} and \eqref{defineD} the condition $J \subset B(c(I), 16 D^{s(I)})$ implies $s(I) \ge s(J)$. By Lemma \ref{boundary overlap}, there are at most $2^{8a}$ cubes $I$ at each scale with $J \subset B(c(I), D^{s(I)})$.
    By convexity of $t \mapsto D^t$ and since $D \ge 2$, we have for all $-1 \le t \le 0$
    $$
        D^t \le 1 + t\left(1 - \frac{1}{D}\right) \le 1 + \frac{1}{2}t\,,
    $$
    so $(1 - D^{-1/a})^{-1} \le 2a \le 2^a$.
    Using this estimate for the sum of the geometric series,
    we conclude that \eqref{eq boundary operator bound 1} is at most
    $$
        2^{9a} \sum_{J\in\mathcal{J}}\int_J|f(y)|  M_{\mathcal{B},1}|g|(y) \, \mathrm{d}\mu(y)\,.
    $$
    The collection $\mathcal{J}$ is a partition of $X$, so this equals
    $$
        2^{9a} \int_X|f(y)|  M_{\mathcal{B},1}|g|(y) \, \mathrm{d}\mu(y)\,.
    $$
    Using Cauchy-Schwarz and Proposition \ref{Hardy Littlewood} we conclude
    $$
        \left|\int \bar g S_{1,\fu}f \, \mathrm{d}\mu \right| \le  2^{11a+1} \|g\|_2\|f\|_2\,.
    $$
    \rs{Constant changed, check}
    The lemma now follows by choosing $g = S_{1,\fu}f$ and dividing on both sides by the finite $\|S_{1,\fu}f\|_2$.
\end{proof}

\section{The quantitative \texorpdfstring{$L^2$}{L2} tree estimate}

The main result of this subsection is the following quantitative bound for operators associated to trees, with decay in the the densities $\dens_1$ and $\dens_2$.

\begin{lemma}[densities tree bound]
    \label{densities tree bound}
    \uses{tree projection estimate,local dens1 tree bound,local dens2 tree bound}
    Let $\fu \in \fU$. Then for all $f,g$ bounded with bounded support
    \begin{equation}
        \label{eq cor tree est}
        \left|\int_X \overline g \sum_{\fp \in \fT(\fu)} T_{\fp }f \, \mathrm{d}\mu \right| \le  2^{155a^3} \dens_1(\fT(\fu))^{1/2} \|f\|_2\|g\|_2\,.
    \end{equation}
    If $|f| \le \mathbf{1}_F$, then we have
    \begin{equation}
        \label{eq cor tree est F}
        \left| \int_X \overline g \sum_{\fp \in \fT(\fu)} T_{\fp }f\, \mathrm{d}\mu \right| \le  2^{256a^3} \dens_1(\fT(\fu))^{1/2} \dens_2(\fT(\fu))^{1/2} \|f\|_2\|g\|_2\,.
    \end{equation}
\end{lemma}

Below, we deduce this lemma from  Lemma \ref{tree projection estimate} and the following two estimates controlling the size of support of the operator and its adjoint.

\begin{lemma}[local dens1 tree bound]
    \label{local dens1 tree bound}
    \uses{monotone cube metrics}
    Let $\fu \in \fU$ and $L \in \mathcal{L}(\fT(\fu))$. Then
    \begin{equation}
    \label{eq 1density estimate tree}
        \mu(L \cap \bigcup_{\fp \in \fT(\fu)} E(\fp)) \le 2^{101a^3} \dens_1(\fT(\fu)) \mu(L)\,.
    \end{equation}
\end{lemma}

\begin{lemma}[local dens2 tree bound]
    \label{local dens2 tree bound}
    Let $J \in \mathcal{J}(\fT(\fu))$ be such that there exist $\fq \in \fT(\fu)$ with $J \cap \sc(\fq) \ne \emptyset$. Then
    $$
        \mu(F \cap J) \le 2^{200a^3 + 19} \dens_2(\fT(\fu))\,.
    $$
\end{lemma}

\begin{proof}[Proof of Lemma \ref{densities tree bound}]
    Denote
    $$
        \mathcal{E}(\fu) = \bigcup_{\fp \in \fT(\fu)} E(\fp)\,.
    $$
    Then we have
    $$
        \left| \int_X \bar g \sum_{\fp \in \fT(\fu)} T_{\fp} f \, \mathrm{d}\mu \right|  = \left| \int_X \overline{ g\mathbf{1}_{\mathcal{E}(\fu)}}  \sum_{\fp \in \fT(\fu)} T_{\fp} f \, \mathrm{d}\mu \right|\,.
    $$
    By Lemma \ref{tree projection estimate}, this is bounded by
    \begin{equation}
        \label{eq both factors tree}
        \le 2^{104a^3}\|P_{\mathcal{J}(\fT(\fu))}|f|\|_2 \|P_{\mathcal{L}(\fT(\fu))} |\mathbf{1}_{\mathcal{E}(\fu)}g|\|_2\,.
    \end{equation}
    We bound the two factors on the right hand side separately.
    We have
    $$
        \|P_{\mathcal{L}(\fT(\fu))} |\mathbf{1}_{\mathcal{E}(\fu)}g|\|_2 = \left( \sum_{L \in \mathcal{L}(\fT(\fu))} \frac{1}{\mu(L)} \left(\int_{L \cap \mathcal{E}(\fu)} |g(y)| \, \mathrm{d}\mu(y)\right)^2 \right)^{1/2}\,.
    $$
    By Cauchy-Schwarz and Lemma \ref{local dens1 tree bound} this is at most
    $$
        \le \left( \sum_{L \in \mathcal{L}(\fT(\fu))} 2^{101a^3} \dens_1(\fT(\fu)) \int_{L \cap \mathcal{E}(\fu)} |g(y)|^2 \, \mathrm{d}\mu(y) \right)^{1/2}\,.
    $$
    Since cubes $L \in \mathcal{L}(\fT(\fu))$ are pairwise disjoint by Lemma \ref{dyadic partitions}, this is
    \begin{equation}
        \label{eq factor L tree}
         \le 2^{51 a^3} \dens_1(\fT(\fu))^{1/2} \|g\|_2\,.
    \end{equation}

    Similarly, we have
    \begin{equation}
        \label{eq cor tree proof}
        \|P_{\mathcal{J}(\fT(\fu))}|f|\|_2  = \left( \sum_{J \in \mathcal{J}(\fT(\fu))} \frac{1}{\mu(J)} \left(\int_J |f(y)| \, \mathrm{d}\mu(y)\right)^2 \right)^{1/2}\,.
    \end{equation}
    By Cauchy-Schwarz, this is
    $$
        \le \left( \sum_{J \in \mathcal{J}(\fT(\fu))} \int_J |f(y)|^2 \, \mathrm{d}\mu(y) \right)^{1/2}\,.
    $$
    Since cubes in $\mathcal{J}(\fT(\fu))$ are pairwise disjoint by Lemma \ref{dyadic partitions}, this at most
    \begin{equation}
        \label{eq factor J tree}
        \|f\|_2\,.
    \end{equation}
    Combining \eqref{eq both factors tree}, \eqref{eq factor L tree} and \eqref{eq factor J tree} and using $a \ge 4$ gives \eqref{eq cor tree est}.

    If $f \le \mathbf{1}_F$ then $f = f\mathbf{1}_F$, so
    $$
        \left( \sum_{J \in \mathcal{J}(\fT(\fu))} \int_J |f(y)|^2 \, \mathrm{d}\mu(y) \right)^{1/2} = \left( \sum_{J \in \mathcal{J}(\fT(\fu))} \int_{J \cap F} |f(y)|^2 \, \mathrm{d}\mu(y) \right)^{1/2}\,.
    $$
    We estimate as before, using now Lemma \ref{local dens2 tree bound} and Cauchy-Schwarz, that the right hand side is
    $$
        \le 2^{100a^3 + 10} \dens_2(\fT(\fu))^{1/2} \|f\|_2\,.
    $$
    Combining this with \eqref{eq both factors tree}, \eqref{eq factor L tree} and $a \ge 4$ gives \eqref{eq cor tree est F}.
\end{proof}

Now we prove the two auxiliary estimates.

\begin{proof}[Proof of Lemma \ref{local dens1 tree bound}]
    If the set on the right hand side is empty, then \eqref{eq 1density estimate tree} holds. If not, then there exists $\fp \in \fT(\fu)$ with $L \cap \sc(\fp) \ne \emptyset$.

    Suppose first that there exists such $\fp$ with $\ps(\fp) \le s(L)$. Then by \eqref{dyadicproperty} $\sc(\fp) \subset L$, which gives by the definition of $\mathcal{L}(\fT(\fu))$ that $s(L) = -S$ and hence $L = \sc(\fp)$. Let $\fq \in \fT(\fu)$ with $E(\fq) \cap L \ne \emptyset$. Since $s(L) = -S \le \ps(\fq)$ it follows from \eqref{dyadicproperty} that $\sc(\fp) = L \subset \sc(\fq)$. We have then by Lemma \ref{monotone cube metrics}
    \begin{align*}
        d_{\fp}(\fcc(\fp), \fcc(\fq)) &\le d_{\fp}(\fcc(\fp), \fcc(\fu)) + d_{\fp}(\fcc(\fq), \fcc(\fu))\\
        &\le d_{\fp}(\fcc(\fp), \fcc(\fu)) + d_{\fq}(\fcc(\fq), \fcc(\fu))\,.
    \end{align*}
    Using that $\fp, \fq \in \fT(\fu)$ and \eqref{forest1}, this is at most $8$. Using again the triangle inequality and Lemma \ref{monotone cube metrics}, we obtain that for each $q \in B_{\fq}(\fcc(\fq), 1)$
    $$
        d_{\fp}(\fcc(\fp), q) \le d_{\fp}(\fcc(\fp), \fcc(\fq)) + d_{\fq}(\fcc(\fq), q) \le 9\,.
    $$
    Thus $L \cap E(\fq) \subset E_2(9, \fp)$. We obtain
    $$
        \mu(L \cap \bigcup_{\fq \in \fT(\fu)} E(\fq)) \le \mu(E_2(9, \fp))\,.
    $$
    By the definition of $\dens_1$, this is bounded by
    $$
        9^a \dens_1(\fT(\fu)) \mu(\sc(\fp)) =9^a \dens_1(\fT(\fu)) \mu(L)\,.
    $$
    Since $a \ge 4$, \eqref{eq 1density estimate tree} follows in this case.

    Now suppose that for each $\fp \in \fT(\fu)$ with $L \cap E(\fp) \ne \emptyset$, we have $\ps(\fp) > s(L)$. Since there exists at least one such $\fp$, there exists in particular at least one cube $L'' \in \mathcal{D}$ with $L \subset L''$ and $s(L'') > s(L)$. By \eqref{coverdyadic}, there exists $L' \in \mathcal{D}$ with $L \subset L'$ and $s(L') = s(L) + 1$. By the definition of $\mathcal{L}(\fT(\fu))$ there exists a tile $\fp'' \in \fT(\fu)$ with $\sc(\fp'') \subset L'$. Let $\fp'$ be the unique tile such that $\sc(\fp') = L'$ and such that $\Omega(\fu) \cap \Omega(\fp') \ne \emptyset$. Since by \eqref{forest1} $\ps(\fp') = s(L') \le \ps(\fp) < \ps(\fu)$, we have by \eqref{dyadicproperty} and \eqref{eq freq dyadic} that $\Omega(\fu) \subset \Omega(\fp')$. Let $\fq \in \fT(\fu)$ with $L \cap E(\fq) \ne \emptyset$. As shown above, this implies $\ps(\fq) \ge s(L')$, so by \eqref{dyadicproperty} $L' \subset \sc(\fq)$. If $q \in B_{\fq}(\fcc(\fq), 1)$, then by a similar calculation as above, using the triangle inequality, Lemma \ref{monotone cube metrics} and \eqref{forest1}, we obtain
    $$
        d_{\fp'}(\fcc(\fp'), q) \le d_{\fp'}(\fcc(\fp'), \fcc(\fq)) + d_{\fq}(\fcc(\fq), q) \le 6\,.
    $$
    Thus $L \cap E(\fq) \subset E_2(6, \fp')$. Since $\sc(\fp'') \subset \sc(\fp') \subset \sc(\fp)$ and $\fp'', \fp \in \fT(\fu)$, we have $\fp' \in \fP(\fT(\fu))$. We deduce using the definition \eqref{definedens1} of $\dens_1$
    $$
        \mu(L \cap \bigcup_{\fq \in \fT(\fu)} E(\fq)) \le \mu(E_2(6, \fq')) \le 6^a \dens_1(\fT(\fu)) \mu(L')\,.
    $$
    Using the doubling property \eqref{doublingx}, \eqref{eq vol sp cube}, and $a \ge 4$ this is estimated by
    $$
        6^a 2^{100a^3 + 5}\dens_1(\fT(\fu)) \mu(L) \le 2^{101 a^3} \dens_1(\fT(\fu))\mu(L)\,.
    $$
    This completes the proof.
\end{proof}

\begin{proof}[Proof of Lemma \ref{local dens2 tree bound}]
    Suppose first that there exists a tile $\fp \in \fT(\fu)$ with $\sc(\fp) \subset B(c(J), 100 D^{s(J) + 1})$. By the definition of $\mathcal{J}(\fT(\fu))$, this implies that $s(J) = -S$, and in particular $\ps(\fp) \ge s(J)$. Using the triangle inequality and \eqref{eq vol sp cube} it follows that $J \subset B(\pc(\fp), 200 D^{\ps(\fp) + 1})$. From the doubling property \eqref{doublingx}, $D=2^{100a^2}$ and \eqref{eq vol sp cube}, we obtain
    $$
        \mu(\sc(\fp)) \le 2^{100a^3 + 9} \mu(J)
    $$
    and hence
    $$
        \mu( B(\pc(\fp), 200 D^{\ps(\fp) + 1})) \le 2^{200a^3 +19} \mu(J)\,.
    $$
    With the definition \eqref{definedens2} of $\dens_2$ it follows that
    $$
        \mu(J \cap F) \le \mu( B(\pc(\fp), 200 D^{\ps(\fp) + 1}) \cap F)
    $$
    $$
        \le \dens_2(\fT(\fu)) \mu( B(\pc(\fp), 200 D^{\ps(\fp) + 1})) \le 2^{200a^3 +19} \dens_2(\fT(\fu))\mu(J)\,,
    $$
    completing the proof in this case.

    Now suppose that there does not exist a tile $\fp \in \fT(\fu)$ with $\sc(\fp) \subset B(c(J), 100 D^{s(J) + 1})$. If we had $\ps(\fq) \le s(J)$, then by \eqref{dyadicproperty} and \eqref{eq vol sp cube}  $\sc(\fq) \subset J \subset B(c(J), 100 D^{s(J) + 1})$, contradicting our assumption. Thus $\ps(\fq) > s(J)$. Then, by \eqref{coverdyadic} and \eqref{dyadicproperty}, there exists some cube $J' \in \mathcal{D}$ with $s(J') = s(J) + 1$ and $J \subset J'$. By definition of $\mathcal{J}(\fT(\fu))$ there exists some $\fp \in \fT(\fu)$ such that $\sc(\fp) \subset B(c(J'), 100 D^{s(J') + 1})$.  From the doubling property \eqref{doublingx}, $D=2^{100a^2}$ and \eqref{eq vol sp cube}, we obtain
    \begin{equation}
        \label{eq measure comparison 1}
        \mu(B(\pc(\fp), 4D^{\ps(\fp)})) \le 2^{4a} \mu(\sc(\fp)) \le 2^{200a^3 + 14} \mu(J)\,.
    \end{equation}
    If $J \subset B(\pc(\fp), 4 D^{\ps(\fp)})$, then we bound
    $$
        \mu(J \cap F) \le \mu(B(\pc(\fp), 4D^{\ps(\fp)}) \cap F)
    $$
    and use the definition \eqref{definedens2}
    $$
        \le \dens_2(\fT(\fu)) \mu(B(\pc(\fp), 4D^{\ps(\fp)})) \le 2^{200a^3 + 14} \mu(J)\,.
    $$
    From now on we assume $J \not \subset B(\pc(\fp), 4 D^{\ps(\fp)})$.
    Since
    \begin{equation*}
        \pc(\fp) \in \sc(\fp) \subset B(c(J'), 100 D^{s(J') + 1})\, ,
    \end{equation*}
    we have by \eqref{eq vol sp cube} and the triangle inequality
    $$
        J \subset J' \subset B(c(J'), 4D^{s(J')}) \subset B(\pc(\fp), 104 D^{s(J') + 1})\,.
    $$
    In particular this implies $104 D^{s(J') + 1} > 4D^{\ps(\fp)}$. By the triangle inequality we also have
    $$
        B(\pc(\fp), 104 D^{s(J') + 1}) \subset B(c(J), 204 D^{s(J') + 1})\,,
    $$
    so from the doubling property \eqref{doublingx}
    $$
        \mu( B(\pc(\fp), 104 D^{s(J') + 1})) \le 2^{200a^3 + 10} \mu(J)\,.
    $$
    From here one completes the proof as in the other cases.
\end{proof}

\section{Almost orthogonality of separated trees}

The main result of this subsection is the almost orthogonality estimate for operators associated to distinct trees in a forest in Lemma \ref{correlation separated trees} below. We will deduce this Lemma from Lemmas \ref{correlation distant tree parts} and \ref{correlation near tree parts}, which are proven in Subsections \ref{subsec big tiles} and \ref{subsec rest tiles}, respectively. Before stating the lemma, we introduce some relevant notation.

The adjoint of the operator $T_{\fp}$ defined in \eqref{definetp} is given by
\begin{equation}
    \label{definetp*}
    T_{\fp}^* g(x) = \int_{E(\fp)} \overline{K_{\ps(\fp)}(y,x)} e(-\tQ(y)(x)+ \tQ(y)(y)) g(y) \, \mathrm{d}\mu(y)\,.
\end{equation}

\begin{lemma}[adjoint tile support]
    \label{adjoint tile support}
    For each $\fp \in \fP$, we have
    $$
        T_{\fp}^* g = \mathbf{1}_{B(\pc(\fp), 5D^{\ps(\fp)})} T_{\fp}^* \mathbf{1}_{\sc(\fp)} g\,.
    $$
    For each $\fu \in \fU$ and each $\fp \in \fT(\fu)$, we have
    $$
        T_{\fp}^* g = \mathbf{1}_{\sc(\fu)} T_{\fp}^* \mathbf{1}_{\sc(\fu)} g\,.
    $$
\end{lemma}

\begin{proof}
    By \eqref{forest1}, $E(\fp) \subset \sc(\fp) \subset \sc(\fu)$. Thus by \eqref{definetp*}
    $$
         T_{\fp}^* g(x) =  T_{\fp}^* (\mathbf{1}_{\sc(\fp)} g)(x)
    $$
    $$
        = \int_{E(\fp)} \overline{K_{\ps(\fp)}(y,x)} e(-\tQ(y)(x) +  \tQ(y)(y)) \mathbf{1}_{\sc(\fp)}(y) g(y) \, \mathrm{d}\mu(y)\,.
    $$
    If this integral is not $0$, then there exists $y \in \sc(\fp)$ such that $K_{\ps(\fp)}(y,x) \ne 0$. By \eqref{supp Ks}, \eqref{eq vol sp cube} and the triangle inequality, it follows that
    \begin{equation*}
        x \in B(\pc(\fp), 5 D^{\ps(\fp)})\, .
    \end{equation*}
    Thus
    $$
        T_{\fp}^* g(x) = \mathbf{1}_{B(\pc(\fp), 5D^{\ps(\fp)})}(x) T_{\fp}^* (\mathbf{1}_{\sc(\fp)} g)(x)\,.
    $$
    The second claimed equation follows now since $\sc(\fp) \subset \sc(\fu)$ and by \eqref{forest6} $B(\pc(\fp), 5D^{\ps(\fp)}) \subset \sc(\fu)$.
\end{proof}

\begin{lemma}[adjoint tree estimate]
    \label{adjoint tree estimate}
    \uses{densities tree bound}
    For all bounded $g$ with bounded support, we have that
    $$
        \left\| \sum_{\fp \in \fT(\fu)} T_{\fp}^* g\right\|_2 \le 2^{155a^3} \dens_1(\fT(\fu))^{1/2} \|g\|_2\,.
    $$
\end{lemma}

\begin{proof}
    By Cauchy-Schwarz and Lemma \ref{densities tree bound}, we have for all bounded $f,g$ with bounded support that
    $$
        \left| \int_X \overline{\sum_{\fp\in \fT(\fu)} T_{\fp}^* g} f \,\mathrm{d}\mu \right| = \left| \int_X g \sum_{\fp \in \fT(\fu)} T_{\fp} f \,\mathrm{d}\mu \right|
    $$
    \begin{equation}
        \label{eq adjoint bound}
        \le 2^{155a^3} \dens_1(\fT(\fu))^{1/2} \|g\|_2 \|f\|_2\,.
    \end{equation}
    Let $f = \sum_{\fp \in \fT(\fu)} T_{\fp}^* g$. If $g$ is bounded and has bounded support, then the same is true for $f$. In particular $\|f\|_2 < \infty$. Dividing \eqref{eq adjoint bound} by $\|f\|_2$ completes the proof.
\end{proof}

We define
$$
    S_{2,\fu}g := \left|\sum_{\fp \in \fT(\fu)} T_{\fp}^*g \right| + M_{\mathcal{B},1}g + |g|\,.
$$
\begin{lemma}[adjoint tree control]
    \label{adjoint tree control}
    \uses{Hardy Littlewood,adjoint tree estimate}
    We have for all bounded $g$ with bounded support
    $$
        \|S_{2, \fu} g\|_2 \le 2^{156a^3} \|g\|_2\,.
    $$
\end{lemma}

\begin{proof}
    This follows immediately from Minkowski's inequality, Proposition \ref{Hardy Littlewood} and Lemma \ref{adjoint tree estimate}, using that $a \ge 4$.
\end{proof}


Now we are ready to state the main result of this subsection.

\begin{lemma}[correlation separated trees]
    \label{correlation separated trees}
    \uses{adjoint tile support,correlation distant tree parts,correlation near tree parts}
    For any $\fu_1 \ne \fu_2 \in \fU$ and all bounded $g_1, g_2$ with bounded support, we have
    \begin{equation}
        \label{eq lhs sep tree}
        \left| \int_X \sum_{\fp_1 \in \fT(\fu_1)} \sum_{\fp_2 \in \fT(\fu_2)} T^*_{\fp_1}g_1 \overline{T^*_{\fp_2}g_2 }\,\mathrm{d}\mu \right|
    \end{equation}
    \begin{equation}
        \label{eq rhs sep tree}
        \le 2^{650a^3-3n} \prod_{j =1}^2 \| S_{2, \fu_j} g_j\|_{L^2(\sc(\fu_1) \cap \sc(\fu_2))}\,.
    \end{equation}
    \rs{Constant changed from $2^{550a^3}$, check}
\end{lemma}

\begin{proof}[Proof of Lemma \ref{correlation separated trees}]
    By Lemma \ref{adjoint tile support} and \eqref{dyadicproperty}, the left hand side \eqref{eq lhs sep tree} is $0$ unless $\sc(\fu_1) \subset \sc(\fu_2)$ or $\sc(\fu_2) \subset \sc(\fu_1)$. Without loss of generality we assume that $\sc(\fu_1) \subset \sc(\fu_2)$.

    Define
    \begin{equation}
        \label{def Tree S set}
         \mathfrak{S} := \{\fp \in \fT(\fu_1) \cup \fT(\fu_2) \ : \ d_{\fp}(\fcc(\fu_1), \fcc(\fu_2)) \ge 2^{Zn/2}\,\}.
    \end{equation}
    Lemma \ref{correlation separated trees} follows by combining the definition \eqref{defineZ} of $Z$ with the following two lemmas.
    \begin{lemma}[correlation distant tree parts]
        \label{correlation distant tree parts}
        We have for all $\fu_1 \ne \fu_2 \in \fU$ with $\sc(\fu_1) \subset \sc(\fu_2)$ and all bounded $g_1, g_2$ with bounded support
        \begin{equation}
            \label{eq lhs big sep tree}
            \left| \int_X \sum_{\fp_1 \in \fT(\fu_1)} \sum_{\fp_2 \in \fT(\fu_2) \cap \mathfrak{S}} T^*_{\fp_1}g_1 \overline{T^*_{\fp_2}g_2 }\,\mathrm{d}\mu \right|
        \end{equation}
        \begin{equation}
            \label{eq rhs big sep tree}
            \le 2^{650a^3} 2^{-Zn/(4a^2 + 2a^3)} \prod_{j =1}^2 \| S_{2, \fu_j} g_j\|_{L^2(\sc(\fu_1))}\,.
        \end{equation}
        \rs{Constant changed from $2^{550a^3}$, check}
    \end{lemma}
    \begin{lemma}[correlation near tree parts]
        \label{correlation near tree parts}
        We have for all $\fu_1 \ne \fu_2 \in \fU$ with $\sc(\fu_1) \subset \sc(\fu_2)$ and all bounded $g_1, g_2$ with bounded support
        \begin{equation}
            \label{eq lhs small sep tree}
            \left| \int_X \sum_{\fp_1 \in \fT(\fu_1)} \sum_{\fp_2 \in \fT(\fu_2) \setminus \mathfrak{S}} T^*_{\fp_1}g_1 \overline{T^*_{\fp_2}g_2 }\,\mathrm{d}\mu \right|
        \end{equation}
        \begin{equation}
            \label{eq rhs small sep tree}
            \le 2^{222a^3} 2^{-Zn 2^{-10a}} \prod_{j =1}^2 \| S_{2, \fu_j} g_j\|_{L^2(\sc(\fu_1)}\,.
        \end{equation}
    \end{lemma}
\end{proof}

In the proofs of both lemmas, we will need the following observation.

\begin{lemma}[overlap implies distance]
    \label{overlap implies distance}
    Let $\fu_1 \ne \fu_2 \in \fU$ with $\sc(\fu_1) \subset \sc(\fu_2)$. If $\fp \in \fT(\fu_1) \cup \fT(\fu_2)$ with $\sc(\fp) \cap \sc(\fu_1) \ne \emptyset$, then $\fp \in \mathfrak{S}$. In particular, we have $\fT(\fu_1) \subset \mathfrak{S}$.
\end{lemma}

\begin{proof}
    Suppose first that $\fp \in \fT(\fu_1)$. Then $\sc(\fp) \subset \sc(\fu_1) \subset \sc(\fu_2)$, by \eqref{forest1}. Thus we have by the separation condition \eqref{forest5}, \eqref{eq freq comp ball}, \eqref{forest1} and the triangle inequality
    \begin{align*}
        d_{\fp}(\fcc(\fu_1), \fcc(\fu_2)) &\ge d_{\fp}(\fcc(\fp), \fcc(\fu_2)) - d_{\fp}(\fcc(\fp), \fcc(\fu_1))\\
        &\ge 2^{Z(n+1)} - 4\\
        &\ge 2^{Zn}\,,
    \end{align*}
    using that $Z= 2^{12a}\ge 4$. Hence $\fp \in \mathfrak{S}$.

    Suppose now that $\fp \in \fT(\fu_2)$. If $\sc(\fp) \subset \sc(\fu_1)$, then the same argument as above with $\fu_1$ and $\fu_2$ swapped shows $\fp \in \mathfrak{S}$. If $\sc(\fp) \not \subset \sc(\fu_1)$ then, by \eqref{dyadicproperty}, $\sc(\fu_1) \subset \sc(\fp)$. Pick $\fp' \in \fT(\fu_1)$, we have $\sc(\fp') \subset \sc(\fu_1) \subset \sc(\fp)$. Hence, by Lemma \ref{monotone cube metrics} and the first paragraph
    $$
        d_{\fp}(\fcc(\fu_1), \fcc(\fu_2)) \ge d_{\fp'}(\fcc(\fu_1), \fcc(\fu_2)) \ge 2^{Zn}\,,
    $$
    so $\fp \in \mathfrak{S}$.
\end{proof}

To simplify the notation, we will write at various places throughout the proof of Lemmas \ref{correlation distant tree parts} and \ref{correlation near tree parts} for a subset $\fC \subset \fP$
$$
    T_{\fC} f := \sum_{\fp \in \fC} T_{\fp} f\,, \quad\quad T_{\fC}^* g := \sum_{\fp\in\fC} T_{\fp}^* g\,.
$$

\section{Proof of Lemma \ref{correlation distant tree parts}: Tiles with large separation}
    \label{subsec big tiles}

Lemma \ref{correlation distant tree parts} follows from the van der Corput estimate in Proposition \ref{Holder van der Corput}. We apply this proposition in Subsubsection \ref{subsubsec van der corput}. To prepare this application, we first, in Subsubsection \ref{subsubsec pao}, construct a suitable partition of unity, and show then, in Subsubsection \ref{subsubsec holder estimates} the Hölder estimates needed to apply Proposition \ref{Holder van der Corput}.

\subsubsection{A partition of unity}
\label{subsubsec pao}
    Define
    $$
        \mathcal{J}' = \{J \in \mathcal{J}(\mathfrak{S}) \ : \ J \subset \sc(\fu_1)\}\,.
    $$

    \begin{lemma}
        \label{lem J' partition}
        We have that
        $$
            \sc(\fu_1) = \dot{\bigcup_{J \in \mathcal{J}'}} J\,.
        $$
    \end{lemma}

    \begin{proof}
        By Lemma \ref{dyadic partitions}, it remains only to show that each $J \in \mathcal{J}(\mathfrak{S})$ with $J \cap \sc(\fu_1) \ne \emptyset$ is in $\mathcal{J}'$. But if $J \notin \mathcal{J}'$, then by \eqref{dyadicproperty} $\sc(\fu_1) \subsetneq J$. Pick $\fp \in \fT(\fu_1) \subset \mathfrak{S}$.  Then $\sc(\fp) \subsetneq J$. This contradicts the definition of $\mathcal{J}(\mathfrak{S})$.
    \end{proof}

    For cubes $J \in \mathcal{D}$, denote
    \begin{equation}
        \label{def BJ}
        B(J) := B(c(J), 8D^{s(J)}).
    \end{equation}
    The main result of this subsubsection is the following.

    \begin{lemma}
        \label{lem partition of unity}
        There exists a family of functions $\chi_J$, $J \in \mathcal{J}'$ such that \begin{equation}
            \label{eq pao 1}
            \mathbf{1}_{\sc(\fu_1)} = \sum_{J \in \mathcal{J}'} \chi_J\,,
        \end{equation}
        and for all $J \in \mathcal{J}'$ and all $y,y' \in \sc(\fu_1)$
        \begin{equation}
            \label{eq pao 2}
            0 \leq \chi_J(y) \leq \mathbf{1}_{B(J)}(y)\,,
        \end{equation}
        \begin{equation}
            \label{eq pao 3}
            |\chi_J(y) - \chi_J(y')| \le 2^{301a^3}  \frac{\rho(y,y')}{D^{s(J)}}\,.
        \end{equation}
        \rs{Changed constant, check}
    \end{lemma}

    In the proof, we will use the following auxiliary lemma.

    \begin{lemma}
        \label{lem J' smooth}
        If $J, J' \in \mathcal{J'}$ with
        $$
            B(J) \cap B(J') \ne \emptyset\,,
        $$
        then $|s(J) - s(J')| \le 1$.
    \end{lemma}

    \begin{proof}[Proof of Lemma \ref{lem partition of unity}]
        For each cube $J \in \mathcal{J}$ let
        $$
            \tilde\chi_J(y) = \max\{0, 8 - D^{-s(J)} \rho(y, c(J))\}\,,
        $$
        and set
        $$
            a(y) = \sum_{J \in \mathcal{J}'} \tilde \chi_J(y)\,.
        $$
        We define
        \[
            \chi_J(y) := \frac{\tilde \chi_J(y)}{a(y)}\,.
        \]
        Then, due to \eqref{forest6} and \eqref{def BJ}, the properties \eqref{eq pao 1} and \eqref{eq pao 2} are clearly true. Estimate \eqref{eq pao 3} follows from \eqref{eq pao 2} if $y, y' \notin B(J)$. Thus we can assume that $y \in B(J)$. We have by the triangle inequality
        $$
            |\chi_J(y) - \chi_J(y')| \le \frac{|\tilde \chi_J(y) - \tilde \chi_J(y')|}{a(y)} + \frac{\tilde \chi_J(y')|a(y) - a(y')|}{a(y)a(y')}
        $$
        Since $\tilde \chi_J(z) \ge 4$ for all $z \in B(c(J), 4) \supset J$ and by Lemma \ref{lem J' partition}, we have that $a(z) \ge 4$ for all $z \in \sc(\fu_1)$. So we can estimate the above further by
        $$
            \le 2^{-2}(|\tilde \chi_J(y) - \tilde \chi_J(y')| + \tilde \chi_J(y')|a(y) - a(y')|)\,.
        $$
        If $y' \notin B(\pc(\fp), 8D^{\ps(\fp)})$ then the second summand vanishes. Else, we can estimate the above, using also that $|\tilde \chi_J(y')| \le 8$, by
        $$
            \le 2^{-2} |\tilde \chi_J(y) - \tilde \chi_J(y')| + 2 \sum_{\substack{J' \in \mathcal{J}'\\ B(c(J'), 8D^{s(J')}) \cap B(c(J), 8D^{s(J)}) \ne \emptyset}}|\tilde \chi_{J'}(y) - \tilde \chi_{J'} (y')|\,.
        $$
        By the triangle inequality, we have for all dyadic cubes $I \in \mathcal{J}'$
        $$
            |\tilde \chi_I(y) - \tilde \chi_I(y')| \le \rho(y, y') D^{-s(I)}\,.
        $$
        Using this above, we obtain
        $$
            |\chi_J(y) - \chi_J(y')| \le \rho(y,y') \Big( \frac{1}{4} D^{-s(J)} + 2 \sum_{\substack{J' \in \mathcal{J}'\\ B(J') \cap B(J) \ne \emptyset}} D^{-s(J')}\Big)\,.
        $$
        By Lemma \ref{lem J' smooth}, this is at most
        $$
             \frac{\rho(y,y')}{D^{s(J)}} \left( \frac{1}{4} + 2D |\{J' \in \mathcal{J}' \ : \  B(J') \cap B(J) \ne \emptyset\}|\right)\,.
        $$
        By \eqref{eq vol sp cube} and Lemma \ref{lem J' partition}, the balls $B(c(J'), \frac{1}{4} D^{s(J')})$ are pairwise disjoint, so by Lemma \ref{lem J' smooth} the balls $B(c(J'), \frac{1}{4} D^{s(J) - 1})$ are also disjoint. By the triangle inequality and Lemma \ref{lem J' smooth}, each such ball for $J'$ in the set of the last display is contained in
        $$
            B(c(J), 9 D^{s(J) + 1})\,.
        $$
        By the doubling property \eqref{doublingx}, we further have
        $$
            \mu\Big(B(c(J'), \frac{1}{4}D^{s(J')})\Big) \ge 2^{-200a^3 - 6} \mu(B(c(J), 9 D^{s(J) + 1}))
        $$
        for each such ball.
        Thus
        $$
            |\{J' \in \mathcal{J}' \ : \  B(J') \cap B(J) \ne \emptyset\}| \le 2^{200a^3 + 6}\,.
        $$
        Recalling that $D=2^{100a^2}$, we obtain
        $$\frac{1}{4} + 2D |\{J' \in \mathcal{J}' \ : \  B(J') \cap B(J) \ne \emptyset\}|\leq 2^{200a^3 + 100a^2+ 8}.$$
        Since $a\ge 4$, \eqref{eq pao 3} follows.
    \end{proof}

    \begin{proof}[Proof of Lemma \ref{lem J' smooth}]
        Suppose that $s(J') < s(J) - 1$. Then $s(J) > -S$. Thus, by the definition of $\mathcal{J}'$ there exists no $\fp \in \mathfrak{S}$ with
        \begin{equation}
            \label{eq tile incl 1}
            \sc(\fp) \subset B(c(J), 100D^{s(J) + 1})\,.
        \end{equation}
        Since $s(J') < s(J)$ and $J', J \subset \sc(\fu_1)$, we have $J' \subsetneq \sc(\fu_1)$.
        By \eqref{coverdyadic}, \eqref{dyadicproperty} there exists a cube $J'' \in \mathcal{D}$ with $J \subset J''$ and $s(J'') = s(J') + 1$. By the definition of $\mathcal{J}'$, there exists a tile $\fp \in \mathfrak{S}$ with
        \begin{equation}
            \label{tile incl 2}
            \sc(\fp) \subset B(c(J''), 100 D^{s(J')+2})\,.
        \end{equation}
        But by the triangle inequality and \eqref{defineD}, we have
        $$
            B(c(J''), 100 D^{s(J')+2}) \subset B(c(J), 100D^{s(J) + 1})\,,
        $$
        which contradicts \eqref{eq tile incl 1} and \eqref{tile incl 2}.
    \end{proof}


\subsubsection{Hölder estimates for adjoint tree operators}
\label{subsubsec holder estimates}
    Let $g_1, g_2:X \to \mathbb{C}$  be bounded with bounded support.
    Define for $J \in \mathcal{J}'$
    \begin{equation}
        \label{def hj}
        h_J(y) := \chi_J(y)\cdot(e(\fcc(\fu_1)(y)) T_{\fT(\fu_1)}^* g_1(y)) \cdot \overline{(e(\fcc(\fu_2)(y)) T_{\fT(\fu_2) \cap \mathfrak{S}}^* g_2(y))}\,.
    \end{equation}
    The main result of this subsubsection is the following $\tau$-Hölder estimate for $h_J$, where $\tau = 1/a$.

    \begin{lemma}
        \label{lem hHölder}
        We have for all $J \in \mathcal{J}'$ that
        \begin{equation}
            \label{hHölder}
            \|h_J\|_{C^{\tau}(B(c(J), 8D^{s(J)}))} \le  2^{611a^3}   \prod_{j = 1,2} (\inf_{B(c(J), \frac{1}{8}D^{s(J)})} |T_{\fT(\fu_j)}^* g_j| + \inf_J M_{\mathcal{B}, 1} |g_j|)\,.
        \end{equation}
        \rs{Constant changed from $511a^3$ to $611a^3$, check}
    \end{lemma}

    We will prove this lemma at the end of this section, after establishing several auxiliary results.

    We begin with the following Hölder continuity estimate for adjoints of operators associated to tiles.
    \begin{lemma}
        \label{lem tile Hölder}
        Let $\fu \in \fU$ and $\fp \in \fT(\fu)$.  Then for all $y, y' \in X$ and all bounded $g$ with bounded support, we have
        $$
            |e(\fcc(\fu)(y)) T_{\fp}^* g(y) - e(\fcc(\fu)(y')) T_{\fp}^* g(y')|
        $$
        \begin{equation}
            \label{T*Hölder2}
            \le \frac{2^{151a^3}}{\mu(B(\pc(\fp), 4D^{\ps(\fp)}))} \left(\frac{\rho(y, y')}{D^{\ps(\fp)}}\right)^{1/a}  \int_{E(\fp)} |g(x)| \, \mathrm{d}\mu(x)\,.
        \end{equation}
    \end{lemma}

    \begin{proof}
        By \eqref{definetp*}, we have
        $$
            |e(\fcc(\fu)(y)) T_{\fp}^* g(y) - e(\fcc(\fu)(y')) T_{\fp}^* g(y')|
        $$
        \begin{multline*}
            =\bigg| \int_{E(\fp)} e(\tQ(x)(x) - \tQ(x)(y) + \fcc(\fu)(y)) \overline{K_{\ps(\fp)}(x, y)} g(x) \\
            -  e(\tQ(x)(x) - \tQ(x)(y') + \fcc(\fu)(y')) \overline{K_{\ps(\fp)}(x, y')}  g(x) \, \mathrm{d}\mu(x)\bigg|
        \end{multline*}
        \begin{multline*}
            \leq\int_{E(\fp)} |g(x)| |e(\tQ(x)(y) - \tQ(x)(y') - \fcc(\fu)(y) + \fcc(\fu)(y'))\overline{K_{\ps(\fp)}(x, y)}\\
            - \overline{K_{\ps(\fp)}(x, y')}| \, \mathrm{d}\mu(x)
        \end{multline*}
        \begin{multline}
            \leq\int_{E(\fp)} |g(x)| |e(-\tQ(x)(y) + \tQ(x)(y') + \fcc(\fu)(y) - \fcc(\fu)(y')) - 1| \\
            \times |\overline{K_{\ps(\fp)}(x, y)}|\, \mathrm{d}\mu(x) \label{T*Hölder1b}
        \end{multline}
        \begin{equation}
            + \int_{E(\fp)} |g(x)| |\overline{K_{\ps(\fp)}(x, y)} - \overline{K_{\ps(\fp)}(x, y')} |\, \mathrm{d}\mu(x)\,.\label{T*Hölder1}
        \end{equation}
        By the definition of $d$, we have
        $$
            |-\tQ(x)(y) + \tQ(x)(y') + \fcc(\fu)(y) - \fcc(\fu)(y')|
        $$
        \begin{equation}
            \label{eq lem tile Holder comp}
            \le d_{B(y, \rho(y,y'))}(\tQ(x), \fcc(\fu))\,.
        \end{equation}
        Suppose that $y, y' \in B(\pc(\fp), 5D^{\ps(\fp)})$, so that $\rho(y,y') \le 10D^{\ps(\fp)}$. Let $k \in \mathbb{Z}$ be such that $2^{ak}\rho(y,y') \le 10D^{\ps(\fp)}$ but $2^{a(k+1)} \rho(y,y') > 10D^{\ps(\fp)}$. In particular, $k \ge 0$. Then, using \eqref{firstdb}, we can bound \eqref{eq lem tile Holder comp} from above by
        $$
            2^{-k} d_{B(\pc(\fp), 10 D^{\ps(\fp)})}(\tQ(x), \fcc(\fu)) \le 2^{6a - k} d_{\fp}(\tQ(x), \fcc(\fu))\,.
        $$
        Since $x \in E(\fp)$ we have $\tQ(x) \in \Omega(\fp) \subset B_{\fp}(\fcc(\fp), 1)$, and since $\fp \in \fT(\fu)$ we have $\fcc(\fu) \in B_{\fp}(\fcc(\fp), 4)$, so this is estimated by
        $$
            \le 5 \cdot 2^{6a - k}\,.
        $$
        By definition of $k$, we have
        $$
            k \le \frac{1}{a} \log_2\left(\frac{10 D^{\ps(\fp)}}{\rho(y,y')}\right)\,,
        $$
        which gives
        \begin{equation}
            \label{eq lem Tile holder im1}
             |-\tQ(x)(y) + \tQ(x)(y') + \fcc(\fu)(y) - \fcc(\fu)(y')| \le 5 \cdot 2^{6a} \left(\frac{\rho(y,y')}{10 D^{\ps(\fp)}}\right)^{1/a}\,.
        \end{equation}
        For all $x \in \sc(\fp)$, we have by \eqref{doublingx} that
        $$
            \mu(B(x, D^{\ps(\fp)})) \ge 2^{-3a} \mu(B(\pc(\fp), 4D^{\ps(\fp)}))\,.
        $$
        Combining the above with \eqref{eq Ks size}, \eqref{eq Ks smooth} and \eqref{eq lem Tile holder im1},
        we obtain
        $$
            \eqref{T*Hölder1b}+\eqref{T*Hölder1} \le \frac{2^{3a}}{\mu(B(\pc(\fp), 4D^{\ps(\fp)}))} \int_{E(\fp)}|g(x)| \, \mathrm{d}\mu(x) \times
        $$
        $$
            (2^{102a^3} \cdot 5 \cdot 2^{6a} \left(\frac{\rho(y,y')}{ D^{\ps(\fp)}}\right)^{1/a} + 2^{150a^3} \left(\frac{\rho(y,y')}{D^{\ps(\fp)}}\right)^{1/a})
        $$
        Since $\rho(y,y') \le 10 D^{\ps(\fp)}$, we conclude
        $$
            \eqref{T*Hölder1b}+\eqref{T*Hölder1} \le \frac{2^{151a^3}}{\mu(B(\pc(\fp), 4D^{\ps(\fp)}))} \left(\frac{\rho(y,y')}{D^{\ps(\fp)}}\right)^{1/a} \int_{E(\fp)}|g(x)| \, \mathrm{d}\mu(x)\,.
        $$

        Next, if $y,y' \notin B(\pc(\fp), 5D^{\ps(\fp)})$, then $T_{\fp}^*g(y) = T_{\fp}^*g(y') = 0$, by Lemma \ref{adjoint tile support}. Then \eqref{T*Hölder2} holds.

        Finally, if $y \in B(\pc(\fp), 5D^{\ps(\fp)})$ and $y' \notin B(\pc(\fp), 5D^{\ps(\fp)})$, then
        $$
            |e(\fcc(\fu)(y)) T_{\fp}^* g(y) - e(\fcc(\fu)(y')) T_{\fp}^* g(y')| = |T_{\fp}^* g(y)|
        $$
        $$
            \le \int_{E(\fp)} |K_{\ps(\fp)}(x,y)| |g(x)| \, \mathrm{d}\mu(x)\,.
        $$
        By the same argument used to prove \eqref{eq Ks aux}, this is bounded by
        \begin{equation}
            \label{eq lem Tile holder im2}
            \le 2^{102a^3} \int_{E(\fp)} \frac{1}{\mu(B(x, D^s))} \psi(D^{-s} \rho(x,y)) |g(x)| \, \mathrm{d}\mu(x)\,.
        \end{equation}
        It follows from the definition of $\psi$ that
        $$
            \psi(x) \le \max\{0, (2  - 4x)^{1/a}\}\,.
        $$
        Now for all $x\in E(\fp)$, it follows by the triangle inequality and \eqref{eq vol sp cube} that
        \begin{multline*}
        2  - 4D^{-\ps(\fp)}\rho(x,y)\leq 2  - 4D^{-\ps(\fp)}\rho(y, \pc(\fp)) + 4 D^{-\ps(\fp)}\rho(x, \pc(\fp))\\\leq 18 - 4 D^{-\ps(\fp)} \rho(y, \pc(\fp)) \leq 4 D^{-\ps(\fp)}\rho(y,y') - 2 .
        \end{multline*}
        Combining the above with the previous estimate on $\psi$, we get
        $$
            \psi(D^{-\ps(\fp)}\rho(x,y))  \le 4 (D^{-\ps(\fp)}\rho(y,y'))^{1/a}.
        $$
        % Thus, by the triangle inequality and \eqref{eq vol sp cube} for all $x\in E(\fp)$
        % $$
        %     \psi(D^{-\ps(\fp)}\rho(x,y))
        % $$
        % $$
        %     \le \max\{0, (2  - 4D^{-\ps(\fp)}\rho(y, \pc(\fp)) + 4 D^{-\ps(\fp)}\rho(x, \pc(\fp)))^{1/a}\}
        % $$
        % $$
        %     \le \max\{0, (18 - 4 D^{-\ps(\fp)} \rho(y, \pc(\fp)))^{1/a}\}
        % $$
        % $$
        %     \le \max\{0, 4 D^{-\ps(\fp)}\rho(y,y') - 2\}^{1/a}
        % $$
        % $$
        %     \le 4 (D^{-\ps(\fp)}\rho(y,y'))^{1/a}\,.
        % $$
        Further, we obtain from the doubling property \eqref{doublingx} and \eqref{eq vol sp cube} that
        $$
            \mu(B(x, D^s)) \ge 2^{-2a} \mu(\pc(\fp), 4D^s)\,.
        $$
        Plugging this into \eqref{eq lem Tile holder im2} and using $a \ge 4$, we get
        $$
            |T_{\fp}^* g(y)| \le   \frac{2^{103a^3}}{\mu(B(\pc(\fp), 4D^{\ps(\fp)}))} \left(\frac{\rho(y,y')}{D^{\ps(\fp)}}\right)^{1/a} \int_{E(\fp)} |g(x)| \, \mathrm{d}\mu(y)\,,
        $$
        which completes the proof of the lemma.
    \end{proof}

    Recall that
    \begin{equation*}
        B(J) := B(c(J), 8D^{s(J)}).
    \end{equation*}
    We also denote
    \begin{equation*}
     B^\circ{}(J) := B(c(J), \frac{1}{8}D^{s(J)})\, .    \end{equation*}


    \begin{lemma}
        \label{lem sep tree aux 2}
        Let $\fp \in \fT_2 \setminus \mathfrak{S}$, $J \in \mathcal{J}'$ and suppose that
        $$
           B(\sc(\fp)) \cap B^\circ(J)  \ne \emptyset\,.
        $$
        Then
        $$
            s(J) \le \ps(\fp) \le s(J) + 10a^2 + 2\,.
        $$
    \end{lemma}

    \begin{proof}
        For the first estimate, assume that $\ps(\fp) < s(J)$, then in particular $\ps(\fp) \le \ps(\fu_1)$. Since $\fp \notin \mathfrak{S}$, we have by Lemma \ref{overlap implies distance} that $\sc(\fp) \cap \sc(\fu_1) = \emptyset$.
        %by \eqref{dyadicproperty}.
        Since $B\Big(c(J), \frac{1}{4} D^{s(J)}\Big) \subset \sc(J) \subset \sc(\fu_1)$, this implies
        $$
            \rho(c(J), \pc(\fp)) \ge \frac{1}{4}D^{s(J)}\,.
        $$
        On the other hand
        $$
            \rho(c(J), \pc(\fp)) \le \frac{1}{8} D^{s(J)} + 8 D^{\ps(\fp)}\,,
        $$
        by our assumption. Thus $D^{\ps(\fp)} \ge 64 D^{s(J)}$, which contradicts \eqref{defineD} and $a \ge 4$.

        For the second estimate, assume that $\ps(\fp) > s(J) +10a^2 + 2$. Since $J \in \mathcal{J}'$, we have $J \subsetneq \sc(\fu_1)$. Thus there exists $J' \in \mathcal{D}$ with $J \subset J'$ and $s(J') = s(J) + 1$, by \eqref{coverdyadic} and \eqref{dyadicproperty}. By definition of $\mathcal{J}'$, there exists some $\fp' \in \mathfrak{S}$ such that $\sc(\fp') \subset B(c(J'), 100 D^{s(J) + 2})$. On the other hand, since $B(\sc(\fp)) \cap B^\circ(J)  \ne \emptyset$, by the triangle inequality it holds that
        $$
            B(c(J'), 100 D^{s(J) + 10a^2 + 2}) \subset B(\pc(\fp), 10 D^{\ps(\fp)})\,.
        $$
        Using the definition of $\mathfrak{S}$, we have
        $$
            2^{Zn/2} \le d_{\fp'}(\fcc(\fu_1), \fcc(\fu_2)) \le d_{B(c(J'), 100 D^{s(J) + 2})}(\fcc(\fu_1), \fcc(\fu_2))\,.
        $$
        By \eqref{seconddb}, this is
        $$
            \le 2^{-10a} d_{B(c(J'), 100 D^{s(J) + 10a^2 + 2})}(\fcc(\fu_1), \fcc(\fu_2))
        $$
        $$
            \le 2^{-10a} d_{B(\pc(\fp), 10 D^{\ps(\fp)})}(\fcc(\fu_1), \fcc(\fu_2))\,,
        $$
        and by \eqref{firstdb} and the definition of $\mathfrak{S}$
        $$
            \le 2^{-4a} d_{\fp}(\fcc(\fu_1), \fcc(\fu_2)) \le 2^{-4a} 2^{Zn/2}\,.
        $$
        This is a contradiction, the second estimate follows.
    \end{proof}


    \begin{lemma}
        \label{lem sep tree aux 3}
        For all $J \in \mathcal{J}'$ and all bounded $g$ with bounded support
        $$
            \sup_{B^\circ{}(J)} |T_{\mathfrak{T}(\mathfrak{u}_2)\setminus\mathfrak{S}}^* g| \le 2^{104a^3} \inf_J M_{\mathcal{B},1}|g|
        $$
    \end{lemma}

    \begin{proof}
        By the triangle inequality and since $T_{\fp}^* g = \mathbf{1}_{B(\pc(\fp), 5D^{\ps(\fp)})} T_{\fp}^* g$, we have
        $$
            \sup_{B^\circ{}(J)} |T_{\fT(\fu_2) \setminus\mathfrak{S}}^* g|
            \leq \sup_{B^\circ{}(J)} \sum_{\substack{\fp \in \fT(\fu_2) \setminus \mathfrak{S}\\ B(\sc(\fp)) \cap B^\circ(J)  \ne \emptyset}} |T_{\fp}^*g|\,.
        $$
        By Lemma \ref{lem sep tree aux 2}, this is at most
        \begin{equation}
            \label{eq sep tree aux 3}
            \sum_{s = s(J)}^{s(J) + 10a^2 + 2} \sum_{\substack{\fp \in \fP, \ps(\fp) = s\\ B(\sc(\fp)) \cap B^\circ(J)  \ne \emptyset}} \sup_{B^\circ{}(J)} |T_{\fp}^* g|\,.
        \end{equation}
        If $x \in E(\fp)$ and $B(\sc(\fp)) \cap B^\circ(J)  \ne \emptyset$, then
        $$
            B(c(J), 16D^{\ps(\fp)}) \subset B(x, 32 D^{\ps(\fp)})\,,
        $$
        by \eqref{eq vol sp cube} and the triangle inequality. Using the doubling property \eqref{doublingx}, it follows that
        $$
            \mu(B(x, D^{\ps(\fp)})) \ge 2^{-5a} \mu(B(c(J), 16D^{\ps(\fp)}))\,.
        $$
        Using \eqref{definetp*}, \eqref{eq Ks size} and that $a \ge 4$, we bound \eqref{eq sep tree aux 3}  by
        $$
            2^{103a^3}\sum_{s = s(J)}^{s(J) + 10a^2 + 2} \sum_{\substack{\fp \in \fP, \ps(\fp) = s\\B(\sc(\fp)) \cap B^\circ(J)  \ne \emptyset}} \frac{1}{\mu(B(c(J), 16 D^s)} \int_{E(\fp)} |g| \, \mathrm{d}\mu\,.
        $$
        For each $I \in \mathcal{D}$, the sets $E(\fp)$ for $\fp \in \fP$ with $\sc(\fp) = I$ are pairwise disjoint by \eqref{definedE} and \eqref{eq dis freq cover}. Further, if $B(\sc(\fp)) \cap B^\circ(J)  \ne \emptyset$ and $\ps(\fp) \ge s(J)$, then $E(\fp) \subset B(c(J), 32 D^{\ps(\fp)})$. Thus the last display is bounded by
        $$
            2^{103a^3}\sum_{s = s(J)}^{s(J) + 10a^2 + 2}  \frac{1}{\mu(B(c(J), 32 D^s))} \int_{B(c(J), 16 D^s)} |g| \, \mathrm{d}\mu\,.
        $$
        $$
            \le \inf_{x' \in J} 2^{103a^3}(10a^2 + 3) M_{\mathcal{B}, 1} |g|\,.
        $$
        The lemma follows since for $a \ge 4$ it holds that $10a^2 + 3 \le 2^{a^3}$.
    \end{proof}

    \begin{lemma}
        \label{lem sep tree aux 4}
        Let $\fC = \fT(\fu_1)$ or $\fC = \fT(\fu_2) \cap \mathfrak{S}$. Then for each $J \in \mathcal{J}'$ and $\fp \in \fC$ with $B(\sc(\fp)) \cap B(J) \neq \emptyset$, we have $\ps(\fp) \ge s(J)$.
    \end{lemma}

    \begin{proof}
        By Lemma \ref{overlap implies distance}, we have that in both cases, $\fC \subset \mathfrak{S}$. If $\fp \in \fC$ with $B(\sc(\fp)) \cap B(J) \neq \emptyset$ and $\ps(\fp) < s(J)$, then $\sc(\fp) \subset B(c(J), 100 D^{s(J) + 1})$. Since $\fp \in \mathfrak{S}$, it follows from the definition of $\mathcal{J}'$ that $s(J) = -S$, which contradicts $\ps(\fp) < s(J)$.
    \end{proof}

    \begin{lemma}
        \label{lem sep tree aux 1}
        Let $\fC = \fT(\fu_1)$ or $\fC = \fT(\fu_2) \cap \mathfrak{S}$. Then for each $J \in \mathcal{J}'$ and all bounded $g$ with bounded support, we have
        \begin{align}
            \label{TreeUB}
            \sup_{B(J)} |T_{\fC}^*g| \leq \inf_{B^\circ{}(J)} |T^*_{\fC} g| + 2^{154a^3} \inf_{J} M_{\mathcal{B}, 1} |g|
        \end{align}
        and for all $y,y' \in B(J)$
        $$
            |e(\fcc(\fu)(y)) T_{\fC}^* g(y) - e(\fcc(\fu)(y')) T_{\fC}^* g(y')|
        $$
        \begin{equation}
            \label{TreeHölder}
             \le 2^{153a^3} \left(\frac{\rho(y,y')}{D^{s(J)}}\right)^{1/a} \inf_J M_{\mathcal{B},1} |g|\,.
        \end{equation}
    \end{lemma}

    \begin{proof}
        Note that \eqref{TreeUB} follows from \eqref{TreeHölder}, since for $y'\in B^\circ{}(J)$, by the triangle inequality,
        $$\left(\frac{\rho(y,y')}{D^{s(J)}}\right)^{1/a}\le \Big(8 + \frac{1}8\Big)^{1/a}\le 2^{a^3}.$$

        By the triangle inequality, Lemma \ref{adjoint tile support} and Lemma \ref{lem tile Hölder}, we have for all $y, y' \in B(J)$
        \begin{equation}
            \label{eq C Lip}
            |e(\fcc(\fu)(y)) T_{\fC}^* g(y) - e(\fcc(\fu)(y')) T_{\fC}^* g(y')|
        \end{equation}
        $$
            \leq \sum_{\substack{\fp \in \fC\\ B(\sc(\fp)) \cap B(J) \neq \emptyset}} |e(\fcc(\fu)(y)) T_{\fp}^* g(y) - e(\fcc(\fu)(y')) T_{\fp}^* g(y')|
        $$
        $$
            \le 2^{151a^3}\rho(y,y')^{1/a}  \sum_{\substack{\fp \in \fC\\ B(\sc(\fp)) \cap B(J) \neq \emptyset}} \frac{D^{- \ps(\fp)/a}}{\mu(B(\pc(\fp), 4D^{\ps(\fp)}))} \int_{E(\fp)} |g| \, \mathrm{d}\mu\,.
        $$
        By Lemma \ref{lem sep tree aux 4}, we have $\ps(\fp) \ge s(J)$ for all $\fp$ occurring in the sum. Further, for each $s \ge s(J)$, the sets $E(\fp)$ for $\fp \in \fP$ with $\ps(\fp) = s$ are pairwise disjoint by \eqref{definedE} and \eqref{eq dis freq cover}, and contained in $B(c(J), 32D^{s})$ by \eqref{eq vol sp cube} and the triangle inequality. Using also the doubling estimate \eqref{doublingx}, we obtain that the expression in the last display can be estimated by
        $$
            2^{151a^3}\rho(y,y')^{1/a} \sum_{S \ge s \ge s(J)}  D^{-s/a}  \frac{2^{3a}}{\mu(B(c(J), 32D^{s}))} \int_{B(c(J), 32D^{s})} |g| \, \mathrm{d}\mu
        $$
        $$
            \le 2^{152a^3} \left(\frac{\rho(y,y')}{D^s}\right)^{1/a} \sum_{S \ge s \ge s(J)} D^{(s(J) - s)/a} \inf_J M_{\mathcal{B},1} |g|\,.
        $$
        By convexity of $t \mapsto D^t$ and since $D \ge 2$, we have for all $-1 \le t \le 0$
        $$
            D^t \le 1 + t(1 - \frac{1}{D}) \le 1 + \frac{1}{2}t\,.
        $$
        Since $-1 \le -1/a <0$, it follows that
        $$
            \sum_{S \ge s \ge s(J)} D^{(s(J) - s)/a} \le \frac{1}{1 - D^{-1/a}} \le 2a \le 2^a\,.
        $$
        Estimate \eqref{TreeHölder}, and therefore the lemma, follow.
    \end{proof}

    \begin{lemma}
        \label{lem sep tree aux 5}
        We have for all $J \in \mathcal{J}'$ and all bounded $g$ with bounded support
        $$
            \sup_{B(J)} |T^*_{\mathfrak{T}_2 \cap \mathfrak{S}} g| \le \inf_{B^\circ{}(J)} |T^*_{\mathfrak{T}_2} g| + 2^{155a^3} \inf_{J} M_{\mathcal{B},1}|g|\,.
        $$
    \end{lemma}

    \begin{proof}
        By Lemma \ref{lem sep tree aux 1}
        $$
            \sup_{B(J)} |T^*_{\fT(\fu_2) \cap \mathfrak{S}} g| \le \inf_{B^\circ{}(J)} |T_{\fT(\fu_2) \cap \mathfrak{S}}^* g| +  2^{154a^3} \inf_{J} M_{\mathcal{B}, 1} |g|
        $$
        $$
            \le \inf_{B^\circ{}(J)} |T_{\fT(\fu_2)}^* g| + \sup_{B^\circ{}(J)} |T_{\fT(\fu_2) \setminus \mathfrak{S}}^* g| +  2^{154a^3} \inf_{J} M_{\mathcal{B}, 1} |g|\,,
        $$
        and by Lemma \ref{lem sep tree aux 3}
        $$
            \le \inf_{B^\circ{}(J)} |T_{\fT(\fu_2)}^* g| + (2^{104a^3} + 2^{154a^3}) \inf_{J} M_{\mathcal{B}, 1} |g|\,.
        $$
        This completes the proof.
    \end{proof}



    \begin{proof}[Proof of Lemma \ref{lem hHölder}]
        Let $P$ be the product on the right hand side of \eqref{hHölder}, and $h_J$ as defined in \eqref{def hj}.

        By \eqref{eq pao 2} and Lemma \ref{adjoint tile support}, the function $h_J$ is supported in $B(J) \cap \sc(\fu_1)$.
        By \eqref{eq pao 2} and Lemma \ref{lem sep tree aux 1}, we have for all $y \in B(J)$:
        $$
            |h_J(y)| \le 2^{308a^3} P\,.
        $$
        We have by the triangle inequality
        \begin{align}
            &|h_J(y) - h_J(y')|\nonumber\\
            \label{eq h Lip 1}
            &\le |\chi_J(y) - \chi_J(y')| |T_{\fT(\fu_1)}^* g_1(y)| |T_{\fT(\fu_2) \cap \mathfrak{S}}^* g_2(y)|\\
            \label{eq h Lip 2}
            & + |\chi_J(y')| |T_{\fT(\fu_1)}^* g_1(y) - T_{\fT(\fu_1)}^* g_1(y')| |T_{\fT(\fu_2) \cap \mathfrak{S}}^* g_2(y)|\\
            \label{eq h Lip 3}
            & + |\chi_J(y')| |T_{\fT(\fu_1)}^* g_1(y')| |T_{\fT(\fu_2) \cap \mathfrak{S}}^* g_2(y) - T_{\fT(\fu_2) \cap \mathfrak{S}}^* g_2(y')|\,.
        \end{align}

        As $h_J$ is supported in $\sc(\fu_1)$, we can assume without loss of generality that $y' \in \sc(\fu_1)$.
        If $y \notin \sc(\fu_1)$, then \eqref{eq h Lip 1} vanishes. If $y \in \sc(\fu_1)$ then we have by \eqref{eq pao 3}, Lemma \ref{lem sep tree aux 1} and Lemma \ref{lem sep tree aux 5}
        $$
            \eqref{eq h Lip 1} \le 2^{610a^3} \frac{\rho(y,y')}{D^{s(J)}} P\,,
        $$
        \rs{Constant changed from $510a^3$ to $610a^3$, check}
        where $P$ denotes the product on the right hand side of \eqref{hHölder}.

        By \eqref{eq pao 2}, Lemma \ref{lem sep tree aux 1} and Lemma \ref{lem sep tree aux 5}, we have
        $$
            \eqref{eq h Lip 2} \le  2^{310a^3} P\,.
            %\left(\frac{\rho(y,y')}{D^{s(J)}}\right)^{1/a}
        $$

        By \eqref{eq pao 2}, and twice Lemma \ref{lem sep tree aux 1}, we have
        $$
            \eqref{eq h Lip 3} \le 2^{308a^3} P\,.
            %\left(\frac{\rho(y,y')}{D^{s(J)}}\right)^{1/a}
        $$
        Using that $\rho(y,y') \le 16D^{s(J)}$ and $a \ge 4$, the lemma follows.
    \end{proof}

\subsubsection{The van der Corput estimate}
\label{subsubsec van der corput}
    \begin{lemma}
        \label{lem osc lower bound}
        For all $J \in \mathcal{J}'$, we have that
        $$
            d_{B(J)}(\fcc(\fu_1), \fcc(\fu_2)) \ge 2^{-201a^3} 2^{Zn/2}\,.
        $$
    \end{lemma}

    \begin{proof}
    Since $\emptyset \ne \fT(\fu_1) \subset \mathfrak{S}$ by Lemma \ref{overlap implies distance}, there exists at least one tile $\fp \in \mathcal{S}$ with $\sc(\fp) \subsetneq \sc(\fu_1)$. Thus $\sc(\fu_1) \notin \mathcal{J}'$, so $J \subsetneq \sc(\fu_1)$. Thus there exists a cube $J' \in \mathcal{D}$ with $J \subset J'$ and $s(J') = s(J) + 1$, by \eqref{coverdyadic} and \eqref{dyadicproperty}. By definition of $\mathcal{J'}$ and the triangle inequality, there exists $\fp \in \mathfrak{S}$ such that
    $$
        \sc(\fp) \subset B(c(J'), 100 D^{s(J') + 1}) \subset B(c(J), 128 D^{s(J)+2})\,.
    $$
    Thus, by definition of $\mathfrak{S}$:
    \begin{align*}
        2^{Zn/2} \le d_{\fp}(\fcc(\fu_1), \fcc(\fu_2)) \le d_{B(c(J), 128 D^{s(J)+2})}(\fcc(\fu_1), \fcc(\fu_2))\,.
    \end{align*}
    By the doubling property \eqref{firstdb}, this is
    $$
        \le 2^{200a^3 + 4a} d_{B(J)}(\fcc(\fu_1), \fcc(\fu_2))\,,
    $$
    which gives the lemma using $a \ge 4$.
    \end{proof}

    Now we are ready to prove Lemma \ref{correlation distant tree parts}.
    \begin{proof}[Proof of Lemma \ref{correlation distant tree parts}]
    We have
    $$
        \eqref{eq lhs big sep tree} = \left| \int_{X} T_{\fT(\fu_1)}^* g_1 \overline{T_{\fT(\fu_2) \cap \mathfrak{S}}^* g_2 }\right|\,.
    $$
    By Lemma \ref{adjoint tile support}, the right hand side is supported in $\sc(\fu_1)$. Using \eqref{eq pao 1} and the definition \eqref{def hj} of $h_J$, we thus have
    $$
        \le  \sum_{J \in \mathcal{J}'} \left|\int_{B(J)} e(\fcc(\fu_2)(y) - \fcc(\fu_1)(y)) h_J(y) \, \mathrm{d}\mu(y) \right|\,.
    $$
    Using Proposition \ref{Holder van der Corput} with the ball $B(J)$, we bound this by
    $$
        \le 2^{8a} \sum_{J \in \mathcal{J}'} \mu(B(J)) \|h_J\|_{C^{\tau}(B(J))} (1 + d_{B(J)}(\fcc(\fu_1), \fcc(\fu_1)))^{-1/(2a^2+a^3)}\,.
    $$
    Using Lemma \ref{lem hHölder} and Lemma \ref{lem osc lower bound} we have that the above is bounded from above by
    \begin{multline}
        \label{eq big sep 1}
        \le 2^{650a^3} 2^{-Zn/(4a^2 + 2a^3)} \sum_{J \in \mathcal{J}'} \mu(B(J)) \\
        \times \prod_{j=1}^2 (\inf_{B^\circ{}(J)} |T_{\fT(\fu_j)}^* g_j| + \inf_J M_{\mathcal{B},1} g_j)\,.
    \end{multline}
    \rs{Constant changed from $2^{550a^3}$ to $2^{650a^3}$, check}
    By the doubling property \eqref{doublingx}
    $$
        \mu(B(J)) \le 2^{6a} \mu(B^\circ{}(J))\,,
    $$
    thus
    $$
        \mu(B(J)) \prod_{j=1}^2 (\inf_{B^\circ{}(J)} |T_{\fT(\fu_j)}^* g_j| + \inf_J M_{\mathcal{B},1} g_j)
    $$
    $$
        \le 2^{6a} \int_{B^\circ{}(J)} \prod_{j=1}^2 ( |T_{\fT(\fu_j)}^* g_j|(x) +  M_{\mathcal{B},1} g_j(x)) \, \mathrm{d}\mu(x)
    $$
    $$
        \le 2^{6a} \int_J \prod_{j=1}^2 ( |T_{\fT(\fu_j)}^* g_j|(x) +  M_{\mathcal{B},1} g_j(x)) \, \mathrm{d}\mu(x)\,.
    $$
    Summing over $J \in \mathcal{J}'$, we obtain
    $$
        \eqref{eq big sep 1} \le 2^{650a^3} 2^{-Zn/(4a^2 + 2a^3)} \int_X \prod_{j=1}^2 ( |T_{\fT(\fu_j)}^* g_j|(x) +  M_{\mathcal{B},1} g_j(x)) \, \mathrm{d}\mu(x)\,.
    $$
    Applying the Cauchy-Schwarz inequality, Lemma \ref{correlation distant tree parts} follows.
    \end{proof}

\section{Proof of Lemma \ref{correlation near tree parts}: The remaining tiles}
    \label{subsec rest tiles}
    We define
    $$
        \mathcal{J}' = \{J \in \mathcal{J}(\fT(\fu_1)) \, : \, J \subset \sc(\fu_1)\}\,,
    $$
    note that this is different from the $\mathcal{J}'$ defined in the previous subsection.
    \begin{lemma}
        \label{lem J' partition 2}
        We have
        $$
            \sc(\fu_1) = \dot{\bigcup_{J \in \mathcal{J}'}} J\,.
        $$
    \end{lemma}

    \begin{proof}
        By Lemma \ref{dyadic partitions}, it remains only to show that each $J \in \mathcal{J}(\fT(\fu_1))$ with $J \cap \sc(\fu_1) \ne \emptyset$ is in $\mathcal{J}'$. But if $J \notin \mathcal{J}'$, then by \eqref{dyadicproperty} $\sc(\fu_1) \subsetneq J$. Pick $\fp \in \fT(\fu_1)$.  Then $\sc(\fp) \subsetneq J$. This contradicts the definition of $\mathcal{J}(\fT(\fu_1))$.
    \end{proof}

    Lemma \ref{correlation near tree parts} follows from the following key estimate.

    \begin{lemma}
        \label{lem sep tree small 1}
        We have
        $$
            \|P_{\mathcal{J}'}|T_{\mathfrak{T}_2 \setminus \mathfrak{S}}^* g_2|\|_2
            \le 2^{118a^3} 2^{-\frac{100}{202a}Zn\kappa} \|\mathbf{1}_{\sc(\fu_1)} M_{\mathcal{B},1} |g_2|\|_2
        $$
    \end{lemma}

    We prove this lemma below. First, we deduce Lemma \ref{correlation near tree parts}.

    \begin{proof}[Proof of Lemma \ref{correlation near tree parts}]
        By Lemma \ref{tree projection estimate} and Lemma \ref{adjoint tile support}, we have
        \begin{align*}
            \eqref{eq lhs small sep tree} \le 2^{104a^3} \|P_{\mathcal{L}(\fT(\fu_1))} |g_1\mathbf{1}_{\sc(\fu_1)}| \|_2 \|P_{\mathcal{J}(\fT(\fu_1) )}|T_{\fT(\fu_2) \setminus \mathfrak{S}}^* g_2|\|_2\,.
        \end{align*}
        It follows from the definition of the projection operator $P$ and Jensen's inequality that
        $$
            \|P_{\mathcal{L}(\fT(\fu_1))} |g_1\mathbf{1}_{\sc(\fu_1)}| \|_2 \le \|g_1 \mathbf{1}_{\sc(\fu_1)}\|_2\,.
        $$
        Combining this with Lemma \ref{lem sep tree small 1}, the definition \eqref{definekappa} and $a \ge 4$ proves the lemma.
    \end{proof}

    We need two more auxiliary lemmas before we prove Lemma \ref{lem sep tree small 1}.

    \begin{lemma}
        \label{lem sep aux 3}
        If $\fp \in \fT_2 \setminus \mathfrak{S}$ and $J \in \mathcal{J'}$ with $B(\sc(\fp)) \cap B(J) \ne \emptyset$, then
        $$
            \ps(\fp) \le s(J) + 2 - \frac{Zn}{202a^3}\,.
        $$
    \end{lemma}

    \begin{proof}
        Suppose that $\ps(\fp) > s(J) + 2 -\frac{Zn}{202a^3} =: s(J) - s_1$. Then, we have
        $$
            \rho(\pc(\fp), c(J)) \le 8D^{s(J)}+8D^{\ps(\fp)} \le 16 D^{\ps(\fp) + s_1}\,.
        $$
        There exists a tile $\fq \in \fT(\fu_1)$. By \eqref{forest1}, it satisfies $\sc(\fq) \subsetneq \sc(\fu_1)$. Thus $\sc(\fu_1) \notin \mathcal{J}'$. It follows that $J \subsetneq \sc(\fu_1)$. By \eqref{coverdyadic} and \eqref{dyadicproperty}, there exists a cube $J' \in \mathcal{D}$ with $J \subset J'$ and $s(J') = s(J) + 1$. By definition of $\mathcal{J}'$, there exists a tile $\fp' \in \fT(\fu_1)$ with
        $$
            \sc(\fp') \subset B(c(J'), 100 D^{s(J') + 1})\,.
        $$
        By the triangle inequality, the definition \eqref{defineD} and $a \ge 4$, we have
        $$
            B(c(J'), 100 D^{s(J')+1}) \subset B(\pc(\fp), 128 D^{\ps(\fp) + s_1 + 1})\,.
        $$
        Since $\fp' \in \fT(\fu_1)$ and $\sc(\fu_1) \subset \sc(\fu_2)$, we have by \eqref{forest5}
        $$
            d_{\fp'}(\fcc(\fp'), \fcc(\fu_2)) > 2^{Z(n+1)}\,.
        $$
        Hence, by \eqref{forest1}, the triangle inequality and using that by \eqref{defineZ} $Z \ge 2$
        $$
            d_{\fp'}(\fcc(\fu_1), \fcc(\fu_2)) > 2^{Z(n+1)} - 4 \ge 2^{Zn}\,.
        $$
        It follows that
        $$
            2^{Zn} \le d_{\fp'}(\fcc(\fu_1), \fcc(\fu_2)) \le d_{B(\pc(\fp), 128 D^{\ps(\fp) + s_1+ 1})}(\fcc(\fu_1), \fcc(\fu_2))\,.
        $$
        Using \eqref{firstdb}, we obtain
        $$
            \le 2^{9a + 100a^3 (s_1+1)} d_{\fp}(\fcc(\fu_1), \fcc(\fu_2))\,.
        $$
        Since $\fp' \notin \mathfrak{S}$ this is bounded by
        $$
            \le 2^{9a + 100a^3 (s_1+1)} 2^{Zn/2}\,.
        $$
        Thus
        $$
            Z n/2 \le 9a + 100a^3(s_1 + 1)\,,
        $$
        contradicting the definition of $s_1$.
    \end{proof}

    \begin{lemma}
        \label{lem sep tree small aux}
        For each $J \in \mathcal{J}'$, we have
        $$
            \frac{1}{\mu(J)} \int_J \Bigg(\sum_{\substack{I \in \mathcal{D}, s(I) = s(J) - s\\ I \cap \sc(\fu_1) = \emptyset\\
        J \cap B(I) \ne \emptyset}} \mathbf{1}_{B(I)}\bigg)^2 \, \mathrm{d}\mu \le 2^{104a^2} (8 D^{-s})^\kappa\,.
        $$
    \end{lemma}

    \begin{proof}[Proof of Lemma \ref{lem sep tree small aux}]
        Since $J \in \mathcal{J}'$ we have $J \subset \sc(\fu_1)$. Thus, if $B(I) \cap J \ne \emptyset$ then
    \begin{equation}
        \label{eq sep small incl}
        B(I) \cap J \subset \{x \in J \ : \ \rho(x, X \setminus J) \le 8D^{s(I)}\}\,.
    \end{equation}
    Furthermore, for each $s$ the balls $B(I)$ with $s(I) = s$ have bounded overlap: Consider the collection $\mathcal{D}_{s,x}$ of all $I \in \mathcal{D}$ with $x \in B(I)$ and $s(I) = s$. By \eqref{eq vol sp cube} and \eqref{dyadicproperty}, the balls $B(c(I), \frac{1}{4} D^{s(I)})$, $I \in \mathcal{D}_{s,x}$ are disjoint, and by the triangle inequality, they are contained in $B(x, 9 D^{s})$. By the doubling property \eqref{doublingx}, we have
    $$
        \mu(B(x, 9D^{s})) \le 2^{8a} \mu(B(c(I), \frac{1}{4} D^{s(I)}))
    $$
    for each $I \in \mathcal{D}_{s,x}$.
    Thus
    $$
        \mu(B(x, 9D^{s})) \ge \sum_{I \in \mathcal{D}_{s,x}} \mu(B(c(I), \frac{1}{4} D^{s(I)})) \ge 2^{-8a} |\mathcal{D}_{s,x}| \mu(B(x, 9D^{s}))\,.
    $$
    Dividing by the positive $\mu(B(x, 9D^{s}))$, we obtain that for each $x$
    \begin{equation}
        \label{eq sep small bound}
        \Bigg(\sum_{\substack{I \in \mathcal{D}, s(I) = s(J) - s\\ I \cap \sc(\fu_1) = \emptyset\\
        J \cap B(I) \ne \emptyset}} \mathbf{1}_{B(I)}(x) \bigg)^2 = |\mathcal{D}_{s(J) - s,x}|^2 \le 2^{16a} \,.
    \end{equation}
    Combining \eqref{eq sep small incl}, \eqref{eq sep small bound} and the small boundary property \eqref{eq small boundary}, noting that $8D^{s(I)}=8D^{-s}D^{s(J)}$, the lemma follows.
\end{proof}


\begin{proof}[Proof of Lemma \ref{lem sep tree small 1}]
    Expanding the definition of $P_{\mathcal{J}'}$, we have
    $$
        \|P_{\mathcal{J}'}|T_{\mathfrak{T}_2 \setminus \mathfrak{S}}^* g_2|\|_2
    $$
    $$
        = \left(\sum_{J \in \mathcal{J}'} \frac{1}{\mu(J)} \left|\int_J \sum_{\fp \in \fT(\fu_2) \setminus \mathfrak{S}} T_{\fp}^* g_2 \, \mathrm{d}\mu(y) \right|^2 \right)^{1/2}\,.
    $$
    We split the innermost sum according to the scale of the tile $\fp$, and then apply the triangle inequality and Minkowski's inequality:
    $$
        \le \sum_{s = -S}^S \left( \sum_{J \in \mathcal{J}'} \frac{1}{\mu(J)} \left|\int_J \sum_{\substack{\fp \in \fT(\fu_2) \setminus \mathfrak{S}\\ \ps(\fp) = s}} T_{\fp}^* g_2 \, \mathrm{d}\mu(y) \right|^2\right)^{1/2}\,.
    $$
    By Lemma \ref{adjoint tile support}, the integral in the last display is $0$ if $J \cap B(\sc(\fp)) = \emptyset$. By Lemma \ref{lem sep aux 3}, it follows with $s_1 := \frac{Zn}{202a^3} - 2$:
    \begin{equation}
    \label{eq sep tree small 1}
        = \sum_{s = s_1}^{s_1 + 2S} \Bigg( \sum_{J \in \mathcal{J}'} \frac{1}{\mu(J)} \Bigg|\int_J \sum_{\substack{\fp \in \fT(\fu_2) \setminus \mathfrak{S}\\ \ps(\fp) = s(J) - s\\
        J \cap B(\sc(\fp)) \ne \emptyset}} T_{\fp}^* g_2 \, \mathrm{d}\mu(y) \Bigg|^2\Bigg)^{1/2}\,.
    \end{equation}
    We have by Lemma \ref{adjoint tile support} and \eqref{eq Ks size}
    $$
        \int |T_{\fp}^* g_2|(y) \, \mathrm{d}\mu(y)
    $$
    $$
        \le 2^{102a^3} \int_{B(\sc(\fp))} \int \frac{1}{\mu(B(x, D^{\ps(\fp)}))} \mathbf{1}_{E(\fp)}(x) |g_2|(x) \, \mathrm{d}\mu(x) \, \mathrm{d}\mu(y)\,.
    $$
    If $x \in E(\fp) \subset \sc(\fp)$, then we have by \eqref{eq vol sp cube} that
    $$
        B(\pc(\fp), 4D^{\ps(\fp)}) \subset B(\sc(\fp))\,.
    $$
    Using the doubling property \eqref{doublingx}, it follows that
    $$
        \mu(B(\pc(\fp), 4D^{\ps(\fp)})) \le 2^{3a} \mu(B(x, D^s))\,.
    $$
    Thus, using also $a \ge 4$
    $$
        \int |T_{\fp}^* g_2|(y) \, \mathrm{d}\mu(y)
    $$
    $$
        \le 2^{103 a^3} \int_{B(\sc(\fp))} \int \frac{1}{\mu(B(\pc(\fp), 4D^{\ps(\fp)}))} \mathbf{1}_{E(\fp)}(x) |g_2|(x) \, \mathrm{d}\mu(x) \, \mathrm{d}\mu(y)\,.
    $$
    Since for each $I \in \mathcal{D}$ the sets $E(\fp), \fp \in \fP(I)$ are disjoint, it follows that
    $$
        \bigg| \int_J \sum_{\substack{\fp \in \fT(\fu_2) \setminus \mathfrak{S}\\ \sc(\fp) = I\\
        J \cap B(\sc(\fp)) \ne \emptyset}} T_{\fp}^* g_2 \, \mathrm{d}\mu \bigg|
    $$
    $$
        \le 2^{103a^3} \int_J \mathbf{1}_{B(I)} \frac{1}{\mu(B(\pc(\fp), 4D^{\ps(\fp)}))} \int_{B(\pc(\fp), 4D^{\ps(\fp)})} |g_2|(x) \, \mathrm{d}\mu(x)
    $$
    $$
        \le 2^{103a^3} \int_J M_{\mathcal{B},1} |g_2|(y) \mathbf{1}_{B(I)}(y) \, \mathrm{d}\mu(y)\,.
    $$
    By Lemma \ref{overlap implies distance}, we have $\sc(\fp) \cap \sc(\fu_1) = \emptyset$ for all $\fp \in \fT(\fu_2) \setminus \mathfrak{S}$.
    Thus we can estimate \eqref{eq sep tree small 1} by
    $$
        2^{103a^3} \sum_{s = s_1}^{s_1 + 2S} \Bigg( \sum_{J \in \mathcal{J}'} \frac{1}{\mu(J)} \Bigg|\int_J \sum_{\substack{I \in \mathcal{D}, s(I) = s(J) - s\\ I \cap \sc(\fu_1) = \emptyset\\
        J \cap B(I) \ne \emptyset}} M_{\mathcal{B},1} |g_2| \mathbf{1}_{B(I)} \, \mathrm{d}\mu \Bigg|^2\Bigg)^{\frac 1 2}\,,
    $$
    which is by Cauchy-Schwarz at most
    \begin{equation}
    \label{eq sep tree small 2}
        2^{103a^3} \sum_{s = s_1}^{s_1 + 2S} \Bigg( \sum_{J \in \mathcal{J}'} \int_J  ( M_{\mathcal{B},1} |g_2|)^2 \frac{1}{\mu(J)} \int_J \Bigg(\sum_{\substack{I \in \mathcal{D}, s(I) = s(J) - s\\ I \cap \sc(\fu_1) = \emptyset\\
        J \cap B(I) \ne \emptyset}} \mathbf{1}_{B(I)}\bigg)^2 \, \mathrm{d}\mu \Bigg)^{\frac 12}\,.
    \end{equation}
    Using Lemma \ref{lem sep tree small aux}, we bound \eqref{eq sep tree small 2} by
    $$
        2^{103a^3} \sum_{s = s_1}^{s_1 + 2S} \left(\sum_{J \in \mathcal{J}'} \int_J (M_{\mathcal{B},1} |g_2|)^2 2^{104a^2} (8 D^{-s})^\kappa\right)^{\frac 1 2}\,,
    $$
    and, since dyadic cubes in $\mathcal{J}'$ form a partition of $\sc(\fu_1)$ by Lemma \ref{lem J' partition 2}, $\kappa \le 1$ by \eqref{definekappa}, and $a \ge 4$
    $$
        \le 2^{116a^3} \sum_{s = s_1}^{s_1 + 2S} D^{-s\kappa/2} \|\mathbf{1}_{\sc(\fu_1)} M_{\mathcal{B},1} |g_2|\|_2
    $$
    $$
        \le 2^{116a^3} D^{-s_1 \kappa /2} \frac{1}{1 - D^{-\kappa/2}} \|\mathbf{1}_{\sc(\fu_1)} M_{\mathcal{B},1} |g_2|\|_2\,.
    $$
    By convexity of $t \mapsto D^t$ and since $D \ge 2$, we have for all $-1 \le t \le 0$
    $$
        D^t \le 1 + t(1 - \frac{1}{D}) \le 1 + \frac{1}{2}t\,.
    $$
    Using this for $t = -\kappa/2$ and using that $s_1 = \frac{Zn}{202a^3} - 2$ and the definitions \eqref{defineD} and \eqref{definekappa} of $\kappa$ and $D$
    $$
        \le 2^{116a^3} 2^{-100a^2(\frac{Zn}{202a^3} - 2) \frac{\kappa}{2}} \frac{2}{\kappa} \|\mathbf{1}_{\sc(\fu_1)} M_{\mathcal{B},1} |g_2|\|_2
    $$
    $$
        \le \frac{2^{117a^3 + 1}}{\kappa} 2^{-\frac{100}{202a}Zn\kappa} \|\mathbf{1}_{\sc(\fu_1)} M_{\mathcal{B},1} |g_2|\|_2\,.
    $$
    Using the definition \eqref{definekappa} of $\kappa$ and $a \ge 4$, the lemma follows.
\end{proof}



\section{Forests}
In this subsection, we complete the proof of Proposition \ref{forest operator} from the results of the previous subsections.

Define an $n$-row to be an $n$-forest $(\fU, \fT)$, i.e. satisfying conditions \eqref{forest1} - \eqref{forest6}, such that in addition the sets $\sc(\fu), \fu \in \fU$ are pairwise disjoint.

\begin{lemma}
    \label{lem row decomposition}
    Let $(\fU, \fT)$ be an $n$-forest. Then there exists a decomposition
    $$
        \fU = \dot{\bigcup_{1 \le j \le 2^n}} \fU_j
    $$
    such that for all $j = 1, \dotsc, 2^n$ the pair $(\fU_j, \fT|_{\fU_j})$ is an $n$-row.
\end{lemma}

\begin{proof}
    Define recursively $\fU_j$ to be a maximal disjoint set of tiles $\fu$ in
    $$
        \fU \setminus \bigcup_{j' < j} \fU_{j'}
    $$
    with inclusion maximal $\sc(\fu)$. Properties \eqref{forest1}, -\eqref{forest6} for $(\fU_j, \fT|_{\fU_k})$ follow immediately from the corresponding properties for $(\fU, \fT)$, and the cubes $\sc(\fu), \fu \in \fU_j$ are disjoint by definition. The collections $\fU_j$ are also disjoint by definition.

    Now we show by induction on $j$ that each point is contained in at most $2^n - j$ cubes $\sc(\fu)$ with $\fu \in \fU \setminus \bigcup_{j' \le j} \fU_{j'}$. This implies that $\bigcup_{j = 1}^{2^n} \fU_j = \fU$, which completes the proof of the Lemma. For $j = 0$ each point is contained in at most $2^n$ cubes by \eqref{forest3}. For larger $j$, if $x$ is contained in any cube $\sc(\fu)$ with $\fu \in \fU \setminus \bigcup_{j' < j} \fU_{j'}$, then it is contained in a maximal such cube. Thus it is contained in a cube in $\sc(\fu)$ with $\fu \in \fU_j$. Thus the number $\fu \in \fU \setminus \bigcup_{j' \le j} \fU_{j'}$ with $x\in \sc(\fu)$ is zero, or is less than the number of $\fu \in \fU \setminus \bigcup_{j' \le j-1} \fU_{j'}$ with $x \in \sc(\fu)$ by at least one.
\end{proof}

We pick a decomposition of the forest $(\fU, \fT)$ into $2^n$ $n$-rows
\begin{equation*}
(\fU_j, \fT_j) := (\fU_j, \fT|_{\fU_j})
\end{equation*}
as in Lemma \ref{lem row decomposition}.

\begin{lemma}
    \label{lem row bound}
    For each $1 \le j \le 2^n$ and each bounded $g$ with bounded support, we have
    \begin{equation}
        \label{eq row bound 1}
        \left\| \sum_{\fu \in \fU_j} \sum_{\fp \in \fT(\fu)}  T_{\fp}^* g\right\|_2 \le 2^{156a^3} 2^{-n/2} \|g\|_2
    \end{equation}
    and
    \begin{equation}
        \label{eq row bound 2}
        \left\| \sum_{\fu \in \fU_j} \sum_{\fp \in \fT(\fu)} \mathbf{1}_F T_{\fp}^* g\right\|_2 \le 2^{257a^3} 2^{-n/2} \dens_2(\bigcup_{\fu\in \fU}\fT(\fu))^{1/2}  \|g\|_2\,.
    \end{equation}
\end{lemma}

\begin{proof}
    By Corollary \ref{densities tree bound} and the density assumption \eqref{forest4}, we have for each $\fu \in \fU$ and all bounded $f$ of bounded support that
    \begin{equation}
        \label{eq explicit tree bound 1}
        \left\|\sum_{\fp \in \fT(\fu)} T_{\fp} f \right\|_{2}  \le 2^{155a^3} 2^{(4a+1-n)/2}  \|f\|_2\,
    \end{equation}
    and
    \begin{equation}
        \label{eq explicit tree bound 2}
        \left\|\sum_{\fp \in \fT(\fu)} T_{\fp} \mathbf{1}_F f \right\|_{2} \le 2^{256a^3} 2^{(4a + 1-n)/2} \dens_2(\fT(\fu))^{1/2} \|f\|_2\,.
    \end{equation}
    Since for each $j$ the top cubes $\sc(\fu)$, $\fu \in \fU_j$ are disjoint, we further have for all bounded $g$ of bounded support by Lemma \ref{adjoint tile support}
    $$
        \left\|\mathbf{1}_F \sum_{\fu \in \fU_j} \sum_{\fp \in \fT(\fu)} T_{\fp}^* g\right\|_2^2 = \left\|\mathbf{1}_F \sum_{\fu \in \fU_j} \sum_{\fp \in \fT(\fu)} \mathbf{1}_{\sc(\fu)} T_{\fp}^* \mathbf{1}_{\sc(\fu)} g\right\|_2^2
    $$
    $$
        = \sum_{\fu \in \fU_j} \int_{\sc(\fu)} \left| \mathbf{1}_F \sum_{\fp \in \fT(\fu)} T_{\fp}^* \mathbf{1}_{\sc(\fu)} g\right|^2 \, \mathrm{d}\mu
        \le \sum_{\fu \in \fU_j} \left\|\sum_{\fp \in \fT(\fu)} \mathbf{1}_F T_{\fp}^* \mathbf{1}_{\sc(\fu)} g\right\|_2^2\,.
    $$
    Applying the estimate for the adjoint operator following from equation \eqref{eq explicit tree bound 2}, we obtain
    $$
        \le 2^{256a^3} 2^{(4a+1-n)/2} \max_{\fu \in \fU_j}\dens_2(\fT(\fu))^{1/2} \sum_{\fu \in \fU_j} \left\| \mathbf{1}_{\sc(\fu)} g\right\|_2^2\,.
    $$
    Again by disjointedness of the cubes $\sc(\fu)$, this is estimated by
    $$
        2^{256a^3} 2^{(4a+1-n)/2} \max_{\fu \in \fU_j}\dens_2(\fT(\fu))^{1/2} \|g\|_2^2\,.
    $$
    Thus, \eqref{eq row bound 2} follows, since $a \ge 4$.
    The proof of \eqref{eq row bound 1} from \eqref{eq explicit tree bound 1} is the same up to replacing $F$ by $X$.
\end{proof}

\begin{lemma}
    \label{lem sep row bound}
    For all $1 \le j < j' \le 2^n$ and for all bounded $g_1, g_2$ with bounded support, it holds that
    $$
        \left| \int \sum_{\fu \in \fU_j} \sum_{\fu' \in \fU_{j'}} \sum_{\fp \in \fT_j(\fu)} \sum_{\fp' \in \fT_{j'}(\fu')} T^*_{\fp} g_1 \overline{T^*_{\fp'} g_2} \, \mathrm{d}\mu \right| \le
        %2^{550a^3-3n}
        2^{962a^3-3n}\|g_1\|_2 \|g_2\|_2\,.
    $$
    \rs{Constant changed from 862 to 962, check}
\end{lemma}

\begin{proof}
    To save some space we will write for subsets $\fC \subset \fP$
    $$
        T_{\fC}^* = \sum_{\fp \in \fC} T_{\fp}^*\,.
    $$
    We have by Lemma \ref{adjoint tile support} and the triangle inequality that
    $$
        \left| \int \sum_{\fu \in \fU_j} \sum_{\fu' \in \fU_{j'}} \sum_{\fp \in \fT_j(\fu)} \sum_{\fp' \in \fT_{j'}(\fu')} T^*_{\fp} g_1 \overline{T^*_{\fp'} g_2} \, \mathrm{d}\mu \right|
    $$
    $$
        \le   \sum_{\fu \in \fU_j} \sum_{\fu' \in \fU_{j'}} \left| \int   T^*_{\fT_j(\fu)} (\mathbf{1}_{\sc(\fu)} g_1) \overline{T^*_{\fT_{j'}(\fu')} (\mathbf{1}_{\sc(\fu')} g_2)} \, \mathrm{d}\mu \right|\,.
    $$
    By Lemma \ref{correlation separated trees}, this is bounded by
    \begin{equation}
        \label{eq S2uu'}
         2^{650a^3-3n} \sum_{\fu \in \fU_j} \sum_{\fu' \in \fU_{j'}} \|S_{2,\fu} g_1\|_{L^2(\sc(\fu')\cap \sc(\fu)} \|S_{2, \fu'} g_2\|_{L^2(\sc(\fu')\cap\sc(\fu))}\,.
    \end{equation}
    We apply the Cauchy-Schwarz inequality in the form
    \begin{equation*}
        \sum_{i \in M} a_i b_i \le (\sum_{i \in M} a_i^2 )^{1/2}(\sum_{i \in M} b_i^2 )^{1/2}
    \end{equation*} to the outer two sums:
    $$
        \le 2^{650a^3-3n} \left(\sum_{\fu \in \fU_j} \sum_{\fu' \in \fU_{j'}} \|S_{2,\fu} g_1\|_{L^2(\sc(\fu')\cap \sc(\fu))}^2 \right)^{1/2}
    $$
    $$
        \left(\sum_{\fu \in \fU_j} \sum_{\fu' \in \fU_{j'}} \|S_{2,\fu'} g_2\|_{L^2(\sc(\fu')\cap\sc(\fu))}^2 \right)^{1/2}\,.
    $$
    \rs{Constant changed form 550 to 650, check}
    By pairwise disjointedness of the sets $\sc(\fu)$ for $\fu \in \fU_j$ and of the sets $\sc(\fu')$ for $\fu' \in \fU_{j'}$, we have
    $$
        \sum_{\fu \in \fU_j}\sum_{\fu' \in \fU_{j'}} \|S_{2,\fu} g_1\|_{L^2(\sc(\fu')\cap \sc(\fu))}^2
        = \sum_{\fu \in \fU_j}\sum_{\fu' \in \fU_{j'}} \int_{\sc(\fu) \cap \sc(\fu')} |S_{2,\fu} g_1(y)|^2 \, \mathrm{d}\mu(y)
    $$
    $$
        \le \int_X |S_{2,\fu}g_1(y)|^2 \, \mathrm{d}\mu(y) = \|S_{2,\fu} g_1\|_2^2\,.
    $$
    Arguing similar for $g_2$, we can estimate \eqref{eq S2uu'} to be
    $$
        \le 2^{650a^3-3n} \|S_{2,\fu}g_1\|_2 \|S_{2,\fu'} g_2\|_2\,.
    $$
    \rs{Constant changed from 550 to 650, check}
    The lemma now follows from Lemma \ref{adjoint tree control}.
\rs{Constant changed, check.}
\end{proof}

Define for $1 \le j \le 2^n$
$$
    E_j := \bigcup_{\fu \in \fU_j} \bigcup_{\fp \in \fT(\fu)} E(\fp)\,.
$$

\begin{lemma}
    \label{lem disjoint support}
    The sets $E_j$, $1 \le j \le 2^n$ are pairwise disjoint.
\end{lemma}

\begin{proof}
    Suppose that $\fp \in \fT(\fu)$ and $\fp' \in \fT(\fu')$ with $\fu \ne \fu'$ and $x \in E(\fp) \cap E(\fp')$. Suppose without loss of generality that $\ps(\fp) \le \ps(\fp')$. Then $x \in \sc(\fp) \cap \sc(\fp') \subset \sc(\fu')$. By \eqref{dyadicproperty} it follows that $\sc(\fp) \subset \sc(\fu')$. By \eqref{forest5}, it follows that
    $$
        d_{\fp}(\fcc(\fp), \fcc(\fu')) > 2^{Z(n+1)}\,.
    $$
    By the triangle inequality. Lemma \ref{monotone cube metrics} and \eqref{forest1} it follows that
    \begin{align*}
        d_{\fp}(\fcc(\fp), \fcc(\fp')) &\ge d_{\fp}(\fcc(\fp), \fcc(\fu')) - d_{\fp}(\fcc(\fp'), \fcc(\fu'))\\
        &> 2^{Z(n+1)} - d_{\fp'}(\fcc(\fp'), \fcc(\fu'))\\
        &\ge 2^{Z(n+1)} - 4\,.
    \end{align*}
    Since $Z \ge 3$ by \eqref{defineZ}, it follows that $\fcc(\fp') \notin B_{\fp}(\fcc(\fp), 1)$, so $\Omega(\fp') \not\subset \Omega(\fp)$ by \eqref{eq freq comp ball}. Hence, by \eqref{eq freq dyadic}, $\Omega(\fp) \cap \Omega(\fp') = \emptyset$. But if $x \in E(\fp) \cap E(\fp')$ then $Q(x) \in \Omega(\fp) \cap \Omega(\fp')$. This is a contradiction, and the lemma follows.
\end{proof}

Now we prove Proposition \ref{forest operator}.

\begin{proof}[Proof of Proposition \ref{forest operator}]
\rs{Change constant}
    To save some space, we will write
    $$
        T_{\mathfrak{R}_j}^* = \sum_{\fu \in \fU_j} \sum_{\fp \in \fT(\fu)} T_{\fp}^*\,.
    $$
    By \eqref{definetp*}, we have for each $j$
    $$
        T_{\mathfrak{R}_j}^*g = \sum_{\fu \in \fU_j} \sum_{\fp \in \fT(\fu)} T_{\fp}^* g = \sum_{\fu \in \fU_j} \sum_{\fp \in \fT(\fu)} T_{\fp}^* \mathbf{1}_{E_j} g = T_{\mathfrak{R}_j}^* \mathbf{1}_{E_j} g\,.
    $$
    Hence, by Lemma \ref{lem row decomposition},
    $$
        \left\|\sum_{\fu \in \fU} \sum_{\fp \in \fT(\fu)} T^*_{\fp} g\right\|_2^2 = \left\|\sum_{j = 1}^{2^n} T^*_{\mathfrak{R}_{j}} g\right\|_2^2  =  \left\|\sum_{j=1}^{2^n} T^*_{\mathfrak{R}_{j}} \mathbf{1}_{E_j} g\right\|_2^2
    $$
    $$
        = \int_X \left|\sum_{j=1}^{2^n} T^*_{\mathfrak{R}_{j}} \mathbf{1}_{E_j} g\right|^2 \, \mathrm{d}\mu
    $$
    $$
        = \sum_{j=1}^{2^n} \int_X |T_{\mathfrak{R}_j}^* \mathbf{1}_{E_j} g|^2 + \sum_{j =1}^{2^n} \sum_{\substack{j' = 1\\j' \ne j}}^{2^n} \int_X \overline{ T_{\mathfrak{R}_j}^* \mathbf{1}_{E_j} g} T_{\mathfrak{R}_{j'}}^* \mathbf{1}_{E_{j'}} g \, \mathrm{d}\mu\,.
    $$
    We use Lemma \ref{lem row bound} to estimate each term in the first sum, and Lemma \ref{lem sep row bound} to bound each term in the second sum:
    $$
        \le 2^{312a^3-n} \sum_{j = 1}^{2^n} \|\mathbf{1}_{E_j} g\|_2^2 +  2^{862a^3-3 n}\sum_{j=1}^{2^n}\sum_{j' = 1}^{2^n} \|\mathbf{1}_{E_j} g\|_2 \|\mathbf{1}_{E_{j'}}g\|_2\,.
    $$
    By Cauchy-Schwarz in the second two sums, this is at most
    $$
        2^{862a^3} (2^{-n} + 2^{n}2^{-3 n}) \sum_{j = 1}^n \|\mathbf{1}_{E_j} g\|_2^2\,,
    $$
    and by disjointedness of the sets $E_j$, this is at most
    $$
        2^{862a^3 - n} \|g\|_2^2\,.
    $$
    Taking adjoints and square roots, it follows that for all $f$
    \begin{equation}
        \label{eq forest bound 1}
        \left\|\sum_{\fu \in \fU} \sum_{\fp \in \fT(\fu)} T_{\fp} f\right\|_2 \le 2^{431a^3-\frac{n}{2}} \|f\|_2\,.
    \end{equation}
    On the other hand, we have by disjointedness of the sets $E_j$
    $$
        \left\|\sum_{\fu \in \fU} \sum_{\fp \in \fT(\fu)} T_{\fp} f\right\|_2^2 =  \left\|\sum_{j=1}^{2^n} \mathbf{1}_{E_j} T_{\mathfrak{R}_{j}} f\right\|_2^2 = \sum_{j = 1}^{2^n} \|\mathbf{1}_{E_j} T_{\mathfrak{R}_{j}} f\|_2^2\,.
    $$
    If $|f| \le \mathbf{1}_F$ then we obtain from Lemma \ref{lem row bound} and taking square roots that
    $$
        \le 2^{257a^3} \dens_2(\bigcup_{\fu\in \fU}\fT(\fu))^{\frac{1}{2}} 2^{-\frac{n}{2}} (\sum_{j = 1}^{2^n} \|f\|_2^2)^{\frac{1}{2}}
    $$
    \begin{equation}
        \label{eq forest bound 2}
        = 2^{257a^3} \dens_2(\bigcup_{\fu\in \fU}\fT(\fu))^{\frac{1}{2}} \|f\|_2\,.
    \end{equation}
    Proposition \ref{Holder van der Corput} follows by taking the product of the $(2 - \frac{2}{q})$-th power of \eqref{eq forest bound 1} and the $(\frac{2}{q} - 1)$-st power of \eqref{eq forest bound 2}.
\end{proof}

\chapter{Proof of Prop. \ref{Holder van der Corput}, the H\"older cancellative condition}
\label{liphoel}

We need the following auxiliary lemma.
Recall that $\tau = 1/a$.

\begin{lemma}[Lipschitz Holder approximation]
    \label{Lipschitz Holder approximation}
    Let $z\in X$ and $R>0$. Let $\varphi: X \to \mathbb{C}$ be a function supported in the  ball
    $B:=B(z,R)$ with finite norm $\|\varphi\|_{C^\tau(B)}$. Let $0<t \leq 1$. There exists a function $\tilde \varphi : X \to \mathbb{C}$, supported in $B(z,2R)$, such that for every $x\in X$
    \begin{equation}\label{eq firstt}
        |\varphi(x) - \tilde \varphi(x)| \leq t^{\tau} \|\varphi\|_{C^\tau(B)}
    \end{equation}and
   \begin{equation}\label{eq secondt}
       \|\tilde \varphi\|_{\Lip(B(z,2R))} \leq 2^{4a}t^{-1-a} \|\varphi\|_{C^{\tau}(B)}\, .
   \end{equation}
\end{lemma}


\begin{proof}
    %Let $s = R/t$.
    Define for $x,y\in X$ the Lipschitz  and thus measurable function
     \begin{equation}
           L(x,y) := \max\{0, 1 - \frac{\rho(x,y)}{tR}\}\, .
    \end{equation}
We  have that $L(x,y)\neq 0$ implies
\begin{equation}\label{eql01}
    y\in B(x, tR)\, .
\end{equation}
We have for $y\in B(x, 2^{-1}tR)$ that
\begin{equation}\label{eql30}
           |L(x,y)|\ge 2^{-1}  \ .
    \end{equation}
Hence
\begin{equation}
        \int L(x,y) \, \mathrm{d}\mu(y)\ge  2^{-1}\mu(B(x, 2^{-1}Rt))\, .
    \end{equation}
 Let $n$ be the smallest integer so that
 \begin{equation}\label{2nt1}
     2^nt\ge 1\, .
 \end{equation} Iterating $n+2$ times the doubling condition \eqref{doublingx}, we obtain
      \begin{equation}\label{eql32}
        \int L(x,y) \, \mathrm{d}\mu(y)\ge  2^{-1-a(n+2)}\mu(B(x, 2R))\, .
    \end{equation}

Now define
    $$
        \tilde \varphi(x) := \left(\int L(x,y) \, \mathrm{d}\mu(y)\right)^{-1}\int L(x,y) \varphi(y) \, \mathrm{d}\mu(y)\, .
    $$
Using that $\varphi$ is supported in $B(z,R)$ and
\eqref{eql01}, we have that $\tilde{\varphi}$ is supported in $B(z,2R)$.

We prove \eqref{eq firstt}.
 For any $x\in X$, using
    that $L$ is nonnegative,
    \begin{equation}\label{eql1}
    \left(\int L(x,y) \, \mathrm{d}\mu(y)\right)
        |\varphi(x) - \tilde \varphi(x)|
    \end{equation}
 \begin{equation}\label{eql2}
 = \left| \int L(x,y)(\varphi(x) - \varphi(y)) \, \mathrm{d}\mu(y)\right|\, .
    \end{equation}
Using \eqref{eql01}, we estimate the last display by
 \begin{equation}\label{eql3}
         \le   \int_{B(x, tR)} L(x,y)|\varphi(x) - \varphi(y)| \, \mathrm{d}\mu(y)\, .\end{equation}
  Using the definition of $\|\varphi\|_{C^\tau(B)}$, we estimate the last display further by
        \begin{equation}\label{eql4}
         \le   \left(\int_{B(x, tR)} L(x,y)
          \rho(x,y)^\tau \, \mathrm{d}\mu(y) \right)\|\varphi\|_{C^\tau(B)}R^{-\tau}\, .
    \end{equation}
  Using the condition on the domain of integration to estimate $\rho(x,y)$ by $tR$ and then expanding the domain by positivity of the integrand, we estimate this further by

    \begin{equation}\label{eql5}
         \le   \left(\int L(x,y) \, \mathrm{d}\mu(y)\right)
         \|\varphi\|_{C^\tau(B)} t^{\tau} \, .
    \end{equation}
 Dividing the string of inequalities from \eqref{eql1} to
\eqref{eql5} by the positive integral of $L$ proves \eqref{eq firstt} .


We turn to \eqref{eq secondt}. For every $x\in X$, we have
\begin{equation}
    \left|\int L(x,y) \, \mathrm{d}\mu(y)\right||\tilde{\varphi}(x)|
    =\left|\int L(x,y) {\varphi}(y)\, \mathrm{d}\mu(y)\right|
\end{equation}
 \begin{equation}
    \le \left|\int L(x,y) \, \mathrm{d}\mu(y)\right| \sup_{x'\in X}
    |{\varphi}(x')|\ .
\end{equation}
As $\varphi$ is supported on $B$, dividing by the integral of $L$, we obtain
\begin{equation}\label{eql42}
 |\tilde{\varphi}(x)|\le \sup_{x'\in B}
    |{\varphi}(x')|\le \|\varphi\|_{C^\tau(B)}\ .
\end{equation}
If $\rho(x,x')\ge R$, then we have by the triangle inequality
  \begin{equation}\label{eql52}
 R\frac{|\tilde{\varphi}(x') - \tilde \varphi(x)|}{\rho(x,x')} \le
 2\sup_{x''\in X} |\tilde{\varphi}(x'')|\le 2\|\varphi\|_{C^\tau(B)}\, .
\end{equation}
Now assume  $\rho(x,x')< R$. For $y\in X$ we have by the triangle inequality and a two fold case distinction
for the maximum in the definition of $L$,
\begin{equation}\label{eql10}
   |L(x,y) - L(x',y)| \le \frac{\rho(x,x')}{tR}.
\end{equation}
We compute with \eqref{eql10}, first adding and subtracting a term in the integral,
\begin{equation}
    \left(\int L(x,y) \, \mathrm{d}\mu(y)\right)
    |\tilde{\varphi}(x') - \tilde \varphi(x)|=
\end{equation}
\begin{equation}
    \left|\int L(x,y) \tilde{\varphi}(x')
    -L(x,y) \tilde{\varphi}(x)
    +L(x',y) \tilde{\varphi}(x')-
     L(x',y) \tilde{\varphi}(x')
    \, \mathrm{d}\mu(y)\right|\,.
\end{equation}
Grouping the second and third and the first and fourth term, we obtain using the definition of $\tilde \varphi$ and Fubini,
\begin{equation}\label{eql21}
    \le  \left| \int (L(x',y)-L(x,y)) \varphi(y) \, \mathrm{d}\mu(y)\right|
\end{equation}
\begin{equation}\label{eql22}
    +  \left| \int L(x,y)  \, \mathrm{d}\mu(y)-\int L(x',y)  \, \mathrm{d}\mu(y)\right||\tilde{\varphi}(x')|
\end{equation}
\begin{equation}\label{eql23}
    \le 2  \int |L(x,y)  -L(x',y)|  \, \mathrm{d}\mu(y)
    \|\varphi\|_{C^\tau(B)}\, ,
\end{equation}
where in the last inequality we have used  \eqref{eql42}.
Using further \eqref{eql10} and the support of $L$, we estimate the last display by
\begin{equation}\label{eql224}\le 2  \frac{\rho(x,x')} {tR}\mu(B(x,tR)\cup B(x',tR))
\|\varphi\|_{C^\tau(B)}\, .
    \end{equation}
  Using $\rho(x,x')<R$ and the triangle inequality, we estimate the last display by
\begin{equation}\label{eql225}\le 2
\frac{\rho(x,x')} {tR}
\mu(B(x,2R))
\|\varphi\|_{C^\tau(B)}\, .
    \end{equation}
Dividing by the integral over $L$ and using \eqref{eql32} and \eqref{2nt1}, we obtain
\begin{equation}\label{eql226}
 \frac {R |\tilde{\varphi}(x') - \tilde \varphi(x)|}{\rho(x,x')}
 \le   2^{2+a(n+2)}t^{-1}\|\varphi\|_{C^\tau(B)} \le
 2^{2+3a} t^{-1-a} \|\varphi\|_{C^\tau(B)}\, .
\end{equation}
Combining \eqref{eql52} and  \eqref{eql226} using $a\ge 4$ and $t\le 1$ and
adding \eqref{eql42} proves \eqref{eq secondt} and completes the proof
of Lemma \ref{Lipschitz Holder approximation}.
\end{proof}


We turn to the proof of Proposition \ref{Holder van der Corput}.
Let $z\in X$ and $R>0$ and set $B=B(z,R)$. Let $\varphi$
be given as in Proposition \ref{Holder van der Corput}.
Set
\begin{equation}\label{eql69}
    t:=(1+d_B(\mfa,\mfb))^{-\frac{\tau}{2+a}}
\end{equation}
and define $\tilde{\varphi}$ as in Lemma \ref{Lipschitz Holder approximation}. Let $\mfa$ and $\mfb$ in $\Mf$.
Then
   \begin{equation}\label{eql60}
       \left|\int e(\mfa(x)-{\mfb(x)}) \varphi (x)\, \mathrm{d}\mu(x)\right|
   \end{equation}
      \begin{equation}\label{eql61}
   \le     \left|\int e(\mfa(x)-{\mfb(x)}) \tilde{\varphi} (x)\, \mathrm{d}\mu(x)\right|
   \end{equation}
           \begin{equation}\label{eql62}
     +  \left|\int e(\mfa(x)-{\mfb(x)}) (\varphi (x)-\tilde{\varphi}(x))\, \mathrm{d}\mu(x)\right|
   \end{equation}
Using the cancellative condition \eqref{eq vdc cond}  of $\Mf$ on the ball $B(z,2R)$, the term \eqref{eql61} is bounded above by
 \begin{equation}\label{eql63}
       2^a \mu(B(z,2R)) \|\tilde{\varphi}\|_{\Lip(B(z,2R))} (1 + d_{B(z,2R)}(\mfa,\mfb))^{-\tau}  \, .
 \end{equation}



Using   the doubling condition \eqref{doublingx},
the inequality \eqref{eq secondt}, and the estimate
$d_B\le d_{B(z,2R)}$ from the definition,
we estimate \eqref{eql63} from above by
\begin{equation}\label{eql64}
       2^{6a}t^{-1-a} \mu(B) \|{\varphi}\|_{C^\tau(B)}
       (1 + d_{B}(\mfa,\mfb))^{-\tau}  \, .
 \end{equation}

The term \eqref{eql62} we estimate using
\eqref{eq firstt} and that
$\mfa$ and $\mfb$ are real and thus $e(\mfa)$ and
$e(\mfb)$ bounded in absolute value by $1$.
We obtain for \eqref{eql62} with \eqref{doublingx}
the upper bound
  \begin{equation}\label{eql65}
      \mu(B(z,2R)) t^{\tau} \|\varphi\|_{C^\tau(B)}
      \le  2^a \mu(B) t^{\tau} \|\varphi\|_{C^\tau(B)}
      \,.
 \end{equation}
Using the definition \eqref{eql69} of $t$ and adding
\eqref{eql64} and \eqref{eql65} estimates
\eqref{eql60} from above by
\begin{equation}
       2^{6a} \mu(B) \|{\varphi}\|_{C^\tau(B)}
       (1 + d_{B}(\mfa,\mfb))^{-\frac{\tau}{2+a}}
       \end{equation}
\begin{equation} +
        2^a \mu(B) \|{\varphi}\|_{C^\tau(B)}
       (1 + d_{B}(\mfa,\mfb))^{-\frac{\tau^2}{2+a}}\, .
 \end{equation}
\begin{equation}\label{eql66}
      \le  2^{1+6a} \mu(B) \|{\varphi}\|_{C^\tau(B)}
       (1 + d_{B}(\mfa,\mfb))^{-\frac{\tau^2}{2+a}}  \, ,
 \end{equation}
where we used $\tau\le 1$.
This completes the proof of Proposition \ref{Holder van der Corput}.

%\begin{proof}
%    Define
%    $$
%        L(x,y) = \max\{0, 1 - \rho(x,y)/(Cs)\}\,.
%    $$
%    For $C \leq 1$ sufficiently small, this satisfies the third property. Note further that for each $x$,
%    $$
%        \int L(x,y) \, \mathrm{d}\mu(y) = \int_{0}^1 \mu(B(x,Cst)) \, \mathrm{d}t\,.
%    $$
%    This implies that
%    $$
%        \mu(B(x,s)) \geq \mu(B(x, Cs)) \geq \int L(x,y) \, \mathrm{d}\mu(y) \geq \frac{1}{2A} \mu(B(x,Cs)) \gtrsim \mu(B(x,s))\,.
%    $$
%    We define
%    $$
%        K(x,y) = \left(\int L(x,y) \, \mathrm{d}\mu(y)\right)^{-1} L(x,y)\,.
%    $$
%    This also satisfies the condition 1) and the upper bound of condition 2). To check the Hölder estimate in condition 2), we fix $y$ and first assume that $x, x' \in B(y, 2As)$. Then, by condition 3) and the doubling property, we have that $\mu(B(x,s)) \sim \mu(B(x',s)) \sim \mu(B(y,s))$. This implies:
%    \begin{align*}
%        |K(x,y) - K(x',y)| &\leq L(x,y)  \left|\bigg(\int L(x,y) \, \mathrm{d}\mu(y)\bigg)^{-1} - \bigg(\int L(x',y) \, \mathrm{d}\mu(y)\bigg)^{-1}\right|\\
%        & + \bigg(\int L(x',y) \, \mathrm{d}\mu(y)\bigg)^{-1} |L(x,y) - L(x',y)|\\
%        &\lesssim \frac{1}{\mu(B(y,s))^{-2}}  \int |L(x,y) - L(x',y)| \, \mathrm{d}\mu(y)  + \frac{\rho(x,x')}{\mu(B(x,s))s}\\
%        &\lesssim \frac{\rho(x,x')}{\mu(B(y,s))s}\,.
%    \end{align*}
%    Now assume that $x \in B(y,s)$ and $x' \notin B(y, 2As)$. Then $K(x',y) = 0$ and $\rho(x,x') \geq s$, so the required estimate also holds. In the final case $x,x' \notin B(y, 2As)$ the left hand side vanishes, so the inequality also holds.
%\end{proof}



\chapter{Proof of Prop. \ref{Hardy Littlewood}, Vitali covering and Hardy Littlewood}
\label{sec hlm}


We begin with a classical representation of the Lebesgue norm.
\begin{lemma}[layer cake representation]\label{layer cake representation}
Let $1\le p< \infty$.  Then for any measurable function $u:X\to [0,\infty)$ on the measure space $X$
relative to the measure $\mu$
we have
\begin{equation}\label{eq layercake}
    \|u\|_p^p=p\int_0^\infty \lambda^{p-1}\mu(\{x: u(x)\ge \lambda\})\, d\lambda\, .
\end{equation}
\end{lemma}
\begin{proof}
    The left-hand side of \eqref{eq hlm} is by definition
\begin{equation}
    \int_X u(x)^p \, d\mu(x)\, .\end{equation}
    Writing $u(x)$ as an elementary integral in $\lambda$ and then using Fubini, we write for the last display
    \begin{equation}
    =\int_X \int _0^{u(x)}
    p \lambda^{p-1} d\lambda\, d\mu(x)
\end{equation}
\begin{equation}
 =p\int _0^{\infty}
    \lambda^{p-1} \mu(\{x: u(x)\ge \lambda\}) d\lambda\, .
\end{equation}
This proves the lemma.
\end{proof}

We turn to the proof of Proposition \ref{Hardy Littlewood}.
Let the collection $\mathcal{B}$ be given.
We first show \eqref{eq besico}.



We recursively choose a finite sequence $B_i\in \mathcal{B}$
for $i\ge 0$ as follows. Assume $B_{i'}$
is already chosen for $0\le i'<i$.
If there exists a ball $B_{i}\in \mathcal{B}$ so that $B_{i}$
is disjoint from all $B_{i'}$
with $0\le i'<i$, then choose
such a ball $B_i=B(x_i,r_i)$ with maximal $r_i$.

If there is no such ball, stop the selection and set
$i'':=i$.

By  disjointedness of the chosen balls and since $0 \le u$, we have
\begin{equation}
\sum_{0\le i<i''}\int_{B_i} u(x)\, d\mu(x) \le \int_X  u(x)\, d\mu(x)\, .
\end{equation}
By \eqref{eq ball assumption}, we conclude
\begin{equation}\label{eqbes1}
\lambda \sum_{0\le i<i''}\mu(B_i)
\le  \int_X  u(x)\, d\mu(x)\, .
\end{equation}
Let $x\in \bigcup \mathcal{B}$.
Choose a ball $B'=B(x',r')\in \mathcal{B}$
such that $x\in B'$.
If $B'$ is one of the selected balls, then
\begin{equation}\label{3rone}
    x\in \bigcup _{0\le i< i''}B_i\subset \bigcup _{0\le i< i''}B(x_i,3r_i)\, .
\end{equation}
If $B'$ is not one of the selected balls, then as it is not selected at time $i''$, there is a selected ball $B_i$  with
$B'\cap B_i\neq \emptyset$.
Choose such $B_i$ with minimal index $i$. As $B'$ is therefore disjoint from all
balls $B_{i'}$ with $i'<i$ and
as it was not selected in place of $B_i$, we have $r_i\ge r'$.

Using a point $y$ in the intersection of $B_i$ and $B'$,
we conclude by the triangle inequality
\begin{equation}
   \rho(x_i,x')\le \rho(x_i,y)+\rho(x',y)\le r_i+r'\le 2r_i \, .
\end{equation}
By the triangle inequality again, we further conclude
\begin{equation}
   \rho(x_i,x)\le \rho(x_i,x')+\rho(x',x)\le 2r_i+r'\le 3r_i \, .
\end{equation}
It follows that
\begin{equation}\label{3rtwo}
    x\in  \bigcup _{0\le i< i''}B(x_i,3r_i)\, .
\end{equation}
With \eqref{3rone} and \eqref{3rtwo}, we conclude
\begin{equation}
\bigcup \mathcal{B}\subset
\bigcup _{0\le i< i''}B(x_i,3r_i)\, .
\end{equation}
With the doubling property
\eqref{doublingx} applied twice, we conclude
\begin{equation}\label{eqbes2}
    \mu(\bigcup{\mathcal{B}})
    \le \sum _{0\le i< i''}\mu (B(x_i,3r_i))
    \le 2^{2a}\sum _{0\le i< i''}\mu (B_i)\, .
\end{equation}
With \eqref{eqbes1} and \eqref{eqbes2} we conclude
\eqref{eq besico}.


We turn to the proof of \eqref{eq hlm}. We first consider the case $p_1=1$ and recall $M_{\mathcal{B}}=M_{\mathcal{B},1}$.
We write for the $p_2$-th power of left-hand side of \eqref{eq hlm}
with Lemma \ref{layer cake representation}
and a change of variables
\begin{equation}
    \|M_{\mathcal{B}}u(x)\|_{p_2}^{p_2}
   =p_2\int _0^{\infty}
    \lambda^{p_2-1} \mu(\{x: M_{\mathcal{B}}u(x)\ge \lambda\}) d\lambda\,
\end{equation}
\begin{equation} \label{eqbesi11}
   =2^{p_2} p_2\int _0^{\infty}
    \lambda^{p_2-1} \mu(\{x: M_{\mathcal{B}}u(x)\ge 2\lambda\}) d\lambda\, .
\end{equation}
Fix $\lambda\ge 0$ and let $x\in X$ satisfy $M_{\mathcal{B}}u(x)\ge 2\lambda$. By definition of $M_{\mathcal{B}}$, there is a ball
$B'\in \mathcal{B}$ such that
$x\in B'$ and
\begin{equation}\label{eqbesi10}
\int_{B'} u(y)\, d\mu(y)\ge 2\lambda \mu({B'})   \, .
\end{equation}
Define
$u_\lambda(y):=0$ if $|u(y)|<\lambda$ and $u_\lambda(y):=u(y)$ if $|u(y)|\ge \lambda$.
Then with \eqref{eqbesi10}
\begin{equation}
\int_{B'} u_\lambda (y)\, d\mu(y)
=\int_{B'} u (y)\, d\mu(y)-
\int_{B'} (u-u_\lambda) (y) d\mu(y)\,
\end{equation}
\begin{equation}
\ge 2\lambda \mu({B'})-
\int_{B'} (u-u_\lambda) (y) d\mu(y)\, .
\end{equation}
As $(u-u_\lambda)(y)\le \lambda$
by definition, we can estimate the last display by
\begin{equation}
\ge 2\lambda \mu({B'})-
\int_{B'} \lambda \,  d\mu(y)
=\lambda \mu({B'})\, .
\end{equation}
Hence $x$ is contained in
$\bigcup(\mathcal{B}_\lambda)$,
where $\mathcal{B}_\lambda$
is the collection of balls $B''$ in $\mathcal{B}$ such that
\begin{equation}
    \int_{B''} u_\lambda (y)\, d\mu(y)\ge \lambda \mu(B'')\, .
\end{equation}
We have thus seen
\begin{equation}
    \{x: M_{\mathcal{B}}u(x)\ge 2\lambda\}\subset
    \bigcup \mathcal{B}_\lambda
\, .
\end{equation}
Applying  \eqref{eq besico} to the  collection $\mathcal{B}_\lambda$
gives
\begin{equation}
    \lambda \mu(\{x: M_{\mathcal{B}}u(x)\ge 2\lambda\})\le
   2^{2a}
    \int u_\lambda (x)\, dx\, .
\end{equation}
With Lemma \ref{layer cake representation},
\begin{equation}\label{eqbesi12}
    \lambda \mu(\{x: M_{\mathcal{B}}u(x)\ge 2\lambda\})\le
   2^{2a}
    \int_0^\infty  \mu (\{x: |u_\lambda (x)|\ge \lambda'\})\, d\lambda'\, .
\end{equation}
By definition of $h_\lambda$, making a case distinction between $\lambda\ge \lambda'$ and $\lambda <\lambda'$, we see that
\begin{equation}\label{eqbesi13}
   \mu (\{x: |u_\lambda (x)|\ge \lambda'\})
   \le
   \mu (\{x: |u (x)|\ge \max(\lambda,\lambda')\})\, .
\end{equation}
We obtain with \eqref{eqbesi11},
\eqref{eqbesi12}, and \eqref{eqbesi13}
\begin{equation}
    \|M_{\mathcal{B}}u(x)\|_{p_2}^{p_2}
 \end{equation}
 \begin{equation}
   \le 2^{p_2+2a} p_2
   \int_0^\infty \lambda^{p_2-2}
   \int_0^\infty
   \mu (\{x: |u (x)|\ge \max(\lambda,\lambda')\})
   \, d\lambda'd\lambda\, .
\end{equation}
We split the integral  into $\lambda\ge \lambda'$ and $\lambda<\lambda'$ and resolve the
maximum correspondingly.
We have for $\lambda\ge \lambda'$
with Lemma \ref{layer cake representation}
\begin{equation}
    \int_0^\infty \lambda^{p_2-2}
   \int_0^\lambda
   \mu (\{x: |u (x)|\ge \lambda\})
   \, d\lambda'd\lambda
\end{equation}
\begin{equation}
   =\int_0^\infty \lambda^{p_2-1}
     \mu (\{x: |u (x)|\ge \lambda\})
d\lambda.
\end{equation}
\begin{equation}\label{eqbesi14}
   =p_2^{-1} \|u\|_{p_2}^{p_2}\, .
\end{equation}
We have for $\lambda< \lambda'$
with Fubini and Lemma \ref{layer cake representation}
\begin{equation}
    \int_0^\infty \lambda^{p_2-2}
   \int_\lambda^\infty
   \mu (\{x: |u(x)|\ge \lambda'\})
   \, d\lambda'd\lambda.
\end{equation}
\begin{equation}
   =\int_0^\infty \int_0^{\lambda'}\lambda^{p_2-2}
     \mu (\{x: |u (x)|\ge \lambda'\})
d\lambda d\lambda'.
\end{equation}
\begin{equation}
   =(p_2-1)^{-1}\int_0^\infty (\lambda')^{p_2-1}
     \mu (\{x: |u(x)|\ge \lambda'\})
d\lambda'.
\end{equation}
\begin{equation}\label{eqbesi15}
   =(p_2-1)^{-1} p_2^{-1}\|u\|_{p_2}^{p_2}\, .
\end{equation}
Adding the two estimates
\eqref{eqbesi14} and \eqref{eqbesi15} gives
\begin{equation}
    \|M_{\mathcal{B}}u(x)\|_{p_2}^{p_2}
   \le 2^{p_2+2a} (1+(p_2-1)^{-1})\|u\|_{p_2}^{p_2}
   = 2^{p_2+2a} p_2(p_2-1)^{-1}\|u\|_{p_2}^{p_2}
   \, .
   \end{equation}
With $a\ge 1$ and $p_2>1$, taking the $p_2$-th root, we obtain \eqref{eq hlm}.
We turn to the case of general
$1\le p_1<p_2$.
We have
\begin{equation}
    M_{\mathcal{B},p_1}u=(M_{\mathcal{B}} (|u|^{p_1}))^{\frac 1{p_1}}\, .
\end{equation}
Applying the special case of \eqref{eq hlm} for $M_{\mathcal{B}}$ gives
\begin{equation}
    \|M_{\mathcal{B},p_1}u\|_{p_2}=
    \|M_{\mathcal{B}} (|u|^{p_1})\|_{p_2/p_1}^{\frac 1{p_1}}
\end{equation}
\begin{equation}
    \le 2^{2a} (p_2/p_1) (p_2/p_1-1)^{-1}
    \|(|u|^{p_1})\|_{p_2/p_1}^{\frac 1{p_1}}
    =2^{2a} p_2(p_2-p_1)^{-1}\|u\|_{p_2}\, .
\end{equation}
This proves \eqref{eq hlm} in general.

Now we construct the operator $M$ satisfying \eqref{eq ball av} and \eqref{eq hlm 2}.

\begin{lemma}[covering separable space]
    \label{covering separable space}
    For each $r > 0$, there exists a countable collection $C(r) \subset X$ of points such that
    $$
        X \subset \bigcup_{c \in C(r)} B(c, r)\,.
    $$
\end{lemma}

\begin{proof}
    It clearly suffices to construct finite collections $C(r,k)$ such that
    $$
        B(o, r2^k) \subset \bigcup_{c \in C(r,k)} B(c,r)\,,
    $$
    since then the collection $C(r) = \bigcup_{k \in \mathbb{N}} C(r,k)$ has the desired property.

    Suppose that $Y \subset B(o, r2^k)$ is a collection of points such that for all $y, y' \in Y$ with $y \ne y'$, we have $\rho(y,y') \ge r$. Then the balls $B(y, r/2)$ are pairwise disjoint and contained in $B(o, r2^{k+1})$. If $y \in B(o, r)$, then $B(o, r2^{k+1}) \subset B(y, r2^{k+2})$. Thus, by the doubling property \eqref{doublingx},
    $$
        \mu(B(y, \frac{r}{2})) \ge 2^{-(k+2)a} \mu(B(o, r2^{k+1}))\,.
    $$
    Thus, we have
    $$
        \mu(B(o, r2^{k+1})) \ge \sum_{y \in Y} \mu(B(y, \frac{r}{2})) \ge |Y| 2^{-(k+2)a} \mu(B(o, r2^{k+1}))\,.
    $$
    We conclude that $|Y| \le 2^{(k+2)a}$. In particular, there exists a set $Y$ of maximal cardinality. Define $C(r,k)$ to be such a set.

    If $x \in B(o, r2^k)$ and $x \notin C(r,k)$, then there must exist $y \in C(r,k)$ with $\rho(x,y) < r$. Thus $C(r,k)$ has the desired property.
\end{proof}

For each $k \in \mathbb{N}$ we choose a countable set $C(2^k)$ as in the lemma.
Define
$$
    \mathcal{B}_\infty = \{B(c, 2^k) \ : \ c \in C(2^k), k \in \mathbb{N}\}\,.
$$
By Lemma \ref{covering separable space}, this is a countable collection of balls. We choose an enumeration $\mathcal{B}_\infty = \{B_1, \dotsc\}$ and define
$$
    \mathcal{B}_n = \{B_1, \dotsc, B_n\}\,.
$$
We define
$$
    Mw := 2^{2a}\sup_{n \in \mathbb{N}} M_{\mathcal{B}_n}w\,.
$$
This function is measurable for each measurable $w$, since it is a countable supremum of measurable functions. Estimate \eqref{eq hlm 2} follows immediately from \eqref{eq hlm} and the monotone convergence theorem.

It remains to show \eqref{eq ball av}. Let $B = B(x, r) \subset X$. Let $k$ be the smallest integer such that $2^k \ge r$, in particular we have $2^k < 2r$. By definition of $C(2^k)$, there exists $c \in C(2^k)$ with $x \in B(c, 2^k)$. By the triangle inequality, we have $B(c, 2^k) \subset B(x, 4r)$, and hence by the doubling property \eqref{doublingx}
$$
    \mu(B(c, 2^k)) \le 2^{2a} \mu(B(x,r))\,.
$$
It follows that for each $z \in B(x,r)$
\begin{align*}
    \frac{1}{\mu(B(x,r))}\int_{B(x,r)} |w(y)| \, \mathrm{d}\mu(y) &\le \frac{2^{2a}}{\mu(B(c,2^k))}\int_{B(c,2^k)} |w(y)| \, \mathrm{d}\mu(y) \\
    &\le Mw(z)\,.
\end{align*}
This completes the proof.


\chapter{Proof of Theorem \ref{classical Carleson}}



The convergence of partial Fourier sums is proved in
Subsection \ref{10classical} in two steps. In the first step,
one establishes convergence on a suitable dense subclass of functions. We choose piece-wise constant functions as subclass, the convergence is stated in Lemma \ref{convergence for piecewise constant} and proved in Subsection \ref{10piecewise}.
In the second step, one controls the relevant error of approximating a general function by a function in
the subclass by a bound of the Carleson maximal operator. This approximation result is stated
in Lemma \ref{control approximation effect} and proved in Subsection \ref{10difference}.
This latter proof refers to the main Theorem \ref{metric space Carleson}. Two assumptions in Theorem \ref{metric space Carleson} require more work, this is prepared in Lemmas \ref{lem hilbert} and \ref{van der Corput} and proved in Subsections \ref{10hilbert}
and \ref{10vandercorput}. Subsections \ref{10piecewise},
\ref{10hilbert}, \ref{10vandercorput}, and \ref{10difference}
are mutually independent.


\section{The classical Carleson theorem}
\label{10classical}

Let a uniformly continuous $2\pi$-periodic function $f:\R\to \mathbb{C}$ bounded in absolute value by $1$ be given. Let $\epsilon>0$ be given, without loss of generality we also assume $\epsilon \le 1$.

By uniform  continuity of $f$, there is a $0<\delta<\pi$
such that for all $x,x' \in \R$ with $|x-x'|\le \delta$
we have
\begin{equation}\label{uniconbound}
|f(x)-f(x')|\le 2^{-2^{50}}\epsilon^2\, .
\end{equation}
Let $K$ be the Gaussian bracket of $\frac{2\pi}\delta+1$, that is the unique integer with
\begin{equation}
    K-1\le  \frac{2\pi}{\delta} < K\, .
\end{equation}
and note that $K>2$ by assumption on $\delta$.
For each $x\in \R$, let $k(x)$ be the Gaussian bracket of $Kx/2\pi$, that is the unique integer such that
\begin{equation}\label{definekx}
k(x)\le \frac{Kx}{2\pi}<k(x)+1\, .
\end{equation}
Define
\begin{equation}\label{def fzero}
f_0(x):=f\left(\frac{2\pi k(x)}{K}\right)\, .
\end{equation}
\begin{lemma}[piecewise constant
approximation]
\label{piecewise constant
approximation}
The function $f_0$ is measurable.
The function $f_0$ is $2\pi $- periodic.
The function $f_0$ satisfies  for all $x\in \R$:
\begin{equation}\label{eq ffzero}
|f(x)-f_0(x)|\le  2^{-2^{50}} \epsilon^2\, ,
\end{equation}
\begin{equation}\label{eq ffzero1}
|f_0(x)|\le  1\, .
\end{equation}
\end{lemma}

\begin{proof}
Let $F$ be any set in $\mathbb{C}$. We show that
$f_0^{-1}(F)$ is measurable. As
$Z:=\{2\pi k/K, k\in \mathbb{Z}\}$ is countable, it suffices to show
that $f_0^{-1}(F)\setminus Z$ is measurable. It then
suffices to show that $f_0^{-1}(F)\setminus Z$ is open.
Let $x\in f_0^{-1}(F)\setminus Z$. There is a $k$
such that $x\in [2\pi k/K, 2\pi (k+1))$. As $x\not\in Z$,
we have that $x\in (2\pi k/K, 2\pi (k+1))$
but $f_0$ is constant on $(2\pi k/K, 2\pi (k+1))$,
hence $(2\pi k/K, 2\pi (k+1))$ is a subset of
$f_0^{-1}(F)\setminus Z$. This proves that
$f_0^{-1}(F)\setminus Z$ is open and completes the proof of measurability of $f_0$.




To see that $f_0$ is $2\pi$-periodic, we observe by
applying \eqref{definekx} to $x+2\pi$ and subtracting $K$
that
\begin{equation}\label{definekxshifted}
k(x+2\pi)-K\le \frac{Kx}{2\pi}<k(x+2\pi)-K+1\,
\end{equation}
and hence
\begin{equation}
 k(x+2\pi)-K=k(x)
\end{equation}
and hence by Definition \eqref{def fzero}
\begin{equation}
    f_0(x+2\pi)=f(\frac {2\pi k(x+2\pi)}K)=f(\frac{2\pi (k(x)+K)}{K})
     =f(\frac{2\pi k(x)}K+2\pi)\ ,
\end{equation}
which by $2\pi$-periodicity of $f$ is equal to
\begin{equation}
   =f(\frac{2\pi k(x)}K)=f_0(x)\, .
\end{equation}
  This proves that $f_0$ is $2\pi$- periodic




To see \eqref{eq ffzero}, observe that by \eqref{definekx} used
twice and then by definition of $K$ we have
\begin{equation}
0\le x-\frac{2\pi k(x)}{K} \le \frac{2\pi }{K}\le \delta\, .
\end{equation}
Hence, by choice of $\delta$, for all $x\in \R$, we obtain \eqref{eq ffzero}.

Finally \eqref{eq ffzero} follows because $|f|$ by assumption is bounded by $1$.
This completes the proof of the lemma.
\end{proof}

Define the set $E_1$ to be
\begin{equation}
E_1=\bigcup_{k=0}^{K}[\frac{2\pi}K (k-\frac {\epsilon}{16\pi }),
\frac{2\pi}K (k+\frac {\epsilon}{16\pi})]\, .
\end{equation}
Then we have for the Lebesgue measure of $E_1$, using $K>1$,
\begin{equation}
 |E_1|\le \sum_{k=0}^{K}\frac {\epsilon}{4K}= \frac{\epsilon}{4}\left(1+\frac 1K\right)\le \frac \epsilon 2\, \, .
\end{equation}

We prove in Subsection \ref{10piecewise}:
\begin{lemma}[convergence for piecewise constant]
\label{convergence for piecewise constant}
\uses{constant function,flat interval partial sum}
    For all $N>\frac {2^{25} K^2}{\epsilon ^3}$ and
    \begin{equation}
        x\in [0,2\pi)\setminus E_1
    \end{equation}
we have
    \begin{equation}
        |S_N f_0 (x)- f_0(x)|\le \frac \epsilon 4\, .
    \end{equation}
\end{lemma}


We prove in Subsection \ref{10difference}:
\begin{lemma}[control approximation effect]
\label{control approximation effect}
\uses{real Carleson, dirichlet kernel,lower secant bound}
    There is a set $E_2 \subset \R$ with Lebesgue measure
    $|E_2|\le \frac \epsilon 2$ such that for all
    \begin{equation}
        x\in [0,2\pi)\setminus E_2
    \end{equation}
   we have
    \begin{equation}
    \label{eq max partial sum diff}
        \sup_{N\ge 0} |S_Nf(x)-S_Nf_0(x)|
        \le \frac \epsilon 4\,.
    \end{equation}
\end{lemma}

Define
\begin{equation}
    E:=E_1\cup E_2\, .
\end{equation}
Then
\begin{equation}
    |E|\le |E_1|+|E_2|\le \frac \epsilon 2 +\frac \epsilon 2 \le \epsilon\, .
\end{equation}
Let $N_0$ be the unique integer such that
\begin{equation}
    N_0- 1\le {2^{25} K^2}{\epsilon ^{-3}}<N_0\, .
\end{equation}
For every
\begin{equation}
x\in [0,1)\setminus E\, ,
\end{equation}
and every $N>N_0$ we have by the triangle inequality
\begin{equation*}
    |f(x)-S_Nf(x)|
    \end{equation*}
    \begin{equation}\label{epsilonthird}
    \le |f(x)-f_0(x)|+ |f_0(x)-S_Nf_0(x)|+|S_Nf_0(x)-S_N f(x)|\, .
\end{equation}
Using \eqref{uniconbound} and Lemmas \ref{convergence for piecewise constant}
and \ref{control approximation effect}, we estimate \eqref{epsilonthird} by
\begin{equation}
    \le 2^{-2^{50}} \epsilon^2 +\frac \epsilon 4 +\frac \epsilon 4\le \epsilon\, .
\end{equation}
This shows  \eqref{aeconv} for the given $E$ and $N_0$
and completes the proof of Theorem \ref{classical Carleson}.

The proof of Lemma \ref{control approximation effect} will essentially be
an application of
the following variant of Theorem \ref{metric space Carleson}.
Let  $\kappa:\R\to \R$ be the function defined by
$\kappa(0)=0$ and for $0<|x|<1$
\begin{equation}\label{eq hilker}
\kappa(x)=\frac { 1-|x|}{1-e^{ix}}\,
\end{equation}
\ct{make sure you never divide anything by zero... dangerous if $x=2\pi m$}
and for $|x|\ge 1$
\begin{equation}\label{eq hilker1}
\kappa(x)=0\, .
\end{equation}
Note that this function is continuous at every point $x$ with $|x|>0$.
The following lemma is proved in Subsection \ref{10carleson}.
\begin{lemma}\label{real Carleson}
\uses{metric space Carleson,real line metric,real line measure,real line doubling,frequency ball doubling,frequency ball growth,frequency ball cover,real van der Corput,Hilbert kernel bound,Hilbert kernel regularity}
    Let $F,G$ be Borel subsets of $\R$ with finite measure. Let $f$ be a bounded measurable function on $\R$ with $|f|\le \mathbf{1}_F$. Then
\begin{equation}
    |\int _G Tf(x) \, dx| \le 2^{2^{40}}|F|^{\frac 12} |G|^{\frac 12} \, ,
\end{equation}
where
\begin{equation}
    \label{define T carleson}
    T f(x)=\sup_{n\in \mathbb{Z}}
    \sup_{r>0}\left|\int_{r<|x-y|<1} f(y)\kappa(x-y) e^{iny}\, dy\right|\, .
\end{equation}
\end{lemma}


The following lemma is proved in Subsection \ref{10hilbert}.
\ct{Lars was right. I changed the following so that it exactly fits what we need. This makes 10.3 mildly more laborous, but that's where one can get synergies....
The $2^8$ can be a bit larger if needed}
\begin{lemma}\label{lem hilbert}
    For every  bounded measurable function $g$ with bounded support we have
\begin{equation}
    \|T_*g\|_2\le 2^8\|g\|_2,
\end{equation}
where
\begin{equation}\label{concretetstar}
    T_* g(x):=\sup_{0<r_1<r_2<1}\sup_{|x-x'|<r_1}\frac 1{2\pi} \left|\int_{r_1<|x-y|<r_2}
g(y) \kappa(x-y)\, dy\right|\, .
\end{equation}
\end{lemma}
The following lemma is proved in Subsection \ref{10vandercorput}.
\begin{lemma}[van der Corput]
\label{van der Corput}
    Let $\alpha<\beta$ be real numbers. Let $g:\R\to \C$ be a  measurable function and assume
    \begin{equation}
        \|g\|_{Lip(\alpha,\beta)}:=\sup_{\alpha\le x\le \beta}|g(x)|+|\beta-\alpha|
        \sup_{\alpha\le x<y\le \beta} \frac {|g(y)-g(x)|}{|y-x|}<\infty\, .
    \end{equation}
    Then for any $0\le \alpha<\beta\le 2\pi$ we have
    \begin{equation}
        \int _{\alpha}^{\beta} g(x) e^{-inx}\, dx\le 2\pi |\beta-\alpha|\|g\|_{Lip(\alpha,\beta)}(1+|n||\beta-\alpha|)^{-1}\, .
    \end{equation}

\end{lemma}






We close this section with four lemmas that are used
across the following subsections.

\begin{lemma}[mean zero oscillation]
\label{mean zero oscillation}
Let $n\in \mathbb{Z}$ with   $n\neq 0$, then
\begin{equation}
\int_0^{2\pi} e^{inx}\, dx=0
\end{equation}
\end{lemma}
\begin{proof}
We have
\begin{equation}
\int_0^{2\pi} e^{inx}\, dx=\left[ \frac 1{in}e^{inx}\right]_0^{2\pi}=\frac  1{in}(e^{2\pi i n}-e^{2\pi i 0})=\frac 1{in}(1-1)=0\, .
\end{equation}

\end{proof}

\begin{lemma}[Dirichlet kernel]
\label{dirichlet kernel}
We have for every $2\pi$-periodic bounded measurable $f$ and every $N\ge 0$
\begin{equation}
    S_Nf(x)=\frac 1{2\pi}\int_{-\pi}^{\pi}f(y) K_N(x-y)\, dy
\end{equation}
where $K_N$ is the $2\pi$-periodic continuous function of
$\R$ given by
\begin{equation}\label{eqksumexp}
\sum_{n=-N}^N e^{in x'}\, .
\end{equation}
We have for $e^{ix'}\neq 1$ that
\begin{equation}\label{eqksumhil}
    K_N(x')=\frac{e^{iNx'}}{1-e^{-ix'}}
      +\frac {e^{-iNx'}}{1-e^{ix'}} \, .
\end{equation}


\end{lemma}


\begin{proof}
We have by definitions and interchanging sum and integral
   \begin{equation*}
        S_Nf(x)=\sum_{n=-N}^N \widehat{f}_n e^{inx}
    \end{equation*}
       \begin{equation*}
    =\sum_{n=-N}^N \frac 1{2\pi}\int_{-\pi}^{\pi}
    f(x) e^{in(x-y)}\, dy
    \end{equation*}
 \begin{equation}\label{eq expsum}
     =\frac 1{2\pi}\int_{-\pi}^\pi
    f(y) \sum_{n=-N}^N e^{in(x-y)}\, dy\, .
 \end{equation}
This proves the first statement of the lemma.
By a telescoping sum, we have for every $x'\in \R$
\begin{equation}
    \left( e^{\frac 12 ix'}-e^{-\frac 12 ix'}\right)  \sum_{n=-N}^N e^{inx'}= e^{(N+\frac 12) ix'}-e^{-(N+\frac 12) ix'}\, .
\end{equation}
If $e^{ix'}\neq 1$, the first factor on the left-hand side is not $0$ and we may divide by this factor to obtain
\begin{equation}
      \sum_{n=-N}^N e^{inx'}= \frac{e^{i(N+\frac 1 2)x'}}{e^{\frac 12 ix'}-e^{-\frac 12ix'}}
      -\frac{e^{-i(N+\frac 1 2)x'}}{e^{\frac 12 ix'}-e^{-\frac 12ix'}}
       =\frac{e^{iNx'}}{1-e^{-ix'}}
      +\frac {e^{-iNx'}}{1-e^{ix'}}\, .
\end{equation}
This  proves the second part of the lemma.
\end{proof}

\begin{lemma}[lower secant bound]
\label{lower secant bound}
Let $\eta>0$ and $-2\pi +\eta \le  x\le 2\pi-\eta$ with $|x|\ge \eta$. Then
\begin{equation}
    |1-e^{ix}|\ge \frac {\eta} 8
\end{equation}
\end{lemma}
\begin{proof}

We have
$$
    |1 - e^{ix}| = \sqrt{(1 - \cos(x))^2 + \sin^2(x)} \ge |\sin(x)|\,.
$$
If $0 \le x \le \frac{\pi}{2}$, then we have from concavity of $\sin$ on $[0, \pi]$ and $\sin(0) = 0$ and $\sin(\frac{\pi}{2}) = 1$
$$
    |\sin(x)| \ge \frac{2}{\pi} x \ge \frac{2}{\pi} \eta\,.
$$
When $x\in \frac{m\pi}{2} + [0, \frac{\pi}{2}]$ for $m \in \{-4, -3, -2, -1, 1, 2, 3\}$ one can argue similarly.
 \end{proof}

The following lemma will be proved in Subsection \ref{10projection}.

\begin{lemma}[spectral projection bound]
\label{spectral projection bound}
    Let $f$ be a bounded $2\pi$-periodic measurable function. Then, for all $N\ge 0$
   \begin{equation}\label{snbound}
   \|S_Nf\|_2\le \|f\|_2.
   \end{equation}
\end{lemma}





\section{Piecewise constant functions.}
\label{10piecewise}









We first compute the partial Fourier sums for constant functions.


\begin{lemma}[constant function]
\label{constant function}
If $h$ satisfies $h(x)=h(0)$ for all $x\in \R$, then for all $N\ge 0$ we have $S_Nh=h$.
 \end{lemma}
\begin{proof}
    We compute with Lemma \ref{mean zero oscillation} for $n\in \mathbb{Z}$ with $n\neq 0$,
    \begin{equation}
        \widehat{h}_n=\frac 1{2\pi}\int_0^{2\pi}h(y)e^{-iny}\, dy=\frac {h(0)}{2\pi}\int_0^{2\pi}e^{-iny}\, dy=0\, .
    \end{equation}
hence for $N\ge 0$
\begin{equation}
    S_nh(x)=\sum_{n=-N}^N \widehat{h}_n e^{inx}=\widehat{h_0}=\frac{1}{2\pi}\int_0^{2\pi}h(y)\, dy
    =\frac{h(0)}{2\pi}\int_0^{2\pi}\, dy=h(x)\, .
\end{equation}
This proves the lemma.
\end{proof}

\begin{lemma}[Dirichlet kernel bound]
\label{dirichlet kernel bound}
\uses{lower secant bound}
Let $\eta>0$. Let
\begin{equation}
    -2\pi +\eta \le a<b \le 2\pi-\eta
\end{equation}
and assume
\begin{equation}\label{eq abdelta}
   [a,b]\cap [-\eta,\eta]=\emptyset \, .
\end{equation}
Then
    \begin{equation}\label{dirichletint}
    \left|\int_a^b
\frac {e^{iNx}} {1-e^{-ix}}
dx\right| \le \frac{64}N(\frac{|b-a|}{\eta^2}+\frac 1{\eta}).
\end{equation}
\end{lemma}
\begin{proof}
 Note first that the integral in \eqref{dirichletint}
    is well defined as the denominator of the integrand is bounded away from zero by Lemma \ref{lower secant bound}
    and thus the integrand is continuous.
    We have with partial integration
\begin{equation*}
    \int_a^b
\frac {e^{-iNx}} {1-e^{ix}}\,
dx
\end{equation*}
\begin{equation}\label{eq part int}
=\frac 1{-iN}\int_a^b
{e^{-iNx}}\frac {ie^{ix}} {(1-e^{ix})^2}\, dx
+\left[ \frac 1{-iN}
\frac {e^{-iNx}} {1-e^{ix}}\right]_a^b\, .
\end{equation}
We estimate the two summands in
\eqref{eq part int} separately. We have
for the first summand in \eqref{eq part int}
with Lemma \ref{lower secant bound},
\begin{equation*}
\left|   \frac 1 {-iN}\int_a^b
{e^{-iNx}}\frac{ie^{ix}}
{(1-e^{ix})^2}\,
dx \right|
\end{equation*}
\begin{equation}\label{firstpi}
    \le \frac 1N \int_a^b|1-e^{-ix}|^{-2} \, dx \le \frac {|b-a|}N\sup_{x\in [a,b]}|1-e^{-ix}|^{-2}
\end{equation}
\begin{equation}
    \le  \frac {64|b-a|}{\eta^2N}
\end{equation}
We have for the second summand in \eqref{eq part int}
with Lemma \ref{lower secant bound} again
\begin{equation*}
   \left|\left[ \frac 1{-iN}
    \frac {e^{-iNx}} {1-e^{ix}}\right]_a^b\right|
\end{equation*}
\begin{equation}\label{secondpi}
   \le \frac 1N (|1-e^{ia}|^{-1}+|1-e^{ib}|^{-1})
    \le \frac {16}{\eta N}\, .
\end{equation}
Using the triangle inequality in \eqref{eq part int}
and applying the estimates \eqref{firstpi} and \eqref{secondpi}  proves the lemma.
\end{proof}



Let $\mathcal{G}$ be the class of $2\pi$-periodic measurable functions $g$ which satisfy for all $x\in \R$
\begin{equation}
   g(\frac{2\pi k(x)}K)=g(x)
\end{equation}
and
\begin{equation}
   |g(x)|\le 2\, .
\end{equation}



\begin{lemma}[flat interval partial sum]
\label{flat interval partial sum}
\uses{dirichlet kernel,dirichlet kernel bound}
Let $g\in \mathcal{G}$. Assume
$x\in [0,2\pi)\setminus E_1 $ and $g(x)=0$.
Then for all $N>\frac {2^{25} K^2}{\epsilon^3}$
\begin{equation}\label{single char f}
|S_Ng(x)|\le \frac \epsilon 4\, ,
\end{equation}
\end{lemma}
\begin{proof}






   With Lemma \ref{dirichlet kernel}, breaking up the domain of integration into a
   partition of subintervals,
   \begin{equation*}
      |S_N(g)|=\left|\int_{-\pi}^{\pi} g(y)K_N(x-y)\, dy\right|
   \end{equation*}
   \begin{equation}\label{eqcf1}
  =  \left|\sum_{k=0}^{K-1}\int_{\frac{2\pi k}K}^{\frac{2\pi (k+1)}K} g(y)K_N(x-y)\, dy\right|\, .
   \end{equation}
Using $g\in \mathcal{G}$ and that $ k(y)=k$ for each
\begin{equation}
    y\in [\frac {2\pi k}K, \frac{2\pi (k+1)}K)\, ,
\end{equation}
and then applying the triangle inequality with the upper bound on $|g|$ and the identity $g(x)=g(2\pi k(x)/K)=0$,  we estimate \eqref{eqcf1} by
      \begin{equation*}
  =  \left|\sum_{k=0}^{K-1} g(\frac{2\pi k}K) \int_{\frac{2\pi k}K}^{\frac{2\pi (k+1)}K} K_N(x-y)\, dy\right|
   \end{equation*}
      \begin{equation}\label{eqcf3}
  \le 2 \sum_{0\le k<K, k\neq k(x)} \left|\int_{\frac{2\pi k}K}^{\frac{2\pi (k+1)}K} K_N(x-y)\, dy\right|\, .
   \end{equation}
Doing a variable substitution, we obtain for \eqref{eqcf3}
\begin{equation}
  2 \sum_{0\le k<K, k\neq k(x)}
   \left|\int_{x-2\pi (k+1)/K}^{x-2\pi k/K} K_N(y)\, dy\right|\, .
\end{equation}
Fix $0\le k<K$ with $k\neq k(x)$ and set
\begin{equation}
    a=x-2\pi (k+1)/K\, ,
\end{equation}
\begin{equation}
    b=x-2\pi k/K\, .
\end{equation}
As $x\in [0,2\pi)\setminus E_1$, we have
with $\eta=\epsilon/(8K)$
\begin{equation}
    a\ge x-2\pi\ge -2\pi+\eta\, ,
\end{equation}
\begin{equation}
    b\le x \le 2\pi -\eta\, .
\end{equation}
If $b< 0$, then $2\pi k/K> x$ and as $x\not \in E_1$ also
$2\pi k-\eta \ge x$. Hence $b \le -\eta $. If $b\ge 0$, then $2\pi k/K\le x$. As $k\neq k(x)$, we also have
$2\pi (k+1)/K\le x$. As $x\not \in E_1$, we have
$2\pi (k+1)/K+\eta \le x$. It follows that
$0<a$. In both cases, we have seen
\eqref{eq abdelta}.



With Lemma \ref{dirichlet kernel} and the triangle inequality,
it follows that
\begin{equation}
   \left|\int_{x-2\pi (k+1)/K}^{x-2\pi k/K} K_N(y)\, dy\right|
   \le \left|\int_{a}^{b}
   \frac{e^{iNy}}{1-e^{-iy}}\, dy\right|+
   \left|\int_{a}^{b}
   \frac{e^{-iNy}}{1-e^{iy}}\, dy\right|
\end{equation}
Using that the two integrals on the right-hand side are complex conjugates of each other, and using Lemma \ref{dirichlet kernel bound} and $\epsilon <2\pi$, this is bounded by
\begin{equation}
   \le 2\left|\int_{a}^{b}
   \frac{e^{iNy}}{1-e^{-iy}}\, dy\right|
   \le \frac{128}N(\frac{|b-a|}{\eta^2}+\frac 1{\eta})
   \le \frac{2^{20}K}{N\epsilon^2 }\le 2^{-3}\epsilon K^{-1}\, .
\end{equation}
Inserting this in \eqref{eqcf3} and adding up proves
the lemma.
\end{proof}

We now prove  Lemma \ref{convergence for piecewise constant}

Let $x\in [0,2\pi)\setminus E_1 $ and $N>\frac {2^{25} K^2}{\epsilon ^3}$.
Let $h$ be the function which is constant equal to $f_0(x)$ and let $g=f_0-h$.
By the bound on $f$ and the triangle inequality,
$|g|$ is bounded by $2$. Hence $g$ is in the class $\mathcal{G}$. We also have $g(x)=0$.
Using Lemma \ref{constant function}, we obtain
\begin{equation}
    S_Nf_0(x)- f_0(x)=S_N(g+h)(x)- S_Nh(x)=S_Ng(x)\, .
\end{equation}
Lemma \ref{convergence for piecewise constant}
now follows by Lemma \ref{flat interval partial sum}.



\section{The truncated Hilbert transform}
\label{10hilbert}

\lars{I am skipping this subsection because it has to be rewritten anyway}
\rs{To be discussed: 1. Using $L^2$ norms in Cotlar leads to a weak $(2,2)$ estimates for $T_*$}
\rs{2. Obtaining $L^2$ estimate for $T_0$ using uniform $L^2$ bound for truncated kernels}
\rs{3. Passing to $\mathbb{R}$ from periodic functions}

\rs{Change norms}


Let $M_n$ be the modulation operator
acting on measurable $2\pi$-periodic functions
defined by
\begin{equation}
    M_ng(x)=g(x) e^{inx}\, .
\end{equation}
Define the approximate Hilbert transform by
\begin{equation}
    L_N g=\frac 1N\sum_{n=0}^{N-1}
       M_{-n-N} S_{N+n}M_{N+n}g\, .
\end{equation}


\begin{lemma}
We have for every bounded measurable $2\pi$-periodic function $g$
\begin{equation}\label{lnbound}
    \|L_Ng\|_{L^2[-\pi, \pi]}\le \|g\|_{L^2[-\pi, \pi]}
\end{equation}
\end{lemma}
\begin{proof}
    We have
    \begin{equation}\label{mnbound}
        \|M_ng\|_2^2=\int_{-\pi}^{\pi} |e^{inx}g(x)|^2\, dx
        =\int_{-\pi}^{\pi} |g(x)|^2\, dx=\|g\|_{L^2[-\pi, \pi]}^2\, .
    \end{equation}
     We have by the triangle inequality, the square root of the identity in\eqref{mnbound}, and Lemma \ref{spectral projection bound}
    \begin{equation*}
        \|L_ng\|_2=\|\frac 1N\sum_{n=0}^{N-1}
       M_{-n-N} S_{N+n}M_{N+n}g\|_2
    \end{equation*}
    \begin{equation*}
        \le \frac 1N\sum_{n=0}^{N-1} \|
       M_{-n-N} S_{N+n}M_{N+n}g\|_2
         = \frac 1N\sum_{n=0}^{N-1} \|
    S_{N+n}M_{N+n}g\|_2
    \end{equation*}
       \begin{equation}
     \le \frac 1N\sum_{n=0}^{N-1} \|
 M_{N+n}g\|_2  = \frac 1N\sum_{n=0}^{N-1} \|
g\|_2 =\|g\|_2\, .
    \end{equation}
This proves \eqref{mnbound} and completes the proof of the lemma.
\end{proof}

\begin{lemma}\label{lem shift}
\lean{Function.Periodic.intervalIntegral_add_eq, intervalIntegral.integral_comp_sub_right}
\leanok
Let $f$ be a bounded $2\pi$-periodic function. We have for any
$0 \le x\le 2\pi$ that
\begin{equation}
 \int_0^{2\pi} f(y)\, dy= \int_{-x}^{2\pi -x}   f(y)\, dy
 =\int_{-\pi}^{\pi}   f(y-x)\, dy
\end{equation}
\end{lemma}
\begin{proof}
\leanok
    We have  by periodicity and change of variables
    \begin{equation}\label{eqhil9}
 \int_{-x}^{0} f(y)\, dy=\int_{-x}^{0} f(y+2\pi)\, dy= \int_{2\pi -x}^{2\pi}   f(y)\, dy\, .
\end{equation}
We then have by breaking up the domain of integration
and using \eqref{eqhil9}
\begin{equation*}
 \int_0^{2\pi} f(y)\, dy= \int_0^{2\pi -x}   f(y)\, dy+
 \int_{2\pi -x}^{2\pi}   f(y)\, dy
 \end{equation*}
\begin{equation}
= \int_0^{2\pi -x}   f(y)\, dy+
 \int_{ -x}^{0}   f(y)\, dy
 = \int_{-x}^{2\pi-x} f(y)\, dy\, .
 \end{equation}
This proves the first identity of the lemma. The second identity follows by substitution of $y$ by $y-x$.
\end{proof}



\begin{lemma}\label{young}
    Let $f$ and $g$ be two bounded non-negative measurable $2\pi$-periodic functions on $\R$. Then
    \begin{equation}\label{eqyoung}
        \left(\int_{-\pi}^{\pi} \left(\int_{-\pi}^{\pi}
        f(y)g(x-y)\, dy\right)^2\, dx\right)^{\frac 12}\le \|f\|_2 \|g\|_1\, .
    \end{equation}
    \end{lemma}
\begin{proof}
Using Fubini and Lemma \ref{lem shift}, we observe
\begin{equation*}
  \int_{-\pi}^{\pi}\int_{-\pi}^{\pi}f(y)^2g(x-y)\, dy
    \, dx=\int_{-\pi}^{\pi}f(y)^2\int_{-\pi}^{\pi}g(x-y)\, dx
    \, dy
\end{equation*}
\begin{equation}\label{eqhil4}
=\int_{-\pi}^{\pi}f(y)^2\int_{-\pi}^{\pi}g(x) \, dx
     dy
=\|f\|_2^2\|g\|_1\, .
\end{equation}

   Let $h$ be the  nonnegative square root of $g$, then
   $h$ is bounded and $2\pi$-periodic with $h^2=g$.
   We estimate the square of the left-hand side of
   \eqref{eqyoung} with Cauchy-Schwarz and then with
   \eqref{eqhil4} by
       \begin{equation*}
         \int_{-\pi}^{\pi} (\int_{-\pi}^{\pi}f(y)h(x-y)h(x-y)\, dy)^2\, dx
   \end{equation*}
\begin{equation}
    \le \int_{-\pi}^{\pi}\left(\int_{-\pi}^{\pi}f(y)^2g(x-y)\, dy\right)
    \left(\int_{-\pi}^{\pi}g(x-y)\, dy\right)\, dx
   = \|f\|_2^2\|g\|_1^2\, .
\end{equation}
Taking square roots, this proves the lemma.
\end{proof}

For $0<r<1$, Define the kernel $k_r$ to be the $2\pi$-periodic function
\begin{equation}
    |k_r(x)|:=\min \left(r^{-1}, 1+\frac r{|1-e^{ix}|^2}\right)\, ,
\end{equation}
where the minimum is understood to be $r^{-1}$ in case $1=e^{ix}$.
\begin{lemma}\label{krbound}
Let $g,f$ be bounded measurable $2\pi$-
periodic functions. Let $0<r<\pi$.
Assume we have for all $0\le x\le 2\pi$
\begin{equation}
    |g(x)|\le k_r(x)\, .
\end{equation}
Let
\begin{equation}
   h(x)= \int_{-\pi}^{\pi} f(y)g(x-y)\, dy \, .
\end{equation}
Then
\begin{equation}
   \|h\|_2\le 2^{5}\|f\|_2  \, .
\end{equation}

\end{lemma}

\begin{proof}
We compute with Lemma \ref{lem shift}
\begin{equation}
    \|g\|_1\le  \int_{-\pi}^{\pi}k_r(x)\, dx=\int_{-\pi}^\pi k_r(x)\, dx
\end{equation}
Using the symmetry
$k_r(x)=k_r(-x)$ and the assumption,  the last display
is equal to
\begin{equation*}
    =  2 \int_0^\pi \min\left(\frac 1r, 1+\frac r{|1-e^{ix}|^2}\right)\, dx
\end{equation*}
\begin{equation*}
    \le 2\int_0^{r} \frac 1r \, dx+2\int_r^{\pi}1+\frac {64r}{x^2}\, dx
\end{equation*}
\begin{equation}
    \le 2+2\pi + 2\left(\frac {64r}r-\frac {64r}{\pi}\right)
    \le 2^{5}\, .
\end{equation}
    Together with Lemma \ref{young}, this proves the lemma.
\end{proof}
\rs{Change power of $2$}
\begin{lemma}\label{lem dirichlet2}
Let $0<r<1$. Let $N$ be the smallest
integer larger than $\frac 1r$.
There is a   $2\pi$-periodic continuous function
 ${L'}$ on $\R$ that satisfies for all $-\pi\le x\le \pi$
and all $2\pi$-periodic bounded measurable functions $f$ on $\R$
\begin{equation}\label{lthroughlprime}
    L_Nf(x)=\frac 1{2\pi}\int_{-\pi}^{\pi}f(y) {L'}(x-y)\, dy
\end{equation}
and
\begin{equation}\label{eqdifflhil}
    \left|L'(x)-\frac{\mathbf{1}_{\{y:\, r<|y|<1\}}(x)\max(1-|x|, 0)}{1-e^{-ix}}\right|\le 2^{10}k_r(x)\, .
\end{equation}
\end{lemma}


\begin{proof}
We have by definition and Lemma \ref{dirichlet kernel}
\begin{equation}
    L_Ng(x)=
    \frac 1N\sum_{n=0}^{N-1}
       \int_{-\pi}^{\pi} e^{-i(N+n)x} K_{N+n}(x-y) e^{i(N+n)y}g(y)
\, dy \, .\end{equation}
This is of the form \eqref{lthroughlprime} with
the continuous function
\begin{equation}
    {L'}(x)=  \frac 1N\sum_{n=0}^{N-1}
      K_{N+n}(x) e^{-i(N+n)x}\, .
\end{equation}
With \eqref{eqksumexp} of Lemma \ref{dirichlet kernel}
we have $|K_N(x)|\le N$ for every $x$ and thus
\begin{equation}\label{eqhil13}
    |{L'}(x)|\le  \frac 1N\sum_{n=0}^{N-1}
      (N+n) \le 2N\le 2^{10} r^{-1}\, .
\end{equation}
Therefore, for $|x|\in [0, r)\cup (1, \pi]$, we have
\begin{equation}
    \label{eqdiffzero}
    \left|L'(x)-\frac{\mathbf{1}_{\{y:\, r<|y|<1\}}(x)\max{(1-|x|, 0)}}{1-e^{-ix}}\right|=|L'(x)|\leq 2^{10} r^{-1}.
\end{equation}
This proves \eqref{eqdifflhil} for $|x|\in [0, r)$ since $k_r(x)=r^{-1}$ in this case.
% The case $x\in [2\pi-r, 2\pi]$ also follows by the symmetry $k_r(-x)=k_r(x)$ and $2\pi$ periodicity of $k_r$.
For $e^{ix'}\neq 1$
and may use the expression
\eqref{eqksumhil} for $K_N$
in Lemma \ref{dirichlet kernel} to obtain
\begin{equation*}
    {L'}(x)=  \frac 1N\sum_{n=0}^{N-1}
     \left(\frac{e^{i(N+n)x}}{1-e^{-ix}}
      +\frac {e^{-i(N+n)x}}{1-e^{ix}}\right) e^{-i(N+n)x}
\end{equation*}
\begin{equation*}
    =  \frac 1N\sum_{n=0}^{N-1}
    \left(\frac{1}{1-e^{-ix}}
      +\frac {e^{-i2(N+n)x}}{1-e^{ix}}\right)
\end{equation*}
\begin{equation}\label{eqhil3}
    =  \frac{1}{1-e^{-ix}} +
     \frac 1N \frac {e^{-i2Nx}}{1-e^{ix}}
     \sum_{n=0}^{N-1}
    {e^{-i2nx}}
\end{equation}
and thus
\begin{equation}
\label{eq L'L''}
  {L'}(x)  -\frac{\mathbf{1}_{{\{y:\, r<|y|<1\}}}(x)\max{(1-|x|, 0)}}{1-e^{-ix}}=L''(x)+ \frac{1-\mathbf{1}_{{\{y:\, r<|y|<1\}}}(x)(1-|x|)}{1-e^{-ix}},
\end{equation}
where
$$L''(x):=\frac 1N \frac {e^{-i2Nx}}{1-e^{ix}}
     \sum_{n=0}^{N-1}
    {e^{-i2nx}}.$$
For $x\in [-\pi, r]\cup [r, \pi]$, we have using Lemma \ref{lower secant bound} that
\begin{equation*}
   \left|\frac{1-\mathbf{1}_{{\{y:\, r<|y|<1\}}}(x)(1-|x|)}{1-e^{-ix}} \right|=\left|\frac{\min(|x|, 1)}{1-e^{-ix}} \right|\leq \frac{8\min(|x|, 1)}{|x|}
\end{equation*}
\begin{equation}
 \label{eq diffzero2}
    \leq 2^3\cdot 1\leq  2^{8} k_r(x).
\end{equation}
% Using the symmetry $k_r(-x)=k_r(x)$ and the $2\pi$ periodicity of $k_r$, we also conclude the same for $x\in [\pi, 2\pi-r)$.

Next, we need to estimate $L''(x)$. If the real part of
$e^{ix}$ is negative, we have
\begin{equation}
  1\le   |1-e^{ix}|\le 2\, .
\end{equation}
and hence
\begin{equation}\label{eqhil12}
    |L''(x)|\le
     \frac 1N
     \sum_{n=0}^{N-1}
    1=1\le 2^{10}\left(1+\frac r{|1-e^{ix}|^2}\right)\, .
\end{equation}
If the real part of $e^{ix}$ is positive and in particular while still $e^{ix}\neq \pm 1$, then  we have by telescoping
\begin{equation}
 (1-e^{-2ix})
     \sum_{n=0}^{N-1}
    {e^{-i2nx}}=1-e^{-i2Nx}\, .
\end{equation}
As $e^{-2ix}\neq 1$, we may divide by $1-e^{-2ix}$ and insert this into
\eqref{eqhil3} to obtain
\begin{equation}
 L''(x)=
           \frac 1N \frac {e^{-i2Nx}}{1-e^{ix}}
     \frac{1-e^{-i2Nx}}{1-e^{-2ix}}\, .
\end{equation}
Hence, with Lemma \ref{lower secant bound} and nonnegativity of the real part of $e^{ix}$
\begin{equation*}
    |L''(x)|
 \le \frac 2 N \frac {1}{|1-e^{ix}|}
     \frac{1}{|1-e^{-2ix}|}
 \end{equation*}
\begin{equation}\label{eqhil11}
    = \frac 2 N \frac {1}{|1-e^{ix}|^2}
     \frac{1}{|1+e^{ix}|}\le
 \frac {4r}{|1-e^{ix}|^2}\le 2^{10} \left (1+\frac {r}{|1-e^{ix}|^2}\right)
\end{equation}
Inequalities \eqref{eqhil13}, \eqref{eqdiffzero}, \eqref{eq L'L''}, \eqref{eq diffzero2}, \eqref{eqhil12}, and \eqref{eqhil11} prove \eqref{eqdifflhil}. This completes the proof of the lemma.
\end{proof}
% \begin{proof}
% We have by definition and Lemma \ref{dirichlet kernel}
% \begin{equation}
%     L_Ng(x)=
%     \frac 1N\sum_{n=0}^{N-1}
%        \int_0^{2\pi} e^{-i(N+n)x} K_{N+n}(x-y) e^{i(N+n)y}g(y)
% \, dy \, .\end{equation}
% This is of the form \eqref{lthroughlprime} with
% the continuous function
% \begin{equation}
%     {L'}(x)=  \frac 1N\sum_{n=0}^{N-1}
%       K_{N+n}(x) e^{-i(N+n)x}\, .
% \end{equation}
% With \eqref{eqksumexp} of Lemma \ref{dirichlet kernel}
% we have $|K_N(x)|\le N$ for every $x$ and thus
% \begin{equation}\label{eqhil13}
%     |{L'}(x)|\le  \frac 1N\sum_{n=0}^{N-1}
%       (N+n) \le 2N\le 2^{8} r^{-1}\, .
% \end{equation}


% For $e^{ix'}\neq 1$
% and may use the expression
% \eqref{eqksumhil} for $K_N$
% in Lemma \ref{dirichlet kernel} to obtain
% \begin{equation*}
%     {L'}(x)=  \frac 1N\sum_{n=0}^{N-1}
%      \left(\frac{e^{i(N+n)x}}{1-e^{-ix}}
%       +\frac {e^{-i(N+n)x}}{1-e^{ix}}\right) e^{-i(N+n)x}
% \end{equation*}
% \begin{equation*}
%     =  \frac 1N\sum_{n=0}^{N-1}
%     \left(\frac{1}{1-e^{-ix}}
%       +\frac {e^{-i2(N+n)x}}{1-e^{ix}}\right)
% \end{equation*}
% \begin{equation}\label{eqhil3}
%     =  \frac{1}{1-e^{-ix}} +
%      \frac 1N \frac {e^{-i2Nx}}{1-e^{ix}}
%      \sum_{n=0}^{N-1}
%     {e^{-i2nx}}
% \end{equation}
% and thus
% \begin{equation}
% \label{eq L'L''}
%   {L'}(x)  -\frac{\mathbf{1}_{[r, 2\pi -r]}(x)\max{(1-|x|, 0)}}{1-e^{-ix}}=L''(x)+ \frac{1-\mathbf{1}_{[r, 1]}(x)(1-x)}{1-e^{-ix}},
% \end{equation}
% where
% $$L''(x):=\frac 1N \frac {e^{-i2Nx}}{1-e^{ix}}
%      \sum_{n=0}^{N-1}
%     {e^{-i2nx}}.$$
% We first show
% \begin{equation}
%     \label{est L''}
%     |L''(x)|\leq 2^8|k_r(x)|.
% \end{equation}
% If the real part of
% $e^{ix}$ is negative, we have
% \begin{equation}
%   1\le   |1-e^{ix}|\le 2\, .
% \end{equation}
% and hence
% \begin{equation}\label{eqhil12}
%     |L''(x)|\le
%      \frac 1N
%      \sum_{n=0}^{N-1}
%     1=1\le 2^{8}\left(1+\frac r{|1-e^{ix}|^2}\right)\, .
% \end{equation}
% If the real part of $e^{ix}$ is positive and in particular while still $e^{ix}\neq \pm 1$, then  we have by telescoping
% \begin{equation}
%  (1-e^{-2ix})
%      \sum_{n=0}^{N-1}
%     {e^{-i2nx}}=1-e^{-i2Nx}\, .
% \end{equation}
% As $e^{-2ix}\neq 1$, we may divide by $1-e^{-2ix}$ and insert this into
% \eqref{eqhil3} to obtain
% \begin{equation}
%  L''(x)=
%            \frac 1N \frac {e^{-i2Nx}}{1-e^{ix}}
%      \frac{1-e^{-i2Nx}}{1-e^{-2ix}}\, .
% \end{equation}
% Hence, with Lemma \ref{lower secant bound} and nonnegativity of the real part of $e^{ix}$
% \begin{equation*}
%     |L''(x)|
%  \le \frac 2 N \frac {1}{|1-e^{ix}|}
%      \frac{1}{|1-e^{-2ix}|}
%  \end{equation*}
% \begin{equation}\label{eqhil11}
%     = \frac 2 N \frac {1}{|1-e^{ix}|^2}
%      \frac{1}{|1+e^{ix}|}\le
%  \frac {4r}{|1-e^{ix}|^2}\le 2^{8} \left (1+\frac {r}{|1-e^{ix}|^2}\right)
% \end{equation}
% Inequalities \eqref{eqhil13}, \eqref{eqhil12}, and \eqref{eqhil11} prove \eqref{est L''}. Next, we estimate the second term on the right in \eqref{eq L'L''}. For $x\in [r, 1]$, we have using Lemma \ref{lower secant bound} that
% \begin{equation*}
% \left|\frac{1-\mathbf{1}_{[r, 1]}(x)(1-x)}{1-e^{-ix}}\right|=
% \frac{|x|}{|1-e^{-ix}|}\leq \min\left(\frac{8|x|}{|x|}, \frac{8}{r}\right)\leq 2^8 k_r(x).
% \end{equation*}
% \rs{Argue for other cases}
% Combining the above with \eqref{est L''} and the triangle inequality completes the proof of the lemma.
% \end{proof}

For $r\in (0,1)$, $x\in \mathbb{R}$ and $g$ a bounded, measurable function on $\mathbb{R}$ with bounded support, we let
\begin{equation}
\label{def H_r}
H_r g(x):= \int_{r<|x-y|<1}
g(y) \kappa(x-y)\, dy.
\end{equation}
We also define
\begin{equation}
\label{def Tr}
     T_r g(x):=\sup_{|x-x'|<r}|H_r g(x')|=\sup_{|x-x'|<r}  \left|\int_{r<|x'-y|<1}
g(y) \kappa(x'-y)\, dy\right|\,.
\end{equation}
Observe that
\begin{equation*}
T_*g(x)=\sup_{0<r_1<r_2<1}\sup_{|x-x'|<r_1}\left|H_{r_1} g(x')-H_{r_2} g(x')\right|\,,
\end{equation*}
so that
\begin{equation}
    \label{eq 1 sup}
    T_*g(x)\leq 2\sup_{0<r<1} T_r g(x).
\end{equation}
Further, let
\begin{equation}
    T_0f(x):=\int f(y)\kappa(x-y) \, dy.
\end{equation}

\begin{lemma}
    \label{lem R transfer}
    Let $0<r<1$. Let $f$ be a bounded, measurable function on $\mathbb{R}$ with bounded support. Then
    \begin{equation}
        \label{eq Hr L2 bound}
        \|H_rf\|_{2}\leq 2^{16} \|f\|_2.
    \end{equation}
\end{lemma}

\begin{proof}
    Suppose first that $f$ is supported in the interval $[-\pi, \pi$ with $f(-\pi)=f(\pi)=0$. Let $\tilde{f}$ be the $2\pi$-periodic extension of $f$ to $\mathbb{R}$. Let $N$ be the smallest
    integer larger than $\frac 1r$. Then, by Lemma \ref{lem dirichlet2} and the triangle inequality, for $x\in [-\pi, \pi]$ we have
    \begin{equation*}
        |H_r \tilde{f}(x)|\leq |L_N \tilde{f}(x)|+2^{10}\left|\int_{-\pi}^{\pi}k_r(x-y)\tilde{f}(y)\, dy\right|.
    \end{equation*}
    Taking $L^2$ norm over the interval $[-\pi, \pi]$ and using its sub-additivity, we get
    \begin{equation*}
        \|H_r \tilde{f}\|_{L^2[-\pi, \pi]}\leq  \|L_N \tilde{f}\|_2\, + \left(\int_{-\pi}^{\pi} \left|\int_{-\pi}^{\pi}k_r(x-y)\tilde{f}(y)\, dy\right|^2\, dx\right)^{\frac{1}{2}}.
    \end{equation*}
Using Lemma \ref{krbound} and \ref{lem dirichlet2}, and passing back to $f$, we conclude
\begin{equation}
\|H_r f\|_{2}\leq \|f\|_2 + 2^{15}\|f\|_2.
\end{equation}
\rs{Pass to $\mathbb{R}$}
\end{proof}

\begin{lemma}
    \label{lem kappa op L2 bound}
    Let $f$ be a bounded, measurable function on $\mathbb{R}$ with bounded support. Then
    \begin{equation}
        \label{eq kappa op L2 bound}
        \|T_0 f\|_2\leq 2^{17}\|f\|_2.
    \end{equation}
\end{lemma}
\begin{proof}
\rs{Write}
\end{proof}

\begin{lemma}\label{lem dirichlet3}
\rs{Replaced by the next lemma}
Let $0<r<1$.  Let $x\in \mathbb{R}$ and let $|x'-x|\le r$. Then
\begin{equation}\label{eqdifftrans}
    \left|\frac{\mathbf{1}_{[r, 2\pi -r]}(x)\max{(1-|x|, 0)}}{1-e^{-ix}}-\frac{\mathbf{1}_{[r, 2\pi -r]}(x')\max{(1-|x'|, 0)}}{1-e^{-ix'}}\right|\le 2^{10}k_r(x)\, .
\end{equation}
\end{lemma}

\begin{proof}
We have by Lemma \ref{lower secant bound} for each $0<x\le \pi$
\begin{equation}
    \left|\frac{\mathbf{1}_{[r, 2\pi -r]}(x)\max(1-|x|, 0)}{1-e^{-ix}}\right|\le \frac 8x\le \frac 8r\, .
\end{equation}
By symmetry $k_r(x)=k_r(-x)$, the analogous inequality holds for $-\pi \le x\le 0$.
By periodicity, the analogous inequality holds for $-\pi\le x\le 3\pi$.
Hence
\begin{equation}\label{eqhil16}
    \left|\frac{\mathbf{1}_{[r, 2\pi -r]}(x)\max(1-|x|, 0)}{1-e^{-ix}}-\frac{\mathbf{1}_{[r, 2\pi -r]}(x')\max(1-|x'|, 0)}{1-e^{-ix'}}\right|\le 2^{3}r^{-1}\, .
\end{equation}
It remains to show the the left hand side above is no greater than $2^{10}\left(1+\frac{r}{|1-e^{ix}|^2}\right)$,
% \begin{equation}\label{eqhil17}
%     \left|\frac{\mathbf{1}_{[r, 2\pi -r]}(x)\max(1-|x|, 0)}{1-e^{-ix}}-\frac{\mathbf{1}_{[r, 2\pi -r]}(x')\max(1-|x'|, 0)}{1-e^{-ix'}}\right|\le 2^{10}\left(1+\frac{r}{|1-e^{ix}|^2}\right)\, .
% \end{equation}
for those $x$ such that
\begin{equation}\label{eqhil15}
 2^{10}\left(1+\frac{r}{|1-e^{ix}|^2}\right)\le 2^{3}r^{-1}\, .
\end{equation}
We consider four cases. If both $x, x'\not\in [r, 1]$, then the left hand side of \eqref{eqhil16} is zero and we are done. If $\{x, x'\}\cap [r, 1]=\{x\}$, then by the triangle inequality, either $|x|\leq 2r$ or $|x|\geq 1-r$. In the first instance, the left hand side of \eqref{eqhil16} is
\begin{equation*}
    \left|\frac{\max(1-|x|, 0)}{1-e^{-ix}}\right|\leq \frac{|1-e^{-ix}|}{|1-e^{-ix}|^2}.
\end{equation*}
This can be estimated by
\begin{equation*}
    \leq \frac{|x|}{|1-e^{-ix}|^2}\leq \frac{2r}{|1-e^{-ix}|^2}\leq 2^{10}\left(1+\frac{r}{|1-e^{ix}|^2}\right),
\end{equation*}
which is the desired inequality. Alternatively, when $|x|\geq 1-r$, we have
\begin{equation*}
    \left|\frac{\max(1-|x|, 0)}{1-e^{-ix}}\right|\leq \frac{r |1-e^{-ix}|}{|1-e^{-ix}|^2}.
\end{equation*}
This can again be estimated by
\begin{equation*}
    \leq \frac{2 r}{|1-e^{-ix}|^2}\leq 2^{10}\left(1+\frac{r}{|1-e^{ix}|^2}\right).
\end{equation*}
The case when $\{x, x'\}\cap [r, 1]=\{x'\}$ is dealt with similarly.

Finally, when both $|x|, |x'|\in [r, 1]$, the left-hand side  of \eqref{eqhil16} becomes
 \begin{equation}
    \left|\frac{1-x}{1-e^{-ix}}-\frac{1-x'}{1-e^{-ix'}}\right|\, .
\end{equation}
If $x'\ge x$, using the fundamental theorem of calculus, we can write this as
\begin{equation*}
\left|\int_{x}^{x'} \frac{-iye^{-iy}+(1-e^{-iy})}{(1-e^{-iy})^2}\, dy\right|\leq 4|x-x'| \sup_{x\leq y\leq x'<1} \frac{1}{|1-e^{-iy}|^2}.
\end{equation*}
Using the decreasing property of $\frac{1}{|1-e^{-iy}|^2}$ on $[0,1]$, we deduce that the right hand side above can be estimated by
$$\frac{4r}{|1-e^{-ix}|^2}\leq 2^{10}\left(1+\frac{r}{|1-e^{-ix}|^2}\right).$$
\rs{The case when $x'<x$}
% \begin{equation*}
%     \left|\int_{x'}^x \frac{-ie^{-iy}}{(1-e^{-iy})^2}\, dy\right|
% \end{equation*}
% \begin{equation}
%     \le \int_{x'}^x \frac{64}{r^2}\, dy=\frac{64(x-x')}{r^2}\le \frac{64}r\, .
% \end{equation}
\end{proof}

\begin{lemma}
    \label{lem non tang diff}
    Let $0<r<1$ and  $x\in \mathbb{R}$. Let $g$ be a bounded measurable function with bounded support on $\mathbb{R}$. Then, there exists a measurable function $Mg: \mathbb{R}\to [0, \infty)$ satisfying
$$\|Mg\|_2\leq 2^{17}\|g\|_2\,,$$ such that for all $x'$ with $|x-x'|<\frac{r}{2}$.
\begin{equation}
\label{eq non-tang diff}
|H_rg(x)-H_rg(x')|\leq 2^{12} Mg(x)\, .
\end{equation}
\rs{Upgrade to $|x-x'|<r$}
\end{lemma}

\begin{proof}
We have
$$|H_rg(x)-H_rg(x')|$$ $$\leq  \int_{\{y:\, r<|x-y|<1\}\cup \{y:\, r<|x'-y|<1\}} |\kappa(x-y)-\kappa(x'-y)||g(y)|\, dy.$$
For $y$ with $|x'-y|>r$, we have
$$|x-y|\geq |x'-y|-|x-x'|>r-\frac{r}{2}=\frac{r}{2}.$$
Therefore the domain of integration above is contained in the set
$\{y:\, |x-y|<\frac{r}{2}\}.$ Decomposing this set into dyadic ranges, we see that the integral above is estimated by
\begin{equation}
    \label{eq rKer dyadic sum}
    \sum_{j=0}^{\lfloor \log_2(\frac{1}{r})\rfloor+1}\int_{2^{j-1}r\leq |x-y|<2^{j}r}|\kappa(x-y)-\kappa(x'-y)||g(y)|\, dy.
\end{equation}
% Since $|x-x'|<\frac{r}{2}<\frac{|x-y|}{2}$, we can argue as in Lemma \ref{Hilbert kernel regularity} to get the estimate
We claim that
\begin{equation}
\label{eq kappa reg Tr}
    |\kappa(x-y)-\kappa(x'-y)|\leq 2^{10}\frac{1}{|x-y|} \frac{|x-x'|}{|x-y|}\,,
\end{equation}
%Detailed proof
\rs{This proof is repeated several times so can be a lemma at the beginning of the section}
To see the above, let $z=x-y$ and $z'=x-y'$. Since $|z-z'|<\frac{r}{2}<\frac{|z|}{2}$, we conclude that $z, z'$ have the same sign. Since $\kappa(z)=\overline{\kappa(-z)}$, we may assume without loss of generality that they are both positive. Then our assumption implies that
    $$
        \frac{z}{2} \le z' \,.
    $$
    We now consider four cases. If $z, z' \le 1$, then we have
    $$
        |\kappa(z)-\kappa(z')| = \left|  \frac{1 - z}{1- e^{-iz}} - \frac{1 - z'}{1- e^{-iz'}}\right|
    $$
    and by the fundamental theorem of calculus
    $$
        = \left| \int_{z'}^{z} \frac{-1 + e^{-it} + i(1-t)e^{it}}{(1 - e^{-it})^2} \,dt \right|\,.
    $$
    Using $z' \ge \frac{z}{2}$ and Lemma \ref{lower secant bound}, we bound this by
    $$
        \le |z - z'| \sup_{\frac{z}{2} \le t \le 1} \frac{3}{|1 - e^{-it}|^2}  \le 3 |z-z'| (8 \frac{2}{z})^2 \le 2^{10} \frac{|z-z'|}{|z|^2}\,.
    $$
    If $z \le 1$ and $z' > 1$, then $\kappa(z')= 0$ and we have from the first case
    $$
        |\kappa(z)-\kappa(z')| = |\kappa(z)| \le 2^{10} \frac{|z-1|}{|z|^2} \le 2^{10} \frac{|z-z'|}{|z|^2}\,.
    $$
    The case when $z > 1$ and $z' \le 1$ can be handled similarly.
    Finally, if $z, z' > 1$ then
    $$
        |\kappa(z)-\kappa(z')| = 0 \le 2^{10} \frac{|z-z'|}{|z|^2}\,.
    $$

Plugging \eqref{eq kappa reg Tr} into \eqref{eq rKer dyadic sum}, we get
\begin{equation}
    \label{eq rker HL}
    |H_rg(x)-H_rg(x')|\leq 2^{10} \sum_{j=0}^{\lfloor \log_2(\frac{1}{r})\rfloor+1}\frac{r}{2}(2^{j-1}r)^{-2}\int_{|x-y|<2^{j}r}|g(y)|\, dy.
\end{equation}

By Proposition \ref{Hardy Littlewood}, there exists a measurable function $Mg: \mathbb{R}\to [0, \infty)$ such that
for each $j$ in the above sum,
$$\frac{1}{2^{j}r}\int_{|x-y|<2^{j}r}|g(y)|\, dy\leq  Mg(x),$$
and
$$\|Mg\|_2\leq 2^{17}\|g\|_2.$$
In combination with \eqref{eq rker HL}, this yields
\begin{equation*}
 |H_rg(x)-H_rg(x')|\leq 2^{10} \sum_{j=0}^{\lfloor \log_2(\frac{1}{r})\rfloor+1}2^{-j+1}Mg(x)\leq 2^{12} Mg(x).
\end{equation*}
\end{proof}




% \begin{lemma}\label{lem dirichlet3}
% Let $0<r<\pi$.  Let $0\le x\le 2\pi$ and let $|x'-x|\le r$.
% \begin{equation}\label{eqdifftrans}
%     |\frac{\mathbf{1}_{[r, 2\pi -r]}(x)}{1-e^{-ix}}-\frac{\mathbf{1}_{[r, 2\pi -r]}(x')}{1-e^{-ix'}}|\le 2^{10}k_r(x)\, .
% \end{equation}
% \end{lemma}
% \rs{Change to the correct kernel}
% \begin{proof}
% We have by Lemma \ref{lower secant bound} for each $0<x\le \pi$
% \begin{equation}
%     \left|\frac{\mathbf{1}_{[r, 2\pi -r]}(x)}{1-e^{-ix}}\right|\le \frac 8x\le \frac 8r\, .
% \end{equation}
% By symmetry $k_r(x)=k_r(-x)$, the analogous inequality holds for $-\pi \le x\le 0$
% By periodicity, the analogous inequality holds for $-\pi\le x\le 3\pi$.
% Hence
% \begin{equation}\label{eqhil16}
%     |\frac{\mathbf{1}_{[r, 2\pi -r]}(x)}{1-e^{-ix}}-\frac{\mathbf{1}_{[r, 2\pi -r]}(x')}{1-e^{-ix'}}|\le 2^{3}r^{-1}\, .
% \end{equation}
% It remains to show
% \begin{equation}\label{eqhil17}
%     |\frac{\mathbf{1}_{[r, 2\pi -r]}(x)}{1-e^{-ix}}-\frac{\mathbf{1}_{[r, 2\pi -r]}(x')}{1-e^{-ix'}}|\le 2^{10}\left(1+\frac{r}{|1-e^{ix}|^2}\right)\, .
% \end{equation}
% for those $x$ such that
% \begin{equation}\label{eqhil15}
%  2^{10}\left(1+\frac{r}{|1-e^{ix}|^2}\right)\le 2^{3}r^{-1}\, .
% \end{equation}
%  For those $x$, the left-hand side  of \eqref{eqhil17} becomes
%  \begin{equation}
%     |\frac{1}{1-e^{-ix}}-\frac{1}{1-e^{-ix'}}|\, .
% \end{equation}
% If $x\ge x'$, we can write this as
% \begin{equation*}
%     |\int_{x'}^x \frac{-ie^{-iy}}{(1-e^{-iy})^2}\, dy|
% \end{equation*}
% \begin{equation}
%     \le \int_{x'}^x \frac{64}{r^2}\, dy=\frac{64(x-x')}{r^2}\le \frac{64}r\, .
% \end{equation}


% \end{proof}

For $x\in \mathbb{R}$ and $r\in (0, 1)$, we shall make use of the following decomposition of $g$.
\begin{equation}
    \label{eq g dec}
    g_{x, 1}:=g\cdot \mathbf{1}_{\{y: |x-y|<r \}},\qquad g_{x, 2}:=g-g_{x,1}\,.
\end{equation}

\begin{lemma}
\label{lem Tr to T}
Let $0<r<1$ and  $x\in \mathbb{R}$. Let $g$ be a bounded measurable function on $\mathbb{R}$ with bounded support. Then, for all $x'\in \mathbb{R}$, we have
\begin{multline}
\label{Tr est1}
|T_rg(x)|\leq  |T_0g_{x,2}(x)-T_0g_{x,2}(x')|+|T_0 g(x')|+|T_0 g_{x,1}(x')|+2^{12} Mg(x)\,,
%\\+2^{10}|\int_0^{2\pi} g(y) k_r(x-y)\, dy|\, .
\end{multline}
\end{lemma}
where $Mg$ is as in Lemma \ref{lem non tang diff}.
\begin{proof}
For every $x$ under consideration, we have
\begin{equation*}
|T_rg(x)|\le |H_rg(x)|+ |T_rg(x)-H_rg(x)|\, .
\end{equation*}
Using Lemma \ref{lem non tang diff}, we obtain the estimate
\begin{equation*}
\label{eq TrHr}
|T_rg(x)|\leq |H_rg(x)|+ 2^{12}\left|Mg(x)\right|\, .
\end{equation*}
Observe that
\begin{equation*}
    \label{gg2}
    H_r g(x)= T_0g_{x,2}(x).
\end{equation*}
Using the triangle inequality twice, we estimate
\begin{equation*}
\label{eq diff xx'}
|T_0g_{x,2}(x)|\leq |T_0g_{x,2}(x)-T_0g_{x,2}(x')|+|T_0g_{x,1}(x')| + |T_0g(x')|.
\end{equation*}
Putting the above inequalities together, we obtain \eqref{Tr est1}.
% For the last term on the right above, another application of triangle inequality yields
% \begin{equation*}
% |H_rg(x')|\leq  |L_N g(x')|+|H_rg(x')-L_N g(x')|.
% \end{equation*}
% Combining the above with Lemma \ref{lem dirichlet2}, we have
% \begin{equation}
% \label{eq diff x'g}
% |H_rg(x')|\leq |L_N g(x')|+ 2^{10}\left|\int_0^{2\pi} g(y) k_r(x'-y)\, dy\right|.
% \end{equation}
% Similarly, we can estimate
% \begin{equation}
% \label{eq diff x'g2}
% |H_rg_{x,1}(x')|\leq  |L_N g_{x,1}(x')|+ 2^{10}\left|\int_0^{2\pi} g_{x,1}(y) k_r(x'-y)\, dy\right|.
% \end{equation}
\end{proof}

\begin{lemma}
    \label{lem cotlar}
    Let $x\in \mathbb{R}$. Let $g$ be a bounded, measurable function with bounded support on $\mathbb{R}$. Then, there exists $x'$ with $|x-x'|<\frac{r}{2}$ such that
such that
\begin{equation}
    \label{eq cotlar}
    |T_0g_{x,1}(x')|+|T_0g(x')|\leq  2^3 [(M(|T_0g|^{\frac{3}{2}})(x))^{\frac{2}{3}}+(M(|g|^2)(x))^{\frac{1}{2}}],
\end{equation}
where $(M(|T_0g|^{\frac{3}{2}})$ and $M(|g|^2)$ are measurable functions satisfying \rs{The second one will only satisfy a weak (2, 2) type inequality}
\end{lemma}
\begin{proof}
For $\alpha>0$, we have
\begin{equation}
    \mu\left(\{x'\in \mathbb{R}: |x'-x|<\frac,\, |T_0g(x')|>\alpha\}\right)\leq \alpha^{-\frac{3}{2}}\int_{|x-y|<\frac{r}{2}} |T_0g(y)|^2\, dy.
\end{equation}
Using Proposition \ref{Hardy Littlewood} (more precisely, \eqref{eq hlm 2} with $w=|T_0g|^{\frac{3}{2}}$), we conclude that there exists a measurable function $M(|T_0g|^{\frac{3}{2}})$ such that the right hand side above can be estimated by
\begin{equation}
    \label{eq HL1}
    \alpha^{-{\frac{3}{2}}} M(|T_0g|^{\frac{3}{2}})(x)\mu(\{x'\in \mathbb{R}: |x-x'|<\frac{r}{2}\}).
    %= 2\frac{r}{2} \alpha^{-2} M(|L_Ng|^2)(x).
\end{equation}
Moreover, this function satisfies the estimate
$$\|M(|T_0g|^{\frac{3}{2}})^{\frac{2}{3}}\|_2\leq 2^{\frac{2.16}{3}}\left(\frac{2}{2-\frac{3}{2}}\right)^{\frac{2}{3}}\|T_0g\|_2\leq 2^{12} \|T_0g\|_2.$$
Similarly, we have
\begin{equation*}
    \mu\left(\{x'\in \mathbb{R}: |x'-x|<\frac{r}{2},\, |T_0g_{x,1}(x')|>\alpha\}\right)\leq \alpha^{-2}\int_{|x-y|<\frac{r}{2}} |T_0g_{x,1}(y)|^2\, dy.
\end{equation*}
This time, we use Lemma \ref{lem kappa op L2 bound} to estimate the above by
\begin{equation*}
    2\alpha^{-2}\int |T_0g_{x,1}(y)|^2\, dy \leq 2^2 \alpha^{-2}\int |g_{x,1}(y)|^2\, dy
    = 2^2 \alpha^{-2}\int_{|y-x'|<\frac{r}{2}} |g(y)|^2 \,dy.
\end{equation*}
Using Proposition \ref{Hardy Littlewood} again (more precisely, \eqref{eq hlm 2} with $w=|g|^2$), we obtain another measurable function $M(|g|^2)$ such that the above can be estimated by
\begin{equation}
    \label{eq HL2}
    2^2\alpha^{-2} M(|g|^2)(x)\mu(\{x'\in \mathbb{R}: |x-x'|<\frac{r}{2}\}).
    %= 2^3 \frac{r}{2} \alpha^{-2} M(|g|^2)(x).
\end{equation}
From \eqref{eq HL1} and \eqref{eq HL2}, we deduce that for
\begin{equation*}
    \label{eq alph choice}
    \alpha=\max\left(4 (M(|T_0g|^{\frac{3}{2}})(x))^{\frac{2}{3}}, 4 (M(|g|^2)(x))^{\frac{1}{2}} \right),
\end{equation*}
we have the estimate
\begin{multline*}
    \mu(\{x'\in \mathbb{R}: |x-x'|<\frac{r}{2}, |T_0g_{x,1}(x')|>\alpha \text{ or }|T_0g(x')|>\alpha\}\\\leq \frac{1}{2} \mu(\{x'\in \mathbb{R}: |x-x'|<\frac{r}{2}\}.
\end{multline*}
Making this choice of $\alpha$, we conclude that there exists an $x'$ with $|x-x'|<\frac{r}{2}$ such that \eqref{eq cotlar} is true.
\end{proof}

\begin{lemma}
\label{lem xx' g2 diff}
Let $0<r<1$ and  $x\in \mathbb{R}$. Let $g$ be a bounded measurable function with bounded support on $\mathbb{R}$. Then, there exists a measurable function $Mg: \mathbb{R}\to [0, \infty)$ satisfying
$$\|Mg\|_2\leq 2^{17}\|g\|_2\,,$$ such that for all $x'$ with $|x-x'|<\frac{r}{2}$.
\begin{equation}
\label{eq xx' g2 diff}
|T_0g_{x,2}(x)-T_0g_{x,2}(x')|\leq 2^{11} Mg(x)\, .
\end{equation}
\end{lemma}
\begin{proof}
We have
$$|T_0g_{x,2}(x)-T_0g_{x,2}(x')|\leq \int_{r<|x-y|<1} |\kappa(x-y)-\kappa(x'-y)||g(y)|\, dy.$$
Decomposing the range of the integral into dyadic ranges, we see the above is estimated by
\begin{equation}
    \label{eq hilbker dyadic sum}
    \sum_{j=0}^{\lfloor \log_2(\frac{1}{r})\rfloor}\int_{2^jr\leq |x-y|<2^{j+1}r}|\kappa(x-y)-\kappa(x'-y)||g(y)|\, dy.
\end{equation}
% Since $|x-x'|<\frac{r}{2}<\frac{|x-y|}{2}$, we can argue as in Lemma \ref{Hilbert kernel regularity} to get the estimate
We claim that
\begin{equation}
\label{eq kappa reg}
    |\kappa(x-y)-\kappa(x'-y)|\leq 2^{10}\frac{1}{|x-y|} \frac{|x-x'|}{|x-y|}\,,
\end{equation}
%Detailed proof
To see the above, let $z=x-y$ and $z'=x-y'$. Since $|z-z'|<\frac{r}{2}<\frac{|z|}{2}$, we conclude that $z, z'$ have the same sign. Since $\kappa(z)=\overline{\kappa(-z)}$, we may assume without loss of generality that they are both positive. Then our assumption implies that
    $$
        \frac{z}{2} \le z' \,.
    $$
    We now consider four cases. If $z, z' \le 1$, then we have
    $$
        |\kappa(z)-\kappa(z')| = \left|  \frac{1 - z}{1- e^{-iz}} - \frac{1 - z'}{1- e^{-iz'}}\right|
    $$
    and by the fundamental theorem of calculus
    $$
        = \left| \int_{z'}^{z} \frac{-1 + e^{-it} + i(1-t)e^{it}}{(1 - e^{-it})^2} \,dt \right|\,.
    $$
    Using $z' \ge \frac{z}{2}$ and Lemma \ref{lower secant bound}, we bound this by
    $$
        \le |z - z'| \sup_{\frac{z}{2} \le t \le 1} \frac{3}{|1 - e^{-it}|^2}  \le 3 |z-z'| (8 \frac{2}{z})^2 \le 2^{10} \frac{|z-z'|}{|z|^2}\,.
    $$
    If $z \le 1$ and $z' > 1$, then $\kappa(z')= 0$ and we have from the first case
    $$
        |\kappa(z)-\kappa(z')| = |\kappa(z)| \le 2^{10} \frac{|z-1|}{|z|^2} \le 2^{10} \frac{|z-z'|}{|z|^2}\,.
    $$
    The case when $z > 1$ and $z' \le 1$ can be handled similarly.
    Finally, if $z, z' > 1$ then
    $$
        |\kappa(z)-\kappa(z')| = 0 \le 2^{10} \frac{|z-z'|}{|z|^2}\,.
    $$

Plugging \eqref{eq kappa reg} into \eqref{eq hilbker dyadic sum}, we get
\begin{equation*}
    \label{eq hilbker HL}
    |T_0g_{x,2}(x)-T_0g_{x,2}(x')|\leq 2^{10} \sum_{j=0}^{\lfloor \log_2(\frac{1}{r})\rfloor}\frac{r}{2}(2^jr)^{-2}\int_{|x-y|<2^{j+1}r}|g(y)|\, dy.
\end{equation*}

By Proposition \ref{Hardy Littlewood}, there exists a measurable function $Mg: \mathbb{R}\to [0, \infty)$ such that
for each $j$ in the above sum,
$$\frac{1}{2^{j+1}r}\int_{|x-y|<2^{j+1}r}|g(y)|\, dy\leq  Mg(x),$$
and
$$\|Mg\|_2\leq 2^{17}\|g\|_2.$$
In combination with \eqref{eq hilbker HL}, this yields
\begin{equation*}
 |T_0g_{x,2}(x)-T_0g_{x,2}(x')|\leq 2^{10} \sum_{j=0}^{\lfloor \log_2(\frac{1}{r})\rfloor}2^{-j}Mg(x)\leq 2^{11} Mg(x).
\end{equation*}
\end{proof}


\begin{proof}[Proof of Lemma \ref{lem hilbert}]
We now prove Lemma \ref{lem hilbert}. \rs{Write}
\end{proof}

% We now prove Lemma \ref{lem hilbert}.
% We have with $r$ and $N$ as above for every $x$
% \begin{equation}
% |T_rg(x)|\le |L_Ng(x)|+ |H_rg(x)-L_Ng(x)|+ |T_rg(x)-H_rg(x)|\, .
% \end{equation}
% With Lemma \ref{lem dirichlet2} and Lemma \ref{dirichlet kernel}, we estimate this by

% \begin{equation}
% \le |L_Ng(x)|+ 2^{11}|\int_0^{2\pi} g(y) k_r(x-y)\, dy|\, .
% \end{equation}

% By monotonicity and sub-additivity of the $L^2$ norm, we obtain
% \begin{equation}
%     \|T_rg\|_2\le \|L_N\|_2+2^{11}\|g*k_r\|_2\ .
% \end{equation}

% By Lemma \ref{lnbound} and Lemma \ref{krbound}, we obtain

% \begin{equation}
%     \|T_rg\|_2\le 2^{30}\|g\|_2\ .
% \end{equation}


\section{The proof of the van der Corput Lemma \ref{van der Corput}}
\label{10vandercorput}

Let $g$ be a Lipschitz continuous function as in the lemma. We have
$$
    e^{in(x + \pi/n)} = -e^{inx}\,.
$$
Using this, we write
$$
    \int_\alpha^\beta g(x) e^{-inx} \, \mathrm{d}x
    = \frac{1}{2} \int_\alpha^\beta g(x) e^{inx} \, \mathrm{d}x - \frac{1}{2} \int_\alpha^\beta g(x) e^{in(x + \pi/n)}) \, \mathrm{d}x\,.
$$
We split the the first integral at $\alpha + \frac{\pi}{n}$ and the second one at $\beta - \frac{\pi}{n}$, and make a change of variables in the first part of the second integral to obtain
$$
    = \frac{1}{2} \int_{\alpha}^{\alpha + \frac{\pi}{n}} g(x) e^{inx} \, \mathrm{d}x - \frac{1}{2} \int_{\beta - \frac{\pi}{n}}^{\beta} g(x) e^{in(x + \pi/n)} \, \mathrm{d}x
$$
$$
    + \frac{1}{2} \int_{\alpha + \frac{\pi}{n}}^{\beta} (g(x) - g(x - \frac{\pi}{n}) e^{inx} \, \mathrm{d}x\,.
$$
The sum of the first two terms is by the triangle inequality bounded by
$$
    \frac{\pi}{n} \sup_{x \in [\alpha,\beta]} |g(x)|\,.
$$
The third term is by the triangle inequality at most
$$
    \frac{1}{2} \int_{\alpha + \frac{\pi}{n}}^\beta |g(x) - g(x - \frac{\pi}{n})| \, \mathrm{d}x
$$
$$
    \le \frac{\pi}{2n} \sup_{\alpha \le x < y \le \beta} \frac{|g(x) - g(y)|}{|x-y|} |\beta-\alpha|\,.
$$
Adding the two terms, we obtain
$$
    \left|\int_\alpha^\beta g(x) e^{-inx} \, \mathrm{d}x\right| \le \frac{\pi}{n} \|g\|_{\mathrm{Lip}(\alpha,\beta)}\,.
$$
By the triangle inequality, we also have
$$
    \left|\int_\alpha^\beta g(x) e^{-inx} \, \mathrm{d}x\right| \le |\beta -\alpha| \sup_{x \in [\alpha,\beta]} |g(x)| \le |\beta-\alpha| \|g\|_{\mathrm{Lip}(\alpha,\beta)}\,.
$$
This completes the proof of the lemma, using that
$$
    \min\{|\beta-\alpha|, \frac{\pi}{n}\} \le 2 \pi |\beta-\alpha|(1 + n|\beta-\alpha|)^{-1}\,.
$$





\section{Partial sums as orthogonal projections}
\label{10projection}

This subsection proves Lemma \ref{spectral projection bound}






\begin{lemma}[partial sum projection]
\label{partial sum projection}
  Let $f$ be a bounded $2\pi$-periodic measurable function. Then, for all $N\ge 0$
   \begin{equation}\label{projection}
   S_N(S_N f)=S_Nf\, .
   \end{equation}
   \end{lemma}
\begin{proof}
Let $N>0$ be given. With $K_N$ as in Lemma \ref{dirichlet kernel},
\begin{equation*}
S_N (S_Nf) (x)=
\int_0^{2\pi} S_Nf(y)K_N(x-y)\, dy
\end{equation*}
\begin{equation}\label{eqhil1}
=
\int_0^{2\pi} \int_0^{2\pi} f(y')K_N(y-y') K_N(x-y)\, \, dy' dy\, .
\end{equation}
We have by Lemma \ref{dirichlet kernel}
\begin{equation*}
\int_0^{2\pi} K_N(y-y') K_N(x-y)\,  dy
\end{equation*}
\begin{equation*}
=\sum_{n=-N}^N\sum_{n'=-N}^N
\int_0^{2\pi} e^{in(y-y')}e^{in'(x-y)}\,  dy
\end{equation*}
\begin{equation}\label{eqhil6}
=\sum_{n=-N}^N\sum_{n'=-N}^N
e^{i(n'x-ny')}\int_0^{2\pi} e^{i(n-n')y}\,  dy\, .
\end{equation}
By Lemma \ref{mean zero oscillation}, the summands for $n\neq n'$ vanish.
We obtain for \eqref{eqhil6}
\begin{equation}\label{eqhil2}
=\sum_{n=-N}^N
e^{in(x-y')}\int_0^{2\pi} \,  dy=K_N(x-y')\, .
\end{equation}
Applying Fubini in  \eqref{eqhil1} and using
\eqref{eqhil2} gives
\begin{equation}
S_N(S_Nf)(x)=
\int_0^{2\pi}  f(y')K(x-y')  \, dy'=S_N f(x)
\end{equation}
This proves the lemma.
\end{proof}
\begin{lemma}[partial sum selfadjoint]
\label{partial sum selfadjoint}
\uses{dirichlet kernel}
    We have for any $2\pi$-periodic bounded measurable $g,f$ that
    \begin{equation}
       \int_0^{2\pi} \overline{S_Nf(x)} g(x)=\int_0^{2\pi} \overline{f(x)} S_Ng(x)\, dx\, .
    \end{equation}
\end{lemma}
\begin{proof}
  We have with $K_N$ as in Lemma \ref{dirichlet kernel} for every $x$
  \begin{equation}
      \overline{K_N(x)}=\sum_{n=-N}^N\overline{ e^{in x}}=
      {\sum_{n=-N}^N e^{-in x}}=K_N(-x)\, .
  \end{equation}
 Further, with Lemma \ref{dirichlet kernel} and Fubini
\begin{equation*}
\int_0^{2\pi} \overline{S_Nf(x)} g(x)
= \frac 1{2\pi} \int_0^{2\pi} \int_{-\pi}^{\pi}\overline{f(y) K_N(x-y)} g(x)\, dy dx
 \end{equation*}
 \begin{equation}
=
\frac 1{2\pi} \int_0^{2\pi} \int_{-\pi}^{\pi}\overline{f(y)} K_N(y-x)
g(x)\, dx dy
=\int_0^{2\pi} \overline{f(x)} S_Ng(x)\, dx
\, .
\end{equation}
 This proves the lemma.
\end{proof}


We turn to the proof of Lemma
\ref{spectral projection bound}.

We have with Lemma \ref{partial sum selfadjoint}, then Lemma \ref{partial sum projection} and the Lemma \ref{partial sum selfadjoint} again
\begin{equation*}
 \int_0^{2\pi}  S_Nf(x)\overline{S_Nf(x)}\, dx
 \int_0^{2\pi}  f(x)\overline{S_N(S_Nf)(x)}\, dx
\end{equation*}
\begin{equation}\label{eqhil7}
 =\int_0^{2\pi}  f(x)\overline{S_Nf(x)}\, dx=
 \int_0^{2\pi}  S_N f(x)\overline{f(x)}\, dx\, .
\end{equation}

We have by the distributive law
\begin{equation}\label{diffnorm}
    \int_0^{2\pi} (f(x)-S_Nf(x))(\overline{f(x)-S_Nf(x)})\, dx=
\end{equation}
\begin{equation*}
 \int_0^{2\pi} f(x)\overline{f(x)}
    -S_Nf(x)\overline{f(x)}
   -f(x)\overline{S_Nf(x)}
     + S_Nf(x)\overline{S_Nf(x)}\, dx
\end{equation*}
Using the various identities expressed in \eqref{eqhil7}, this becomes
\begin{equation}
 =\int_0^{2\pi} f(x)\overline{f(x)}\, dx
    -
   \int_0^{2\pi} S_Nf(x)\overline{S_Nf(x)}\, dx\, .
\end{equation}
As \eqref{diffnorm} has nonnegative integrand and is thus nonnegative, we conclude
\begin{equation}
  \int_0^{2\pi} S_Nf(x)\overline{S_Nf(x)}\, dx\le
 \int_0^{2\pi} f(x)\overline{f(x)})\, dx\, .
\end{equation}
As both sides are positive, we may take the square root of this inequality.
This completes the proof of the lemma.














\section{The error bound}
\label{10difference}
We prove Lemma \ref{control approximation effect}. Define
$$
    E_2 := \{x \in [0, 2\pi) \ : \ \sup_{N > 0} |S_N f(x) - S_N f_0(x)| > \frac{\epsilon}{4} \}\,.
$$
Then \eqref{eq max partial sum diff} clearly holds, and it remains to show that $|E_2| \le \frac{\epsilon}{2}$. This will follow from Lemma \ref{real Carleson}.

Let $x \in E_2$. Then there exists $N > 0$ with
$$
    |S_N f(x) - S_N f_0(x)| > \frac{\epsilon}{4}\,,
$$
pick such $N$. We have with Lemma \ref{dirichlet kernel}
$$
    \frac{\epsilon}{4} < |S_N f(x) - S_N f_0(x)| = \frac{1}{2\pi} \left| \int_0^{2\pi} (f(y) - f_0(y)) K_N(x-y) \, dy\right|\,.
$$
We make a change of variables, replacing $y$ by $x -y$. Then we use $2\pi$-periodicity of $f$, $f_0$ and $K_N$ to shift the domain of integration to obtain
$$
    = \frac{1}{2\pi} \left|\int_{-\pi}^{\pi} (f(x-y) - f_0(x-y)) K_N(y) \, dy\right|\,.
$$
Using the triangle inequality, we split this as
$$
    \le \frac{1}{2\pi} \left|\int_{-\pi}^{\pi} (f(x-y) - f_0(x-y)) \max(1 - |y|, 0) K_N(y) \, dy\right|
$$
$$
    + \frac{1}{2\pi} \left|\int_{-\pi}^{\pi} (f(x-y) - f_0(x-y)) \min(|y|, 1) K_N(y) \, dy\right|\,.
$$
Note that all integrals are well defined, since $K_N$ is by \eqref{eqksumexp} bounded by $2N+1$.
Using \eqref{eqksumhil} and the definition \eqref{eq hilker} of $k$, we rewrite the two terms and obtain
\begin{equation}
    \label{eq diff singular}
    \frac{\epsilon}{4} < \frac{1}{2\pi} \left| \int_{-\pi}^{\pi} (f(x-y) - f_0(x-y)) (e^{iNy} \overline{k}(y) + e^{-iNy}k(y)) \, dy\right|
\end{equation}
\begin{equation}
    \label{eq diff integrable}
    + \frac{1}{2\pi} \left|\int_{-\pi}^{\pi} (f(x-y) - f_0(x-y)) ( e^{iNy} \frac{\min\{|y|, 1\} }{1 - e^{-iy}} + e^{-iNy} \frac{\min\{|y|, 1\} }{1 - e^{iy}}) \, dy \right|\,.
\end{equation}
By Lemma \ref{lower secant bound} with $\eta = |y|$, we have for $-1 \le y \le 1$
$$
    |e^{iNy}\frac{\min\{|y|, 1\} }{1 - e^{-iy}}| = \frac{|y|}{|1 - e^{iy}|} \le 8\,.
$$
By Lemma \ref{lower secant bound} with $\eta = 1$, we have for $1 \le |y| \le \pi$
$$
    |e^{iNy}\frac{\min\{|y|, 1\} }{1 - e^{-iy}}| = \frac{1}{|1 - e^{iy}|} \le 8\,.
$$
Thus we obtain using the triangle inequality and  \eqref{eq ffzero}
$$
    \eqref{eq diff integrable} \le \frac{16}{2\pi} \int_{-\pi}^{\pi} |f(x-y) - f_0(x-y)| \, dy \le 2^{4-2^{50}} \epsilon^2\,.
$$
Consequently, we have that
$$
    \frac{\epsilon}{8} \le \frac{1}{2\pi} \left| \int_{-\pi}^{\pi} (f(x-y) - f_0(x-y)) (e^{iNy} \overline{k}(y) + e^{-iNy}k(y)) \, dy\right|\,.
$$
By dominated convergence and since $k(y) = 0$ for $|y| > 1$, this equals
$$
     = \frac{1}{2\pi} \lim_{r \to 0^+} \left| \int_{r < |y| < 1} (f(x-y) - f_0(x-y)) (e^{iNy} \overline{k}(y) + e^{-iNy}k(y)) \, dy\right|\,.
$$
Let $h = (f - f_0) \mathbf{1}_{[-\pi, 3\pi]}$. Since $x \in [0, 2\pi]$, the above integral does not change if we replace $(f - f_0)$ by $h$. We do that, apply the triangle inequality and bound the limits by suprema
$$
    \le \frac{1}{2\pi} \sup_{r > 0} \left| \int_{r < |y| < 1} h(x-y) e^{-iNy} k(y) \, dy\right|
$$
$$
    + \frac{1}{2\pi} \sup_{r > 0} \left| \int_{r < |y| < 1} \overline{h}(x-y) e^{-iNy} k(y) \, dy\right|\,.
$$
By the definition \eqref{define T carleson} of $T$, this is
$$
    \le \frac{1}{2\pi} (Th(x) + T\bar{h}(x))\,.
$$
Thus for each $x \in E_2$, at least one of $Th(x)$ and $T\bar h(x)$ is larger than $\frac{\epsilon}{16}$.
Thus at least one of $Th$ and $T\bar h$ is $\ge \frac{\epsilon}{16}$ on a subset $E_2'$ of $E_2$ with $2|E_2'| \ge |E_2|$. Without loss of generality this is $Th$. By assumption \eqref{eq ffzero}, we have $|2^{2^{50}}\epsilon^{-2} h| \le \mathbf{1}_{[-\pi, 3\pi]}$. Applying Lemma \ref{real Carleson} with $F = [-\pi, 3\pi]$ and $G = E_2'$, it follows that
$$
    \frac{\epsilon}{16} |E_2'| \le \int_{E_2'} Th(x) \, dx = 2^{-2^{50}}\epsilon^2 \int_{E_2'} T(2^{2^{50}}\epsilon^{-2} h)(x) \, dx
$$
$$
    \le 2^{-2^{50}}  \epsilon^2 \cdot 2^{2^{40}}  |F|^{\frac{1}{2}} |E_2'|^{\frac{1}{2}} \le  2^{-2^{40}} \frac{\epsilon^2}{16} |E_2'|^{\frac{1}{2}}\,.
$$
Rearranging, we obtain
$$
    |E_2'| \le 2^{-2^{41}}\epsilon^2 \le \frac{\epsilon}{4}\,.
$$
This completes the proof using $|E_2| \le 2|E_2'|$.





\section{Carleson on the real line}
\label{10carleson}

We prove Lemma \ref{real Carleson}.

Consider the standard distance function
\begin{equation}
    \rho(x,y)=|x-y|
\end{equation}
on the real line $\R$.
\begin{lemma}[real line metric]
\label{real line metric}
The space $(\R,\rho)$ is a complete locally compact metric space.
\end{lemma}
\begin{proof}
    This is part of the Lean library.
\end{proof}
\begin{lemma}
\label{real line ball}
    \lean{Real.ball_eq_Ioo}
    \leanok
    For $x\in R$ and $R>0$, the ball $B(x,R)$ is the interval $(x-R,x+R)$
\end{lemma}
\begin{proof}
\leanok
Let $x'\in B(x,R)$. By definition of the ball,
$|x'-x|<R$. It follows that $x'-x<R$ and $x-x'<R$.
It follows $x'<x+R$ and $x'>x-R$. This implies
$x'\in (x-R,x+R)$.
Conversely, let $x'\in (x-R,x+R)$. Then
$x'<x+R$ and $x'>x-R$. It follows that
$x'-x<R$ and $x-x'<R$. It follows that $|x'-x|<R$,
hence $x'\in B(x,R)$.
This proves the lemma.
\end{proof}
We consider the Lebesgue measure $\mu$ on $\R$.
\begin{lemma}[real line measure]
\label{real line measure}
    The measure $\mu$ is a sigma-finite non-zero
    Radon-Borel measure on $\R$.
\end{lemma}
\begin{proof}
    This is part of the Lean library.
\end{proof}
\begin{lemma}[real line ball measure]
\label{real line ball measure}
\uses{real line ball}
    \lean{Real.volume_ball}
    \leanok
    We have for every $x\in \R$ and $R>0$
    \begin{equation}
        \mu(B(x,R))=2R\, .
    \end{equation}
\end{lemma}
\begin{proof}
\leanok
We have with Lemma \ref{real line ball}
\begin{equation}
    \mu(B(x,R))=\mu((x-R,x+R))=2R\, .
\end{equation}
\end{proof}

\begin{lemma}[real line doubling]
\label{real line doubling}
    We have for every $x\in \R$ and $R>0$
    \begin{equation}
        \mu(B(x,2R))=2\mu(B(x,R))\, .
    \end{equation}
\end{lemma}
\begin{proof}
    We have with Lemma \ref{real line ball measure}
\begin{equation}
    \mu(B(x,2R)=4R=2\mu(B(x,R)\, .
\end{equation}
This proves the lemma.
\end{proof}


The preceding four lemmas show that $(\R, \rho, \mu, 4)$ is a doubling metric measure space. Indeed, we even show
that $(\R, \rho, \mu, 1)$ is a doubling metric measure space, but we may relax the estimate in Lemma \ref{real line doubling} to conclude that $(\R, \rho, \mu, 4)$
is a doubling metric measure space.


For each $n\in \mathbb{Z}$ define
$\mfa_n:\R\to \R$ by
\begin{equation}
    \mfa_n(x)=nx\, .
\end{equation}


Let $\Mf$ be the collection $\{\mfa_n, n\in \mathbb{Z}\}$.
Note that for every $n\in \mathbb{Z}$ we have $\mfa_n(0)=0$.
Define $d_E$ as in \eqref{definedE}. Note that
for
$n,m\in \mathbb{Z}$ and $x\in \R$ and $x>0$
we have

\begin{equation}
    d_{B(x,R)}(\mfa_n,\mfa_m)=\sup_{y,y'\in B(x,R)}|ny-ny'-my+my'|
\end{equation}
\begin{equation}\label{eqcarl1}
       =\sup_{y,y'\in B(x,R)}|(n-m)(y-x)-(n-m)(y'-x)|
 \end{equation}
By the triangle inequality, we have for \eqref{eqcarl1} the upper bound
\begin{equation}\label{eqcarl2}
       \le 2|n-m|R\, .
 \end{equation}
On the other hand, for any $0<R'<R$, we have
by choosing suitable $y,y'\in \{x-R', x+R'\}$,
we have for \eqref{eqcarl1} the lower bound
\begin{equation}\label{eqcarl3}
       \ge 2|n-m|R'\, .
 \end{equation}
As $R'<R$ is arbitrary, we have with \eqref{eqcarl2}
and \eqref{eqcarl3}
\begin{equation}\label{eqcarl4}
    d_{B(x,R)}(\mfa_n,\mfa_m)=2R|n-m|\, .
\end{equation}



\begin{lemma}[frequency ball doubling]
\label{frequency ball doubling}
  For any $x,x'\in \R$ and $R>0$ with
   $x\in B(x',2R)$  and any $n,m\in \mathbb{Z}$, we have
\begin{equation}\label{firstdb1}
    d_{B(x',2R)}(\mfa_n,\mfa_m)\le 2 d_{B(x,R)}(\mfa_n,\mfa_m) \, .
\end{equation}
\end{lemma}
\begin{proof}
With \eqref{eqcarl4}, both sides of \eqref{firstdb1} are equal to $4R|n-m|$. This proves the lemma.
\end{proof}

\begin{lemma}[frequency ball growth]
\label{frequency ball growth}
    For any $x,x'\in \R$ and $R>0$ with
   $B(x,R)\subset B(x',2R)$  and any $n,m\in \mathbb{Z}$, we have
\begin{equation}\label{seconddb1}
    2d_{B(x,R)}(\mfa_n,\mfa_m)\le  d_{B(x',2R)}(\mfa_n,\mfa_m) \, .
\end{equation}
\end{lemma}
\begin{proof}
With \eqref{eqcarl4}, both sides of \eqref{firstdb1} are equal to $4R|n-m|$. This proves the lemma.
\end{proof}

\begin{lemma}[frequency ball cover]
\label{frequency ball cover}
    For every $x\in \R$ and $R>0$ and every
    $n\in \mathbb{Z}$ and $R'>0$,
    there exist $m_1, m_2, m_3\in \mathbb{Z}$
    such that
    \begin{equation}\label{eqcarl5}
        B'\subset B_1\cup B_2\cup B_3\, ,
    \end{equation}
where
\begin{equation}
B'=     \{ \mfa \in \Mf: d_{B(x,R)}(\mfa, \mfa_n)<2R'\}
\end{equation}
and for $j=1,2,3$
\begin{equation}
  B_j=
     \{ \mfa \in \Mf: d_{B(x,R)}(\mfa, \mfa_{m_j})<R'\}
     \, .
\end{equation}

\end{lemma}
\begin{proof}
Let $m_1$ be the largest integer smaller than
or equal to
$n-R'/2$.
Let $m_2=n$.
Let $m_3$ be the smallest integer larger than
or equal to $n+R'/2$.

Let $\mfa_{n'}\in B'$, then with \eqref{eqcarl4},
we have
\begin{equation}\label{eqcarl6}
    2R|n-n'|< 2R'\, .
\end{equation}

Assume first $n'\le n-R'/2$. By definition of $m_1$,
we have $n'\le m_1$.  With \eqref{eqcarl6}
we have
\begin{equation*}
    R|m_1-n'|=R(m_1-n')=R(m_1-n)+R(n-n')
\end{equation*}
\begin{equation}
    < -\frac{R'}2+R'=-\frac{R'}2\, .
\end{equation}
We conclude $\mfa_{n'}\in B_1$.

Assume next  $n-R'/2<n'<n+R'/2$. Then
$\mfa_{n'}\in B_2$.

Assume finally that $n+R'/2\le n'$
By definition of $m_3$,
we have $m_3\le n'$.  With \eqref{eqcarl6}
we have
\begin{equation*}
    R|m_3-n'|=R(n'-m_3)=R(n'-n)+R(n-m_3)
\end{equation*}
\begin{equation}
    < R' -\frac{R'}2=-\frac{R'}2\, .
\end{equation}
We conclude $\mfa_{n'}\in B_1$.
This completes the proof of the lemma.
\end{proof}


\begin{lemma}[real van der Corput]
\label{real van der Corput}
\uses{van der Corput}
    For any $x\in \R$ and $R>0$ and any
    function $\varphi: X\to \C$ supported on $B'=B(x,R)$
    such that
\begin{equation}
    \|\varphi\|_{\Lip(B')} = \sup_{x \in B'} |\varphi(x)| + R \sup_{x,y \in B', x \neq y} \frac{|\varphi(x) - \varphi(y)|}{\rho(x,y)}
\end{equation}
is finite and for any $n,m\in \mathbb{Z}$, we have
\begin{equation}
    \label{eq vdc cond1}
    \left|\int_{B'} e(\mfa_n(x)-{\mfa_m(x)}) \varphi(x) d\mu(x)\right|\le 2\pi \mu(B')\frac{\|\varphi\|_{\Lip(B')}}{1+d_{B'}(\mfa_n,\mfa_m)}
\, .
\end{equation}


\end{lemma}
\begin{proof}
Set $n'=n-m$. Then we have to prove
\begin{equation}
    \label{eq vdc cond2}
    \left|\int_{x-R}^{x+R} e^{in'y}\varphi(y) dy\right|\le 4\pi  R\|\varphi\|_{\Lip(B')}
(1+2R|n'|)^{-1}\, .
\end{equation}
This follows from Lemma \ref{van der Corput} with $\alpha = x - R$ and $\beta = x + 2R$.
%We do a case distinction whether $Rn'\le \pi$
%or $Rn'> \pi$.
%Assume first  $Rn'\le \pi$. We estimate the left-hand side  of \eqref{eq vdc cond2} by
%\begin{equation}
%    2R\sup_{y\in B'}|\varphi(y)|\le 2^4R\|\varphi\|_{\Lip(B)}(1+2R|n'|)^{-1}\, .
%\end{equation}
%This proves \eqref{eq vdc cond2} in this case.
%
%Assume now $Rn'> \pi$.
%We write
%\begin{equation}\label{eqcarl10}
%    2\int_{x-R}^{x+R} e^{in'y}\varphi(y) dy
%\end{equation}
%\begin{equation*}
%=\int_{x-R}^{x-R+\pi/n'} e^{in'y}\varphi(y) dy
%+\int_{x-R+\pi/n'}^{x+R} e^{in'y}\varphi(y) dy
%\end{equation*}
%\begin{equation*}
%+\int_{x-R}^{x+R-\pi/n'} e^{in'y}\varphi(y) dy
%+\int_{x+R-\pi/n'}^{x+R} e^{in'y}\varphi(y) dy\, .
%\end{equation*}
%We estimate the sum of the second and third term
%on the right-hand side of  \eqref{eqcarl10} using variable substitution and $e^{i\pi}=-1$ by
%\begin{equation*}
%    \left|\int_{x-R+\pi/n'}^{x+R} e^{in'y}\varphi(y) dy
%    +\int_{x-R}^{x+R-\pi/n'} e^{in'y}\varphi(y) dy\right|
%\end{equation*}
%\begin{equation*}
%    =\left|\int_{x-R}^{x+R-\pi/n' }e^{in'(y+\pi/n')}\varphi(y+\pi/n')
%    + e^{in'y}\varphi(y) dy\right|
%\end{equation*}
%\begin{equation*}
%    =\left|\int_{x-R}^{x+R-\pi/n' }e^{in'y}(-\varphi(y+\pi/n')
%    + \varphi(y)) dy\right|
%\end{equation*}
%\begin{equation*}
%    \le 2R\sup_{y\in (x-R,x+R-\pi/n')}
%    |\varphi(y+\pi/n')
%    - \varphi(y)|
%\end{equation*}
%\begin{equation*}
%    \le 2R \|\varphi\|_{Lip(B')}\frac{\pi}{Rn'}
%\end{equation*}
%\begin{equation}\label{eqcarl21}
%    \le 2^5 R \|\varphi\|_{Lip(B')}\frac{1}{(1+2Rn')},
%\end{equation}
%where in the last line we have used $Rn'\ge \pi$.
%We estimate the first and fourth term on the right %hand side of \eqref{eqcarl10} by
%\begin{equation*}
%    \left|\int_{x-R'}^{x-R+\pi/n'} e^{in'y}\varphi(y) %dy
%    +\int_{x+R-\pi/n'}^{x+R} e^{in'y}\varphi(y) dy\right|
%\end{equation*}
%\begin{equation}\label{eqcarl22}
%    \le \frac{2\pi}{n'}\sup_{y\in B'}|\varphi(y)|
%     \le 2^4 R\|\varphi(y)\|_{Lip(B')}\frac 1 %{1+Rn'}\, ,
%\end{equation}
%where in the last line we have used $Rn'\ge \pi$.
%Adding \eqref{eqcarl21} and \eqref{eqcarl22}
%with the triangle inequality proves \eqref{eq vdc cond2} in the given case and completes the proof of the lemma.
\end{proof}

The preceding three lemmas establish that $\Mf$ is a cancellative, compatible collection of functions on $(\R, \rho, \mu, 4)$. Again, some of the statements in these lemmas
are stronger than what is needed for $a=4$, but can be relaxed to give the desired conclusion for $a=4$.




With $\kappa$ as near \eqref{eq hilker}, define
the function $K:\R\times \R\to \mathbb{C}$ by
\begin{equation}
    K(x,y):=\kappa(x-y)\, .
\end{equation}
The function $K$ is continuous outside the diagonal
$x=y$ and vanishes on the diagonal. Hence it is measurable.

\begin{lemma}[Hilbert kernel bound]
\label{Hilbert kernel bound}
    For $x,y\in \R$ with $x\neq y$ we have
    \begin{equation}\label{eqcarl30}
        |K(x,y)|\le 2^4(2|x-y|)^{-1}\, .
    \end{equation}
\end{lemma}
\begin{proof}
    Fix $x\neq y$. If $K(x,y)$ is zero, then \eqref{eqcarl30} is evident. Assume $K(x,y)$ is not zero, then $0<|x-y|<1$.
    We have
\begin{equation}\label{eqcarl31}
|K(x,y)|=|\kappa(x-y)|=\left|\frac {1-|x-y|}{1-e^{i(x-y)}}\right|\, .
\end{equation}
We estimate
with Lemma \ref{lower secant bound}
\begin{equation}\label{eqcarl311}
|K(x,y)|\le \frac {1}{|1-e^{i(x-y)}|}\le \frac 8{|x-y|}\, .
\end{equation}
This proves \eqref{eqcarl30} in the given case and completes the proof of the lemma.
\end{proof}

\begin{lemma}[Hilbert kernel regularity]
\label{Hilbert kernel regularity}
\uses{lower secant bound}
    For $x,y,y'\in \R$ with $x\neq y,y'$ and
    \begin{equation}
        \label{eq close hoelder}
        2|y-y'|\le |x-y|\, ,
    \end{equation}
    we have
    \begin{equation}\label{eqcarl301}
        |K(x,y) - K(x, y')|\le 2^{10}\frac{1}{|x-y|} \frac{|y-y'|}{|x-y|}\, .
    \end{equation}
\end{lemma}

\begin{proof}
    Since $K(x,y) = k(x-y) = K(0, y-x)$ we can assume that $x = 0$. Then the assumption \eqref{eq close hoelder} implies that $y$ and $y'$ have the same sign. Since $K(0,y) = k(y) = \bar k(-y) = \bar K(0, -y)$ we can assume that they are both positive. Then it follows from \eqref{eq close hoelder} that
    $$
        \frac{y}{2} \le y' \,.
    $$
    We distinguish four cases. If $y, y' \le 1$, then we have
    $$
        |K(0,y) - K(0,y')| = \left|  \frac{1 - y}{1- e^{-iy}} - \frac{1 - y'}{1- e^{-iy'}}\right|
    $$
    and by the fundamental theorem of calculus
    $$
        = \left| \int_{y'}^{y} \frac{-1 + e^{-it} + i(1-t)e^{it}}{(1 - e^{-it})^2} \,dt \right|\,.
    $$
    Using $y' \ge \frac{y}{2}$ and Lemma \ref{lower secant bound}, we bound this by
    $$
        \le |y - y'| \sup_{\frac{y}{2} \le t \le 1} \frac{3}{|1 - e^{-it}|^2}  \le 3 |y-y'| (8 \frac{2}{y})^2 \le 2^{10} \frac{|y-y'|}{|y|^2}\,.
    $$
    If $y \le 1$ and $y' > 1$, then $K(0, y') = 0$ and we have from the first case
    $$
        |K(0,y) - K(0,y')| = |K(0,y) - K(0,1)| \le 2^{10} \frac{|y-1|}{|y|^2} \le 2^{10} \frac{|y-y'|}{|y|^2}\,.
    $$
    Similarly, if $y > 1$ and $y' \le 1$, then $K(0, y) = 0$ and we have by the same computation as for the first case
    $$
        |K(0,y) - K(0,y')| = |K(0,y') - K(0,1)| \le 2^{10} \frac{|y-1|}{|y|^2} \le 2^{10} \frac{|y-y'|}{|y|^2}\,.
    $$
    Finally, if $y, y' > 1$ then
    $$
        |K(0,y) - K(0,y')| = 0 \le 2^{10} \frac{|y-y'|}{|y|^2}\,.
    $$
\end{proof}

By the previous two lemmas, $K$ is a one-sided Calder\'on--Zygmund kernel on $(\R,\rho,\mu,4)$.


The operator $T^*$ defined in \eqref{def tang unm op} coincides in our setting with the operator $T^*$ defined in \eqref{concretetstar}. By  Lemma \ref{lem hilbert}, this operator satisfies the bound \eqref{nontanbound}.

Thus the assumptions of Theorem \ref{metric space Carleson} are all satisfied. Applying the Theorem, Lemma \ref{real Carleson} follows.

\printbibliography
