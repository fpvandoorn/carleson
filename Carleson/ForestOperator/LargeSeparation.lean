import Carleson.ForestOperator.AlmostOrthogonality

open ShortVariables TileStructure
variable {X : Type*} {a : â„•} {q : â„} {K : X â†’ X â†’ â„‚} {Ïƒâ‚ Ïƒâ‚‚ : X â†’ â„¤} {F G : Set X}
  [MetricSpace X] [ProofData a q K Ïƒâ‚ Ïƒâ‚‚ F G] [TileStructure Q D Îº S o]
  {n j j' : â„•} {t : Forest X n} {u uâ‚ uâ‚‚ p : ð”“ X} {x x' : X} {ð”– : Set (ð”“ X)}
  {f fâ‚ fâ‚‚ g gâ‚ gâ‚‚ : X â†’ â„‚} {I J J' L : Grid X}
variable {E' : Type*} [NormedAddCommGroup E'] [NormedSpace â„ E']

noncomputable section

open Set MeasureTheory Metric Function Complex Bornology TileStructure Classical Filter
open scoped NNReal ENNReal ComplexConjugate

namespace TileStructure.Forest

/-! ## Section 7.5 -/

variable (t uâ‚ uâ‚‚) in
/-- The definition `ð“™'` at the start of Section 7.5.1.
We use a different notation to distinguish it from the ð“™' used in Section 7.6 -/
def ð“™â‚… : Set (Grid X) := ð“™ (ð”–â‚€ t uâ‚ uâ‚‚) âˆ© Iic (ð“˜ uâ‚)

/-- The definition of Ï‡-tilde, defined in the proof of Lemma 7.5.2 -/
def Ï‡tilde (J : Grid X) (x : X) : â„â‰¥0 :=
  8 - D ^ (- s J) * dist x (c J) |>.toNNReal

variable (t uâ‚ uâ‚‚) in
/-- The definition of Ï‡, defined in the proof of Lemma 7.5.2 -/
def Ï‡ (J : Grid X) (x : X) : â„â‰¥0 :=
  Ï‡tilde J x / âˆ‘ J' âˆˆ { I | I âˆˆ ð“™â‚… t uâ‚ uâ‚‚ }, Ï‡tilde J' x

-- /-- The definition of `B`, defined in (7.5.1) -/
-- protected def _root_.Grid.ball (I : Grid X) : Set X := ball (c I) (8 * D ^ s I)

variable (t uâ‚ uâ‚‚) in
/-- The definition of h_J, defined in the proof of Section 7.5.2 -/
def holderFunction (fâ‚ fâ‚‚ : X â†’ â„‚)  (J : Grid X) (x : X) : â„‚ :=
  Ï‡ t uâ‚ uâ‚‚ J x * (exp (.I * ð’¬ uâ‚ x) * adjointCarlesonSum (t uâ‚) fâ‚ x) *
  conj (exp (.I * ð’¬ uâ‚‚ x) * adjointCarlesonSum (t uâ‚‚ âˆ© ð”–â‚€ t uâ‚ uâ‚‚) fâ‚‚ x)

/-! ### Subsection 7.5.1 and Lemma 7.5.2 -/

/-- Part of Lemma 7.5.1. -/
lemma union_ð“™â‚… (huâ‚ : uâ‚ âˆˆ t) (huâ‚‚ : uâ‚‚ âˆˆ t) (hu : uâ‚ â‰  uâ‚‚)
    (h2u : ð“˜ uâ‚ â‰¤ ð“˜ uâ‚‚) :
    â‹ƒ J âˆˆ ð“™â‚… t uâ‚ uâ‚‚, (J : Set X) = ð“˜ uâ‚ := by
  sorry

/-- Part of Lemma 7.5.1. -/
lemma pairwiseDisjoint_ð“™â‚… (huâ‚ : uâ‚ âˆˆ t) (huâ‚‚ : uâ‚‚ âˆˆ t) (hu : uâ‚ â‰  uâ‚‚)
    (h2u : ð“˜ uâ‚ â‰¤ ð“˜ uâ‚‚) :
    (ð“™â‚… t uâ‚ uâ‚‚).PairwiseDisjoint (fun I â†¦ (I : Set X)) := by
  sorry

/-- Lemma 7.5.3 (stated somewhat differently). -/
lemma moderate_scale_change (huâ‚ : uâ‚ âˆˆ t) (huâ‚‚ : uâ‚‚ âˆˆ t) (hu : uâ‚ â‰  uâ‚‚)
    (h2u : ð“˜ uâ‚ â‰¤ ð“˜ uâ‚‚) (hJ : J âˆˆ ð“™â‚… t uâ‚ uâ‚‚) (hJ' : J' âˆˆ ð“™â‚… t uâ‚ uâ‚‚)
  (h : Â¬ Disjoint (J : Set X) J') : s J + 1 â‰¤ s J' := by
  sorry

/-- The constant used in `dist_Ï‡_Ï‡_le`.
Has value `2 ^ (226 * a ^ 3)` in the blueprint. -/
-- Todo: define this recursively in terms of previous constants
irreducible_def C7_5_2 (a : â„•) : â„â‰¥0 := 2 ^ (226 * (a : â„) ^ 3)

/-- Part of Lemma 7.5.2. -/
lemma sum_Ï‡ (huâ‚ : uâ‚ âˆˆ t) (huâ‚‚ : uâ‚‚ âˆˆ t) (hu : uâ‚ â‰  uâ‚‚)
    (h2u : ð“˜ uâ‚ â‰¤ ð“˜ uâ‚‚) (x : X) :
    âˆ‘ J âˆˆ { I | I âˆˆ ð“™â‚… t uâ‚ uâ‚‚ }, Ï‡ t uâ‚ uâ‚‚ J x = (ð“˜ uâ‚ : Set X).indicator 1 x := by
  sorry

/-- Part of Lemma 7.5.2. -/
lemma Ï‡_mem_Icc (huâ‚ : uâ‚ âˆˆ t) (huâ‚‚ : uâ‚‚ âˆˆ t) (hu : uâ‚ â‰  uâ‚‚)
    (h2u : ð“˜ uâ‚ â‰¤ ð“˜ uâ‚‚) (hJ : J âˆˆ ð“™â‚… t uâ‚ uâ‚‚) (hx : x âˆˆ ð“˜ uâ‚) :
    Ï‡ t uâ‚ uâ‚‚ J x âˆˆ Icc 0 ((ball (c I) (8 * D ^ s I)).indicator 1 x) := by
  sorry

/-- Part of Lemma 7.5.2. -/
lemma dist_Ï‡_Ï‡_le (huâ‚ : uâ‚ âˆˆ t) (huâ‚‚ : uâ‚‚ âˆˆ t) (hu : uâ‚ â‰  uâ‚‚)
    (h2u : ð“˜ uâ‚ â‰¤ ð“˜ uâ‚‚) (hJ : J âˆˆ ð“™â‚… t uâ‚ uâ‚‚) (hx : x âˆˆ ð“˜ uâ‚) (hx' : x' âˆˆ ð“˜ uâ‚) :
    dist (Ï‡ t uâ‚ uâ‚‚ J x) (Ï‡ t uâ‚ uâ‚‚ J x) â‰¤ C7_5_2 a * dist x x' / D ^ s J := by
  sorry


/-! ### Subsection 7.5.2 and Lemma 7.5.4 -/

/-- The constant used in `holder_correlation_tile`.
Has value `2 ^ (151 * a ^ 3)` in the blueprint. -/
-- Todo: define this recursively in terms of previous constants
irreducible_def C7_5_5 (a : â„•) : â„â‰¥0 := 2 ^ (151 * (a : â„) ^ 3)

/-- Lemma 7.5.5. -/
lemma holder_correlation_tile (hu : u âˆˆ t) (hp : p âˆˆ t u)
    (hf : IsBounded (range f)) (h2f : HasCompactSupport f) (h3f : AEStronglyMeasurable f) :
    nndist (exp (.I * ð’¬ u x) * adjointCarleson p f x)
      (exp (.I * ð’¬ u x') * adjointCarleson p f x') â‰¤
    C7_5_5 a / volume (ball (ð”  p) (4 * D ^ ð”° p)) *
    (nndist x x' / D ^ (ð”° p : â„)) ^ (a : â„)â»Â¹ * âˆ«â» x in E p, â€–f xâ€–â‚Š := by
  sorry

/-- Lemma 7.5.6. -/
lemma limited_scale_impact (huâ‚ : uâ‚ âˆˆ t) (huâ‚‚ : uâ‚‚ âˆˆ t) (hu : uâ‚ â‰  uâ‚‚)
    (h2u : ð“˜ uâ‚ â‰¤ ð“˜ uâ‚‚) (hp : p âˆˆ t uâ‚‚ \ ð”–â‚€ t uâ‚ uâ‚‚) (hJ : J âˆˆ ð“™â‚… t uâ‚ uâ‚‚)
    (h : Â¬ Disjoint (ball (ð”  p) (8 * D ^ ð”° p)) (ball (c J) (8â»Â¹ * D ^ s J))) :
    ð”° p âˆˆ Icc (s J) (s J + 3) := by
  sorry

/-- The constant used in `local_tree_control`.
Has value `2 ^ (104 * a ^ 3)` in the blueprint. -/
-- Todo: define this recursively in terms of previous constants
irreducible_def C7_5_7 (a : â„•) : â„â‰¥0 := 2 ^ (104 * (a : â„) ^ 3)

/-- Lemma 7.5.7. -/
lemma local_tree_control (huâ‚ : uâ‚ âˆˆ t) (huâ‚‚ : uâ‚‚ âˆˆ t) (hu : uâ‚ â‰  uâ‚‚)
    (h2u : ð“˜ uâ‚ â‰¤ ð“˜ uâ‚‚) (hJ : J âˆˆ ð“™â‚… t uâ‚ uâ‚‚)
    (hf : IsBounded (range f)) (h2f : HasCompactSupport f) (h3f : AEStronglyMeasurable f) :
    â¨† x âˆˆ ball (c J) (8â»Â¹ * D ^ s J), â€–adjointCarlesonSum (t uâ‚‚ \ ð”–â‚€ t uâ‚ uâ‚‚) f xâ€–â‚Š â‰¤
    C7_5_7 a * â¨… x âˆˆ J, MB volume ð“‘ cð“‘ rð“‘ (â€–f Â·â€–) x := by
  sorry

/-- Lemma 7.5.8. -/
lemma scales_impacting_interval (huâ‚ : uâ‚ âˆˆ t) (huâ‚‚ : uâ‚‚ âˆˆ t) (hu : uâ‚ â‰  uâ‚‚)
    (h2u : ð“˜ uâ‚ â‰¤ ð“˜ uâ‚‚) (hJ : J âˆˆ ð“™â‚… t uâ‚ uâ‚‚) (hp : p âˆˆ t uâ‚ âˆª (t uâ‚‚ âˆ© ð”–â‚€ t uâ‚ uâ‚‚))
    (h : Â¬ Disjoint (ball (ð”  p) (8 * D ^ ð”° p)) (ball (c J) (8 * D ^ s J))) : s J â‰¤ ð”° p := by
  sorry

/-- The constant used in `global_tree_control1_1`.
Has value `2 ^ (154 * a ^ 3)` in the blueprint. -/
-- Todo: define this recursively in terms of previous constants
irreducible_def C7_5_9_1 (a : â„•) : â„â‰¥0 := 2 ^ (154 * (a : â„) ^ 3)

/-- The constant used in `global_tree_control1_2`.
Has value `2 ^ (153 * a ^ 3)` in the blueprint. -/
-- Todo: define this recursively in terms of previous constants
irreducible_def C7_5_9_2 (a : â„•) : â„â‰¥0 := 2 ^ (153 * (a : â„) ^ 3)

/-- Part 1 of Lemma 7.5.9 -/
lemma global_tree_control1_1 (huâ‚ : uâ‚ âˆˆ t) (huâ‚‚ : uâ‚‚ âˆˆ t) (hu : uâ‚ â‰  uâ‚‚)
    (h2u : ð“˜ uâ‚ â‰¤ ð“˜ uâ‚‚) (â„­ : Set (ð”“ X)) (hâ„­ : â„­ = t uâ‚ âˆ¨ â„­ = t uâ‚‚ âˆ© ð”–â‚€ t uâ‚ uâ‚‚)
    (hJ : J âˆˆ ð“™â‚… t uâ‚ uâ‚‚) (hf : IsBounded (range f)) (h2f : HasCompactSupport f)
    (h3f : AEStronglyMeasurable f) :
    â¨† x âˆˆ ball (c J) (8 * D ^ s J), â€–adjointCarlesonSum â„­ f xâ€–â‚Š â‰¤
    (â¨… x âˆˆ ball (c J) (8â»Â¹ * D ^ s J), â€–adjointCarlesonSum â„­ f xâ€–â‚Š) +
    C7_5_9_1 a * â¨… x âˆˆ J, MB volume ð“‘ cð“‘ rð“‘ (â€–f Â·â€–) x := by
  sorry

/-- Part 2 of Lemma 7.5.9 -/
lemma global_tree_control1_2 (huâ‚ : uâ‚ âˆˆ t) (huâ‚‚ : uâ‚‚ âˆˆ t) (hu : uâ‚ â‰  uâ‚‚)
    (h2u : ð“˜ uâ‚ â‰¤ ð“˜ uâ‚‚) (â„­ : Set (ð”“ X)) (hâ„­ : â„­ = t uâ‚ âˆ¨ â„­ = t uâ‚‚ âˆ© ð”–â‚€ t uâ‚ uâ‚‚)
    (hJ : J âˆˆ ð“™â‚… t uâ‚ uâ‚‚) (hf : IsBounded (range f)) (h2f : HasCompactSupport f)
    (h3f : AEStronglyMeasurable f)
    (hx : x âˆˆ ball (c J) (8 * D ^ s J)) (hx' : x' âˆˆ ball (c J) (8 * D ^ s J)) :
    nndist (exp (.I * ð’¬ u x) * adjointCarlesonSum â„­ f x)
      (exp (.I * ð’¬ u x') * adjointCarlesonSum â„­ f x') â‰¤
    C7_5_9_1 a * (nndist x x' / D ^ (ð”° p : â„)) ^ (a : â„)â»Â¹ *
    â¨… x âˆˆ J, MB volume ð“‘ cð“‘ rð“‘ (â€–f Â·â€–) x := by
  sorry

/-- The constant used in `global_tree_control2`.
Has value `2 ^ (155 * a ^ 3)` in the blueprint. -/
-- Todo: define this recursively in terms of previous constants
irreducible_def C7_5_10 (a : â„•) : â„â‰¥0 := 2 ^ (155 * (a : â„) ^ 3)

/-- Lemma 7.5.10 -/
lemma global_tree_control2 (huâ‚ : uâ‚ âˆˆ t) (huâ‚‚ : uâ‚‚ âˆˆ t) (hu : uâ‚ â‰  uâ‚‚)
    (h2u : ð“˜ uâ‚ â‰¤ ð“˜ uâ‚‚) (hJ : J âˆˆ ð“™â‚… t uâ‚ uâ‚‚)
    (hf : IsBounded (range f)) (h2f : HasCompactSupport f) (h3f : AEStronglyMeasurable f) :
    â¨† x âˆˆ ball (c J) (8 * D ^ s J), â€–adjointCarlesonSum (t uâ‚‚ âˆ© ð”–â‚€ t uâ‚ uâ‚‚) f xâ€–â‚Š â‰¤
    â¨… x âˆˆ ball (c J) (8â»Â¹ * D ^ s J), â€–adjointCarlesonSum (t uâ‚‚) f xâ€–â‚Š +
    C7_5_10 a * â¨… x âˆˆ J, MB volume ð“‘ cð“‘ rð“‘ (â€–f Â·â€–) x := by
  sorry

/-- The constant used in `holder_correlation_tree`.
Has value `2 ^ (535 * a ^ 3)` in the blueprint. -/
-- Todo: define this recursively in terms of previous constants
irreducible_def C7_5_4 (a : â„•) : â„â‰¥0 := 2 ^ (535 * (a : â„) ^ 3)

/-- Lemma 7.5.4. -/
lemma holder_correlation_tree (huâ‚ : uâ‚ âˆˆ t) (huâ‚‚ : uâ‚‚ âˆˆ t) (hu : uâ‚ â‰  uâ‚‚)
    (h2u : ð“˜ uâ‚ â‰¤ ð“˜ uâ‚‚) (hJ : J âˆˆ ð“™â‚… t uâ‚ uâ‚‚)
    (hfâ‚ : IsBounded (range fâ‚)) (h2fâ‚ : HasCompactSupport fâ‚)
    (hfâ‚‚ : IsBounded (range fâ‚‚)) (h2fâ‚‚ : HasCompactSupport fâ‚‚) :
    HolderOnWith (C7_5_4 a *
    ((â¨… x âˆˆ ball (c J) (8â»Â¹ * D ^ s J), â€–adjointCarlesonSum (t uâ‚) fâ‚ xâ€–â‚Š) +
    (â¨… x âˆˆ J, MB volume ð“‘ cð“‘ rð“‘ (â€–fâ‚ Â·â€–) x).toNNReal) *
    ((â¨… x âˆˆ ball (c J) (8â»Â¹ * D ^ s J), â€–adjointCarlesonSum (t uâ‚‚) fâ‚‚ xâ€–â‚Š) +
    (â¨… x âˆˆ J, MB volume ð“‘ cð“‘ rð“‘ (â€–fâ‚‚ Â·â€–) x).toNNReal))
    nnÏ„ (holderFunction t uâ‚ uâ‚‚ fâ‚ fâ‚‚ J) (ball (c J) (8 * D ^ s J)) := by
  sorry


/-! ### Subsection 7.5.3 and Lemma 7.4.5 -/

/-- The constant used in `lower_oscillation_bound`.
Has value `2 ^ (Z * n / 2 - 201 * a ^ 3)` in the blueprint. -/
-- Todo: define this recursively in terms of previous constants
irreducible_def C7_5_11 (a n : â„•) : â„â‰¥0 := 2 ^ (Z * n / 2 - 201 * (a : â„) ^ 3)

/-- Lemma 7.5.11 -/
lemma lower_oscillation_bound (huâ‚ : uâ‚ âˆˆ t) (huâ‚‚ : uâ‚‚ âˆˆ t) (hu : uâ‚ â‰  uâ‚‚)
    (h2u : ð“˜ uâ‚ â‰¤ ð“˜ uâ‚‚) (hJ : J âˆˆ ð“™â‚… t uâ‚ uâ‚‚) :
    C7_5_11 a n â‰¤ dist_{c J, 8 * D ^ s J} (ð’¬ uâ‚) (ð’¬ uâ‚‚) := by
  sorry

/-- The constant used in `correlation_distant_tree_parts`.
Has value `2 ^ (541 * a ^ 3 - Z * n / (4 * a ^ 2 + 2 * a ^ 3))` in the blueprint. -/
-- Todo: define this recursively in terms of previous constants
irreducible_def C7_4_5 (a n : â„•) : â„â‰¥0 := 2 ^ (541 * (a : â„) ^ 3 - Z * n / (4 * a ^ 2 + 2 * a ^ 3))

/-- Lemma 7.4.5 -/
lemma correlation_distant_tree_parts (huâ‚ : uâ‚ âˆˆ t) (huâ‚‚ : uâ‚‚ âˆˆ t) (hu : uâ‚ â‰  uâ‚‚)
    (h2u : ð“˜ uâ‚ â‰¤ ð“˜ uâ‚‚)
    (hfâ‚ : IsBounded (range fâ‚)) (h2fâ‚ : HasCompactSupport fâ‚)
    (hfâ‚‚ : IsBounded (range fâ‚‚)) (h2fâ‚‚ : HasCompactSupport fâ‚‚) :
    â€–âˆ« x, adjointCarlesonSum (t uâ‚) gâ‚ x * conj (adjointCarlesonSum (t uâ‚‚ âˆ© ð”–â‚€ t uâ‚ uâ‚‚) gâ‚‚ x)â€–â‚Š â‰¤
    C7_4_5 a n *
    eLpNorm ((ð“˜ uâ‚ : Set X).indicator (adjointBoundaryOperator t uâ‚ gâ‚) Â· |>.toReal) 2 volume *
    eLpNorm ((ð“˜ uâ‚ : Set X).indicator (adjointBoundaryOperator t uâ‚‚ gâ‚‚) Â· |>.toReal) 2 volume := by
  sorry

end TileStructure.Forest
