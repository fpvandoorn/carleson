import Carleson.ForestOperator.LargeSeparation
import Carleson.ForestOperator.RemainingTiles

open ShortVariables TileStructure
variable {X : Type*} {a : â„•} {q : â„} {K : X â†’ X â†’ â„‚} {Ïƒâ‚ Ïƒâ‚‚ : X â†’ â„¤} {F G : Set X}
  [MetricSpace X] [ProofData a q K Ïƒâ‚ Ïƒâ‚‚ F G] [TileStructure Q D Îº S o]
  {n j j' : â„•} {t : Forest X n} {u uâ‚ uâ‚‚ p : ð”“ X} {x x' : X} {ð”– : Set (ð”“ X)}
  {f fâ‚ fâ‚‚ g gâ‚ gâ‚‚ : X â†’ â„‚} {I J J' L : Grid X}
variable {E' : Type*} [NormedAddCommGroup E'] [NormedSpace â„ E']

noncomputable section

open Set MeasureTheory Metric Function Complex Bornology TileStructure Classical Filter
open scoped NNReal ENNReal ComplexConjugate

namespace TileStructure.Forest

/-! ## Lemmas 7.4.4 -/

/-- The constant used in `correlation_separated_trees`.
Has value `2 ^ (550 * a ^ 3 - 3 * n)` in the blueprint. -/
-- Todo: define this recursively in terms of previous constants
irreducible_def C7_4_4 (a n : â„•) : â„â‰¥0 := 2 ^ (550 * (a : â„) ^ 3 - 3 * n)

lemma correlation_separated_trees_of_subset (huâ‚ : uâ‚ âˆˆ t) (huâ‚‚ : uâ‚‚ âˆˆ t) (hu : uâ‚ â‰  uâ‚‚)
    (h2u : ð“˜ uâ‚ â‰¤ ð“˜ uâ‚‚)
    (hfâ‚ : IsBounded (range fâ‚)) (h2fâ‚ : HasCompactSupport fâ‚)
    (hfâ‚‚ : IsBounded (range fâ‚‚)) (h2fâ‚‚ : HasCompactSupport fâ‚‚) :
    â€–âˆ« x, adjointCarlesonSum (t uâ‚) gâ‚ x * conj (adjointCarlesonSum (t uâ‚‚) gâ‚‚ x)â€–â‚Š â‰¤
    C7_4_4 a n *
    eLpNorm
      ((ð“˜ uâ‚ âˆ© ð“˜ uâ‚‚ : Set X).indicator (adjointBoundaryOperator t uâ‚ gâ‚) Â· |>.toReal) 2 volume *
    eLpNorm
      ((ð“˜ uâ‚ âˆ© ð“˜ uâ‚‚ : Set X).indicator (adjointBoundaryOperator t uâ‚‚ gâ‚‚) Â· |>.toReal) 2 volume := by
  sorry

/-- Lemma 7.4.4. -/
lemma correlation_separated_trees (huâ‚ : uâ‚ âˆˆ t) (huâ‚‚ : uâ‚‚ âˆˆ t) (hu : uâ‚ â‰  uâ‚‚)
    (hfâ‚ : IsBounded (range fâ‚)) (h2fâ‚ : HasCompactSupport fâ‚)
    (hfâ‚‚ : IsBounded (range fâ‚‚)) (h2fâ‚‚ : HasCompactSupport fâ‚‚) :
    â€–âˆ« x, adjointCarlesonSum (t uâ‚) gâ‚ x * conj (adjointCarlesonSum (t uâ‚‚) gâ‚‚ x)â€–â‚Š â‰¤
    C7_4_4 a n *
    eLpNorm
      ((ð“˜ uâ‚ âˆ© ð“˜ uâ‚‚ : Set X).indicator (adjointBoundaryOperator t uâ‚ gâ‚) Â· |>.toReal) 2 volume *
    eLpNorm
      ((ð“˜ uâ‚ âˆ© ð“˜ uâ‚‚ : Set X).indicator (adjointBoundaryOperator t uâ‚‚ gâ‚‚) Â· |>.toReal) 2 volume := by
  sorry


/-! ## Section 7.7 -/

/-- The row-decomposition of a tree, defined in the proof of Lemma 7.7.1.
The indexing is off-by-one compared to the blueprint. -/
def rowDecomp (t : Forest X n) (j : â„•) : Row X n := sorry

/-- Part of Lemma 7.7.1 -/
@[simp]
lemma biUnion_rowDecomp : â‹ƒ j < 2 ^ n, t.rowDecomp j = (t : Set (ð”“ X)) := by
  sorry

/-- Part of Lemma 7.7.1 -/
lemma pairwiseDisjoint_rowDecomp :
    (Iio (2 ^ n)).PairwiseDisjoint (rowDecomp t Â· : â„• â†’ Set (ð”“ X)) := by
  sorry

@[simp] lemma rowDecomp_apply : t.rowDecomp j u = t u := by
  sorry

/-- The constant used in `row_bound`.
Has value `2 ^ (156 * a ^ 3 - n / 2)` in the blueprint. -/
-- Todo: define this recursively in terms of previous constants
irreducible_def C7_7_2_1 (a n : â„•) : â„â‰¥0 := 2 ^ (156 * (a : â„) ^ 3 - n / 2)

/-- The constant used in `indicator_row_bound`.
Has value `2 ^ (257 * a ^ 3 - n / 2)` in the blueprint. -/
-- Todo: define this recursively in terms of previous constants
irreducible_def C7_7_2_2 (a n : â„•) : â„â‰¥0 := 2 ^ (257 * (a : â„) ^ 3 - n / 2)

/-- Part of Lemma 7.7.2. -/
lemma row_bound (hj : j < 2 ^ n) (hf : IsBounded (range f)) (h2f : HasCompactSupport f)
    (h3f : AEStronglyMeasurable f) :
    eLpNorm (âˆ‘ u âˆˆ {p | p âˆˆ rowDecomp t j}, adjointCarlesonSum (t u) f) 2 volume â‰¤
    C7_7_2_1 a n * eLpNorm f 2 volume := by
  sorry

/-- Part of Lemma 7.7.2. -/
lemma indicator_row_bound (hj : j < 2 ^ n) (hf : IsBounded (range f)) (h2f : HasCompactSupport f)
    (h3f : AEStronglyMeasurable f) :
    eLpNorm (âˆ‘ u âˆˆ {p | p âˆˆ rowDecomp t j}, F.indicator <| adjointCarlesonSum (t u) f) 2 volume â‰¤
    C7_7_2_2 a n * densâ‚‚ (â‹ƒ u âˆˆ t, t u) ^ (2 : â„)â»Â¹ * eLpNorm f 2 volume := by
  sorry

/-- The constant used in `row_correlation`.
Has value `2 ^ (862 * a ^ 3 - 3 * n)` in the blueprint. -/
-- Todo: define this recursively in terms of previous constants
irreducible_def C7_7_3 (a n : â„•) : â„â‰¥0 := 2 ^ (862 * (a : â„) ^ 3 - 2 * n)

/-- Lemma 7.7.3. -/
lemma row_correlation (hjj' : j < j') (hj' : j' < 2 ^ n)
    (hfâ‚ : IsBounded (range fâ‚)) (h2fâ‚ : HasCompactSupport fâ‚)
    (hfâ‚‚ : IsBounded (range fâ‚‚)) (h2fâ‚‚ : HasCompactSupport fâ‚‚) :
    â€–âˆ« x, (âˆ‘ u âˆˆ {p | p âˆˆ rowDecomp t j}, adjointCarlesonSum (t u) fâ‚ x) *
    (âˆ‘ u âˆˆ {p | p âˆˆ rowDecomp t j'}, adjointCarlesonSum (t u) fâ‚‚ x)â€–â‚Š â‰¤
    C7_7_3 a n * eLpNorm fâ‚ 2 volume * eLpNorm fâ‚‚ 2 volume := by
  sorry

variable (t) in
/-- The definition of `Eâ±¼` defined above Lemma 7.7.4. -/
def rowSupport (j : â„•) : Set X := â‹ƒ (u âˆˆ rowDecomp t j) (p âˆˆ t u), E p

/-- Lemma 7.7.4 -/
lemma pairwiseDisjoint_rowSupport :
    (Iio (2 ^ n)).PairwiseDisjoint (rowSupport t) := by
  sorry

end TileStructure.Forest

/-! ## Proposition 2.0.4 -/

/-- The constant used in `forest_operator`.
Has value `2 ^ (432 * a ^ 3 - (q - 1) / q * n)` in the blueprint. -/
-- Todo: define this recursively in terms of previous constants
irreducible_def C2_0_4 (a q : â„) (n : â„•) : â„â‰¥0 := 2 ^ (432 * a ^ 3 - (q - 1) / q * n)

theorem forest_operator {n : â„•} (ð”‰ : Forest X n) {f g : X â†’ â„‚}
    (hf : Measurable f) (h2f : âˆ€ x, â€–f xâ€– â‰¤ F.indicator 1 x) (hg : Measurable g)
    (h2g : IsBounded (support g)) :
    â€–âˆ« x, conj (g x) * âˆ‘ u âˆˆ { p | p âˆˆ ð”‰ }, carlesonSum (ð”‰ u) f xâ€–â‚Š â‰¤
    C2_0_4 a q n * (densâ‚‚ (X := X) (â‹ƒ u âˆˆ ð”‰, ð”‰ u)) ^ (qâ»Â¹ - 2â»Â¹) *
    eLpNorm f 2 volume * eLpNorm g 2 volume := by
  sorry
