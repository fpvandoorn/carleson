import Carleson.ForestOperator.AlmostOrthogonality

open ShortVariables TileStructure
variable {X : Type*} {a : â„•} {q : â„} {K : X â†’ X â†’ â„‚} {Ïƒâ‚ Ïƒâ‚‚ : X â†’ â„¤} {F G : Set X}
  [MetricSpace X] [ProofData a q K Ïƒâ‚ Ïƒâ‚‚ F G] [TileStructure Q D Îº S o]
  {n j j' : â„•} {t : Forest X n} {u uâ‚ uâ‚‚ p : ğ”“ X} {x x' : X} {ğ”– : Set (ğ”“ X)}
  {f fâ‚ fâ‚‚ g gâ‚ gâ‚‚ : X â†’ â„‚} {I J J' L : Grid X}
variable {E' : Type*} [NormedAddCommGroup E'] [NormedSpace â„ E']

noncomputable section

open Set MeasureTheory Metric Function Complex Bornology TileStructure Classical Filter
open scoped NNReal ENNReal ComplexConjugate

namespace TileStructure.Forest


/-! ## Section 7.6 and Lemma 7.4.6 -/

variable (t uâ‚) in
/-- The definition `ğ“™'` at the start of Section 7.6.
We use a different notation to distinguish it from the ğ“™' used in Section 7.5 -/
def ğ“™â‚† : Set (Grid X) := ğ“™ (t uâ‚) âˆ© Iic (ğ“˜ uâ‚)

/-- Part of Lemma 7.6.1. -/
lemma union_ğ“™â‚† (huâ‚ : uâ‚ âˆˆ t) :
    â‹ƒ J âˆˆ ğ“™â‚† t uâ‚, (J : Set X) = ğ“˜ uâ‚ := by
  sorry

/-- Part of Lemma 7.6.1. -/
lemma pairwiseDisjoint_ğ“™â‚† (huâ‚ : uâ‚ âˆˆ t) :
    (ğ“™â‚† t uâ‚).PairwiseDisjoint (fun I â†¦ (I : Set X)) := by
  sorry

/-- The constant used in `thin_scale_impact`. This is denoted `sâ‚` in the proof of Lemma 7.6.3.
Has value `Z * n / (202 * a ^ 3) - 2` in the blueprint. -/
-- Todo: define this recursively in terms of previous constants
irreducible_def C7_6_3 (a n : â„•) : â„ := Z * n / (202 * a ^ 3) - 2

-- if needed
lemma C7_6_3_pos [ProofData a q K Ïƒâ‚ Ïƒâ‚‚ F G] (h : 1 â‰¤ n) : 0 < C7_6_3 a n := by
  sorry

/-- Lemma 7.6.3. -/
lemma thin_scale_impact (huâ‚ : uâ‚ âˆˆ t) (huâ‚‚ : uâ‚‚ âˆˆ t) (hu : uâ‚ â‰  uâ‚‚)
    (h2u : ğ“˜ uâ‚ â‰¤ ğ“˜ uâ‚‚) (hp : p âˆˆ t uâ‚‚ \ ğ”–â‚€ t uâ‚ uâ‚‚) (hJ : J âˆˆ ğ“™â‚† t uâ‚)
    (h : Â¬ Disjoint (ball (ğ”  p) (8 * D ^ ğ”° p)) (ball (c J) (8 * D ^ s J))) :
    ğ”° p â‰¤ s J - C7_6_3 a n := by
  sorry

/-- The constant used in `square_function_count`.
Has value `Z * n / (202 * a ^ 3) - 2` in the blueprint. -/
-- Todo: define this recursively in terms of previous constants
irreducible_def C7_6_4 (a : â„•) (s : â„¤) : â„â‰¥0 := 2 ^ (104 * (a : â„) ^ 2) * (8 * D ^ (- s)) ^ Îº

/-- Lemma 7.6.4. -/
lemma square_function_count (huâ‚ : uâ‚ âˆˆ t) (huâ‚‚ : uâ‚‚ âˆˆ t) (hu : uâ‚ â‰  uâ‚‚)
    (h2u : ğ“˜ uâ‚ â‰¤ ğ“˜ uâ‚‚) (hp : p âˆˆ t uâ‚‚ \ ğ”–â‚€ t uâ‚ uâ‚‚) (hJ : J âˆˆ ğ“™â‚† t uâ‚) (s' : â„¤ /- ? -/) :
    â¨â» x : X, (âˆ‘ I âˆˆ {I : Grid X | s I = s J - s' âˆ§ Disjoint (I : Set X) (ğ“˜ uâ‚) âˆ§
    Â¬ Disjoint (J : Set X) (ball (c I) (8 * D ^ s I)) },
    (ball (c I) (8 * D ^ s I)).indicator 1 x) ^ 2 â‰¤ C7_6_4 a s' := by
  sorry

/-- The constant used in `bound_for_tree_projection`.
Has value `2 ^ (118 * a ^ 3 - 100 / (202 * a) * Z * n * Îº)` in the blueprint. -/
-- Todo: define this recursively in terms of previous constants
irreducible_def C7_6_2 (a n : â„•) : â„â‰¥0 := 2 ^ (118 * (a : â„) ^ 3 - 100 / (202 * a) * Z * n * Îº)

/-- Lemma 7.6.2. Todo: add needed hypothesis to LaTeX -/
lemma bound_for_tree_projection (huâ‚ : uâ‚ âˆˆ t) (huâ‚‚ : uâ‚‚ âˆˆ t) (hu : uâ‚ â‰  uâ‚‚)
    (h2u : ğ“˜ uâ‚ â‰¤ ğ“˜ uâ‚‚) (hf : IsBounded (range f)) (h2f : HasCompactSupport f)
    (h3f : AEStronglyMeasurable f) :
    eLpNorm (approxOnCube (ğ“™â‚† t uâ‚) (â€–adjointCarlesonSum (t uâ‚‚ \ ğ”–â‚€ t uâ‚ uâ‚‚) f Â·â€–)) 2 volume â‰¤
    C7_6_2 a n *
    eLpNorm ((ğ“˜ uâ‚ : Set X).indicator (MB volume ğ“‘ cğ“‘ rğ“‘ (â€–f Â·â€–) Â· |>.toReal)) 2 volume := by
  sorry

/-- The constant used in `correlation_near_tree_parts`.
Has value `2 ^ (541 * a ^ 3 - Z * n / (4 * a ^ 2 + 2 * a ^ 3))` in the blueprint. -/
-- Todo: define this recursively in terms of previous constants
irreducible_def C7_4_6 (a n : â„•) : â„â‰¥0 := 2 ^ (222 * (a : â„) ^ 3 - Z * n * 2 ^ (-10 * (a : â„)))

/-- Lemma 7.4.6 -/
lemma correlation_near_tree_parts (huâ‚ : uâ‚ âˆˆ t) (huâ‚‚ : uâ‚‚ âˆˆ t) (hu : uâ‚ â‰  uâ‚‚) (h2u : ğ“˜ uâ‚ â‰¤ ğ“˜ uâ‚‚)
    (hfâ‚ : IsBounded (range fâ‚)) (h2fâ‚ : HasCompactSupport fâ‚)
    (hfâ‚‚ : IsBounded (range fâ‚‚)) (h2fâ‚‚ : HasCompactSupport fâ‚‚) :
    â€–âˆ« x, adjointCarlesonSum (t uâ‚) gâ‚ x * conj (adjointCarlesonSum (t uâ‚‚ \ ğ”–â‚€ t uâ‚ uâ‚‚) gâ‚‚ x)â€–â‚Š â‰¤
    C7_4_6 a n *
    eLpNorm ((ğ“˜ uâ‚ : Set X).indicator (adjointBoundaryOperator t uâ‚ gâ‚) Â· |>.toReal) 2 volume *
    eLpNorm ((ğ“˜ uâ‚ : Set X).indicator (adjointBoundaryOperator t uâ‚‚ gâ‚‚) Â· |>.toReal) 2 volume := by
  sorry

end TileStructure.Forest
